ğŸ–•æ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·â€œå½¤å“¥è¯»æºç â€ï¼ŒæŸ¥çœ‹æ›´å¤šæºç ç³»åˆ—æ–‡ç« , ä¸å½¤å“¥ä¸€èµ·ç•…æ¸¸æºç çš„æµ·æ´‹ã€‚ 

ï¼ˆæ‰‹æœºæ¨ªå±çœ‹æºç æ›´æ–¹ä¾¿ï¼‰

---

## é—®é¢˜

ï¼ˆ1ï¼‰ä»€ä¹ˆæ˜¯ABAï¼Ÿ

ï¼ˆ2ï¼‰ABAçš„å±å®³ï¼Ÿ

ï¼ˆ3ï¼‰ABAçš„è§£å†³æ–¹æ³•ï¼Ÿ

ï¼ˆ4ï¼‰AtomicStampedReferenceæ˜¯ä»€ä¹ˆï¼Ÿ

ï¼ˆ5ï¼‰AtomicStampedReferenceæ˜¯æ€ä¹ˆè§£å†³ABAçš„ï¼Ÿ

## ç®€ä»‹

AtomicStampedReferenceæ˜¯javaå¹¶å‘åŒ…ä¸‹æä¾›çš„ä¸€ä¸ªåŸå­ç±»ï¼Œå®ƒèƒ½è§£å†³å…¶å®ƒåŸå­ç±»æ— æ³•è§£å†³çš„ABAé—®é¢˜ã€‚

## ABA

ABAé—®é¢˜å‘ç”Ÿåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œå½“æŸçº¿ç¨‹è¿ç»­è¯»å–åŒä¸€å—å†…å­˜åœ°å€ä¸¤æ¬¡ï¼Œä¸¤æ¬¡å¾—åˆ°çš„å€¼ä¸€æ ·ï¼Œå®ƒç®€å•åœ°è®¤ä¸ºâ€œæ­¤å†…å­˜åœ°å€çš„å€¼å¹¶æ²¡æœ‰è¢«ä¿®æ”¹è¿‡â€ï¼Œç„¶è€Œï¼ŒåŒæ—¶å¯èƒ½å­˜åœ¨å¦ä¸€ä¸ªçº¿ç¨‹åœ¨è¿™ä¸¤æ¬¡è¯»å–ä¹‹é—´æŠŠè¿™ä¸ªå†…å­˜åœ°å€çš„å€¼ä»Aä¿®æ”¹æˆäº†Båˆä¿®æ”¹å›äº†Aï¼Œè¿™æ—¶è¿˜ç®€å•åœ°è®¤ä¸ºâ€œæ²¡æœ‰ä¿®æ”¹è¿‡â€æ˜¾ç„¶æ˜¯é”™è¯¯çš„ã€‚

æ¯”å¦‚ï¼Œä¸¤ä¸ªçº¿ç¨‹æŒ‰ä¸‹é¢çš„é¡ºåºæ‰§è¡Œï¼š

ï¼ˆ1ï¼‰çº¿ç¨‹1è¯»å–å†…å­˜ä½ç½®Xçš„å€¼ä¸ºAï¼›

ï¼ˆ2ï¼‰çº¿ç¨‹1é˜»å¡äº†ï¼›

ï¼ˆ3ï¼‰çº¿ç¨‹2è¯»å–å†…å­˜ä½ç½®Xçš„å€¼ä¸ºAï¼›

ï¼ˆ4ï¼‰çº¿ç¨‹2ä¿®æ”¹å†…å­˜ä½ç½®Xçš„å€¼ä¸ºBï¼›

ï¼ˆ5ï¼‰çº¿ç¨‹2ä¿®æ”¹åˆå†…å­˜ä½ç½®Xçš„å€¼ä¸ºAï¼›

ï¼ˆ6ï¼‰çº¿ç¨‹1æ¢å¤ï¼Œç»§ç»­æ‰§è¡Œï¼Œæ¯”è¾ƒå‘ç°è¿˜æ˜¯AæŠŠå†…å­˜ä½ç½®Xçš„å€¼è®¾ç½®ä¸ºCï¼›

![ABA](3.AtomicStampedReference%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.resource/ABA1.png)

å¯ä»¥çœ‹åˆ°ï¼Œé’ˆå¯¹çº¿ç¨‹1æ¥è¯´ï¼Œç¬¬ä¸€æ¬¡çš„Aå’Œç¬¬äºŒæ¬¡çš„Aå®é™…ä¸Šå¹¶ä¸æ˜¯åŒä¸€ä¸ªAã€‚

ABAé—®é¢˜é€šå¸¸å‘ç”Ÿåœ¨æ— é”ç»“æ„ä¸­ï¼Œç”¨ä»£ç æ¥è¡¨ç¤ºä¸Šé¢çš„è¿‡ç¨‹å¤§æ¦‚å°±æ˜¯è¿™æ ·ï¼š

```java
public class ABATest {

    public static void main(String[] args) {
        AtomicInteger atomicInteger = new AtomicInteger(1);

        new Thread(()->{
            int value = atomicInteger.get();
            System.out.println("thread 1 read value: " + value);

            // é˜»å¡1s
            LockSupport.parkNanos(1000000000L);

            if (atomicInteger.compareAndSet(value, 3)) {
                System.out.println("thread 1 update from " + value + " to 3");
            } else {
                System.out.println("thread 1 update fail!");
            }
        }).start();

        new Thread(()->{
            int value = atomicInteger.get();
            System.out.println("thread 2 read value: " + value);
            if (atomicInteger.compareAndSet(value, 2)) {
                System.out.println("thread 2 update from " + value + " to 2");

                // do sth

                value = atomicInteger.get();
                System.out.println("thread 2 read value: " + value);
                if (atomicInteger.compareAndSet(value, 1)) {
                    System.out.println("thread 2 update from " + value + " to 1");
                }
            }
        }).start();
    }
}
```

æ‰“å°ç»“æœä¸ºï¼š

```java
thread 1 read value: 1
thread 2 read value: 1
thread 2 update from 1 to 2
thread 2 read value: 2
thread 2 update from 2 to 1
thread 1 update from 1 to 3
```

## ABAçš„å±å®³

ä¸ºäº†æ›´å¥½åœ°ç†è§£ABAçš„å±å®³ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ¥çœ‹ä¸€ä¸ªç°å®ç‚¹çš„ä¾‹å­ã€‚

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæ— é”çš„æ ˆç»“æ„ï¼Œå¦‚ä¸‹ï¼š

```java
public class ABATest {

    static class Stack {
        // å°†topæ”¾åœ¨åŸå­ç±»ä¸­
        private AtomicReference<Node> top = new AtomicReference<>();
        // æ ˆä¸­èŠ‚ç‚¹ä¿¡æ¯
        static class Node {
            int value;
            Node next;

            public Node(int value) {
                this.value = value;
            }
        }
        // å‡ºæ ˆæ“ä½œ
        public Node pop() {
            for (;;) {
                // è·å–æ ˆé¡¶èŠ‚ç‚¹
                Node t = top.get();
                if (t == null) {
                    return null;
                }
                // æ ˆé¡¶ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
                Node next = t.next;
                // CASæ›´æ–°topæŒ‡å‘å…¶nextèŠ‚ç‚¹
                if (top.compareAndSet(t, next)) {
                    // æŠŠæ ˆé¡¶å…ƒç´ å¼¹å‡ºï¼Œåº”è¯¥æŠŠnextæ¸…ç©ºé˜²æ­¢å¤–é¢ç›´æ¥æ“ä½œæ ˆ
                    t.next = null;
                    return t;
                }
            }
        }
        // å…¥æ ˆæ“ä½œ
        public void push(Node node) {
            for (;;) {
                // è·å–æ ˆé¡¶èŠ‚ç‚¹
                Node next = top.get();
                // è®¾ç½®æ ˆé¡¶èŠ‚ç‚¹ä¸ºæ–°èŠ‚ç‚¹çš„nextèŠ‚ç‚¹
                node.next = next;
                // CASæ›´æ–°topæŒ‡å‘æ–°èŠ‚ç‚¹
                if (top.compareAndSet(next, node)) {
                    return;
                }
            }
        }
    }
}
```

å’‹ä¸€çœ‹ï¼Œè¿™æ®µç¨‹åºä¼¼ä¹æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œç„¶è€Œè¯•æƒ³ä»¥ä¸‹æƒ…å½¢ã€‚

å‡å¦‚ï¼Œæˆ‘ä»¬åˆå§‹åŒ–æ ˆç»“æ„ä¸º top->1->2->3ï¼Œç„¶åæœ‰ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«åšå¦‚ä¸‹æ“ä½œï¼š

ï¼ˆ1ï¼‰çº¿ç¨‹1æ‰§è¡Œpop()å‡ºæ ˆæ“ä½œï¼Œä½†æ˜¯æ‰§è¡Œåˆ°`if (top.compareAndSet(t, next)) {`è¿™è¡Œä¹‹å‰æš‚åœäº†ï¼Œæ‰€ä»¥æ­¤æ—¶èŠ‚ç‚¹1å¹¶æœªå‡ºæ ˆï¼›

ï¼ˆ2ï¼‰çº¿ç¨‹2æ‰§è¡Œpop()å‡ºæ ˆæ“ä½œå¼¹å‡ºèŠ‚ç‚¹1ï¼Œæ­¤æ—¶æ ˆå˜ä¸º top->2->3ï¼›

ï¼ˆ3ï¼‰çº¿ç¨‹2æ‰§è¡Œpop()å‡ºæ ˆæ“ä½œå¼¹å‡ºèŠ‚ç‚¹2ï¼Œæ­¤æ—¶æ ˆå˜ä¸º top->3ï¼›

ï¼ˆ4ï¼‰çº¿ç¨‹2æ‰§è¡Œpush()å…¥æ ˆæ“ä½œæ·»åŠ èŠ‚ç‚¹1ï¼Œæ­¤æ—¶æ ˆå˜ä¸º top->1->3ï¼›

ï¼ˆ5ï¼‰çº¿ç¨‹1æ¢å¤æ‰§è¡Œï¼Œæ¯”è¾ƒèŠ‚ç‚¹1çš„å¼•ç”¨å¹¶æ²¡æœ‰æ”¹å˜ï¼Œæ‰§è¡ŒCASæˆåŠŸï¼Œæ­¤æ—¶æ ˆå˜ä¸º top->2ï¼›

Whatï¼Ÿç‚¹è§£å˜æˆ top->2 äº†ï¼Ÿä¸æ˜¯åº”è¯¥å˜æˆ top->3 å—ï¼Ÿ

é‚£æ˜¯å› ä¸ºçº¿ç¨‹1åœ¨ç¬¬ä¸€æ­¥ä¿å­˜çš„nextæ˜¯èŠ‚ç‚¹2ï¼Œæ‰€ä»¥å®ƒæ‰§è¡ŒCASæˆåŠŸåtopèŠ‚ç‚¹å°±æŒ‡å‘äº†èŠ‚ç‚¹2äº†ã€‚

æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š

```java
private static void testStack() {
    // åˆå§‹åŒ–æ ˆä¸º top->1->2->3
    Stack stack = new Stack();
    stack.push(new Stack.Node(3));
    stack.push(new Stack.Node(2));
    stack.push(new Stack.Node(1));

    new Thread(()->{
        // çº¿ç¨‹1å‡ºæ ˆä¸€ä¸ªå…ƒç´ 
        stack.pop();
    }).start();

    new Thread(()->{
        // çº¿ç¨‹2å‡ºæ ˆä¸¤ä¸ªå…ƒç´ 
        Stack.Node A = stack.pop();
        Stack.Node B = stack.pop();
        // çº¿ç¨‹2åˆæŠŠAå…¥æ ˆäº†
        stack.push(A);
    }).start();
}

public static void main(String[] args) {
    testStack();
}
```

åœ¨Stackçš„pop()æ–¹æ³•çš„`if (top.compareAndSet(t, next)) {`å¤„æ‰“ä¸ªæ–­ç‚¹ï¼Œçº¿ç¨‹1è¿è¡Œåˆ°è¿™é‡Œæ—¶é˜»å¡å®ƒçš„æ‰§è¡Œï¼Œè®©çº¿ç¨‹2æ‰§è¡Œå®Œï¼Œå†æ‰§è¡Œçº¿ç¨‹1è¿™å¥ï¼Œè¿™å¥æ‰§è¡Œå®Œå¯ä»¥çœ‹åˆ°æ ˆçš„topå¯¹è±¡ä¸­åªæœ‰2è¿™ä¸ªèŠ‚ç‚¹äº†ã€‚

_è®°å¾—æ‰“æ–­ç‚¹çš„æ—¶å€™ä¸€å®šè¦æ‰“Threadæ–­ç‚¹ï¼Œåœ¨IDEAä¸­æ˜¯å³å‡»é€‰æ‹©Suspendä¸ºThreadã€‚_

é€šè¿‡è¿™ä¸ªä¾‹å­ï¼Œç¬”è€…è®¤ä¸ºä½ è‚¯å®šå¾ˆæ¸…æ¥šABAçš„å±å®³äº†ã€‚

## ABAçš„è§£å†³æ–¹æ³•

ABAçš„å±å®³æˆ‘ä»¬æ¸…æ¥šäº†ï¼Œé‚£ä¹ˆæ€ä¹ˆè§£å†³ABAå‘¢ï¼Ÿ

ç¬”è€…æ€»ç»“äº†ä¸€ä¸‹ï¼Œå¤§æ¦‚æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š

ï¼ˆ1ï¼‰ç‰ˆæœ¬å·

æ¯”å¦‚ï¼Œä¸Šé¢çš„æ ˆç»“æ„å¢åŠ ä¸€ä¸ªç‰ˆæœ¬å·ç”¨äºæ§åˆ¶ï¼Œæ¯æ¬¡CASçš„åŒæ—¶æ£€æŸ¥ç‰ˆæœ¬å·æœ‰æ²¡æœ‰å˜è¿‡ã€‚

è¿˜æœ‰ä¸€äº›æ•°æ®ç»“æ„å–œæ¬¢ä½¿ç”¨é«˜ä½å­˜å‚¨ä¸€ä¸ªé‚®æˆ³æ¥ä¿è¯CASçš„å®‰å…¨ã€‚

ï¼ˆ2ï¼‰ä¸é‡å¤ä½¿ç”¨èŠ‚ç‚¹çš„å¼•ç”¨

æ¯”å¦‚ï¼Œä¸Šé¢çš„æ ˆç»“æ„åœ¨çº¿ç¨‹2æ‰§è¡Œpush()å…¥æ ˆæ“ä½œçš„æ—¶å€™æ–°å»ºä¸€ä¸ªèŠ‚ç‚¹ä¼ å…¥ï¼Œè€Œä¸æ˜¯å¤ç”¨èŠ‚ç‚¹1çš„å¼•ç”¨ï¼›

ï¼ˆ3ï¼‰ç›´æ¥æ“ä½œå…ƒç´ è€Œä¸æ˜¯èŠ‚ç‚¹

æ¯”å¦‚ï¼Œä¸Šé¢çš„æ ˆç»“æ„push()æ–¹æ³•ä¸åº”è¯¥ä¼ å…¥ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰ï¼Œè€Œæ˜¯ä¼ å…¥å…ƒç´ å€¼ï¼ˆintçš„valueï¼‰ã€‚


å¥½äº†ï¼Œæ‰¯äº†è¿™ä¹ˆå¤šï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹javaä¸­çš„AtomicStampedReferenceæ˜¯æ€ä¹ˆè§£å†³ABAçš„å§^^

## æºç åˆ†æ

### å†…éƒ¨ç±»

```java
private static class Pair<T> {
    final T reference;
    final int stamp;
    private Pair(T reference, int stamp) {
        this.reference = reference;
        this.stamp = stamp;
    }
    static <T> Pair<T> of(T reference, int stamp) {
        return new Pair<T>(reference, stamp);
    }
}
```

å°†å…ƒç´ å€¼å’Œç‰ˆæœ¬å·ç»‘å®šåœ¨ä¸€èµ·ï¼Œå­˜å‚¨åœ¨Pairçš„referenceå’Œstampï¼ˆé‚®ç¥¨ã€æˆ³çš„æ„æ€ï¼‰ä¸­ã€‚

### å±æ€§

```java
private volatile Pair<V> pair;
private static final sun.misc.Unsafe UNSAFE = sun.misc.Unsafe.getUnsafe();
private static final long pairOffset =
    objectFieldOffset(UNSAFE, "pair", AtomicStampedReference.class);
```

å£°æ˜ä¸€ä¸ªPairç±»å‹çš„å˜é‡å¹¶ä½¿ç”¨Unsfaeè·å–å…¶åç§»é‡ï¼Œå­˜å‚¨åˆ°pairOffsetä¸­ã€‚

### æ„é€ æ–¹æ³•

```java
public AtomicStampedReference(V initialRef, int initialStamp) {
    pair = Pair.of(initialRef, initialStamp);
}
```

æ„é€ æ–¹æ³•éœ€è¦ä¼ å…¥åˆå§‹å€¼åŠåˆå§‹ç‰ˆæœ¬å·ã€‚

### compareAndSet()æ–¹æ³•

```java
public boolean compareAndSet(V   expectedReference,
                             V   newReference,
                             int expectedStamp,
                             int newStamp) {
    // è·å–å½“å‰çš„ï¼ˆå…ƒç´ å€¼ï¼Œç‰ˆæœ¬å·ï¼‰å¯¹
    Pair<V> current = pair;
    return
        // å¼•ç”¨æ²¡å˜
        expectedReference == current.reference &&
        // ç‰ˆæœ¬å·æ²¡å˜
        expectedStamp == current.stamp &&
        // æ–°å¼•ç”¨ç­‰äºæ—§å¼•ç”¨
        ((newReference == current.reference &&
        // æ–°ç‰ˆæœ¬å·ç­‰äºæ—§ç‰ˆæœ¬å·
          newStamp == current.stamp) ||
          // æ„é€ æ–°çš„Pairå¯¹è±¡å¹¶CASæ›´æ–°
         casPair(current, Pair.of(newReference, newStamp)));
}

private boolean casPair(Pair<V> cmp, Pair<V> val) {
    // è°ƒç”¨Unsafeçš„compareAndSwapObject()æ–¹æ³•CASæ›´æ–°pairçš„å¼•ç”¨ä¸ºæ–°å¼•ç”¨
    return UNSAFE.compareAndSwapObject(this, pairOffset, cmp, val);
}
```

ï¼ˆ1ï¼‰å¦‚æœå…ƒç´ å€¼å’Œç‰ˆæœ¬å·éƒ½æ²¡æœ‰å˜åŒ–ï¼Œå¹¶ä¸”å’Œæ–°çš„ä¹Ÿç›¸åŒï¼Œè¿”å›trueï¼›

ï¼ˆ2ï¼‰å¦‚æœå…ƒç´ å€¼å’Œç‰ˆæœ¬å·éƒ½æ²¡æœ‰å˜åŒ–ï¼Œå¹¶ä¸”å’Œæ–°çš„ä¸å®Œå…¨ç›¸åŒï¼Œå°±æ„é€ ä¸€ä¸ªæ–°çš„Pairå¯¹è±¡å¹¶æ‰§è¡ŒCASæ›´æ–°pairã€‚

å¯ä»¥çœ‹åˆ°ï¼Œjavaä¸­çš„å®ç°è·Ÿæˆ‘ä»¬ä¸Šé¢è®²çš„ABAçš„è§£å†³æ–¹æ³•æ˜¯ä¸€è‡´çš„ã€‚

é¦–å…ˆï¼Œä½¿ç”¨ç‰ˆæœ¬å·æ§åˆ¶ï¼›

å…¶æ¬¡ï¼Œä¸é‡å¤ä½¿ç”¨èŠ‚ç‚¹ï¼ˆPairï¼‰çš„å¼•ç”¨ï¼Œæ¯æ¬¡éƒ½æ–°å»ºä¸€ä¸ªæ–°çš„Pairæ¥ä½œä¸ºCASæ¯”è¾ƒçš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯å¤ç”¨æ—§çš„ï¼›

æœ€åï¼Œå¤–éƒ¨ä¼ å…¥å…ƒç´ å€¼åŠç‰ˆæœ¬å·ï¼Œè€Œä¸æ˜¯èŠ‚ç‚¹ï¼ˆPairï¼‰çš„å¼•ç”¨ã€‚

## æ¡ˆä¾‹

è®©æˆ‘ä»¬æ¥ä½¿ç”¨AtomicStampedReferenceè§£å†³å¼€ç¯‡é‚£ä¸ªAtomicIntegerå¸¦æ¥çš„ABAé—®é¢˜ã€‚

```java
public class ABATest {

    public static void main(String[] args) {
        testStamp();
    }

    private static void testStamp() {
        AtomicStampedReference<Integer> atomicStampedReference = new AtomicStampedReference<>(1, 1);

        new Thread(()->{
            int[] stampHolder = new int[1];
            int value = atomicStampedReference.get(stampHolder);
            int stamp = stampHolder[0];
            System.out.println("thread 1 read value: " + value + ", stamp: " + stamp);

            // é˜»å¡1s
            LockSupport.parkNanos(1000000000L);

            if (atomicStampedReference.compareAndSet(value, 3, stamp, stamp + 1)) {
                System.out.println("thread 1 update from " + value + " to 3");
            } else {
                System.out.println("thread 1 update fail!");
            }
        }).start();

        new Thread(()->{
            int[] stampHolder = new int[1];
            int value = atomicStampedReference.get(stampHolder);
            int stamp = stampHolder[0];
            System.out.println("thread 2 read value: " + value + ", stamp: " + stamp);
            if (atomicStampedReference.compareAndSet(value, 2, stamp, stamp + 1)) {
                System.out.println("thread 2 update from " + value + " to 2");

                // do sth

                value = atomicStampedReference.get(stampHolder);
                stamp = stampHolder[0];
                System.out.println("thread 2 read value: " + value + ", stamp: " + stamp);
                if (atomicStampedReference.compareAndSet(value, 1, stamp, stamp + 1)) {
                    System.out.println("thread 2 update from " + value + " to 1");
                }
            }
        }).start();
    }
}
```

è¿è¡Œç»“æœä¸ºï¼š

```java
thread 1 read value: 1, stamp: 1
thread 2 read value: 1, stamp: 1
thread 2 update from 1 to 2
thread 2 read value: 2, stamp: 2
thread 2 update from 2 to 1
thread 1 update fail!
```

å¯ä»¥çœ‹åˆ°çº¿ç¨‹1æœ€åæ›´æ–°1åˆ°3æ—¶å¤±è´¥äº†ï¼Œå› ä¸ºè¿™æ—¶ç‰ˆæœ¬å·ä¹Ÿå˜äº†ï¼ŒæˆåŠŸè§£å†³äº†ABAçš„é—®é¢˜ã€‚

## æ€»ç»“

ï¼ˆ1ï¼‰åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä½¿ç”¨æ— é”ç»“æ„è¦æ³¨æ„ABAé—®é¢˜ï¼›

ï¼ˆ2ï¼‰ABAçš„è§£å†³ä¸€èˆ¬ä½¿ç”¨ç‰ˆæœ¬å·æ¥æ§åˆ¶ï¼Œå¹¶ä¿è¯æ•°æ®ç»“æ„ä½¿ç”¨å…ƒç´ å€¼æ¥ä¼ é€’ï¼Œä¸”æ¯æ¬¡æ·»åŠ å…ƒç´ éƒ½æ–°å»ºèŠ‚ç‚¹æ‰¿è½½å…ƒç´ å€¼ï¼›

ï¼ˆ3ï¼‰AtomicStampedReferenceå†…éƒ¨ä½¿ç”¨Pairæ¥å­˜å‚¨å…ƒç´ å€¼åŠå…¶ç‰ˆæœ¬å·ï¼›

## å½©è›‹

ï¼ˆ1ï¼‰javaä¸­è¿˜æœ‰å“ªäº›ç±»å¯ä»¥è§£å†³ABAçš„é—®é¢˜ï¼Ÿ

AtomicMarkableReferenceï¼Œå®ƒä¸æ˜¯ç»´æŠ¤ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œè€Œæ˜¯ç»´æŠ¤ä¸€ä¸ªbooleanç±»å‹çš„æ ‡è®°ï¼Œæ ‡è®°å€¼æœ‰ä¿®æ”¹ï¼Œäº†è§£ä¸€ä¸‹ã€‚

ï¼ˆ2ï¼‰å®é™…å·¥ä½œä¸­é‡åˆ°è¿‡ABAé—®é¢˜å—ï¼Ÿ

ç¬”è€…è¿˜çœŸé‡åˆ°è¿‡ï¼Œä»¥å‰åšæ£‹ç‰Œæ¸¸æˆçš„æ—¶å€™ï¼ŒABCDå››ä¸ªç©å®¶ï¼ŒAç©å®¶å‡ºäº†ä¸€å¼ ç‰Œï¼Œç„¶åä»–è¿™ä¸ªè¯·æ±‚è¿Ÿè¿Ÿæ²¡åˆ°æœåŠ¡å™¨ï¼Œä¹Ÿå°±æ˜¯è¶…æ—¶äº†ï¼ŒæœåŠ¡å™¨å°±å¸®ä»–è‡ªåŠ¨å‡ºäº†ä¸€å¼ ç‰Œã€‚

ç„¶åï¼Œè½¬äº†ä¸€åœˆï¼Œåˆè½®åˆ°Aç©å®¶å‡ºç‰Œäº†ï¼Œè¯´å·§ä¸å·§ï¼Œæ­£å¥½è¿™æ—¶ä¹‹å‰é‚£ä¸ªè¯·æ±‚åˆ°äº†æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨æ£€æµ‹åˆ°ç°åœ¨æ­£å¥½æ˜¯Aå‡ºç‰Œï¼Œè€Œä¸”è¯·æ±‚çš„ä¹Ÿæ˜¯å‡ºç‰Œï¼Œå°±æŠŠè¿™å¼ ç‰Œæ‰“å‡ºå»äº†ã€‚

ç„¶åå‘¢ï¼ŒAç©å®¶çš„ç‰Œå°±ä¸å¯¹äº†ã€‚

æœ€åï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡ç»™æ¯ä¸ªè¯·æ±‚å¢åŠ ä¸€ä¸ªåºåˆ—å·æ¥å¤„ç†çš„ï¼Œæ£€æµ‹åˆ°è¿‡æœŸçš„åºåˆ—å·è¯·æ±‚ç›´æ¥æŠ›å¼ƒæ‰ã€‚


ä½ æœ‰æ²¡æœ‰é‡åˆ°è¿‡ABAé—®é¢˜å‘¢ï¼Ÿ

---

æ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·â€œå½¤å“¥è¯»æºç â€ï¼ŒæŸ¥çœ‹æ›´å¤šæºç ç³»åˆ—æ–‡ç« , ä¸å½¤å“¥ä¸€èµ·ç•…æ¸¸æºç çš„æµ·æ´‹ã€‚

![qrcode](3.AtomicStampedReference%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.resource/qrcode_ss.jpg)