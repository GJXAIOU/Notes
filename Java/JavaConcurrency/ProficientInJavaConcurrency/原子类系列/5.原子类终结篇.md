ğŸ–•æ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·â€œå½¤å“¥è¯»æºç â€ï¼ŒæŸ¥çœ‹æ›´å¤šæºç ç³»åˆ—æ–‡ç« , ä¸å½¤å“¥ä¸€èµ·ç•…æ¸¸æºç çš„æµ·æ´‹ã€‚ 

ï¼ˆæ‰‹æœºæ¨ªå±çœ‹æºç æ›´æ–¹ä¾¿ï¼‰

---

## æ¦‚è§ˆ

åŸå­æ“ä½œæ˜¯æŒ‡ä¸ä¼šè¢«çº¿ç¨‹è°ƒåº¦æœºåˆ¶æ‰“æ–­çš„æ“ä½œï¼Œè¿™ç§æ“ä½œä¸€æ—¦å¼€å§‹ï¼Œå°±ä¸€ç›´è¿è¡Œåˆ°ç»“æŸï¼Œä¸­é—´ä¸ä¼šæœ‰ä»»ä½•çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚

åŸå­æ“ä½œå¯ä»¥æ˜¯ä¸€ä¸ªæ­¥éª¤ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªæ“ä½œæ­¥éª¤ï¼Œä½†æ˜¯å…¶é¡ºåºä¸å¯ä»¥è¢«æ‰“ä¹±ï¼Œä¹Ÿä¸å¯ä»¥è¢«åˆ‡å‰²è€Œåªæ‰§è¡Œå…¶ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œå°†æ•´ä¸ªæ“ä½œè§†ä½œä¸€ä¸ªæ•´ä½“æ˜¯åŸå­æ€§çš„æ ¸å¿ƒç‰¹å¾ã€‚

åœ¨javaä¸­æä¾›äº†å¾ˆå¤šåŸå­ç±»ï¼Œç¬”è€…åœ¨æ­¤ä¸»è¦æŠŠè¿™äº›åŸå­ç±»åˆ†æˆå››å¤§ç±»ã€‚

![atomic](5.%E5%8E%9F%E5%AD%90%E7%B1%BB%E7%BB%88%E7%BB%93%E7%AF%87.resource/atomic1.png)

## åŸå­æ›´æ–°åŸºæœ¬ç±»å‹æˆ–å¼•ç”¨ç±»å‹

å¦‚æœæ˜¯åŸºæœ¬ç±»å‹ï¼Œåˆ™æ›¿æ¢å…¶å€¼ï¼Œå¦‚æœæ˜¯å¼•ç”¨ï¼Œåˆ™æ›¿æ¢å…¶å¼•ç”¨åœ°å€ï¼Œè¿™äº›ç±»ä¸»è¦æœ‰ï¼š

 - AtomicBoolean

 åŸå­æ›´æ–°å¸ƒå°”ç±»å‹ï¼Œå†…éƒ¨ä½¿ç”¨intç±»å‹çš„valueå­˜å‚¨1å’Œ0è¡¨ç¤ºtrueå’Œfalseï¼Œåº•å±‚ä¹Ÿæ˜¯å¯¹intç±»å‹çš„åŸå­æ“ä½œã€‚

 - AtomicInteger

 åŸå­æ›´æ–°intç±»å‹ã€‚

 - AtomicLong

 åŸå­æ›´æ–°longç±»å‹ã€‚

 - AtomicReference

 åŸå­æ›´æ–°å¼•ç”¨ç±»å‹ï¼Œé€šè¿‡æ³›å‹æŒ‡å®šè¦æ“ä½œçš„ç±»ã€‚

 - AtomicMarkableReference

 åŸå­æ›´æ–°å¼•ç”¨ç±»å‹ï¼Œå†…éƒ¨ä½¿ç”¨Pairæ‰¿è½½å¼•ç”¨å¯¹è±¡åŠæ˜¯å¦è¢«æ›´æ–°è¿‡çš„æ ‡è®°ï¼Œé¿å…äº†ABAé—®é¢˜ã€‚

 - AtomicStampedReference

 åŸå­æ›´æ–°å¼•ç”¨ç±»å‹ï¼Œå†…éƒ¨ä½¿ç”¨Pairæ‰¿è½½å¼•ç”¨å¯¹è±¡åŠæ›´æ–°çš„é‚®æˆ³ï¼Œé¿å…äº†ABAé—®é¢˜ã€‚

è¿™å‡ ä¸ªç±»çš„æ“ä½œåŸºæœ¬ç±»ä¼¼ï¼Œåº•å±‚éƒ½æ˜¯è°ƒç”¨Unsafeçš„compareAndSwapXxx()æ¥å®ç°ï¼ŒåŸºæœ¬ç”¨æ³•å¦‚ä¸‹ï¼š

```java
private static void testAtomicReference() {
    AtomicInteger atomicInteger = new AtomicInteger(1);
    atomicInteger.incrementAndGet();
    atomicInteger.getAndIncrement();
    atomicInteger.compareAndSet(3, 666);
    System.out.println(atomicInteger.get());

    AtomicStampedReference<Integer> atomicStampedReference = new AtomicStampedReference<>(1, 1);
    atomicStampedReference.compareAndSet(1, 2, 1, 3);
    atomicStampedReference.compareAndSet(2, 666, 3, 5);
    System.out.println(atomicStampedReference.getReference());
    System.out.println(atomicStampedReference.getStamp());
}
```

## åŸå­æ›´æ–°æ•°ç»„ä¸­çš„å…ƒç´ 

åŸå­æ›´æ–°æ•°ç»„ä¸­çš„å…ƒç´ ï¼Œå¯ä»¥æ›´æ–°æ•°ç»„ä¸­æŒ‡å®šç´¢å¼•ä½ç½®çš„å…ƒç´ ï¼Œè¿™äº›ç±»ä¸»è¦æœ‰ï¼š

 - AtomicIntegerArray

 åŸå­æ›´æ–°intæ•°ç»„ä¸­çš„å…ƒç´ ã€‚

 - AtomicLongArray

 åŸå­æ›´æ–°longæ•°ç»„ä¸­çš„å…ƒç´ ã€‚

 - AtomicReferenceArray

 åŸå­æ›´æ–°Objectæ•°ç»„ä¸­çš„å…ƒç´ ã€‚

è¿™å‡ ä¸ªç±»çš„æ“ä½œåŸºæœ¬ç±»ä¼¼ï¼Œæ›´æ–°å…ƒç´ æ—¶éƒ½è¦æŒ‡å®šåœ¨æ•°ç»„ä¸­çš„ç´¢å¼•ä½ç½®ï¼ŒåŸºæœ¬ç”¨æ³•å¦‚ä¸‹ï¼š

```java
private static void testAtomicReferenceArray() {
    AtomicIntegerArray atomicIntegerArray = new AtomicIntegerArray(10);
    atomicIntegerArray.getAndIncrement(0);
    atomicIntegerArray.getAndAdd(1, 666);
    atomicIntegerArray.incrementAndGet(2);
    atomicIntegerArray.addAndGet(3, 666);
    atomicIntegerArray.compareAndSet(4, 0, 666);
    
    System.out.println(atomicIntegerArray.get(0));
    System.out.println(atomicIntegerArray.get(1));
    System.out.println(atomicIntegerArray.get(2));
    System.out.println(atomicIntegerArray.get(3));
    System.out.println(atomicIntegerArray.get(4));
    System.out.println(atomicIntegerArray.get(5));
}
```

## åŸå­æ›´æ–°å¯¹è±¡ä¸­çš„å­—æ®µ

åŸå­æ›´æ–°å¯¹è±¡ä¸­çš„å­—æ®µï¼Œå¯ä»¥æ›´æ–°å¯¹è±¡ä¸­æŒ‡å®šå­—æ®µåç§°çš„å­—æ®µï¼Œè¿™äº›ç±»ä¸»è¦æœ‰ï¼š

 - AtomicIntegerFieldUpdater

 åŸå­æ›´æ–°å¯¹è±¡ä¸­çš„intç±»å‹å­—æ®µã€‚

 - AtomicLongFieldUpdater

 åŸå­æ›´æ–°å¯¹è±¡ä¸­çš„longç±»å‹å­—æ®µã€‚

 - AtomicReferenceFieldUpdater

 åŸå­æ›´æ–°å¯¹è±¡ä¸­çš„å¼•ç”¨ç±»å‹å­—æ®µã€‚

è¿™å‡ ä¸ªç±»çš„æ“ä½œåŸºæœ¬ç±»ä¼¼ï¼Œéƒ½éœ€è¦ä¼ å…¥è¦æ›´æ–°çš„å­—æ®µåç§°ï¼ŒåŸºæœ¬ç”¨æ³•å¦‚ä¸‹ï¼š

```java
private static void testAtomicReferenceField() {
    AtomicReferenceFieldUpdater<User, String> updateName = AtomicReferenceFieldUpdater.newUpdater(User.class, String.class,"name");
    AtomicIntegerFieldUpdater<User> updateAge = AtomicIntegerFieldUpdater.newUpdater(User.class, "age");

    User user = new User("tong ge", 21);
    updateName.compareAndSet(user, "tong ge", "read source code");
    updateAge.compareAndSet(user, 21, 25);
    updateAge.incrementAndGet(user);
    
    System.out.println(user);
}

private static class User {
    volatile String name;
    volatile int age;

    public User(String name, int age) {
        this.name = name;
        this.age = age;
    }

    @Override
    public String toString() {
        return "name: " + name + ", age: " + age;
    }
}
```

## é«˜æ€§èƒ½åŸå­ç±»

é«˜æ€§èƒ½åŸå­ç±»ï¼Œæ˜¯java8ä¸­å¢åŠ çš„åŸå­ç±»ï¼Œå®ƒä»¬ä½¿ç”¨åˆ†æ®µçš„æ€æƒ³ï¼ŒæŠŠä¸åŒçš„çº¿ç¨‹hashåˆ°ä¸åŒçš„æ®µä¸Šå»æ›´æ–°ï¼Œæœ€åå†æŠŠè¿™äº›æ®µçš„å€¼ç›¸åŠ å¾—åˆ°æœ€ç»ˆçš„å€¼ï¼Œè¿™äº›ç±»ä¸»è¦æœ‰ï¼š

 - Striped64

 ä¸‹é¢å››ä¸ªç±»çš„çˆ¶ç±»ã€‚

 - LongAccumulator

 longç±»å‹çš„èšåˆå™¨ï¼Œéœ€è¦ä¼ å…¥ä¸€ä¸ªlongç±»å‹çš„äºŒå…ƒæ“ä½œï¼Œå¯ä»¥ç”¨æ¥è®¡ç®—å„ç§èšåˆæ“ä½œï¼ŒåŒ…æ‹¬åŠ ä¹˜ç­‰ã€‚

 - LongAdder

 longç±»å‹çš„ç´¯åŠ å™¨ï¼ŒLongAccumulatorçš„ç‰¹ä¾‹ï¼Œåªèƒ½ç”¨æ¥è®¡ç®—åŠ æ³•ï¼Œä¸”ä»0å¼€å§‹è®¡ç®—ã€‚

 - DoubleAccumulator

 doubleç±»å‹çš„èšåˆå™¨ï¼Œéœ€è¦ä¼ å…¥ä¸€ä¸ªdoubleç±»å‹çš„äºŒå…ƒæ“ä½œï¼Œå¯ä»¥ç”¨æ¥è®¡ç®—å„ç§èšåˆæ“ä½œï¼ŒåŒ…æ‹¬åŠ ä¹˜ç­‰ã€‚

 - DoubleAdder

 doubleç±»å‹çš„ç´¯åŠ å™¨ï¼ŒDoubleAccumulatorçš„ç‰¹ä¾‹ï¼Œåªèƒ½ç”¨æ¥è®¡ç®—åŠ æ³•ï¼Œä¸”ä»0å¼€å§‹è®¡ç®—ã€‚

è¿™å‡ ä¸ªç±»çš„æ“ä½œåŸºæœ¬ç±»ä¼¼ï¼Œå…¶ä¸­DoubleAccumulatorå’ŒDoubleAdderåº•å±‚å…¶å®ä¹Ÿæ˜¯ç”¨longæ¥å®ç°çš„ï¼ŒåŸºæœ¬ç”¨æ³•å¦‚ä¸‹ï¼š

```java
private static void testNewAtomic() {
    LongAdder longAdder = new LongAdder();
    longAdder.increment();
    longAdder.add(666);
    System.out.println(longAdder.sum());

    LongAccumulator longAccumulator = new LongAccumulator((left, right)->left + right * 2, 666);
    longAccumulator.accumulate(1);
    longAccumulator.accumulate(3);
    longAccumulator.accumulate(-4);
    System.out.println(longAccumulator.get());
}
```

## é—®é¢˜

å…³äºåŸå­ç±»çš„é—®é¢˜ï¼Œç¬”è€…æ•´ç†äº†å¤§æ¦‚æœ‰ä»¥ä¸‹è¿™äº›ï¼š

ï¼ˆ1ï¼‰Unsafeæ˜¯ä»€ä¹ˆï¼Ÿ

ï¼ˆ3ï¼‰Unsafeä¸ºä»€ä¹ˆæ˜¯ä¸å®‰å…¨çš„ï¼Ÿ

ï¼ˆ4ï¼‰Unsafeçš„å®ä¾‹æ€ä¹ˆè·å–ï¼Ÿ

ï¼ˆ5ï¼‰Unsafeçš„CASæ“ä½œï¼Ÿ

ï¼ˆ6ï¼‰Unsafeçš„é˜»å¡/å”¤é†’æ“ä½œï¼Ÿ

ï¼ˆ7ï¼‰Unsafeå®ä¾‹åŒ–ä¸€ä¸ªç±»ï¼Ÿ

ï¼ˆ8ï¼‰å®ä¾‹åŒ–ç±»çš„å…­ç§æ–¹å¼ï¼Ÿ

ï¼ˆ9ï¼‰åŸå­æ“ä½œæ˜¯ä»€ä¹ˆï¼Ÿ

ï¼ˆ10ï¼‰åŸå­æ“ä½œä¸æ•°æ®åº“ACIDä¸­Açš„å…³ç³»ï¼Ÿ

ï¼ˆ11ï¼‰AtomicIntegeræ€ä¹ˆå®ç°åŸå­æ“ä½œçš„ï¼Ÿ

ï¼ˆ12ï¼‰AtomicIntegerä¸»è¦è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ

ï¼ˆ13ï¼‰AtomicIntegeræœ‰å“ªäº›ç¼ºç‚¹ï¼Ÿ

ï¼ˆ14ï¼‰ABAæ˜¯ä»€ä¹ˆï¼Ÿ

ï¼ˆ15ï¼‰ABAçš„å±å®³ï¼Ÿ

ï¼ˆ16ï¼‰ABAçš„è§£å†³æ–¹æ³•ï¼Ÿ

ï¼ˆ17ï¼‰AtomicStampedReferenceæ˜¯æ€ä¹ˆè§£å†³ABAçš„ï¼Ÿ

ï¼ˆ18ï¼‰å®é™…å·¥ä½œä¸­é‡åˆ°è¿‡ABAé—®é¢˜å—ï¼Ÿ

ï¼ˆ19ï¼‰CPUçš„ç¼“å­˜æ¶æ„æ˜¯æ€æ ·çš„ï¼Ÿ

ï¼ˆ20ï¼‰CPUçš„ç¼“å­˜è¡Œæ˜¯ä»€ä¹ˆï¼Ÿ

ï¼ˆ21ï¼‰å†…å­˜å±éšœåˆæ˜¯ä»€ä¹ˆï¼Ÿ

ï¼ˆ22ï¼‰ä¼ªå…±äº«æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´çš„ï¼Ÿ

ï¼ˆ23ï¼‰æ€ä¹ˆé¿å…ä¼ªå…±äº«ï¼Ÿ

ï¼ˆ24ï¼‰æ¶ˆé™¤ä¼ªå…±äº«åœ¨javaä¸­çš„åº”ç”¨ï¼Ÿ

ï¼ˆ25ï¼‰LongAdderçš„å®ç°æ–¹å¼ï¼Ÿ

ï¼ˆ26ï¼‰LongAdderæ˜¯æ€ä¹ˆæ¶ˆé™¤ä¼ªå…±äº«çš„ï¼Ÿ

ï¼ˆ27ï¼‰LongAdderä¸AtomicLongçš„æ€§èƒ½å¯¹æ¯”ï¼Ÿ

ï¼ˆ28ï¼‰LongAdderä¸­çš„cellsæ•°ç»„æ˜¯æ— é™æ‰©å®¹çš„å—ï¼Ÿ

å…³äºåŸå­ç±»çš„é—®é¢˜å·®ä¸å¤šå°±è¿™ä¹ˆå¤šï¼Œéƒ½èƒ½å›ç­”ä¸Šæ¥å—ï¼Ÿç‚¹å‡»ä¸‹é¢çš„é“¾æ¥å¯ä»¥ç›´æ¥åˆ°ç›¸åº”çš„ç« èŠ‚æŸ¥çœ‹ï¼š

[æ­»ç£• javaé­”æ³•ç±»ä¹‹Unsafeè§£æ](https://mp.weixin.qq.com/s/0s-u-MysppIaIHVrshp9fA)

[æ­»ç£• javaåŸå­ç±»ä¹‹AtomicIntegeræºç åˆ†æ](https://mp.weixin.qq.com/s/DdwSC5bYgFCWwnb0jxkspg)

[æ­»ç£• javaåŸå­ç±»ä¹‹AtomicStampedReferenceæºç åˆ†æ](https://mp.weixin.qq.com/s/7pY1jKNVB_dvadZRIzmD1Q)

[æ‚è°ˆ ä»€ä¹ˆæ˜¯ä¼ªå…±äº«ï¼ˆfalse sharingï¼‰ï¼Ÿ](https://mp.weixin.qq.com/s/rd13SOSxhLA6TT13N9ni8Q)

[æ­»ç£• javaåŸå­ç±»ä¹‹LongAdderæºç åˆ†æ](https://mp.weixin.qq.com/s/_-z1Bz2iMiK1tQnaDD4N6Q)

## å½©è›‹

åŸå­ç±»ç³»åˆ—æºç åˆ†æåˆ°æ­¤å°±ç»“æŸäº†ï¼Œè™½ç„¶åˆ†æçš„ç±»æ¯”è¾ƒå°‘ï¼Œä½†æ˜¯ç‰µæ¶‰çš„å†…å®¹éå¸¸å¤šï¼Œç‰¹åˆ«æ˜¯æ“ä½œç³»ç»Ÿåº•å±‚çš„çŸ¥è¯†ï¼Œæ¯”å¦‚CPUæŒ‡ä»¤ã€CPUç¼“å­˜æ¶æ„ã€å†…å­˜å±éšœç­‰ã€‚

ä¸‹ä¸€ç« ï¼Œæˆ‘ä»¬å°†è¿›å…¥â€œåŒæ­¥ç³»åˆ—â€ï¼ŒåŒæ­¥æœ€å¸¸è§çš„å°±æ˜¯å„ç§é”äº†ï¼Œè¿™é‡Œä¼šç€é‡åˆ†æjavaä¸­çš„å„ç§é”ã€å„ç§åŒæ­¥å™¨ä»¥åŠåˆ†å¸ƒå¼é”ç›¸å…³çš„å†…å®¹ã€‚

---

æ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·â€œå½¤å“¥è¯»æºç â€ï¼ŒæŸ¥çœ‹æ›´å¤šæºç ç³»åˆ—æ–‡ç« , ä¸å½¤å“¥ä¸€èµ·ç•…æ¸¸æºç çš„æµ·æ´‹ã€‚

![qrcode](5.%E5%8E%9F%E5%AD%90%E7%B1%BB%E7%BB%88%E7%BB%93%E7%AF%87.resource/qrcode_ss.jpg)