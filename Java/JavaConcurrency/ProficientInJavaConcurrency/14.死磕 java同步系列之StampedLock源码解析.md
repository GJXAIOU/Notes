ğŸ–•æ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·â€œå½¤å“¥è¯»æºç â€ï¼ŒæŸ¥çœ‹æ›´å¤šæºç ç³»åˆ—æ–‡ç« , ä¸å½¤å“¥ä¸€èµ·ç•…æ¸¸æºç çš„æµ·æ´‹ã€‚ 

ï¼ˆæ‰‹æœºæ¨ªå±çœ‹æºç æ›´æ–¹ä¾¿ï¼‰

---

## é—®é¢˜

ï¼ˆ1ï¼‰StampedLockæ˜¯ä»€ä¹ˆï¼Ÿ

ï¼ˆ2ï¼‰StampedLockå…·æœ‰ä»€ä¹ˆç‰¹æ€§ï¼Ÿ

ï¼ˆ3ï¼‰StampedLockæ˜¯å¦æ”¯æŒå¯é‡å…¥ï¼Ÿ

ï¼ˆ4ï¼‰StampedLockä¸ReentrantReadWriteLockçš„å¯¹æ¯”ï¼Ÿ

## ç®€ä»‹

StampedLockæ˜¯java8ä¸­æ–°å¢çš„ç±»ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ›´åŠ é«˜æ•ˆçš„è¯»å†™é”çš„å®ç°ï¼Œè€Œä¸”å®ƒä¸æ˜¯åŸºäºAQSæ¥å®ç°çš„ï¼Œå®ƒçš„å†…éƒ¨è‡ªæˆä¸€ç‰‡é€»è¾‘ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ¥å­¦ä¹ å§ã€‚

StampedLockå…·æœ‰ä¸‰ç§æ¨¡å¼ï¼šå†™æ¨¡å¼ã€è¯»æ¨¡å¼ã€ä¹è§‚è¯»æ¨¡å¼ã€‚

ReentrantReadWriteLockä¸­çš„è¯»å’Œå†™éƒ½æ˜¯ä¸€ç§æ‚²è§‚é”çš„ä½“ç°ï¼ŒStampedLockåŠ å…¥äº†ä¸€ç§æ–°çš„æ¨¡å¼â€”â€”ä¹è§‚è¯»ï¼Œå®ƒæ˜¯æŒ‡å½“ä¹è§‚è¯»æ—¶å‡å®šæ²¡æœ‰å…¶å®ƒçº¿ç¨‹ä¿®æ”¹æ•°æ®ï¼Œè¯»å–å®Œæˆåå†æ£€æŸ¥ä¸‹ç‰ˆæœ¬å·æœ‰æ²¡æœ‰å˜åŒ–ï¼Œæ²¡æœ‰å˜åŒ–å°±è¯»å–æˆåŠŸäº†ï¼Œè¿™ç§æ¨¡å¼æ›´é€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ã€‚

## ä½¿ç”¨æ–¹æ³•

è®©æˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„ä¾‹å­äº†è§£ä¸€ä¸‹StampedLockä¸‰ç§æ¨¡å¼çš„ä½¿ç”¨æ–¹æ³•ï¼š

```java
class Point {
    private double x, y;
    private final StampedLock sl = new StampedLock();

    void move(double deltaX, double deltaY) {
        // è·å–å†™é”ï¼Œè¿”å›ä¸€ä¸ªç‰ˆæœ¬å·ï¼ˆæˆ³ï¼‰
        long stamp = sl.writeLock();
        try {
            x += deltaX;
            y += deltaY;
        } finally {
            // é‡Šæ”¾å†™é”ï¼Œéœ€è¦ä¼ å…¥ä¸Šé¢è·å–çš„ç‰ˆæœ¬å·
            sl.unlockWrite(stamp);
        }
    }

    double distanceFromOrigin() {
        // ä¹è§‚è¯»
        long stamp = sl.tryOptimisticRead();
        double currentX = x, currentY = y;
        // éªŒè¯ç‰ˆæœ¬å·æ˜¯å¦æœ‰å˜åŒ–
        if (!sl.validate(stamp)) {
            // ç‰ˆæœ¬å·å˜äº†ï¼Œä¹è§‚è¯»è½¬æ‚²è§‚è¯»
            stamp = sl.readLock();
            try {
                // é‡æ–°è¯»å–xã€yçš„å€¼
                currentX = x;
                currentY = y;
            } finally {
                // é‡Šæ”¾è¯»é”ï¼Œéœ€è¦ä¼ å…¥ä¸Šé¢è·å–çš„ç‰ˆæœ¬å·
                sl.unlockRead(stamp);
            }
        }
        return Math.sqrt(currentX * currentX + currentY * currentY);
    }

    void moveIfAtOrigin(double newX, double newY) {
        // è·å–æ‚²è§‚è¯»é”
        long stamp = sl.readLock();
        try {
            while (x == 0.0 && y == 0.0) {
                // è½¬ä¸ºå†™é”
                long ws = sl.tryConvertToWriteLock(stamp);
                // è½¬æ¢æˆåŠŸ
                if (ws != 0L) {
                    stamp = ws;
                    x = newX;
                    y = newY;
                    break;
                }
                else {
                    // è½¬æ¢å¤±è´¥
                    sl.unlockRead(stamp);
                    // è·å–å†™é”
                    stamp = sl.writeLock();
                }
            }
        } finally {
            // é‡Šæ”¾é”
            sl.unlock(stamp);
        }
    }
}
```

ä»ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬å¯ä»¥ä¸ReentrantReadWriteLockè¿›è¡Œå¯¹æ¯”ï¼š

ï¼ˆ1ï¼‰å†™é”çš„ä½¿ç”¨æ–¹å¼åŸºæœ¬ä¸€å¯¹å¾…ï¼›

ï¼ˆ2ï¼‰è¯»é”ï¼ˆæ‚²è§‚ï¼‰çš„ä½¿ç”¨æ–¹å¼å¯ä»¥è¿›è¡Œå‡çº§ï¼Œé€šè¿‡tryConvertToWriteLock()æ–¹å¼å¯ä»¥å‡çº§ä¸ºå†™é”ï¼›

ï¼ˆ3ï¼‰ä¹è§‚è¯»é”æ˜¯ä¸€ç§å…¨æ–°çš„æ–¹å¼ï¼Œå®ƒå‡å®šæ•°æ®æ²¡æœ‰æ”¹å˜ï¼Œä¹è§‚è¯»ä¹‹åå¤„ç†å®Œä¸šåŠ¡é€»è¾‘å†åˆ¤æ–­ç‰ˆæœ¬å·æ˜¯å¦æœ‰æ”¹å˜ï¼Œå¦‚æœæ²¡æ”¹å˜åˆ™ä¹è§‚è¯»æˆåŠŸï¼Œå¦‚æœæœ‰æ”¹å˜åˆ™è½¬åŒ–ä¸ºæ‚²è§‚è¯»é”é‡è¯•ï¼›

ä¸‹é¢æˆ‘ä»¬ä¸€èµ·æ¥å­¦ä¹ å®ƒçš„æºç æ˜¯æ€ä¹ˆå®ç°çš„ã€‚

## æºç åˆ†æ

### ä¸»è¦å†…éƒ¨ç±»

```java
static final class WNode {
    // å‰ä¸€ä¸ªèŠ‚ç‚¹
    volatile WNode prev;
    // åä¸€ä¸ªèŠ‚ç‚¹
    volatile WNode next;
    // è¯»çº¿ç¨‹æ‰€ç”¨çš„é“¾è¡¨ï¼ˆå®é™…æ˜¯ä¸€ä¸ªæ ˆç»“æœï¼‰
    volatile WNode cowait;    // list of linked readers
    // é˜»å¡çš„çº¿ç¨‹
    volatile Thread thread;   // non-null while possibly parked
    // çŠ¶æ€
    volatile int status;      // 0, WAITING, or CANCELLED
    // è¯»æ¨¡å¼è¿˜æ˜¯å†™æ¨¡å¼
    final int mode;           // RMODE or WMODE
    WNode(int m, WNode p) { mode = m; prev = p; }
}
```

é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹ï¼Œç±»ä¼¼äºAQSé˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°å®ƒç»„æˆäº†ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå†…éƒ¨ç»´æŠ¤ç€é˜»å¡çš„çº¿ç¨‹ã€‚

### ä¸»è¦å±æ€§

```java
// ä¸€å †å¸¸é‡
// è¯»çº¿ç¨‹çš„ä¸ªæ•°å æœ‰ä½7ä½
private static final int LG_READERS = 7;
// è¯»çº¿ç¨‹ä¸ªæ•°æ¯æ¬¡å¢åŠ çš„å•ä½
private static final long RUNIT = 1L;
// å†™çº¿ç¨‹ä¸ªæ•°æ‰€åœ¨çš„ä½ç½®
private static final long WBIT  = 1L << LG_READERS;  // 128 = 1000 0000
// è¯»çº¿ç¨‹ä¸ªæ•°æ‰€åœ¨çš„ä½ç½®
private static final long RBITS = WBIT - 1L;  // 127 = 111 1111
// æœ€å¤§è¯»çº¿ç¨‹ä¸ªæ•°
private static final long RFULL = RBITS - 1L;  // 126 = 111 1110
// è¯»çº¿ç¨‹ä¸ªæ•°å’Œå†™çº¿ç¨‹ä¸ªæ•°çš„æ©ç 
private static final long ABITS = RBITS | WBIT;  // 255 = 1111 1111
// è¯»çº¿ç¨‹ä¸ªæ•°çš„åæ•°ï¼Œé«˜25ä½å…¨éƒ¨ä¸º1
private static final long SBITS = ~RBITS;  // -128 = 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1000 0000

// stateçš„åˆå§‹å€¼
private static final long ORIGIN = WBIT << 1;  // 256 = 1 0000 0000
// é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹
private transient volatile WNode whead;
// é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹
private transient volatile WNode wtail;
// å­˜å‚¨ç€å½“å‰çš„ç‰ˆæœ¬å·ï¼Œç±»ä¼¼äºAQSçš„çŠ¶æ€å˜é‡state
private transient volatile long state;
```

é€šè¿‡å±æ€§å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ˜¯ä¸€ä¸ªç±»ä¼¼äºAQSçš„ç»“æ„ï¼Œå†…éƒ¨åŒæ ·ç»´æŠ¤ç€ä¸€ä¸ªçŠ¶æ€å˜é‡stateå’Œä¸€ä¸ªCLHé˜Ÿåˆ—ã€‚

### æ„é€ æ–¹æ³•

```java
public StampedLock() {
    state = ORIGIN;
}
```

stateçš„åˆå§‹å€¼ä¸ºORIGINï¼ˆ256ï¼‰ï¼Œå®ƒçš„äºŒè¿›åˆ¶æ˜¯ 1 0000 0000ï¼Œä¹Ÿå°±æ˜¯åˆå§‹ç‰ˆæœ¬å·ã€‚

### writeLock()æ–¹æ³•

è·å–å†™é”ã€‚

```java
public long writeLock() {
    long s, next;
    // ABITS = 255 = 1111 1111
    // WBITS = 128 = 1000 0000
    // stateä¸ABITSå¦‚æœç­‰äº0ï¼Œå°è¯•åŸå­æ›´æ–°stateçš„å€¼åŠ WBITS
    // å¦‚æœæˆåŠŸåˆ™è¿”å›æ›´æ–°çš„å€¼ï¼Œå¦‚æœå¤±è´¥è°ƒç”¨acquireWrite()æ–¹æ³•
    return ((((s = state) & ABITS) == 0L &&
             U.compareAndSwapLong(this, STATE, s, next = s + WBIT)) ?
            next : acquireWrite(false, 0L));
}
```

æˆ‘ä»¬ä»¥stateç­‰äºåˆå§‹å€¼ä¸ºä¾‹ï¼Œåˆ™state & ABITSçš„ç»“æœä¸ºï¼š

![StampedLock](https://gitee.com/alan-tang-tt/yuan/raw/master/æ­»ç£•%20javaåŒæ­¥ç³»åˆ—/resource/StampedLock1.png)

æ­¤æ—¶stateä¸ºåˆå§‹çŠ¶æ€ï¼Œä¸ABITSä¸è¿ç®—åçš„å€¼ä¸º0ï¼Œæ‰€ä»¥æ‰§è¡Œåé¢çš„CASæ–¹æ³•ï¼Œs + WBITSçš„å€¼ä¸º384 = 1 1000 0000ã€‚

åˆ°è¿™é‡Œæˆ‘ä»¬å¤§èƒ†çŒœæµ‹ï¼šstateçš„é«˜24ä½å­˜å‚¨çš„æ˜¯ç‰ˆæœ¬å·ï¼Œä½8ä½å­˜å‚¨çš„æ˜¯æ˜¯å¦æœ‰åŠ é”ï¼Œç¬¬8ä½å­˜å‚¨çš„æ˜¯å†™é”ï¼Œä½7ä½å­˜å‚¨çš„æ˜¯è¯»é”è¢«è·å–çš„æ¬¡æ•°ï¼Œè€Œä¸”å¦‚æœåªæœ‰ç¬¬8ä½å­˜å‚¨å†™é”çš„è¯ï¼Œé‚£ä¹ˆå†™é”åªèƒ½è¢«è·å–ä¸€æ¬¡ï¼Œä¹Ÿå°±ä¸å¯èƒ½é‡å…¥äº†ã€‚

åˆ°åº•æˆ‘ä»¬çŒœæµ‹çš„å¯¹ä¸å¯¹å‘¢ï¼Œèµ°ç€ç§^^

æˆ‘ä»¬æ¥ç€æ¥åˆ†æacquireWrite()æ–¹æ³•ï¼š

ï¼ˆæ‰‹æœºæ¨ªå±çœ‹æºç æ›´æ–¹ä¾¿ï¼‰

```java
private long acquireWrite(boolean interruptible, long deadline) {
    // nodeä¸ºæ–°å¢èŠ‚ç‚¹ï¼Œpä¸ºå°¾èŠ‚ç‚¹ï¼ˆå³å°†æˆä¸ºnodeçš„å‰ç½®èŠ‚ç‚¹ï¼‰
    WNode node = null, p;
    
    // ç¬¬ä¸€æ¬¡è‡ªæ—‹â€”â€”å…¥é˜Ÿ
    for (int spins = -1;;) { // spin while enqueuing
        long m, s, ns;
        // å†æ¬¡å°è¯•è·å–å†™é”
        if ((m = (s = state) & ABITS) == 0L) {
            if (U.compareAndSwapLong(this, STATE, s, ns = s + WBIT))
                return ns;
        }
        else if (spins < 0)
            // å¦‚æœè‡ªæ—‹æ¬¡æ•°å°äº0ï¼Œåˆ™è®¡ç®—è‡ªæ—‹çš„æ¬¡æ•°
            // å¦‚æœå½“å‰æœ‰å†™é”ç‹¬å ä¸”é˜Ÿåˆ—æ— å…ƒç´ ï¼Œè¯´æ˜å¿«è½®åˆ°è‡ªå·±äº†
            // å°±è‡ªæ—‹å°±è¡Œäº†ï¼Œå¦‚æœè‡ªæ—‹å®Œäº†è¿˜æ²¡è½®åˆ°è‡ªå·±æ‰å…¥é˜Ÿ
            // åˆ™è‡ªæ—‹æ¬¡æ•°ä¸ºSPINSå¸¸é‡
            // å¦åˆ™è‡ªæ—‹æ¬¡æ•°ä¸º0
            spins = (m == WBIT && wtail == whead) ? SPINS : 0;
        else if (spins > 0) {
            // å½“è‡ªæ—‹æ¬¡æ•°å¤§äº0æ—¶ï¼Œå½“å‰è¿™æ¬¡è‡ªæ—‹éšæœºå‡ä¸€æ¬¡è‡ªæ—‹æ¬¡æ•°
            if (LockSupport.nextSecondarySeed() >= 0)
                --spins;
        }
        else if ((p = wtail) == null) {
            // å¦‚æœé˜Ÿåˆ—æœªåˆå§‹åŒ–ï¼Œæ–°å»ºä¸€ä¸ªç©ºèŠ‚ç‚¹å¹¶åˆå§‹åŒ–å¤´èŠ‚ç‚¹å’Œå°¾èŠ‚ç‚¹
            WNode hd = new WNode(WMODE, null);
            if (U.compareAndSwapObject(this, WHEAD, null, hd))
                wtail = hd;
        }
        else if (node == null)
            // å¦‚æœæ–°å¢èŠ‚ç‚¹è¿˜æœªåˆå§‹åŒ–ï¼Œåˆ™æ–°å»ºä¹‹ï¼Œå¹¶èµ‹å€¼å…¶å‰ç½®èŠ‚ç‚¹ä¸ºå°¾èŠ‚ç‚¹
            node = new WNode(WMODE, p);
        else if (node.prev != p)
            // å¦‚æœå°¾èŠ‚ç‚¹æœ‰å˜åŒ–ï¼Œåˆ™æ›´æ–°æ–°å¢èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹ä¸ºæ–°çš„å°¾èŠ‚ç‚¹
            node.prev = p;
        else if (U.compareAndSwapObject(this, WTAIL, p, node)) {
            // å°è¯•æ›´æ–°æ–°å¢èŠ‚ç‚¹ä¸ºæ–°çš„å°¾èŠ‚ç‚¹æˆåŠŸï¼Œåˆ™é€€å‡ºå¾ªç¯
            p.next = node;
            break;
        }
    }

    // ç¬¬äºŒæ¬¡è‡ªæ—‹â€”â€”é˜»å¡å¹¶ç­‰å¾…å”¤é†’
    for (int spins = -1;;) {
        // hä¸ºå¤´èŠ‚ç‚¹ï¼Œnpä¸ºæ–°å¢èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹ï¼Œppä¸ºå‰å‰ç½®èŠ‚ç‚¹ï¼Œpsä¸ºå‰ç½®èŠ‚ç‚¹çš„çŠ¶æ€
        WNode h, np, pp; int ps;
        // å¦‚æœå¤´èŠ‚ç‚¹ç­‰äºå‰ç½®èŠ‚ç‚¹ï¼Œè¯´æ˜å¿«è½®åˆ°è‡ªå·±äº†
        if ((h = whead) == p) {
            if (spins < 0)
                // åˆå§‹åŒ–è‡ªæ—‹æ¬¡æ•°
                spins = HEAD_SPINS;
            else if (spins < MAX_HEAD_SPINS)
                // å¢åŠ è‡ªæ—‹æ¬¡æ•°
                spins <<= 1;
            
            // ç¬¬ä¸‰æ¬¡è‡ªæ—‹ï¼Œä¸æ–­å°è¯•è·å–å†™é”
            for (int k = spins;;) { // spin at head
                long s, ns;
                if (((s = state) & ABITS) == 0L) {
                    if (U.compareAndSwapLong(this, STATE, s,
                                             ns = s + WBIT)) {
                        // å°è¯•è·å–å†™é”æˆåŠŸï¼Œå°†nodeè®¾ç½®ä¸ºæ–°å¤´èŠ‚ç‚¹å¹¶æ¸…é™¤å…¶å‰ç½®èŠ‚ç‚¹(gc)
                        whead = node;
                        node.prev = null;
                        return ns;
                    }
                }
                // éšæœºç«‹å‡è‡ªæ—‹æ¬¡æ•°ï¼Œå½“è‡ªæ—‹æ¬¡æ•°å‡ä¸º0æ—¶è·³å‡ºå¾ªç¯å†é‡è¯•
                else if (LockSupport.nextSecondarySeed() >= 0 &&
                         --k <= 0)
                    break;
            }
        }
        else if (h != null) { // help release stale waiters
            // è¿™æ®µä»£ç å¾ˆéš¾è¿›æ¥ï¼Œæ˜¯ç”¨äºååŠ©å”¤é†’è¯»èŠ‚ç‚¹çš„
            // æˆ‘æ˜¯è¿™ä¹ˆè°ƒè¯•è¿›æ¥çš„ï¼š
            // èµ·ä¸‰ä¸ªå†™çº¿ç¨‹ï¼Œä¸¤ä¸ªè¯»çº¿ç¨‹
            // å†™çº¿ç¨‹1è·å–é”ä¸è¦é‡Šæ”¾
            // è¯»çº¿ç¨‹1è·å–é”ï¼Œè¯»çº¿ç¨‹2è·å–é”ï¼ˆä¼šé˜»å¡ï¼‰
            // å†™çº¿ç¨‹2è·å–é”ï¼ˆä¼šé˜»å¡ï¼‰
            // å†™çº¿ç¨‹1é‡Šæ”¾é”ï¼Œæ­¤æ—¶ä¼šå”¤é†’è¯»çº¿ç¨‹1
            // åœ¨è¯»çº¿ç¨‹1é‡Œé¢å…ˆä¸è¦å”¤é†’è¯»çº¿ç¨‹2
            // å†™çº¿ç¨‹3è·å–é”ï¼Œæ­¤æ—¶å°±ä¼šèµ°åˆ°è¿™é‡Œæ¥äº†
            WNode c; Thread w;
            // å¦‚æœå¤´èŠ‚ç‚¹çš„cowaité“¾è¡¨ï¼ˆæ ˆï¼‰ä¸ä¸ºç©ºï¼Œå”¤é†’é‡Œé¢çš„æ‰€æœ‰èŠ‚ç‚¹
            while ((c = h.cowait) != null) {
                if (U.compareAndSwapObject(h, WCOWAIT, c, c.cowait) &&
                    (w = c.thread) != null)
                    U.unpark(w);
            }
        }
        
        // å¦‚æœå¤´èŠ‚ç‚¹æ²¡æœ‰å˜åŒ–
        if (whead == h) {
            // å¦‚æœå°¾èŠ‚ç‚¹æœ‰å˜åŒ–ï¼Œåˆ™æ›´æ–°
            if ((np = node.prev) != p) {
                if (np != null)
                    (p = np).next = node;   // stale
            }
            else if ((ps = p.status) == 0)
                // å¦‚æœå°¾èŠ‚ç‚¹çŠ¶æ€ä¸º0ï¼Œåˆ™æ›´æ–°æˆWAITING
                U.compareAndSwapInt(p, WSTATUS, 0, WAITING);
            else if (ps == CANCELLED) {
                // å¦‚æœå°¾èŠ‚ç‚¹çŠ¶æ€ä¸ºå–æ¶ˆï¼Œåˆ™æŠŠå®ƒä»é“¾è¡¨ä¸­åˆ é™¤
                if ((pp = p.prev) != null) {
                    node.prev = pp;
                    pp.next = node;
                }
            }
            else {
                // æœ‰è¶…æ—¶æ—¶é—´çš„å¤„ç†
                long time; // 0 argument to park means no timeout
                if (deadline == 0L)
                    time = 0L;
                else if ((time = deadline - System.nanoTime()) <= 0L)
                    // å·²è¶…æ—¶ï¼Œå‰”é™¤å½“å‰èŠ‚ç‚¹
                    return cancelWaiter(node, node, false);
                // å½“å‰çº¿ç¨‹
                Thread wt = Thread.currentThread();
                U.putObject(wt, PARKBLOCKER, this);
                // æŠŠnodeçš„çº¿ç¨‹æŒ‡å‘å½“å‰çº¿ç¨‹
                node.thread = wt;
                if (p.status < 0 && (p != h || (state & ABITS) != 0L) &&
                    whead == h && node.prev == p)
                    // é˜»å¡å½“å‰çº¿ç¨‹
                    U.park(false, time);  // ç­‰åŒäºLockSupport.park()
                    
                // å½“å‰èŠ‚ç‚¹è¢«å”¤é†’åï¼Œæ¸…é™¤çº¿ç¨‹
                node.thread = null;
                U.putObject(wt, PARKBLOCKER, null);
                // å¦‚æœä¸­æ–­äº†ï¼Œå–æ¶ˆå½“å‰èŠ‚ç‚¹
                if (interruptible && Thread.interrupted())
                    return cancelWaiter(node, node, true);
            }
        }
    }
}
```

è¿™é‡Œå¯¹acquireWrite()æ–¹æ³•åšä¸€ä¸ªæ€»ç»“ï¼Œè¿™ä¸ªæ–¹æ³•é‡Œé¢æœ‰ä¸‰æ®µè‡ªæ—‹é€»è¾‘ï¼š

ç¬¬ä¸€æ®µè‡ªæ—‹â€”â€”å…¥é˜Ÿï¼š

ï¼ˆ1ï¼‰å¦‚æœå¤´èŠ‚ç‚¹ç­‰äºå°¾èŠ‚ç‚¹ï¼Œè¯´æ˜æ²¡æœ‰å…¶å®ƒçº¿ç¨‹æ’é˜Ÿï¼Œé‚£å°±å¤šè‡ªæ—‹ä¸€ä¼šï¼Œçœ‹èƒ½ä¸èƒ½å°è¯•è·å–åˆ°å†™é”ï¼›

ï¼ˆ2ï¼‰å¦åˆ™ï¼Œè‡ªæ—‹æ¬¡æ•°ä¸º0ï¼Œç›´æ¥è®©å…¶å…¥é˜Ÿï¼›

ç¬¬äºŒæ®µè‡ªæ—‹â€”â€”é˜»å¡å¹¶ç­‰å¾…è¢«å”¤é†’ + ç¬¬ä¸‰æ®µè‡ªæ—‹â€”â€”ä¸æ–­å°è¯•è·å–å†™é”ï¼š

ï¼ˆ1ï¼‰ç¬¬ä¸‰æ®µè‡ªæ—‹åœ¨ç¬¬äºŒæ®µè‡ªæ—‹å†…éƒ¨ï¼›

ï¼ˆ2ï¼‰å¦‚æœå¤´èŠ‚ç‚¹ç­‰äºå‰ç½®èŠ‚ç‚¹ï¼Œé‚£å°±è¿›å…¥ç¬¬ä¸‰æ®µè‡ªæ—‹ï¼Œä¸æ–­å°è¯•è·å–å†™é”ï¼›

ï¼ˆ3ï¼‰å¦åˆ™ï¼Œå°è¯•å”¤é†’å¤´èŠ‚ç‚¹ä¸­ç­‰å¾…ç€çš„è¯»çº¿ç¨‹ï¼›

ï¼ˆ4ï¼‰æœ€åï¼Œå¦‚æœå½“å‰çº¿ç¨‹ä¸€ç›´éƒ½æ²¡æœ‰è·å–åˆ°å†™é”ï¼Œå°±é˜»å¡å½“å‰çº¿ç¨‹å¹¶ç­‰å¾…è¢«å”¤é†’ï¼›

è¿™ä¹ˆä¸€å¤§æ®µé€»è¾‘çœ‹ç€æ¯”è¾ƒé—¹å¿ƒï¼Œå…¶å®çœŸæ­£åˆ†è§£ä¸‹æ¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæ— éå°±æ˜¯è‡ªæ—‹ï¼ŒæŠŠå¾ˆå¤šçŠ¶æ€çš„å¤„ç†éƒ½ç³…åˆåˆ°ä¸€ä¸ªforå¾ªç¯é‡Œé¢å¤„ç†äº†ã€‚

### unlockWrite()æ–¹æ³•

é‡Šæ”¾å†™é”ã€‚

```java
public void unlockWrite(long stamp) {
    WNode h;
    // æ£€æŸ¥ç‰ˆæœ¬å·å¯¹ä¸å¯¹
    if (state != stamp || (stamp & WBIT) == 0L)
        throw new IllegalMonitorStateException();
    // è¿™è¡Œä»£ç å®é™…æœ‰ä¸¤ä¸ªä½œç”¨ï¼š
    // 1. æ›´æ–°ç‰ˆæœ¬å·åŠ 1
    // 2. é‡Šæ”¾å†™é”
    // stamp + WBITå®é™…ä¼šæŠŠstateçš„ç¬¬8ä½ç½®ä¸º0ï¼Œä¹Ÿå°±ç›¸å½“äºé‡Šæ”¾äº†å†™é”
    // åŒæ—¶ä¼šè¿›1ï¼Œä¹Ÿå°±æ˜¯é«˜24ä½æ•´ä½“åŠ 1äº†
    state = (stamp += WBIT) == 0L ? ORIGIN : stamp;
    // å¦‚æœå¤´èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œå¹¶ä¸”çŠ¶æ€ä¸ä¸º0ï¼Œè°ƒç”¨releaseæ–¹æ³•å”¤é†’å®ƒçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
    if ((h = whead) != null && h.status != 0)
        release(h);
}
private void release(WNode h) {
    if (h != null) {
        WNode q; Thread w;
        // å°†å…¶çŠ¶æ€æ”¹ä¸º0
        U.compareAndSwapInt(h, WSTATUS, WAITING, 0);
        // å¦‚æœå¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©ºæˆ–è€…å…¶çŠ¶æ€ä¸ºå·²å–æ¶ˆ
        if ((q = h.next) == null || q.status == CANCELLED) {
            // ä»å°¾èŠ‚ç‚¹å‘å‰éå†æ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„èŠ‚ç‚¹
            for (WNode t = wtail; t != null && t != h; t = t.prev)
                if (t.status <= 0)
                    q = t;
        }
        // å”¤é†’qèŠ‚ç‚¹æ‰€åœ¨çš„çº¿ç¨‹
        if (q != null && (w = q.thread) != null)
            U.unpark(w);
    }
}
```

å†™é”çš„é‡Šæ”¾è¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼š

ï¼ˆ1ï¼‰æ›´æ”¹stateçš„å€¼ï¼Œé‡Šæ”¾å†™é”ï¼›

ï¼ˆ2ï¼‰ç‰ˆæœ¬å·åŠ 1ï¼›

ï¼ˆ3ï¼‰å”¤é†’ä¸‹ä¸€ä¸ªç­‰å¾…ç€çš„èŠ‚ç‚¹ï¼›

### readLock()æ–¹æ³•

è·å–è¯»é”ã€‚

```java
public long readLock() {
    long s = state, next;  // bypass acquireRead on common uncontended case
    // æ²¡æœ‰å†™é”å ç”¨ï¼Œå¹¶ä¸”è¯»é”è¢«è·å–çš„æ¬¡æ•°æœªè¾¾åˆ°æœ€å¤§å€¼
    // å°è¯•åŸå­æ›´æ–°è¯»é”è¢«è·å–çš„æ¬¡æ•°åŠ 1
    // å¦‚æœæˆåŠŸç›´æ¥è¿”å›ï¼Œå¦‚æœå¤±è´¥è°ƒç”¨acquireRead()æ–¹æ³•
    return ((whead == wtail && (s & ABITS) < RFULL &&
             U.compareAndSwapLong(this, STATE, s, next = s + RUNIT)) ?
            next : acquireRead(false, 0L));
}
```

è·å–è¯»é”çš„æ—¶å€™å…ˆçœ‹çœ‹ç°åœ¨æœ‰æ²¡æœ‰å…¶å®ƒçº¿ç¨‹å ç”¨ç€å†™é”ï¼Œå¦‚æœæ²¡æœ‰çš„è¯å†æ£€æµ‹è¯»é”è¢«è·å–çš„æ¬¡æ•°æœ‰æ²¡æœ‰è¾¾åˆ°æœ€å¤§ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ç›´æ¥å°è¯•è·å–ä¸€æ¬¡è¯»é”ï¼Œå¦‚æœæˆåŠŸäº†ç›´æ¥è¿”å›ç‰ˆæœ¬å·ï¼Œå¦‚æœæ²¡æˆåŠŸå°±è°ƒç”¨acquireRead()æ’é˜Ÿã€‚

ä¸‹é¢æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹acquireRead()æ–¹æ³•ï¼Œè¿™åˆæ˜¯ä¸€ä¸ªå·¨é•¿æ— æ¯”çš„æ–¹æ³•ï¼Œè¯·**ä¿æŒè€å¿ƒ**ï¼Œæˆ‘ä»¬ä¸€æ­¥æ­¥æ¥åˆ†è§£ï¼š

ï¼ˆæ‰‹æœºæ¨ªå±çœ‹æºç æ›´æ–¹ä¾¿ï¼‰

```java
private long acquireRead(boolean interruptible, long deadline) {
    // nodeä¸ºæ–°å¢èŠ‚ç‚¹ï¼Œpä¸ºå°¾èŠ‚ç‚¹
    WNode node = null, p;
    // ç¬¬ä¸€æ®µè‡ªæ—‹â€”â€”å…¥é˜Ÿ
    for (int spins = -1;;) {
        // å¤´èŠ‚ç‚¹
        WNode h;
        // å¦‚æœå¤´èŠ‚ç‚¹ç­‰äºå°¾èŠ‚ç‚¹
        // è¯´æ˜æ²¡æœ‰æ’é˜Ÿçš„çº¿ç¨‹äº†ï¼Œå¿«è½®åˆ°è‡ªå·±äº†ï¼Œç›´æ¥è‡ªæ—‹ä¸æ–­å°è¯•è·å–è¯»é”
        if ((h = whead) == (p = wtail)) {
            // ç¬¬äºŒæ®µè‡ªæ—‹â€”â€”ä¸æ–­å°è¯•è·å–è¯»é”
            for (long m, s, ns;;) {
                // å°è¯•è·å–è¯»é”ï¼Œå¦‚æœæˆåŠŸäº†ç›´æ¥è¿”å›ç‰ˆæœ¬å·
                if ((m = (s = state) & ABITS) < RFULL ?
                    U.compareAndSwapLong(this, STATE, s, ns = s + RUNIT) :
                    (m < WBIT && (ns = tryIncReaderOverflow(s)) != 0L))
                    // å¦‚æœè¯»çº¿ç¨‹ä¸ªæ•°è¾¾åˆ°äº†æœ€å¤§å€¼ï¼Œä¼šæº¢å‡ºï¼Œè¿”å›çš„æ˜¯0
                    return ns;
                else if (m >= WBIT) {
                    // m >= WBITè¡¨ç¤ºæœ‰å…¶å®ƒçº¿ç¨‹å…ˆä¸€æ­¥è·å–äº†å†™é”
                    if (spins > 0) {
                        // éšæœºç«‹å‡è‡ªæ—‹æ¬¡æ•°
                        if (LockSupport.nextSecondarySeed() >= 0)
                            --spins;
                    }
                    else {
                        // å¦‚æœè‡ªæ—‹æ¬¡æ•°ä¸º0äº†ï¼Œçœ‹çœ‹æ˜¯å¦è¦è·³å‡ºå¾ªç¯
                        if (spins == 0) {
                            WNode nh = whead, np = wtail;
                            if ((nh == h && np == p) || (h = nh) != (p = np))
                                break;
                        }
                        // è®¾ç½®è‡ªæ—‹æ¬¡æ•°
                        spins = SPINS;
                    }
                }
            }
        }
        // å¦‚æœå°¾èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆå§‹åŒ–å¤´èŠ‚ç‚¹å’Œå°¾èŠ‚ç‚¹
        if (p == null) { // initialize queue
            WNode hd = new WNode(WMODE, null);
            if (U.compareAndSwapObject(this, WHEAD, null, hd))
                wtail = hd;
        }
        else if (node == null)
            // å¦‚æœæ–°å¢èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆå§‹åŒ–ä¹‹
            node = new WNode(RMODE, p);
        else if (h == p || p.mode != RMODE) {
            // å¦‚æœå¤´èŠ‚ç‚¹ç­‰äºå°¾èŠ‚ç‚¹æˆ–è€…å°¾èŠ‚ç‚¹ä¸æ˜¯è¯»æ¨¡å¼
            // å½“å‰èŠ‚ç‚¹å…¥é˜Ÿ
            if (node.prev != p)
                node.prev = p;
            else if (U.compareAndSwapObject(this, WTAIL, p, node)) {
                p.next = node;
                break;
            }
        }
        else if (!U.compareAndSwapObject(p, WCOWAIT,
                                         node.cowait = p.cowait, node))
            // æ¥ç€ä¸Šä¸€ä¸ªelseifï¼Œè¿™é‡Œè‚¯å®šæ˜¯å°¾èŠ‚ç‚¹ä¸ºè¯»æ¨¡å¼äº†
            // å°†å½“å‰èŠ‚ç‚¹åŠ å…¥åˆ°å°¾èŠ‚ç‚¹çš„cowaitä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªæ ˆ
            // ä¸Šé¢çš„CASæˆåŠŸäº†æ˜¯ä¸ä¼šè¿›å…¥åˆ°è¿™é‡Œæ¥çš„
            node.cowait = null;
        else {
            // ç¬¬ä¸‰æ®µè‡ªæ—‹â€”â€”é˜»å¡å½“å‰çº¿ç¨‹å¹¶ç­‰å¾…è¢«å”¤é†’
            for (;;) {
                WNode pp, c; Thread w;
                // å¦‚æœå¤´èŠ‚ç‚¹ä¸ä¸ºç©ºä¸”å…¶cowaitä¸ä¸ºç©ºï¼ŒååŠ©å”¤é†’å…¶ä¸­ç­‰å¾…çš„è¯»çº¿ç¨‹
                if ((h = whead) != null && (c = h.cowait) != null &&
                    U.compareAndSwapObject(h, WCOWAIT, c, c.cowait) &&
                    (w = c.thread) != null) // help release
                    U.unpark(w);
                // å¦‚æœå¤´èŠ‚ç‚¹ç­‰å¾…å‰å‰ç½®èŠ‚ç‚¹æˆ–è€…ç­‰äºå‰ç½®èŠ‚ç‚¹æˆ–è€…å‰å‰ç½®èŠ‚ç‚¹ä¸ºç©º
                // è¿™åŒæ ·è¯´æ˜å¿«è½®åˆ°è‡ªå·±äº†
                if (h == (pp = p.prev) || h == p || pp == null) {
                    long m, s, ns;
                    // ç¬¬å››æ®µè‡ªæ—‹â€”â€”åˆæ˜¯ä¸æ–­å°è¯•è·å–é”
                    do {
                        if ((m = (s = state) & ABITS) < RFULL ?
                            U.compareAndSwapLong(this, STATE, s,
                                                 ns = s + RUNIT) :
                            (m < WBIT &&
                             (ns = tryIncReaderOverflow(s)) != 0L))
                            return ns;
                    } while (m < WBIT); // åªæœ‰å½“å‰æ—¶åˆ»æ²¡æœ‰å…¶å®ƒçº¿ç¨‹å æœ‰å†™é”å°±ä¸æ–­å°è¯•
                }
                // å¦‚æœå¤´èŠ‚ç‚¹æœªæ›¾æ”¹å˜ä¸”å‰å‰ç½®èŠ‚ç‚¹ä¹Ÿæœªæ›¾æ”¹
                // é˜»å¡å½“å‰çº¿ç¨‹
                if (whead == h && p.prev == pp) {
                    long time;
                    // å¦‚æœå‰å‰ç½®èŠ‚ç‚¹ä¸ºç©ºï¼Œæˆ–è€…å¤´èŠ‚ç‚¹ç­‰äºå‰ç½®èŠ‚ç‚¹ï¼Œæˆ–è€…å‰ç½®èŠ‚ç‚¹å·²å–æ¶ˆ
                    // ä»ç¬¬ä¸€ä¸ªforè‡ªæ—‹å¼€å§‹é‡è¯•
                    if (pp == null || h == p || p.status > 0) {
                        node = null; // throw away
                        break;
                    }
                    // è¶…æ—¶æ£€æµ‹
                    if (deadline == 0L)
                        time = 0L;
                    else if ((time = deadline - System.nanoTime()) <= 0L)
                        // å¦‚æœè¶…æ—¶äº†ï¼Œå–æ¶ˆå½“å‰èŠ‚ç‚¹
                        return cancelWaiter(node, p, false);
                    
                    // å½“å‰çº¿ç¨‹
                    Thread wt = Thread.currentThread();
                    U.putObject(wt, PARKBLOCKER, this);
                    // è®¾ç½®è¿›nodeä¸­
                    node.thread = wt;
                    // æ£€æµ‹ä¹‹å‰çš„æ¡ä»¶æœªæ›¾æ”¹å˜
                    if ((h != pp || (state & ABITS) == WBIT) &&
                        whead == h && p.prev == pp)
                        // é˜»å¡å½“å‰çº¿ç¨‹å¹¶ç­‰å¾…è¢«å”¤é†’
                        U.park(false, time);
                    
                    // å”¤é†’ä¹‹åæ¸…é™¤çº¿ç¨‹
                    node.thread = null;
                    U.putObject(wt, PARKBLOCKER, null);
                    // å¦‚æœä¸­æ–­äº†ï¼Œå–æ¶ˆå½“å‰èŠ‚ç‚¹
                    if (interruptible && Thread.interrupted())
                        return cancelWaiter(node, p, true);
                }
            }
        }
    }
    
    // åªæœ‰ç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹ä¼šèµ°åˆ°ä¸‹é¢çš„forå¾ªç¯å¤„ï¼Œå‚è€ƒä¸Šé¢ç¬¬ä¸€æ®µè‡ªæ—‹ä¸­æœ‰ä¸€ä¸ªbreakï¼Œå½“ç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹å…¥é˜Ÿçš„æ—¶å€™breakå‡ºæ¥çš„
    
    // ç¬¬äº”æ®µè‡ªæ—‹â€”â€”è·Ÿä¸Šé¢çš„é€»è¾‘å·®ä¸å¤šï¼Œåªä¸è¿‡è¿™é‡Œå•ç‹¬æä¸€ä¸ªè‡ªæ—‹é’ˆå¯¹ç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹
    for (int spins = -1;;) {
        WNode h, np, pp; int ps;
        // å¦‚æœå¤´èŠ‚ç‚¹ç­‰äºå°¾èŠ‚ç‚¹ï¼Œè¯´æ˜å¿«è½®åˆ°è‡ªå·±äº†
        // ä¸æ–­å°è¯•è·å–è¯»é”
        if ((h = whead) == p) {
            // è®¾ç½®è‡ªæ—‹æ¬¡æ•°
            if (spins < 0)
                spins = HEAD_SPINS;
            else if (spins < MAX_HEAD_SPINS)
                spins <<= 1;
                
            // ç¬¬å…­æ®µè‡ªæ—‹â€”â€”ä¸æ–­å°è¯•è·å–è¯»é”
            for (int k = spins;;) { // spin at head
                long m, s, ns;
                // ä¸æ–­å°è¯•è·å–è¯»é”
                if ((m = (s = state) & ABITS) < RFULL ?
                    U.compareAndSwapLong(this, STATE, s, ns = s + RUNIT) :
                    (m < WBIT && (ns = tryIncReaderOverflow(s)) != 0L)) {
                    // è·å–åˆ°äº†è¯»é”
                    WNode c; Thread w;
                    whead = node;
                    node.prev = null;
                    // å”¤é†’å½“å‰èŠ‚ç‚¹ä¸­æ‰€æœ‰ç­‰å¾…ç€çš„è¯»çº¿ç¨‹
                    // å› ä¸ºå½“å‰èŠ‚ç‚¹æ˜¯ç¬¬ä¸€ä¸ªè¯»èŠ‚ç‚¹ï¼Œæ‰€ä»¥å®ƒæ˜¯åœ¨é˜Ÿåˆ—ä¸­çš„ï¼Œå…¶å®ƒè¯»èŠ‚ç‚¹éƒ½æ˜¯æŒ‚è¿™ä¸ªèŠ‚ç‚¹çš„cowaitæ ˆä¸­çš„
                    while ((c = node.cowait) != null) {
                        if (U.compareAndSwapObject(node, WCOWAIT,
                                                   c, c.cowait) &&
                            (w = c.thread) != null)
                            U.unpark(w);
                    }
                    // è¿”å›ç‰ˆæœ¬å·
                    return ns;
                }
                // å¦‚æœå½“å‰æœ‰å…¶å®ƒçº¿ç¨‹å æœ‰ç€å†™é”ï¼Œå¹¶ä¸”æ²¡æœ‰è‡ªæ—‹æ¬¡æ•°äº†ï¼Œè·³å‡ºå½“å‰å¾ªç¯
                else if (m >= WBIT &&
                         LockSupport.nextSecondarySeed() >= 0 && --k <= 0)
                    break;
            }
        }
        else if (h != null) {
            // å¦‚æœå¤´èŠ‚ç‚¹ä¸ç­‰å¾…å°¾èŠ‚ç‚¹ä¸”ä¸ä¸ºç©ºä¸”å…¶ä¸ºè¯»æ¨¡å¼ï¼ŒååŠ©å”¤é†’é‡Œé¢çš„è¯»çº¿ç¨‹
            WNode c; Thread w;
            while ((c = h.cowait) != null) {
                if (U.compareAndSwapObject(h, WCOWAIT, c, c.cowait) &&
                    (w = c.thread) != null)
                    U.unpark(w);
            }
        }
        
        // å¦‚æœå¤´èŠ‚ç‚¹æœªæ›¾å˜åŒ–
        if (whead == h) {
            // æ›´æ–°å‰ç½®èŠ‚ç‚¹åŠå…¶çŠ¶æ€ç­‰
            if ((np = node.prev) != p) {
                if (np != null)
                    (p = np).next = node;   // stale
            }
            else if ((ps = p.status) == 0)
                U.compareAndSwapInt(p, WSTATUS, 0, WAITING);
            else if (ps == CANCELLED) {
                if ((pp = p.prev) != null) {
                    node.prev = pp;
                    pp.next = node;
                }
            }
            else {
                // ç¬¬ä¸€ä¸ªè¯»èŠ‚ç‚¹å³å°†è¿›å…¥é˜»å¡
                long time;
                // è¶…æ—¶è®¾ç½®
                if (deadline == 0L)
                    time = 0L;
                else if ((time = deadline - System.nanoTime()) <= 0L)
                    // å¦‚æœè¶…æ—¶äº†å–æ¶ˆå½“å‰èŠ‚ç‚¹
                    return cancelWaiter(node, node, false);
                Thread wt = Thread.currentThread();
                U.putObject(wt, PARKBLOCKER, this);
                node.thread = wt;
                if (p.status < 0 &&
                    (p != h || (state & ABITS) == WBIT) &&
                    whead == h && node.prev == p)
                    // é˜»å¡ç¬¬ä¸€ä¸ªè¯»èŠ‚ç‚¹å¹¶ç­‰å¾…è¢«å”¤é†’
                    U.park(false, time);
                node.thread = null;
                U.putObject(wt, PARKBLOCKER, null);
                if (interruptible && Thread.interrupted())
                    return cancelWaiter(node, node, true);
            }
        }
    }
}
```

è¯»é”çš„è·å–è¿‡ç¨‹æ¯”è¾ƒè‰°è¾›ï¼Œä¸€å…±æœ‰å…­æ®µè‡ªæ—‹ï¼ŒOh my godï¼Œè®©æˆ‘ä»¬æ¥å¤§è‡´åœ°åˆ†è§£ä¸€ä¸‹ï¼š

ï¼ˆ1ï¼‰è¯»èŠ‚ç‚¹è¿›æ¥éƒ½æ˜¯å…ˆåˆ¤æ–­æ˜¯å¤´èŠ‚ç‚¹å¦‚æœç­‰äºå°¾èŠ‚ç‚¹ï¼Œè¯´æ˜å¿«è½®åˆ°è‡ªå·±äº†ï¼Œå°±ä¸æ–­åœ°å°è¯•è·å–è¯»é”ï¼Œå¦‚æœæˆåŠŸäº†å°±è¿”å›ï¼›

ï¼ˆ2ï¼‰å¦‚æœå¤´èŠ‚ç‚¹ä¸ç­‰äºå°¾èŠ‚ç‚¹ï¼Œè¿™é‡Œå°±ä¼šè®©å½“å‰èŠ‚ç‚¹å…¥é˜Ÿï¼Œè¿™é‡Œå…¥é˜Ÿåˆåˆ†æˆäº†ä¸¤ç§ï¼›

ï¼ˆ3ï¼‰ä¸€ç§æ˜¯é¦–ä¸ªè¯»èŠ‚ç‚¹å…¥é˜Ÿï¼Œå®ƒæ˜¯ä¼šæ’é˜Ÿåˆ°æ•´ä¸ªé˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œç„¶åè·³å‡ºç¬¬ä¸€æ®µè‡ªæ—‹ï¼›

ï¼ˆ4ï¼‰å¦ä¸€ç§æ˜¯éç¬¬ä¸€ä¸ªè¯»èŠ‚ç‚¹å…¥é˜Ÿï¼Œå®ƒæ˜¯è¿›å…¥åˆ°é¦–ä¸ªè¯»èŠ‚ç‚¹çš„cowaitæ ˆä¸­ï¼Œæ‰€ä»¥æ›´ç¡®åˆ‡åœ°è¯´åº”è¯¥æ˜¯å…¥æ ˆï¼›

ï¼ˆ5ï¼‰ä¸ç®¡æ˜¯å…¥é˜Ÿè¿˜å…¥æ ˆåï¼Œéƒ½ä¼šå†æ¬¡æ£€æµ‹å¤´èŠ‚ç‚¹æ˜¯ä¸æ˜¯ç­‰äºå°¾èŠ‚ç‚¹äº†ï¼Œå¦‚æœç›¸ç­‰ï¼Œåˆ™ä¼šå†æ¬¡ä¸æ–­å°è¯•è·å–è¯»é”ï¼›

ï¼ˆ6ï¼‰å¦‚æœå¤´èŠ‚ç‚¹ä¸ç­‰äºå°¾èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæ‰ä¼šçœŸæ­£åœ°é˜»å¡å½“å‰çº¿ç¨‹å¹¶ç­‰å¾…è¢«å”¤é†’ï¼›

ï¼ˆ7ï¼‰ä¸Šé¢è¯´çš„é¦–ä¸ªè¯»èŠ‚ç‚¹å…¶å®æ˜¯è¿ç»­çš„è¯»çº¿ç¨‹ä¸­çš„é¦–ä¸ªï¼Œå¦‚æœæ˜¯ä¸¤ä¸ªè¯»çº¿ç¨‹ä¸­é—´å¤¹äº†ä¸€ä¸ªå†™çº¿ç¨‹ï¼Œè¿˜æ˜¯è€è€å®å®çš„æ’é˜Ÿã€‚

è‡ªæ—‹ï¼Œè‡ªæ—‹ï¼Œè‡ªæ—‹ï¼Œæ—‹è½¬çš„æœ¨é©¬ï¼Œè®©æˆ‘å¿˜äº†ä¼¤^^

### unlockRead()æ–¹æ³•

é‡Šæ”¾è¯»é”ã€‚

```java
public void unlockRead(long stamp) {
    long s, m; WNode h;
    for (;;) {
        // æ£€æŸ¥ç‰ˆæœ¬å·
        if (((s = state) & SBITS) != (stamp & SBITS) ||
            (stamp & ABITS) == 0L || (m = s & ABITS) == 0L || m == WBIT)
            throw new IllegalMonitorStateException();
        // è¯»çº¿ç¨‹ä¸ªæ•°æ­£å¸¸
        if (m < RFULL) {
            // é‡Šæ”¾ä¸€æ¬¡è¯»é”
            if (U.compareAndSwapLong(this, STATE, s, s - RUNIT)) {
                // å¦‚æœè¯»é”å…¨éƒ¨éƒ½é‡Šæ”¾äº†ï¼Œä¸”å¤´èŠ‚ç‚¹ä¸ä¸ºç©ºä¸”çŠ¶æ€ä¸ä¸º0ï¼Œå”¤é†’å®ƒçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
                if (m == RUNIT && (h = whead) != null && h.status != 0)
                    release(h);
                break;
            }
        }
        else if (tryDecReaderOverflow(s) != 0L)
            // è¯»çº¿ç¨‹ä¸ªæ•°æº¢å‡ºæ£€æµ‹
            break;
    }
}

private void release(WNode h) {
    if (h != null) {
        WNode q; Thread w;
        // å°†å…¶çŠ¶æ€æ”¹ä¸º0
        U.compareAndSwapInt(h, WSTATUS, WAITING, 0);
        // å¦‚æœå¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©ºæˆ–è€…å…¶çŠ¶æ€ä¸ºå·²å–æ¶ˆ
        if ((q = h.next) == null || q.status == CANCELLED) {
            // ä»å°¾èŠ‚ç‚¹å‘å‰éå†æ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„èŠ‚ç‚¹
            for (WNode t = wtail; t != null && t != h; t = t.prev)
                if (t.status <= 0)
                    q = t;
        }
        // å”¤é†’qèŠ‚ç‚¹æ‰€åœ¨çš„çº¿ç¨‹
        if (q != null && (w = q.thread) != null)
            U.unpark(w);
    }
}
```

è¯»é”é‡Šæ”¾çš„è¿‡ç¨‹å°±æ¯”è¾ƒç®€å•äº†ï¼Œå°†stateçš„ä½7ä½å‡1ï¼Œå½“å‡ä¸º0çš„æ—¶å€™è¯´æ˜å®Œå…¨é‡Šæ”¾äº†è¯»é”ï¼Œå°±å”¤é†’ä¸‹ä¸€ä¸ªæ’é˜Ÿçš„çº¿ç¨‹ã€‚

### tryOptimisticRead()æ–¹æ³•

ä¹è§‚è¯»ã€‚

```java
public long tryOptimisticRead() {
    long s;
    return (((s = state) & WBIT) == 0L) ? (s & SBITS) : 0L;
}
```

å¦‚æœæ²¡æœ‰å†™é”ï¼Œå°±è¿”å›stateçš„é«˜25ä½ï¼Œè¿™é‡ŒæŠŠå†™æ‰€åœ¨ä½ç½®ä¸€èµ·è¿”å›äº†ï¼Œæ˜¯ä¸ºäº†åé¢æ£€æµ‹æ•°æ®æœ‰æ²¡æœ‰è¢«å†™è¿‡ã€‚

### validate()æ–¹æ³•

æ£€æµ‹ä¹è§‚è¯»ç‰ˆæœ¬å·æ˜¯å¦å˜åŒ–ã€‚

```java
public boolean validate(long stamp) {
    // å¼ºåˆ¶åŠ å…¥å†…å­˜å±éšœï¼Œåˆ·æ–°æ•°æ®
    U.loadFence();
    return (stamp & SBITS) == (state & SBITS);
}
```

æ£€æµ‹ä¸¤è€…çš„ç‰ˆæœ¬å·æ˜¯å¦ä¸€è‡´ï¼Œä¸SBITSä¸æ“ä½œä¿è¯ä¸å—è¯»æ“ä½œçš„å½±å“ã€‚

### å˜å¼‚çš„CLHé˜Ÿåˆ—

StampedLockä¸­çš„é˜Ÿåˆ—æ˜¯ä¸€ç§å˜å¼‚çš„CLHé˜Ÿåˆ—ï¼Œå›¾è§£å¦‚ä¸‹ï¼š

![StampedLock](https://gitee.com/alan-tang-tt/yuan/raw/master/æ­»ç£•%20javaåŒæ­¥ç³»åˆ—/resource/StampedLock2.png)

## æ€»ç»“

StampedLockçš„æºç è§£æåˆ°è¿™é‡Œå°±å·®ä¸å¤šäº†ï¼Œè®©æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹ï¼š

ï¼ˆ1ï¼‰StampedLockä¹Ÿæ˜¯ä¸€ç§è¯»å†™é”ï¼Œå®ƒä¸æ˜¯åŸºäºAQSå®ç°çš„ï¼›

ï¼ˆ2ï¼‰StampedLockç›¸è¾ƒäºReentrantReadWriteLockå¤šäº†ä¸€ç§ä¹è§‚è¯»çš„æ¨¡å¼ï¼Œä»¥åŠè¯»é”è½¬åŒ–ä¸ºå†™é”çš„æ–¹æ³•ï¼›

ï¼ˆ3ï¼‰StampedLockçš„stateå­˜å‚¨çš„æ˜¯ç‰ˆæœ¬å·ï¼Œç¡®åˆ‡åœ°è¯´æ˜¯é«˜24ä½å­˜å‚¨çš„æ˜¯ç‰ˆæœ¬å·ï¼Œå†™é”çš„é‡Šæ”¾ä¼šå¢åŠ å…¶ç‰ˆæœ¬å·ï¼Œè¯»é”ä¸ä¼šï¼›

ï¼ˆ4ï¼‰StampedLockçš„ä½7ä½å­˜å‚¨çš„è¯»é”è¢«è·å–çš„æ¬¡æ•°ï¼Œç¬¬8ä½å­˜å‚¨çš„æ˜¯å†™é”è¢«è·å–çš„æ¬¡æ•°ï¼›

ï¼ˆ5ï¼‰StampedLockä¸æ˜¯å¯é‡å…¥é”ï¼Œå› ä¸ºåªæœ‰ç¬¬8ä½æ ‡è¯†å†™é”è¢«è·å–äº†ï¼Œå¹¶ä¸èƒ½é‡å¤è·å–ï¼›

ï¼ˆ6ï¼‰StampedLockä¸­è·å–é”çš„è¿‡ç¨‹ä½¿ç”¨äº†å¤§é‡çš„è‡ªæ—‹æ“ä½œï¼Œå¯¹äºçŸ­ä»»åŠ¡çš„æ‰§è¡Œä¼šæ¯”è¾ƒé«˜æ•ˆï¼Œé•¿ä»»åŠ¡çš„æ‰§è¡Œä¼šæµªè´¹å¤§é‡CPUï¼›

ï¼ˆ7ï¼‰StampedLockä¸èƒ½å®ç°æ¡ä»¶é”ï¼›

## å½©è›‹

StampedLockä¸ReentrantReadWriteLockçš„å¯¹æ¯”ï¼Ÿ

ç­”ï¼šStampedLockä¸ReentrantReadWriteLockä½œä¸ºä¸¤ç§ä¸åŒçš„è¯»å†™é”æ–¹å¼ï¼Œå½¤å“¥å¤§è‡´å½’çº³äº†å®ƒä»¬çš„å¼‚åŒç‚¹ï¼š

ï¼ˆ1ï¼‰ä¸¤è€…éƒ½æœ‰è·å–è¯»é”ã€è·å–å†™é”ã€é‡Šæ”¾è¯»é”ã€é‡Šæ”¾å†™é”çš„æ–¹æ³•ï¼Œè¿™æ˜¯ç›¸åŒç‚¹ï¼›

ï¼ˆ2ï¼‰ä¸¤è€…çš„ç»“æ„åŸºæœ¬ç±»ä¼¼ï¼Œéƒ½æ˜¯ä½¿ç”¨state + CLHé˜Ÿåˆ—ï¼›

ï¼ˆ3ï¼‰å‰è€…çš„stateåˆ†æˆä¸‰æ®µï¼Œé«˜24ä½å­˜å‚¨ç‰ˆæœ¬å·ã€ä½7ä½å­˜å‚¨è¯»é”è¢«è·å–çš„æ¬¡æ•°ã€ç¬¬8ä½å­˜å‚¨å†™é”è¢«è·å–çš„æ¬¡æ•°ï¼›

ï¼ˆ4ï¼‰åè€…çš„stateåˆ†æˆä¸¤æ®µï¼Œé«˜16ä½å­˜å‚¨è¯»é”è¢«è·å–çš„æ¬¡æ•°ï¼Œä½16ä½å­˜å‚¨å†™é”è¢«è·å–çš„æ¬¡æ•°ï¼›

ï¼ˆ5ï¼‰å‰è€…çš„CLHé˜Ÿåˆ—å¯ä»¥çœ‹æˆæ˜¯å˜å¼‚çš„CLHé˜Ÿåˆ—ï¼Œè¿ç»­çš„è¯»çº¿ç¨‹åªæœ‰é¦–ä¸ªèŠ‚ç‚¹å­˜å‚¨åœ¨é˜Ÿåˆ—ä¸­ï¼Œå…¶å®ƒçš„èŠ‚ç‚¹å­˜å‚¨çš„é¦–ä¸ªèŠ‚ç‚¹çš„cowaitæ ˆä¸­ï¼›

ï¼ˆ6ï¼‰åè€…çš„CLHé˜Ÿåˆ—æ˜¯æ­£å¸¸çš„CLHé˜Ÿåˆ—ï¼Œæ‰€æœ‰çš„èŠ‚ç‚¹éƒ½åœ¨è¿™ä¸ªé˜Ÿåˆ—ä¸­ï¼›

ï¼ˆ7ï¼‰å‰è€…è·å–é”çš„è¿‡ç¨‹ä¸­æœ‰åˆ¤æ–­é¦–å°¾èŠ‚ç‚¹æ˜¯å¦ç›¸åŒï¼Œä¹Ÿå°±æ˜¯æ˜¯ä¸æ˜¯å¿«è½®åˆ°è‡ªå·±äº†ï¼Œå¦‚æœæ˜¯åˆ™ä¸æ–­è‡ªæ—‹ï¼Œæ‰€ä»¥é€‚åˆæ‰§è¡ŒçŸ­ä»»åŠ¡ï¼›

ï¼ˆ8ï¼‰åè€…è·å–é”çš„è¿‡ç¨‹ä¸­éå…¬å¹³æ¨¡å¼ä¸‹ä¼šåšæœ‰é™æ¬¡å°è¯•ï¼›

ï¼ˆ9ï¼‰å‰è€…åªæœ‰éå…¬å¹³æ¨¡å¼ï¼Œä¸€ä¸Šæ¥å°±å°è¯•è·å–é”ï¼›

ï¼ˆ10ï¼‰å‰è€…å”¤é†’è¯»é”æ˜¯ä¸€æ¬¡æ€§å”¤é†’è¿ç»­çš„è¯»é”çš„ï¼Œè€Œä¸”å…¶å®ƒçº¿ç¨‹è¿˜ä¼šååŠ©å”¤é†’ï¼›

ï¼ˆ11ï¼‰åè€…æ˜¯ä¸€ä¸ªæ¥ç€ä¸€ä¸ªåœ°å”¤é†’çš„ï¼›

ï¼ˆ12ï¼‰å‰è€…æœ‰ä¹è§‚è¯»çš„æ¨¡å¼ï¼Œä¹è§‚è¯»çš„å®ç°æ˜¯é€šè¿‡åˆ¤æ–­stateçš„é«˜25ä½æ˜¯å¦æœ‰å˜åŒ–æ¥å®ç°çš„ï¼›

ï¼ˆ13ï¼‰å‰è€…å„ç§æ¨¡å¼å¯ä»¥äº’è½¬ï¼Œç±»ä¼¼tryConvertToXxx()æ–¹æ³•ï¼›

ï¼ˆ14ï¼‰å‰è€…å†™é”ä¸å¯é‡å…¥ï¼Œåè€…å†™é”å¯é‡å…¥ï¼›

ï¼ˆ15ï¼‰å‰è€…æ— æ³•å®ç°æ¡ä»¶é”ï¼Œåè€…å¯ä»¥å®ç°æ¡ä»¶é”ï¼›

å·®ä¸å¤šå°±è¿™ä¹ˆå¤šå§ï¼Œå¦‚æœä½ è¿˜èƒ½æƒ³åˆ°ï¼Œä¹Ÿæ¬¢è¿è¡¥å……å“¦^^å½“ç„¶ï¼Œèƒ½é¡ºæ‰‹ç‚¹ä¸‹å°å¹¿å‘Šå°±æ›´å®Œç¾äº†^^

