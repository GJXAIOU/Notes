ğŸ–•æ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·â€œå½¤å“¥è¯»æºç â€ï¼ŒæŸ¥çœ‹æ›´å¤šæºç ç³»åˆ—æ–‡ç« , ä¸å½¤å“¥ä¸€èµ·ç•…æ¸¸æºç çš„æµ·æ´‹ã€‚ 

ï¼ˆæ‰‹æœºæ¨ªå±çœ‹æºç æ›´æ–¹ä¾¿ï¼‰

---

## é—®é¢˜

ï¼ˆ1ï¼‰Semaphoreæ˜¯ä»€ä¹ˆï¼Ÿ

ï¼ˆ2ï¼‰Semaphoreå…·æœ‰å“ªäº›ç‰¹æ€§ï¼Ÿ

ï¼ˆ3ï¼‰Semaphoreé€šå¸¸ä½¿ç”¨åœ¨ä»€ä¹ˆåœºæ™¯ä¸­ï¼Ÿ

ï¼ˆ4ï¼‰Semaphoreçš„è®¸å¯æ¬¡æ•°æ˜¯å¦å¯ä»¥åŠ¨æ€å¢å‡ï¼Ÿ

ï¼ˆ5ï¼‰Semaphoreå¦‚ä½•å®ç°é™æµï¼Ÿ

## ç®€ä»‹

Semaphoreï¼Œä¿¡å·é‡ï¼Œå®ƒä¿å­˜äº†ä¸€ç³»åˆ—çš„è®¸å¯ï¼ˆpermitsï¼‰ï¼Œæ¯æ¬¡è°ƒç”¨acquire()éƒ½å°†æ¶ˆè€—ä¸€ä¸ªè®¸å¯ï¼Œæ¯æ¬¡è°ƒç”¨release()éƒ½å°†å½’è¿˜ä¸€ä¸ªè®¸å¯ã€‚

## ç‰¹æ€§

Semaphoreé€šå¸¸ç”¨äºé™åˆ¶åŒä¸€æ—¶é—´å¯¹å…±äº«èµ„æºçš„è®¿é—®æ¬¡æ•°ä¸Šï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„é™æµã€‚

ä¸‹é¢æˆ‘ä»¬ä¸€èµ·æ¥å­¦ä¹ Javaä¸­Semaphoreæ˜¯å¦‚ä½•å®ç°çš„ã€‚

## ç±»ç»“æ„

![Semaphore](https://gitee.com/alan-tang-tt/yuan/raw/master/æ­»ç£•%20javaåŒæ­¥ç³»åˆ—/resource/Semaphore.png)

Semaphoreä¸­åŒ…å«äº†ä¸€ä¸ªå®ç°äº†AQSçš„åŒæ­¥å™¨Syncï¼Œä»¥åŠå®ƒçš„ä¸¤ä¸ªå­ç±»FairSyncå’ŒNonFairSyncï¼Œè¿™è¯´æ˜Semaphoreä¹Ÿæ˜¯åŒºåˆ†å…¬å¹³æ¨¡å¼å’Œéå…¬å¹³æ¨¡å¼çš„ã€‚

## æºç åˆ†æ

åŸºäºä¹‹å‰å¯¹äºReentrantLockå’ŒReentrantReadWriteLockçš„åˆ†æï¼Œè¿™ç¯‡æ–‡ç« ç›¸å¯¹æ¥è¯´æ¯”è¾ƒç®€å•ï¼Œä¹‹å‰è®²è¿‡çš„ä¸€äº›æ–¹æ³•å°†ç›´æ¥ç•¥è¿‡ï¼Œæœ‰å…´è¶£çš„å¯ä»¥æ‹‰åˆ°æ–‡ç« åº•éƒ¨æŸ¥çœ‹ä¹‹å‰çš„æ–‡ç« ã€‚

### å†…éƒ¨ç±»Sync

```java
// java.util.concurrent.Semaphore.Sync
abstract static class Sync extends AbstractQueuedSynchronizer {
    private static final long serialVersionUID = 1192457210091910933L;
    // æ„é€ æ–¹æ³•ï¼Œä¼ å…¥è®¸å¯æ¬¡æ•°ï¼Œæ”¾å…¥stateä¸­
    Sync(int permits) {
        setState(permits);
    }
    // è·å–è®¸å¯æ¬¡æ•°
    final int getPermits() {
        return getState();
    }
    // éå…¬å¹³æ¨¡å¼å°è¯•è·å–è®¸å¯
    final int nonfairTryAcquireShared(int acquires) {
        for (;;) {
            // çœ‹çœ‹è¿˜æœ‰å‡ ä¸ªè®¸å¯
            int available = getState();
            // å‡å»è¿™æ¬¡éœ€è¦è·å–çš„è®¸å¯è¿˜å‰©ä¸‹å‡ ä¸ªè®¸å¯
            int remaining = available - acquires;
            // å¦‚æœå‰©ä½™è®¸å¯å°äº0äº†åˆ™ç›´æ¥è¿”å›
            // å¦‚æœå‰©ä½™è®¸å¯ä¸å°äº0ï¼Œåˆ™å°è¯•åŸå­æ›´æ–°stateçš„å€¼ï¼ŒæˆåŠŸäº†è¿”å›å‰©ä½™è®¸å¯
            if (remaining < 0 ||
                compareAndSetState(available, remaining))
                return remaining;
        }
    }
    // é‡Šæ”¾è®¸å¯
    protected final boolean tryReleaseShared(int releases) {
        for (;;) {
            // çœ‹çœ‹è¿˜æœ‰å‡ ä¸ªè®¸å¯
            int current = getState();
            // åŠ ä¸Šè¿™æ¬¡é‡Šæ”¾çš„è®¸å¯
            int next = current + releases;
            // æ£€æµ‹æº¢å‡º
            if (next < current) // overflow
                throw new Error("Maximum permit count exceeded");
            // å¦‚æœåŸå­æ›´æ–°stateçš„å€¼æˆåŠŸï¼Œå°±è¯´æ˜é‡Šæ”¾è®¸å¯æˆåŠŸï¼Œåˆ™è¿”å›true
            if (compareAndSetState(current, next))
                return true;
        }
    }
    // å‡å°‘è®¸å¯
    final void reducePermits(int reductions) {
        for (;;) {
            // çœ‹çœ‹è¿˜æœ‰å‡ ä¸ªè®¸å¯
            int current = getState();
            // å‡å»å°†è¦å‡å°‘çš„è®¸å¯
            int next = current - reductions;
            // æ£€æµ‹ä¸¾å‡º
            if (next > current) // underflow
                throw new Error("Permit count underflow");
            // åŸå­æ›´æ–°stateçš„å€¼ï¼ŒæˆåŠŸäº†è¿”å›true
            if (compareAndSetState(current, next))
                return;
        }
    }
    // é”€æ¯è®¸å¯
    final int drainPermits() {
        for (;;) {
            // çœ‹çœ‹è¿˜æœ‰å‡ ä¸ªè®¸å¯
            int current = getState();
            // å¦‚æœä¸º0ï¼Œç›´æ¥è¿”å›
            // å¦‚æœä¸ä¸º0ï¼ŒæŠŠstateåŸå­æ›´æ–°ä¸º0
            if (current == 0 || compareAndSetState(current, 0))
                return current;
        }
    }
}
```

é€šè¿‡Syncçš„å‡ ä¸ªå®ç°æ–¹æ³•ï¼Œæˆ‘ä»¬è·å–åˆ°ä»¥ä¸‹å‡ ç‚¹ä¿¡æ¯ï¼š

ï¼ˆ1ï¼‰è®¸å¯æ˜¯åœ¨æ„é€ æ–¹æ³•æ—¶ä¼ å…¥çš„ï¼›

ï¼ˆ2ï¼‰è®¸å¯å­˜æ”¾åœ¨çŠ¶æ€å˜é‡stateä¸­ï¼›

ï¼ˆ3ï¼‰å°è¯•è·å–ä¸€ä¸ªè®¸å¯çš„æ—¶å€™ï¼Œåˆ™stateçš„å€¼å‡1ï¼›

ï¼ˆ4ï¼‰å½“stateçš„å€¼ä¸º0çš„æ—¶å€™ï¼Œåˆ™æ— æ³•å†è·å–è®¸å¯ï¼›

ï¼ˆ5ï¼‰é‡Šæ”¾ä¸€ä¸ªè®¸å¯çš„æ—¶å€™ï¼Œåˆ™stateçš„å€¼åŠ 1ï¼›

ï¼ˆ6ï¼‰è®¸å¯çš„ä¸ªæ•°å¯ä»¥åŠ¨æ€æ”¹å˜ï¼›

### å†…éƒ¨ç±»NonfairSync

```java
// java.util.concurrent.Semaphore.NonfairSync
static final class NonfairSync extends Sync {
    private static final long serialVersionUID = -2694183684443567898L;
    // æ„é€ æ–¹æ³•ï¼Œè°ƒç”¨çˆ¶ç±»çš„æ„é€ æ–¹æ³•
    NonfairSync(int permits) {
        super(permits);
    }
    // å°è¯•è·å–è®¸å¯ï¼Œè°ƒç”¨çˆ¶ç±»çš„nonfairTryAcquireShared()æ–¹æ³•
    protected int tryAcquireShared(int acquires) {
        return nonfairTryAcquireShared(acquires);
    }
}
```

éå…¬å¹³æ¨¡å¼ä¸‹ï¼Œç›´æ¥è°ƒç”¨çˆ¶ç±»çš„nonfairTryAcquireShared()å°è¯•è·å–è®¸å¯ã€‚

### å†…éƒ¨ç±»FairSync

```java
// java.util.concurrent.Semaphore.FairSync
static final class FairSync extends Sync {
    private static final long serialVersionUID = 2014338818796000944L;
    // æ„é€ æ–¹æ³•ï¼Œè°ƒç”¨çˆ¶ç±»çš„æ„é€ æ–¹æ³•
    FairSync(int permits) {
        super(permits);
    }
    // å°è¯•è·å–è®¸å¯
    protected int tryAcquireShared(int acquires) {
        for (;;) {
            // å…¬å¹³æ¨¡å¼éœ€è¦æ£€æµ‹æ˜¯å¦å‰é¢æœ‰æ’é˜Ÿçš„
            // å¦‚æœæœ‰æ’é˜Ÿçš„ç›´æ¥è¿”å›å¤±è´¥
            if (hasQueuedPredecessors())
                return -1;
            // æ²¡æœ‰æ’é˜Ÿçš„å†å°è¯•æ›´æ–°stateçš„å€¼
            int available = getState();
            int remaining = available - acquires;
            if (remaining < 0 ||
                compareAndSetState(available, remaining))
                return remaining;
        }
    }
}
```

å…¬å¹³æ¨¡å¼ä¸‹ï¼Œå…ˆæ£€æµ‹å‰é¢æ˜¯å¦æœ‰æ’é˜Ÿçš„ï¼Œå¦‚æœæœ‰æ’é˜Ÿçš„åˆ™è·å–è®¸å¯å¤±è´¥ï¼Œè¿›å…¥é˜Ÿåˆ—æ’é˜Ÿï¼Œå¦åˆ™å°è¯•åŸå­æ›´æ–°stateçš„å€¼ã€‚

### æ„é€ æ–¹æ³•

```java
// æ„é€ æ–¹æ³•ï¼Œåˆ›å»ºæ—¶è¦ä¼ å…¥è®¸å¯æ¬¡æ•°ï¼Œé»˜è®¤ä½¿ç”¨éå…¬å¹³æ¨¡å¼
public Semaphore(int permits) {
    sync = new NonfairSync(permits);
}
// æ„é€ æ–¹æ³•ï¼Œéœ€è¦ä¼ å…¥è®¸å¯æ¬¡æ•°ï¼ŒåŠæ˜¯å¦å…¬å¹³æ¨¡å¼
public Semaphore(int permits, boolean fair) {
    sync = fair ? new FairSync(permits) : new NonfairSync(permits);
}
```
åˆ›å»ºSemaphoreæ—¶éœ€è¦ä¼ å…¥è®¸å¯æ¬¡æ•°ã€‚

Semaphoreé»˜è®¤ä¹Ÿæ˜¯éå…¬å¹³æ¨¡å¼ï¼Œä½†æ˜¯ä½ å¯ä»¥è°ƒç”¨ç¬¬äºŒä¸ªæ„é€ æ–¹æ³•å£°æ˜å…¶ä¸ºå…¬å¹³æ¨¡å¼ã€‚

ä¸‹é¢çš„æ–¹æ³•åœ¨å­¦ä¹ è¿‡å‰é¢çš„å†…å®¹çœ‹æ¥éƒ½æ¯”è¾ƒç®€å•ï¼Œå½¤å“¥è¿™é‡Œåªåˆ—ä¸¾Semaphoreæ”¯æŒçš„ä¸€äº›åŠŸèƒ½äº†ã€‚

ä»¥ä¸‹çš„æ–¹æ³•éƒ½æ˜¯é’ˆå¯¹éå…¬å¹³æ¨¡å¼æ¥æè¿°ã€‚

### acquire()æ–¹æ³•

```java
public void acquire() throws InterruptedException {
    sync.acquireSharedInterruptibly(1);
}
```

è·å–ä¸€ä¸ªè®¸å¯ï¼Œé»˜è®¤ä½¿ç”¨çš„æ˜¯å¯ä¸­æ–­æ–¹å¼ï¼Œå¦‚æœå°è¯•è·å–è®¸å¯å¤±è´¥ï¼Œä¼šè¿›å…¥AQSçš„é˜Ÿåˆ—ä¸­æ’é˜Ÿã€‚

### acquireUninterruptibly()æ–¹æ³•

```java
public void acquireUninterruptibly() {
    sync.acquireShared(1);
}
```

è·å–ä¸€ä¸ªè®¸å¯ï¼Œéä¸­æ–­æ–¹å¼ï¼Œå¦‚æœå°è¯•è·å–è®¸å¯å¤±è´¥ï¼Œä¼šè¿›å…¥AQSçš„é˜Ÿåˆ—ä¸­æ’é˜Ÿã€‚

### tryAcquire()æ–¹æ³•

```java
public boolean tryAcquire() {
    return sync.nonfairTryAcquireShared(1) >= 0;
}
```

å°è¯•è·å–ä¸€ä¸ªè®¸å¯ï¼Œä½¿ç”¨Syncçš„éå…¬å¹³æ¨¡å¼å°è¯•è·å–è®¸å¯æ–¹æ³•ï¼Œä¸è®ºæ˜¯å¦è·å–åˆ°è®¸å¯éƒ½è¿”å›ï¼Œåªå°è¯•ä¸€æ¬¡ï¼Œä¸ä¼šè¿›å…¥é˜Ÿåˆ—æ’é˜Ÿã€‚

### tryAcquire(long timeout, TimeUnit unit)æ–¹æ³•

```java
public boolean tryAcquire(long timeout, TimeUnit unit)
    throws InterruptedException {
    return sync.tryAcquireSharedNanos(1, unit.toNanos(timeout));
}
```

å°è¯•è·å–ä¸€ä¸ªè®¸å¯ï¼Œå…ˆå°è¯•ä¸€æ¬¡è·å–è®¸å¯ï¼Œå¦‚æœå¤±è´¥åˆ™ä¼šç­‰å¾…timeoutæ—¶é—´ï¼Œè¿™æ®µæ—¶é—´å†…éƒ½æ²¡æœ‰è·å–åˆ°è®¸å¯ï¼Œåˆ™è¿”å›falseï¼Œå¦åˆ™è¿”å›trueï¼›

### release()æ–¹æ³•

```java
public void release() {
    sync.releaseShared(1);
}
```

é‡Šæ”¾ä¸€ä¸ªè®¸å¯ï¼Œé‡Šæ”¾ä¸€ä¸ªè®¸å¯æ—¶stateçš„å€¼ä¼šåŠ 1ï¼Œå¹¶ä¸”ä¼šå”¤é†’ä¸‹ä¸€ä¸ªç­‰å¾…è·å–è®¸å¯çš„çº¿ç¨‹ã€‚

### acquire(int permits)æ–¹æ³•

```java
public void acquire(int permits) throws InterruptedException {
    if (permits < 0) throw new IllegalArgumentException();
    sync.acquireSharedInterruptibly(permits);
}
```

ä¸€æ¬¡è·å–å¤šä¸ªè®¸å¯ï¼Œå¯ä¸­æ–­æ–¹å¼ã€‚

### acquireUninterruptibly(int permits)æ–¹æ³•

```java
public void acquireUninterruptibly(int permits) {
    if (permits < 0) throw new IllegalArgumentException();
    sync.acquireShared(permits);
}
```

ä¸€æ¬¡è·å–å¤šä¸ªè®¸å¯ï¼Œéä¸­æ–­æ–¹å¼ã€‚

### tryAcquire(int permits)æ–¹æ³•

```java
public boolean tryAcquire(int permits) {
    if (permits < 0) throw new IllegalArgumentException();
    return sync.nonfairTryAcquireShared(permits) >= 0;
}
```

ä¸€æ¬¡å°è¯•è·å–å¤šä¸ªè®¸å¯ï¼Œåªå°è¯•ä¸€æ¬¡ã€‚

### tryAcquire(int permits, long timeout, TimeUnit unit)æ–¹æ³•

```java
public boolean tryAcquire(int permits, long timeout, TimeUnit unit)
    throws InterruptedException {
    if (permits < 0) throw new IllegalArgumentException();
    return sync.tryAcquireSharedNanos(permits, unit.toNanos(timeout));
}
```

å°è¯•è·å–å¤šä¸ªè®¸å¯ï¼Œå¹¶ä¼šç­‰å¾…timeoutæ—¶é—´ï¼Œè¿™æ®µæ—¶é—´æ²¡è·å–åˆ°è®¸å¯åˆ™è¿”å›falseï¼Œå¦åˆ™è¿”å›trueã€‚

### release(int permits)æ–¹æ³•

```java
public void release(int permits) {
    if (permits < 0) throw new IllegalArgumentException();
    sync.releaseShared(permits);
}
```

ä¸€æ¬¡é‡Šæ”¾å¤šä¸ªè®¸å¯ï¼Œstateçš„å€¼ä¼šç›¸åº”å¢åŠ permitsçš„æ•°é‡ã€‚

### availablePermits()æ–¹æ³•

```java
public int availablePermits() {
    return sync.getPermits();
}
```

è·å–å¯ç”¨çš„è®¸å¯æ¬¡æ•°ã€‚

### drainPermits()æ–¹æ³•

```java
public int drainPermits() {
    return sync.drainPermits();
}
```

é”€æ¯å½“å‰å¯ç”¨çš„è®¸å¯æ¬¡æ•°ï¼Œå¯¹äºå·²ç»è·å–çš„è®¸å¯æ²¡æœ‰å½±å“ï¼Œä¼šæŠŠå½“å‰å‰©ä½™çš„è®¸å¯å…¨éƒ¨é”€æ¯ã€‚

### reducePermits(int reduction)æ–¹æ³•

```java
protected void reducePermits(int reduction) {
    if (reduction < 0) throw new IllegalArgumentException();
    sync.reducePermits(reduction);
}
```

å‡å°‘è®¸å¯çš„æ¬¡æ•°ã€‚

## æ€»ç»“

ï¼ˆ1ï¼‰Semaphoreï¼Œä¹Ÿå«ä¿¡å·é‡ï¼Œé€šå¸¸ç”¨äºæ§åˆ¶åŒä¸€æ—¶åˆ»å¯¹å…±äº«èµ„æºçš„è®¿é—®ä¸Šï¼Œä¹Ÿå°±æ˜¯é™æµåœºæ™¯ï¼›

ï¼ˆ2ï¼‰Semaphoreçš„å†…éƒ¨å®ç°æ˜¯åŸºäºAQSçš„å…±äº«é”æ¥å®ç°çš„ï¼›

ï¼ˆ3ï¼‰Semaphoreåˆå§‹åŒ–çš„æ—¶å€™éœ€è¦æŒ‡å®šè®¸å¯çš„æ¬¡æ•°ï¼Œè®¸å¯çš„æ¬¡æ•°æ˜¯å­˜å‚¨åœ¨stateä¸­ï¼›

ï¼ˆ4ï¼‰è·å–ä¸€ä¸ªè®¸å¯æ—¶ï¼Œåˆ™stateå€¼å‡1ï¼›

ï¼ˆ5ï¼‰é‡Šæ”¾ä¸€ä¸ªè®¸å¯æ—¶ï¼Œåˆ™stateå€¼åŠ 1ï¼›

ï¼ˆ6ï¼‰å¯ä»¥åŠ¨æ€å‡å°‘nä¸ªè®¸å¯ï¼›

ï¼ˆ7ï¼‰å¯ä»¥åŠ¨æ€å¢åŠ nä¸ªè®¸å¯å—ï¼Ÿ

## å½©è›‹

ï¼ˆ1ï¼‰å¦‚ä½•åŠ¨æ€å¢åŠ nä¸ªè®¸å¯ï¼Ÿ

ç­”ï¼šè°ƒç”¨release(int permits)å³å¯ã€‚æˆ‘ä»¬çŸ¥é“é‡Šæ”¾è®¸å¯çš„æ—¶å€™stateçš„å€¼ä¼šç›¸åº”å¢åŠ ï¼Œå†å›å¤´çœ‹çœ‹é‡Šæ”¾è®¸å¯çš„æºç ï¼Œå‘ç°ä¸ReentrantLockçš„é‡Šæ”¾é”è¿˜æ˜¯æœ‰ç‚¹åŒºåˆ«çš„ï¼ŒSemaphoreé‡Šæ”¾è®¸å¯çš„æ—¶å€™å¹¶ä¸ä¼šæ£€æŸ¥å½“å‰çº¿ç¨‹æœ‰æ²¡æœ‰è·å–è¿‡è®¸å¯ï¼Œæ‰€ä»¥å¯ä»¥è°ƒç”¨é‡Šæ”¾è®¸å¯çš„æ–¹æ³•åŠ¨æ€å¢åŠ ä¸€äº›è®¸å¯ã€‚

ï¼ˆ2ï¼‰å¦‚ä½•å®ç°é™æµï¼Ÿ

ç­”ï¼šé™æµï¼Œå³åœ¨æµé‡çªç„¶å¢å¤§çš„æ—¶å€™ï¼Œä¸Šå±‚è¦èƒ½å¤Ÿé™åˆ¶ä½çªç„¶çš„å¤§æµé‡å¯¹ä¸‹æ¸¸æœåŠ¡çš„å†²å‡»ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­é™æµä¸€èˆ¬åšåœ¨ç½‘å…³å±‚ï¼Œå½“ç„¶åœ¨ä¸ªåˆ«åŠŸèƒ½ä¸­ä¹Ÿå¯ä»¥è‡ªå·±ç®€å•åœ°æ¥é™æµï¼Œæ¯”å¦‚ç§’æ€åœºæ™¯ï¼Œå‡å¦‚åªæœ‰10ä¸ªå•†å“éœ€è¦ç§’æ€ï¼Œé‚£ä¹ˆï¼ŒæœåŠ¡æœ¬èº«å¯ä»¥é™åˆ¶åŒæ—¶åªè¿›æ¥100ä¸ªè¯·æ±‚ï¼Œå…¶å®ƒè¯·æ±‚å…¨éƒ¨ä½œåºŸï¼Œè¿™æ ·æœåŠ¡çš„å‹åŠ›ä¹Ÿä¸ä¼šå¤ªå¤§ã€‚

ä½¿ç”¨Semaphoreå°±å¯ä»¥ç›´æ¥é’ˆå¯¹è¿™ä¸ªåŠŸèƒ½æ¥é™æµï¼Œä»¥ä¸‹æ˜¯ä»£ç å®ç°ï¼š

```java
public class SemaphoreTest {
    public static final Semaphore SEMAPHORE = new Semaphore(100);
    public static final AtomicInteger failCount = new AtomicInteger(0);
    public static final AtomicInteger successCount = new AtomicInteger(0);

    public static void main(String[] args) {
        for (int i = 0; i < 1000; i++) {
            new Thread(()->seckill()).start();
        }
    }

    public static boolean seckill() {
        if (!SEMAPHORE.tryAcquire()) {
            System.out.println("no permits, count="+failCount.incrementAndGet());
            return false;
        }

        try {
            // å¤„ç†ä¸šåŠ¡é€»è¾‘
            Thread.sleep(2000);
            System.out.println("seckill success, count="+successCount.incrementAndGet());
        } catch (InterruptedException e) {
            // todo å¤„ç†å¼‚å¸¸
            e.printStackTrace();
        } finally {
            SEMAPHORE.release();
        }
        return true;
    }
}
```

