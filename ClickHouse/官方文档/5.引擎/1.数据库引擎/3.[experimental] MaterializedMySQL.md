# [experimental] MaterializedMySQL

**这是一个实验性的特性，不应该在生产中使用。**

创建ClickHouse数据库，包含MySQL中所有的表，以及这些表中的所有数据。

ClickHouse服务器作为MySQL副本工作。它读取binlog并执行DDL和DML查询。

这个功能是实验性的。

## 创建数据库[](https://clickhouse.com/docs/zh/engines/database-engines/materialize-mysql#creating-a-database)

```sql
CREATE DATABASE [IF NOT EXISTS] db_name [ON CLUSTER cluster]
ENGINE = MaterializeMySQL('host:port', ['database' | database], 'user', 'password') [SETTINGS ...]
```



**引擎参数**

- `host:port` — MySQL服务地址
- `database` — MySQL数据库名称
- `user` — MySQL用户名
- `password` — MySQL用户密码

**引擎配置**

- `max_rows_in_buffer` — 允许数据缓存到内存中的最大行数(对于单个表和无法查询的缓存数据)。当超过行数时，数据将被物化。默认值: `65505`。
- `max_bytes_in_buffer` — 允许在内存中缓存数据的最大字节数(对于单个表和无法查询的缓存数据)。当超过行数时，数据将被物化。默认值: `1048576`.
- `max_rows_in_buffers` — 允许数据缓存到内存中的最大行数(对于数据库和无法查询的缓存数据)。当超过行数时，数据将被物化。默认值: `65505`.
- `max_bytes_in_buffers` — 允许在内存中缓存数据的最大字节数(对于数据库和无法查询的缓存数据)。当超过行数时，数据将被物化。默认值: `1048576`.
- `max_flush_data_time` — 允许数据在内存中缓存的最大毫秒数(对于数据库和无法查询的缓存数据)。当超过这个时间时，数据将被物化。默认值: `1000`.
- `max_wait_time_when_mysql_unavailable` — 当MySQL不可用时重试间隔(毫秒)。负值禁止重试。默认值: `1000`.
- `allows_query_when_mysql_lost` — 当mysql丢失时，允许查询物化表。默认值: `0` (`false`).

```text
CREATE DATABASE mysql ENGINE = MaterializeMySQL('localhost:3306', 'db', 'user', '***')
     SETTINGS
        allows_query_when_mysql_lost=true,
        max_wait_time_when_mysql_unavailable=10000;
```



**MySQL服务器端配置**

为了`MaterializeMySQL`正确的工作，有一些强制性的`MySQL`侧配置设置应该设置:

- `default_authentication_plugin = mysql_native_password`，因为`MaterializeMySQL`只能使用此方法授权。
- `gtid_mode = on`，因为要提供正确的`MaterializeMySQL`复制，基于GTID的日志记录是必须的。注意，在打开这个模式`On`时，你还应该指定`enforce_gtid_consistency = on`。

## 虚拟列[](https://clickhouse.com/docs/zh/engines/database-engines/materialize-mysql#virtual-columns)

当使用`MaterializeMySQL`数据库引擎时，[ReplacingMergeTree](https://clickhouse.com/docs/zh/engines/table-engines/mergetree-family/replacingmergetree)表与虚拟的`_sign`和`_version`列一起使用。

- `_version` — 同步版本。 类型[UInt64](https://clickhouse.com/docs/zh/sql-reference/data-types/int-uint).

- ```
  _sign
  ```

   

  — 删除标记。类型

   

  Int8

  . Possible values:

  - `1` — 行不会删除,
  - `-1` — 行被删除。

## 支持的数据类型[](https://clickhouse.com/docs/zh/engines/database-engines/materialize-mysql#data_types-support)

| MySQL                 | ClickHouse                                                   |
| --------------------- | ------------------------------------------------------------ |
| TINY                  | [Int8](https://clickhouse.com/docs/zh/sql-reference/data-types/int-uint) |
| SHORT                 | [Int16](https://clickhouse.com/docs/zh/sql-reference/data-types/int-uint) |
| INT24                 | [Int32](https://clickhouse.com/docs/zh/sql-reference/data-types/int-uint) |
| LONG                  | [UInt32](https://clickhouse.com/docs/zh/sql-reference/data-types/int-uint) |
| LONGLONG              | [UInt64](https://clickhouse.com/docs/zh/sql-reference/data-types/int-uint) |
| FLOAT                 | [Float32](https://clickhouse.com/docs/zh/sql-reference/data-types/float) |
| DOUBLE                | [Float64](https://clickhouse.com/docs/zh/sql-reference/data-types/float) |
| DECIMAL, NEWDECIMAL   | [Decimal](https://clickhouse.com/docs/zh/sql-reference/data-types/decimal) |
| DATE, NEWDATE         | [Date](https://clickhouse.com/docs/zh/sql-reference/data-types/date) |
| DATETIME, TIMESTAMP   | [DateTime](https://clickhouse.com/docs/zh/sql-reference/data-types/datetime) |
| DATETIME2, TIMESTAMP2 | [DateTime64](https://clickhouse.com/docs/zh/sql-reference/data-types/datetime64) |
| ENUM                  | [Enum](https://clickhouse.com/docs/zh/sql-reference/data-types/enum) |
| STRING                | [String](https://clickhouse.com/docs/zh/sql-reference/data-types/string) |
| VARCHAR, VAR_STRING   | [String](https://clickhouse.com/docs/zh/sql-reference/data-types/string) |
| BLOB                  | [String](https://clickhouse.com/docs/zh/sql-reference/data-types/string) |
| BINARY                | [FixedString](https://clickhouse.com/docs/zh/sql-reference/data-types/fixedstring) |

不支持其他类型。如果MySQL表包含此类类型的列，ClickHouse抛出异常"Unhandled data type"并停止复制。

[Nullable](https://clickhouse.com/docs/zh/sql-reference/data-types/nullable)已经支持

## 使用方式[](https://clickhouse.com/docs/zh/engines/database-engines/materialize-mysql#specifics-and-recommendations)

### 兼容性限制[](https://clickhouse.com/docs/zh/engines/database-engines/materialize-mysql#兼容性限制)

除了数据类型的限制外，与`MySQL`数据库相比，还存在一些限制，在实现复制之前应先解决这些限制：

- `MySQL`中的每个表都应该包含`PRIMARY KEY`
- 对于包含`ENUM`字段值超出范围（在`ENUM`签名中指定）的行的表，复制将不起作用。

### DDL查询[](https://clickhouse.com/docs/zh/engines/database-engines/materialize-mysql#ddl-queries)

MySQL DDL查询转换为相应的ClickHouse DDL查询([ALTER](https://clickhouse.com/docs/zh/sql-reference/statements/alter/overview), [CREATE](https://clickhouse.com/docs/zh/sql-reference/statements/create), [DROP](https://clickhouse.com/docs/zh/sql-reference/statements/drop), [RENAME](https://clickhouse.com/docs/zh/sql-reference/statements/rename))。如果ClickHouse无法解析某个DDL查询，则该查询将被忽略。

### Data Replication[](https://clickhouse.com/docs/zh/engines/database-engines/materialize-mysql#data-replication)

`MaterializeMySQL`不支持直接`INSERT`, `DELETE`和`UPDATE`查询. 但是，它们是在数据复制方面支持的：

- MySQL的`INSERT`查询转换为`INSERT`并携带`_sign=1`.
- MySQL的`DELETE`查询转换为`INSERT`并携带`_sign=-1`.
- MySQL的`UPDATE`查询转换为`INSERT`并携带`_sign=-1`, `INSERT`和`_sign=1`.

### 查询MaterializeMySQL表[](https://clickhouse.com/docs/zh/engines/database-engines/materialize-mysql#select)

`SELECT`查询`MaterializeMySQL`表有一些细节:

- 如果`_version`在`SELECT`中没有指定，则使用[FINAL](https://clickhouse.com/docs/zh/sql-reference/statements/select/from#select-from-final)修饰符。所以只有带有`MAX(_version)`的行才会被选中。
- 如果`_sign`在`SELECT`中没有指定，则默认使用`WHERE _sign=1`。因此，删除的行不会包含在结果集中。
- 结果包括列中的列注释，因为它们存在于SQL数据库表中。

### Index Conversion[](https://clickhouse.com/docs/zh/engines/database-engines/materialize-mysql#index-conversion)

MySQL的`PRIMARY KEY`和`INDEX`子句在ClickHouse表中转换为`ORDER BY`元组。

ClickHouse只有一个物理顺序，由`ORDER BY`子句决定。要创建一个新的物理顺序，使用[materialized views](https://clickhouse.com/docs/zh/sql-reference/statements/create/view#materialized)。

**Notes**

- 带有`_sign=-1`的行不会从表中物理删除。
- `MaterializeMySQL`引擎不支持级联`UPDATE/DELETE`查询。
- 复制很容易被破坏。
- 禁止对数据库和表进行手工操作。
- `MaterializeMySQL`受[optimize_on_insert](https://clickhouse.com/docs/zh/operations/settings/settings#optimize-on-insert)设置的影响。当MySQL服务器中的表发生变化时，数据会合并到`MaterializeMySQL`数据库中相应的表中。

## 使用示例[](https://clickhouse.com/docs/zh/engines/database-engines/materialize-mysql#examples-of-use)

MySQL操作:

```sql
mysql> CREATE DATABASE db;
mysql> CREATE TABLE db.test (a INT PRIMARY KEY, b INT);
mysql> INSERT INTO db.test VALUES (1, 11), (2, 22);
mysql> DELETE FROM db.test WHERE a=1;
mysql> ALTER TABLE db.test ADD COLUMN c VARCHAR(16);
mysql> UPDATE db.test SET c='Wow!', b=222;
mysql> SELECT * FROM test;
```



```text
+---+------+------+
| a |    b |    c |
+---+------+------+
| 2 |  222 | Wow! |
+---+------+------+
```



ClickHouse中的数据库，与MySQL服务器交换数据:

创建的数据库和表:

```sql
CREATE DATABASE mysql ENGINE = MaterializeMySQL('localhost:3306', 'db', 'user', '***');
SHOW TABLES FROM mysql;
```



```text
┌─name─┐
│ test │
└──────┘
```



然后插入数据:

```sql
SELECT * FROM mysql.test;
```



```text
┌─a─┬──b─┐
│ 1 │ 11 │
│ 2 │ 22 │
└───┴────┘
```



删除数据后，添加列并更新:

```sql
SELECT * FROM mysql.test;
```



```text
┌─a─┬───b─┬─c────┐
│ 2 │ 222 │ Wow! │
└───┴─────┴──────┘
```



[Edit this page](https://github.com/ClickHouse/ClickHouse/tree/master/docs/zh/engines/database-engines/materialize-mysql.md)