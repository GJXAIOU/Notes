
# 数据链路层

文章结构为：
@toc

## 一、基本概念与基本问题  

1.数据发送模型  

![数据链路层发送数据模型]($resource/%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B.png)

- 应用层准备数据    
- 运输层将其分段  
- 网络层将其加上地址  
- 数据链路层加上数据帧头帧尾 
- 物理层考虑，时分多用，频分复用等等，更加有效的传输数据  

**2.链路:** 一种无源的点到点的物理线路，中间没有任何交换节点；
**3.数据链路：** 将实现通信协议（用于可控制数据的传输）的软件和硬（网络适配器即网卡）加载在物理线路上，构成数据链路；

**4. 路由器：** 路由器工作在网络层，数据进入路由器后要先从物理层上到网络层，在转发表中找到下一跳的地址，再下到物理层转发出去。


---


## 二、数据链路层作用     

(1) 链路管理
(2) 帧定界
(3) 流量控制
**一般均由收方进行流量控制，**  当数据发送时间大于接收方处理时间时候，理论上不需要进行流量控制（前提是传输均无差错）
(4) 差错控制
(5) 将数据和控制信息区分开
(6) 透明传输
(7) 寻址



---



## 三、三个基本问题  

- 数据链路层的协议数据单元：帧
- 作用：数据链路层将网络层交下来的数据构成帧发送到链路上，以及将接收到的帧中的数据取出并上交给网络层


### 1.封装成帧  
**网络层的IP数据报传送到数据链路层就成为了帧的数据部分**

**帧结构：** 数据包加上帧头（SOH）（十六进制为01）帧尾（EOT）(十六进制为04，并非三个字母的组合) ，用于判断哪里开始是数据；  


### 2.透明传输  
- 含义：当传送的帧中不会出现像帧头帧尾这种帧定界控制字符，即所有数据都可以放入帧中传输过去，这种传输就是透明传输
- 当传输数据非ASCII码的文本文件时：
若所传输的数据中出现和开始帧与结尾帧标志一样的数据，则在该数据（与帧头相同的数据）前面加上ESC，若正好是ESC数据，则写入两个ESC，接收时候就是一个ESC。 此方法为：**字符填充**


### 3.差错控制
    
- 为CRC这种检错而添加的冗余码称为：**帧检验序列FCS** 

 路由器收到发现有错误，则扔掉数据，**只检错不纠错** ；
  
  **可以使用循环冗余检测（CRC）算法**   
   [CRC介绍](https://zh.wikipedia.org/wiki/%E5%BE%AA%E7%92%B0%E5%86%97%E9%A4%98%E6%A0%A1%E9%A9%97)

[散列函数](https://zh.wikipedia.org/wiki/%E6%95%A3%E5%88%97%E5%87%BD%E6%95%B8)   

- **算法实现：**
  - 在需要传输的数据后面加0 ,一直加到$2^n$位数；
  - 然后除以比数据所加位数多一位的数，（例如数据后面加了4个0，那么除以5位数，这五位数值随便，例如10011等等），除法即是做加法但是不进位（异或，相同为0，不同为1）；
  - 如果余数为4位，相当于被除数少一位，则商0，除以0000.  最终的余数作为FCS（冗余码）。所以最终传输数据为原来的数据后面加上FCS。    

- **检验方法：**  
接收端用接受到的数据同样除以原来的除数，结果余数如果为0则表示传输正确，接受。余数为1则表示传输错误，丢弃。但是当被除数位数很小的时候可能检测不出来错误。




---



## 四、两种情况下的数据链路层    


### 1.点对点通信  
- 一对一点到点通信（使用PPP协议）  
（可以使用思科的仿真软件）  
- 主要针对广域网  
- 计算机和ISP进行通信就是使用数据链路层的PPP协议
- 协议内容：接收方每收到一个帧就进行CRC校验，如果校验正确就收下，否则丢弃该帧，**其他什么都不做**
- 协议组成：
  - 一个将IP数据包封装到串行链路的方法
  - 一个用于建立、配置、测试数据链路连接的链路控制协议LCP
  - 一套网络控制协议NCP

- 帧格式：
![20160204105742700 (1)]($resource/20160204105742700%20(1).jpg)

  - 首部的第一个字段和最后一个字段都是标志字段：F ，规定为：0x7E ；表示一个帧的开始和结束
  - 首部第二三个字段中没有信息
  - 首部第四个字段是两个字节的协议字段，表示各种协议
  - 尾部第一个字段（2个字节）是使用CRC的帧检验序列FCS

###  2.广播信道   
- 一对多通信   ；
- 主要针对局域网；
- 拓扑结构（总线型、星型（使用集线器或者交换机）、环形、树形）；  
- 若想实现一对一通信，以地址进行限制；  
- 局域网的工作跨越了数据链路层和物理层；

### 3.相关概念
- **共享通信媒体：**  
1.静态划分信道（麻烦）  
频分复用  时分复用  波分复用  码分复用  

  2.动态接入（多点接入）  
随机接入（以太网与局域网接入方法）  
受控接入

- **链路：**  
一根点到点的物理线路段  中间没有交换节点  

- **数据链路：**  
物理链路加上必要的通信协议（最常使用的是适配器（网卡）来控制数据的传输）  

- **帧：**  
数据链路层加上帧头帧尾（网络层已经加上IP地址）与物理层地址与校验值，可以判断数据传输的是否正确。   


---


## 五、以太网（以太局域网）    
使用协议CSMA/CD:载波监听多点接入/碰撞检测  

### 1.概念解释

**多点接入：**  许多计算机以多点接入方式接入总线 ；   

**载波监听：** 发送数据之前先检测一下是否有其他计算机在发送数据；  

**注：** 使用协议CSMA/CD:载波监听多点接入/碰撞检测 的以太网不能使用全双工通信，**只能使用半双工进行通信** ，而且在发送数据的过程中存在碰撞冲突，使整个以太网的平均通信量远小于以太网的最高数据率 。



### 2.算法

**（1）检测算法：**   

- 当总线上有几个站同时发送数据的时候，总线上的电压摆动值会增加，当摆动值超过设置的电压阈值的时候，则认为至少两个站在同时发送数据；   
- 检测到碰撞之后都停止发送 ； 



**（2）延迟对于冲突的影响：** 
- 假设数据发送延迟为τ，则最多在2τ时间内就可以知道是否发生了碰撞；  
- 而2τ称为**争用期**  ，**以太网中争用期为51.2μs** ,例如10Mb/s的以太网，则在争用期内可以发送512bit，即64字节（最短帧）  ，**则64字节之内都没有冲突，则默认为有效帧** 。    

**（3）等待时间计算：**  
使用二进制指数类型退避算法 ： 

1.基本退避时间为2τ  
2.定义参数k=min[重传次数，10]
3.从整数集合[0,1，。。。（2^k）-1]中随机取一个数即为r，重传时延即为r倍的基本退避时间，因此各个计算机等待的时间一般不会相同，如果任由相同的在进行算法设计，最多重传16次，超过就丢弃该帧，并向高层报告   





**1.概述:**  
- 数据链路层包含两个子层：  
  - 逻辑链路控制LLC子层：很多适配器（网卡）上没有安装此协议    
  - 媒体接入控制MAC子层：   

**PS：**  
1.集线器工作在物理层，带宽共享，不安全

2.使用集线器的以太网标准：10BASE-T：10兆带宽，传输的是基带信号，T表示是双绞线联网，FX表示光纤   

3.信道利用率：数据传输时间占帧（重传时延+发送数据时间+发送时延τ）的比值  
实际使用以τ/数据的发送时间（T0）比值为信道利用率，越小则越早可以检测出冲突 ，最大值为1/（1+a）,其中a=τ/T0   

4.**MAC层：**  
- 1.MAC层的硬件地址  
局域网中硬件地址也称为物理地址或者MAC地址  
MAC地址由48位的二进制位唯一确定(显示为12位16进制)，24（代表生产厂家）+24(厂家支配)    电脑显示：cmd -> ipconfig /all   显示电脑的MAC地址  

- 2.适配器检查MAC地址  
适配器收到网络中的MAC帧，检查是不是发给自己的，时就接受，不是就丢弃  

- 3.帧种类：
单播帧（一对一）  
广播帧（一对全体） 目标MAC地址为全F或者全1的   
多播帧（一对多）  

- 4.MAC帧格式  （最少64字节）                        

![以太网帧格式]($resource/%E4%BB%A5%E5%A4%AA%E7%BD%91%E5%B8%A7%E6%A0%BC%E5%BC%8F.png)
  
  
  
**PS**   
帧间最小间隔为9.6μs

**无效的MAC地址格式：**

不满足以上条件的  

-----------

  
## 六、扩展以太网   

### 1.距离上  
使用光纤  

### 2.数量上   
将各个集线器相互连接，但是造成冲突域变大了     

![大的冲突域]($resource/%E5%A4%A7%E7%9A%84%E5%86%B2%E7%AA%81%E5%9F%9F.png)



**优化以太网**  
在数据链路层使用网桥  

**网桥：** 具有帧地址过滤功能,当网桥接受到帧，不向所有的接口发送数据帧，而是根据目标地址的MAC地址选择性的转发 ；   

当然第一次时候网桥的两个端口会逐步记住MAC地址在那边，从而在接下来的通信将根据记住的MAC地址来决定转发不转发数据 ；   

当网桥的接口变得很多的时候，网桥开始直接连接计算机，那么就变成了交换机  ；

交换机是存储转发，这样可以一次性发给很多计算机，收发同时进行，全双工通信，带宽独享；   



![网桥转发帧]($resource/%E7%BD%91%E6%A1%A5%E8%BD%AC%E5%8F%91%E5%B8%A7.png)
![交换机组网]($resource/%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%BB%84%E7%BD%91.png)


**Cisco TD**  
查看交换机的MAC地址：show ip-address-table  


---


## 七、高速以太网  
超过100M的以太网，仍使用CSMA/CD协议   


**Cisco组网3层协议：** 
接入层（直接连接计算机）
汇聚层（将接入层连接）   
核心层（将汇聚层连接）   



