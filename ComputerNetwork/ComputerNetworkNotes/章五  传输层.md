# 章五： 传输层
文章结构为：
@toc

## 一、传输层的功能   

- 基础知识：
  
  - **只有主机的协议栈才有运输层，而网络核心部分的交换机只有下三层**；
    
  - 传输层为相互通信的应用进程（程序）提供了逻辑通信；     
即如何让发送端的应用程序找到另一个计算机的应用程序，通过TCP加端口来找到应用程序     
  - **IP协议提供了主机之间的逻辑通信**    
  - **TCP和UDP提供了应用进程之间的端到端的逻辑通信**    
  - **通信的真正端点是主机中的进程**
一个数据包大小最大为65535个字节，因为数据包中数据范围为46-1500字节，真正数据最大为1480字节。   


- 传输层的功能：
  - 复用：发送方不同的应用进程都可以使用同一个运输层协议进行传送数据；
  - 分用：接收方的运输层在剥去报文的首部后可以将数据正确的交付目的应用进程；
  - 差错检验：因为网络层IP数据报的首部中检验和字段，只检验首部是否出错，不检查数据部分；

- 传输层和应用层协议之间的关系：   

  - 运输层使用协议端口号，（抽象的协议端口，这是一种软件端口），本质上是应用层的各种协议进程与运输实体进行层间交互的一种地址；
  - 当运输层收到IP层交上来的运输层报文的时候，能够根据其首部中的目的端口号把数据交付应用层的目的应用进程
  - 端口号经具有本地意义，仅仅为标识本计算机应用层中各个进程在和运输层交互时候的层间接口。

- 常见的应用层协议使用的端口   

等价于| 端口  
----|--- 
http |TCP+80端口   
https |TCP+443端口  
RDP | TCP+3389端口  
ftp | TCP+21端口   
共享文件夹  |TCP+445端口  
SMTP | TCP+25端口  
POP3 | TCP+110端口  
telent | TCP+23端口  
SQL | TCP+1433端口  
DNS | UDP+53端口


   - 服务和应用层之间的关系：  
安装了左边的协议，就会使用右边进行侦听客户端请求， 客户端使用IP地址定位服务器，使用目标端口定位服务 ，同时可以再服务器网卡上设置只开放必要的端口，实现服务器端的安全
  
  - 如何在windows上安装服务  
安装windows组件，然后查看端口就可以看出来安装了那些服务   

  - 如何查看服务侦听的端口
 
命令|作用  
---|---
netstat -n |  查看建立的回话    
netstat -an |   
netstat -nb  | 查看建立回话的进程与进程名        
netstat -anb  | 查看建立会话进程具体端口与进程名   

可以使用端口扫描工具，进行特定网段的端口扫描，从而判断相对应的开启了什么服务，对应看看哪些漏洞   


  - 如何更改服务使用默认的端口   
可以迷惑入侵者，使系统更加安全；   

  - 如何设置windows网络安全   
通过设置本地连接的TCP/IP筛选，








## 二、传输层协议UDP和TCP   

- 两个对等传输实体在通信时传送的数据单位：运输协议数据单元TPDU
  - 分别为：TCP报文段  UDP用户数据报

![使用UDP和TCP协议的各种应用和应用层协议]($resource/%E4%BD%BF%E7%94%A8UDP%E5%92%8CTCP%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%90%84%E7%A7%8D%E5%BA%94%E7%94%A8%E5%92%8C%E5%BA%94%E7%94%A8%E5%B1%82%E5%8D%8F%E8%AE%AE.png)




### （一）TCP：传输控制协议  

- **1.TCP主要特点**   
  - 面向连接的传输层协议，通讯之前建立连接；     
  - 只能点到点的连接；实现通讯：IP地址+端口=套接字        
  - 提供可靠交付的服务；   
  - 提供全双工通信，例如传输之间需要反馈；   
  - 面向字节流；   
  - 实现拥塞控制（网络），流量控制；   
  - 不提供广播或者多播服务；

   需要将要传输的文件分段传输，需要**建立回话**，可以实现**可靠传输**与**流量控制**功能。
例如:QQ聊天传输较大的文件；电邮，文件共享，下载


- **2.TCP 的连接**

  - 每一条TCP连接的两个端点是**套接字或插口**
  - 套接字socket = {IP地址：端口号}
  - 每一条TCP连接唯一地被通信两端的两个端点（即两个套接字）多确定； 即：TCP连接 ::= {socket1,socket2} = {(IP1:port1),(IP2:port2)}


- **3.TCP可靠传输的实现**   

  使用 **停止等待协议ARQ:** 简单但是信道利用率太低； 
  分为两种情况：正常情况和非正常（确认丢失和确认迟到）   


  - **正常的情况：**
    - 停止等待：每发送完一个分组之后 就停止发送，等待对方的确认。在收到确认后再发送下一个分组

   ![可靠传输-停止等待协议]($resource/%E5%8F%AF%E9%9D%A0%E4%BC%A0%E8%BE%93-%E5%81%9C%E6%AD%A2%E7%AD%89%E5%BE%85%E5%8D%8F%E8%AE%AE.png)


    - 超时重传：发一个数据包，回复一个确认，超过一段时间（一个来回时间）没有收到确认，再次发送
      - 三点：在没有收到确认之前发送方必须暂时保留已发送分组的副本
      - 发送的确认的分组必须有编号
      - 超时计时器设置的时间比数据在分组传输的；平均往返时间略长

---
   - **确认丢失和确认迟到**
      - A没有收到确认，会重新发送；然后B收到还是原来的分组M1，首先会**丢弃这个重复的分组**，然后向A发送确认。
      - 这种可靠传输协议常称为：**自动重传请求ARQ**，这种重传的请求是自动进行，不需要接收方发送重新发送的请求。
  
  ![可靠传输-丢失]($resource/%E5%8F%AF%E9%9D%A0%E4%BC%A0%E8%BE%93-%E4%B8%A2%E5%A4%B1.png)
      

- **4.提高信道利用率**
  - 方案：使用连续ARP协议和滑动窗口协议

    - 为了提高信道利用率，可以采用 **连续ARQ协议** ，可以采用发送方连续发送多个分组，即流水线传输；（可能发送到第10个包才收到第一个包的确认信息）    
这里需要发送方固定一个一定长度的发送窗口，则该窗口长度内的数据可以不用等待进行连续发送，当发送完后收到第一个数据包的确认信息，则该窗口向右移动一个，则新纳入发射窗口的数据包可以发送，以此类推。   

 - **累积ARQ协议**  接收端每隔一定数据包时间返回一个确认，例如收到1 2 3数据包，接收端只需要发送收到数据包3，即表示收到前面连续的3个数据包。缺点就是:重传数据包数量可能会多余实际丢失的数据包个数。    


### （二）TCP报文段的首部格式

![TCP报文段的首部格式]($resource/TCP%E6%8A%A5%E6%96%87%E6%AE%B5%E7%9A%84%E9%A6%96%E9%83%A8%E6%A0%BC%E5%BC%8F.png)

  - 序号：在一个TCP连接中传送的字节流的每一个字节都按照顺序编号
  - 确认号：期望收到**对方下一个报文段的第一个数据字节的序号** ；例如发送序号字段值为401.数据长度为200（401- 600）。则确认号为601
  - 数据偏移：指出了TCP报文段的数据起始处距离TCP报文段的起始处有多远，实际上就是TCP报文段的首部长度。
  - 紧急URG：值为1的时候表示此报文段中有紧急数据，会尽快发送，不按照原来的排队顺序，TCP会将紧急数据放在本数据报的最前面，后边仍然是普通数据；后面的紧急指针指出了紧急数据的末尾在数据段中的位置。
  - 窗口：值为（0 ~ 2^16 - 1）之间的整数，此窗口指发送本报文段的一方的接受窗口； 该值为了告诉发送方：**从本报文段首部中的确认号算起，接收方目前允许对方发送的数据量（以字节为单位）**，因为接收方的缓存空间是有限的。**窗口值作为接收方让发送方设置其发送窗口的依据**  
    - 窗口值是经常动态变化的；


  - 选项中有一项：MSS（最大报文段长度），规定每一个TCP报文段中的数据字段的最大长度；






### （三）TCP的流量控制   
  为了让发送方的发送速率不要太快，要让接收方来得及接受
    - 当接收端的缓存满了，处理不多来的时候，发送一个数据给发送端，则发送端接受到这个数据包后会停止发送时数据，当接收端的缓存清空之后（处理完之后），就会再次放送一个数据包给发送端，这样在进行数据通信    

   - 通信之前建立回话的时候接收端会告诉发送端自己的接受窗口大小，在通信过程之后发送端在发送确认消息的同时会发送现在接受窗口的大小还有多大。



### （四）TCP的拥塞控制    

拥塞一般指网络的拥塞，容易发生丢包现象；防止过多的数据注入到网络中，不至于路由器和链路过载。这是一个全局性过程：涉及到全部的主机、路由器等等。
流量控制一般是端到端的控制；
一般是因为某个节点缓存的容量太小时候，到达的分组没有存储空间从而不得不丢弃。当然简单的增加该节点的存储空间没用，因为存储量变大，只会造成分组再此排队，等到处理的时候已经超时了，需要重传；
   ![拥塞原理图](http://note.youdao.com/noteshare?id=583525b0a3fcc950f9c7b56d82b5b665&sub=8688F2322CB247EE823EFF97BFD29803)
    
   ![拥塞算法](http://note.youdao.com/noteshare?id=583525b0a3fcc950f9c7b56d82b5b665&sub=8688F2322CB247EE823EFF97BFD29803)     
    
    
    

### （五）TCP的运输连接管理  

- 传输连接三个阶段：建立连接、数据连接、连接释放。    
- TCP连接的建立都是采用**客户服务器方式**。    
 **客户：** 主动发起连接建立的应用进程；    
  **服务器：** 被动等待连接的应用进程；    
  
![TCP建立连接](http://note.youdao.com/noteshare?id=583525b0a3fcc950f9c7b56d82b5b665&sub=8688F2322CB247EE823EFF97BFD29803)       
    
  - 结束通信：发送端发送一个数据包   ，其中fin=1，seq=u，请求结束通话    
    
   ![结束连接](http://note.youdao.com/noteshare?id=583525b0a3fcc950f9c7b56d82b5b665&sub=8688F2322CB247EE823EFF97BFD29803)
    
    


## 三、UDP：用户报文协议   

###  （一）UDP主要特点：     
- 发送数据之前不需要建立连接；    
- 使用尽最大努力交付，不保证可靠交付，不使用拥塞控制；  
- 面向报文的（UDP对于应用层交下来的报文，不合并不拆分，保留这些报文的边界；同样面对IP层交上来的报文，去除首部之后就原封不动的交付上层的应用进程。因此应用程序交付的报文长度要正好，防止需要IP层分片浪费资源），没有拥塞控制，适合多媒体通信；   
- 支持一对一，一对多，多对一，多对多的交互通信；   
- 首部开销小，只有8个字节；首部开销小，只有8个字节；        
- 目的主机传输层收到UDP报文后，无需给出任何确认；

### （二）UDP组成示例   

![UDP数据报首部与伪首部]($resource/UDP%E6%95%B0%E6%8D%AE%E6%8A%A5%E9%A6%96%E9%83%A8%E4%B8%8E%E4%BC%AA%E9%A6%96%E9%83%A8.jpg)

  - 源端口号：需要对方回信的时候使用，不需要的时候为全0
  - 校验和：UDP的校验和是将首部和数据部分一起都检验；TCP是只检验IP数据报的首部 
    
 当一个数据包就可以完成数据通信，不需要分段，**不需要建立回话与流量控制，并不可靠传输。**   
例如：域名解析；QQ聊天的部分文字聊天；特殊：屏幕广播，应用于多播与广播，语音，视频流





 

