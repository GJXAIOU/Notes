# 第一章：概述

# 第1章 概述

#### 1.1 引言

#### 1.2 分层

网络协议通常分不同层次进行开发，每一层分别负责不同的通信功能。**一个协议族，比如TCP/IP，是一组不同层次上的多个协议的组合。**TCP/IP通常被认为是一个四层协议系统，如图1-1所示。

![第1章 概述_TCP/IP详解卷1 协议_即时通讯网(52im.net)](http://docs.52im.net/extend/docs/book/tcpip/vol1/1/images2/52im_1.png)
图1-1 TCP/IP协议族的四个层次

每一层负责不同的功能：

1.  **链路层，有时也称作数据链路层或网络接口层，通常包括操作系统中的设备驱动程序和计算机中对应的网络接口卡。**它们一起处理与电缆（或其他任何传输媒介）的物理接口细节。
2.  网络层，有时也称作互联网层，处理分组在网络中的活动，例如分组的选路。在TCP/IP协议族中，**网络层协议包括IP协议（网际协议），ICMP协议（Internet互联网控制报文协议），以及IGMP协议（Internet组管理协议）。**
3.  运输层主要为两台主机上的应用程序提供端到端的通信。在TCP/IP协议族中，有两个互不相同的传输协议：TCP（传输控制协议）和UDP（用户数据报协议）。

   TCP为两台主机提供高可靠性的数据通信。它所做的工作包括把应用程序交给它的数据分成合适的小块交给下面的网络层，确认接收到的分组，设置发送最后确认分组的超时时钟等。由于运输层提供了高可靠性的端到端的通信，因此应用层可以忽略所有这些细节。

   而另一方面，UDP则为应用层提供一种非常简单的服务。它只是把称作数据报的分组从一台主机发送到另一台主机，但并不保证该数据报能到达另一端。任何必需的可靠性必须由应用层来提供。
    这两种运输层协议分别在不同的应用程序中有不同的用途，这一点将在后面看到。
4.  应用层负责处理特定的应用程序细节。几乎各种不同的TCP/IP实现都会提供下面这些通用的应用程序：

   • Telnet远程登录。
    • FTP文件传输协议。
    • SMTP简单邮件传送协议。
    • SNMP简单网络管理协议。 


另外还有许多其他应用，在后面章节中将介绍其中的一部分。假设在一个局域网（LAN）如以太网中有两台主机，二者都运行FTP协议，图1-2列出了该过程所涉及到的所有协议。

![图1-2 局域网上运行FTP的两台主机](http://docs.52im.net/extend/docs/book/tcpip/vol1/1/images2/52im_2.png)




**在同一层上，双方都有对应的一个或多个协议进行通信。**例如，某个协议允许TCP层进行通信，而另一个协议则允许两个IP层进行通信。

在图1-2的右边，我们注意到应用程序通常是一个用户进程，而下三层则一般在（操作系统）内核中执行。尽管这不是必需的，但通常都是这样处理的，例如UNIX操作系统。

在图1-2中，顶层与下三层之间还有另一个关键的不同之处。应用层关心的是应用程序的细节，而不是数据在网络中的传输活动。下三层对应用程序一无所知，但它们要处理所有的通信细节。

在图1-2中列举了四种不同层次上的协议。FTP是一种应用层协议，TCP是一种运输层协议，IP是一种网络层协议，而以太网协议则应用于链路层上。TCP/IP协议族是一组不同的协议组合在一起构成的协议族。尽管通常称该协议族为TCP/IP，但TCP和IP只是其中的两种协议而已（该协议族的另一个名字是Internet协议族(Internet Protocol Suite)）。

网络接口层和应用层的目的是很显然的——前者处理有关通信媒介的细节（以太网、令牌环网等），而后者处理某个特定的用户应用程序（FTP、Telnet等）。但是，从表面上看，网络层和运输层之间的区别不那么明显。为什么要把它们划分成两个不同的层次呢？为了理解这一点，我们必须把视野从单个网络扩展到一组网络。


**路由器的好处是为不同类型的物理网络提供连接**：以太网、令牌环网、点对点的链接和FDDI（光纤分布式数据接口）等等。


图1-3是一个包含两个网络的互连网：一个以太网和一个令牌环网，通过一个路由器互相连接。尽管这里是两台主机通过路由器进行通信，实际上以太网中的任何主机都可以与令牌环网中的任何主机进行通信。

在图1-3中，我们可以划分出端系统（End system）（两边的两台主机）和中间系统（Intermediate system）（中间的路由器）。**应用层和运输层使用端到端（End-to-end）协议**。在图中，只有端系统需要这两层协议。但是，**网络层提供的却是逐跳（Hop-by-hop）协议**，两个端系统和每个中间系统都要使用它。


![图1-3 通过路由器连接的两个网络]($resource/52im_3.png)

![令牌环]($resource/%E4%BB%A4%E7%89%8C%E7%8E%AF.png)

**令牌环**：在该网络中，有一个专门的帧叫做“令牌”，在环路上持续的传输来确定一个节点何时可以发送包。

在TCP/IP协议族中，**网络层IP提供的是一种不可靠的服务**。也就是说，它只是尽可能快地把分组从源结点送到目的结点，但是并不提供任何可靠性保证。而另一方面，**TCP在不可靠的IP层上提供了一个可靠的运输层。**为了提供这种可靠的服务，TCP采用了超时重传、发送和接收端到端的确认分组等机制。由此可见，运输层和网络层分别负责不同的功能。


连接网络的另一个途径是使用网桥。**网桥是在链路层上对网络进行互连，而路由器则是在网络层上对网络进行互连。网桥使得多个局域网（LAN）组合在一起**，这样对上层来说就好像是一个局域网。


#### 1.3 TCP/IP的分层

在TCP/IP协议族中，有很多种协议。图1-4给出了本书将要讨论的其他协议。

[![图1-4 TCP/IP协议族中不同层次的协议](http://docs.52im.net/extend/docs/book/tcpip/vol1/1/images2/52im_4.png)]



TCP和UDP是两种最为著名的运输层协议，二者都使用IP作为网络层协议。



**UDP为应用程序发送和接收数据报。一个数据报是指从发送方传输到接收方的一个信息单元（例如，发送方指定的一定字节数的信息）。**但是与TCP不同的是，UDP是不可靠的，它不能保证数据报能安全无误地到达最终目的。

IP是网络层上的主要协议，同时被TCP和UDP使用。TCP和UDP的每组数据都通过端系统和每个中间路由器中的IP层在互联网中进行传输。在图1-4中，我们给出了一个直接访问IP的应用程序。这是很少见的，但也是可能的（一些较老的选路协议就是以这种方式来实现的。当然新的运输层协议也有可能使用这种方式）。

**ICMP是IP协议的附属协议。IP层用它来与其他主机或路由器交换错误报文和其他重要信息。**
**IGMP是Internet组管理协议。它用来把一个UDP数据报多播到多个主机。**

ARP（地址解析协议）和RARP（逆地址解析协议）是某些网络接口（如以太网和令牌环网）使用的特殊协议，用来转换IP层和网络接口层使用的地址。


#### 1.4 互联网的地址

IP地址长32 bit，五类不同的互联网地址格式如图1-5所示。

![图1-5 五类互联网地址](http://docs.52im.net/extend/docs/book/tcpip/vol1/1/images2/52im_5.png)

[IP地址划分方法](ip地址与子网划分)

需要再次指出的是，多接口主机具有多个IP地址，其中每个接口都对应一个IP地址。

[![第1章 概述_TCP/IP详解卷1 协议_即时通讯网(52im.net)](http://docs.52im.net/extend/docs/book/tcpip/vol1/1/images2/52im_6.png)
图1-6 各类IP地址的范围

**有三类IP地址：单播地址（目的为单个主机）、广播地址（目的端为给定网络上的所有主机）以及多播地址（目的端为同一组内的所有主机）**
图3-9给出了几个特殊的IP地址：**主机号和网络号为全0或全1。**

#### 1.5 域名系统

**域名系统（DNS）是一个分布的数据库**，由它来提供IP地址和主机名之间的映射信息。

#### 1.6 封装

**以太网数据帧的物理特性是其长度必须在46～1500字节之间**（数据包的大小）。

图1-7中**IP和网络接口层之间传送的数据单元应该是分组（packet）**。**分组既可以是一个IP数据报，也可以是IP数据报的一个片（fragment）**。

[![第1章 概述_TCP/IP详解卷1 协议_即时通讯网(52im.net)](http://docs.52im.net/extend/docs/book/tcpip/vol1/1/images2/52im_7.png)]

图1-7 数据进入协议栈时的封装过程

UDP数据与TCP数据基本一致。**唯一的不同是UDP传给IP的信息单元称作UDP数据报（UDP datagram），而且UDP的首部长为8字节。**

回想1.3节中的图1-4，由于TCP、UDP、ICMP和IGMP都要向IP传送数据，因此IP必须在生成的IP首部中加入某种标识，以表明数据属于哪一层。为此**，IP在首部中存入一个长度为8bit的数值，称作协议域。1表示为ICMP协议，2表示为IGMP协议，6表示为TCP协议，17表示为UDP协议。**

类似地，许多应用程序都可以使用TCP或UDP来传送数据。运输层协议在生成报文首部时要存入一个应用程序的标识符。TCP和UDP都用一个16bit的端口号来表示不同的应用程序。**TCP和UDP把源端口号和目的端口号分别存入报文首部中。**

网络接口分别要发送和接收IP、ARP和RARP数据，因此也必须在以太网的帧首部中加入某种形式的标识，以指明生成数据的网络层协议。为此，**以太网的帧首部也有一个16 bit的帧类型域。**



#### 1.7 分用

当目的主机收到一个以太网数据帧时，数据就开始从协议栈中由底向上升，同时去掉各层协议加上的报文首部。每层协议盒都要去检查报文首部中的协议标识，以确定接收数据的上层协议。这个过程称作分用（Demultiplexing），图1-8显示了该过程是如何发生的。

[![第1章 概述_TCP/IP详解卷1 协议_即时通讯网(52im.net)](http://docs.52im.net/extend/docs/book/tcpip/vol1/1/images2/52im_8.png)
图1-8以太网数据帧的分用过程

为协议ICMP和IGMP定位一直是一件很棘手的事情。在图1-4中，把它们与IP放在同一层上，那是因为事实上它们是IP的附属协议。但是在这里，我们又把它们放在IP层的上面，**这是因为ICMP和IGMP报文都被封装在IP数据报中。**

对于ARP和RARP，我们也遇到类似的难题。在这里把它们放在以太网设备驱动程序的上方，这是因为它们和IP数据报一样，都有各自的以太网数据帧类型。但在图2-4中，我们又把ARP作为以太网设备驱动程序的一部分，放在IP层的下面，其原因在逻辑上是合理的。

#### 1.8 客户-服务器模型

大部分网络应用程序在编写时都假设一端是客户，另一端是服务器，其目的是为了让服务器为客户提供一些特定的服务。

可以将这种**服务分为两种类型：重复型或并发型。重复型服务器通过以下步骤进行交互：**

1.  I1.等待一个客户请求的到来。
2.  I2.处理客户请求。
3.  I3.发送响应给发送请求的客户。
4.  I4.返回I1步。

重复型服务器主要的问题发生在I2状态。在这个时候，它不能为其他客户机提供服务。相应地，并发型服务器采用以下步骤：

1.  C1.等待一个客户请求的到来。
2.  C2.启动一个新的服务器来处理这个客户的请求。在这期间可能生成一个新的进程、任务或线程，并依赖底层操作系统的支持。这个步骤如何进行取决于操作系统。生成的新服务器对客户的全部请求进行处理。处理结束后，终止这个新服务器。
3.  C3.返回C1步。

并发服务器的优点在于它是利用生成其他服务器的方法来处理客户的请求。也就是说，每个客户都有它自己对应的服务器。

一般来说，TCP服务器是并发的，而UDP服务器是重复的，但也存在一些例外。

#### 1.9 端口号

前面已经指出过，TCP和UDP采用16 bit的端口号来识别应用程序。那么这些端口号是如何选择的呢？

服务器一般都是通过知名端口号来识别的。例如，对于每个TCP/IP实现来说，FTP服务器的TCP端口号都是21，每个Telnet服务器的TCP端口号都是23，每个TFTP(简单文件传送协议)服务器的UDP端口号都是69。任何TCP/IP实现所提供的服务都用知名的1～1023之间的端口号。这些知名端口号由Internet号分配机构（Internet Assigned Numbers Authority, IANA）来管理。


大多数TCP/IP实现给临时端口分配1024～5000之间的端口号。大于5000的端口号是为其他服务器预留的（Internet上并不常用的服务)。

大多数Unix系统的文件/etc/services都包含了人们熟知的端口号。为了找到Telnet服务器和域名系统的端口号，可以运行以下语句：

[![第1章 概述_TCP/IP详解卷1 协议_即时通讯网(52im.net)](http://docs.52im.net/extend/docs/book/tcpip/vol1/1/images2/52im_9.png)](http://www.52im.net/ "即时通讯网 - 即时通讯开发者社区！")

Unix系统有保留端口号的概念。只有具有超级用户特权的进程才允许给它自己分配一个保留端口号。

#### 1.10 标准化过程

#### 1.11 RFC

所有关于Internet的正式标准都以RFC（Request for Comment）文档出版。另外，大量的RFC并不是正式的标准，出版的目的只是为了提供信息。


#### 1.12 标准的简单服务

当使用TCP和UDP提供相同的服务时，一般选择相同的端口号。

[![第1章 概述_TCP/IP详解卷1 协议_即时通讯网(52im.net)](http://docs.52im.net/extend/docs/book/tcpip/vol1/1/images2/52im_10.png)]

图1-9大多数实现都提供的标准的简单服务



如果仔细检查这些标准的简单服务以及其他标准的TCP/IP服务（如Telnet、FTP、SMTP等）的端口号时，我们发现它们都是奇数。这是有历史原因的，因为这些端口号都是从NCP端口号派生出来的（NCP，即网络控制协议，是ARPANET的运输层协议，是TCP的前身）。NCP是单工的，不是全双工的，因此每个应用程序需要两个连接，需预留一对奇数和偶数端口号。当TCP和UDP成为标准的运输层协议时，每个应用程序只需要一个端口号，因此就使用了NCP中的奇数。

#### 1.13 互联网

#### 1.14 实现

#### 1.15 应用编程接口

**使用TCP/IP协议的应用程序通常采用两种应用编程接口（API）：socket和TLI**（运输层接口：Transport Layer Interface）。


#### 1.16 测试网络

图1-11是本书中所有的例子运行的测试网络。为阅读时参考方便，该图还复制在本书扉页前的插页中。

[![第1章 概述_TCP/IP详解卷1 协议_即时通讯网(52im.net)](http://docs.52im.net/extend/docs/book/tcpip/vol1/1/images2/52im_12.png)]

#### 1.17 小结

- TCP/IP协议族分为四层：链路层、网络层、运输层和应用层，每一层各有不同的责任。
- 在TCP/IP中，网络层和运输层之间的区别是最为关键的：
- 网络层（IP）提供点到点的服务，而运输层（TCP和UDP）提供端到端的服务。

- 在一个互联网上，每个接口都用IP地址来标识，尽管用户习惯使用主机名而不是IP地址。域名系统为主机名和IP地址之间提供动态的映射。端口号用来标识互相通信的应用程序。服务器使用知名端口号，而客户使用临时设定的端口号。


