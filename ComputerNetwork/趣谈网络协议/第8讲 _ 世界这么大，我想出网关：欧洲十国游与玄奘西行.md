# 第8讲 \| 世界这么大，我想出网关：欧洲十国游与玄奘西行

<audio><source src="https://static001.geekbang.org/resource/audio/fb/b1/fb36e0987432e257d1226e874a77bab1.mp3" type="audio/mpeg"></audio>

前几节，我主要跟你讲了宿舍里和办公室里用到的网络协议。你已经有了一些基础，是时候去外网逛逛了！

## 怎么在宿舍上网？

还记得咱们在宿舍的时候买了台交换机，几台机器组了一个局域网打游戏吗？可惜啊，只能打局域网的游戏，不能上网啊！盼啊盼啊，终于盼到大二，允许宿舍开通网络了。学校给每个宿舍的网口分配了一个IP地址。这个IP是校园网的IP，完全由网管部门控制。宿舍网的IP地址多为192.168.1.x。校园网的IP地址，假设是10.10.x.x。

这个时候，你要在宿舍上网，有两个办法：

第一个办法，让你们宿舍长再买一个网卡。这个时候，你们宿舍长的电脑里就有两张网卡。一张网卡的线插到你们宿舍的交换机上，另一张网卡的线插到校园网的网口。而且，这张新的网卡的IP地址要按照学校网管部门分配的配置，不然上不了网。**这种情况下，如果你们宿舍的人要上网，就需要一直开着宿舍长的电脑。**

第二个办法，你们共同出钱买个家庭路由器（反正当时我们买不起）。家庭路由器会有内网网口和外网网口。把外网网口的线插到校园网的网口上，将这个外网网口配置成和网管部的一样。内网网口连上你们宿舍的所有的电脑。**这种情况下，如果你们宿舍的人要上网，就需要一直开着路由器。**

<!-- [[[read_end]]] -->

这两种方法其实是一样的。只不过第一种方式，让你的宿舍长的电脑，变成一个有多个口的路由器而已。而你买的家庭路由器，里面也跑着程序，和你宿舍长电脑里的功能一样，只不过是一个嵌入式的系统。

当你的宿舍长能够上网之后，接下来，就是其他人的电脑怎么上网的问题。这就需要配置你们的**网卡。**当然DHCP是可以默认配置的。在进行网卡配置的时候，除了IP地址，还需要配置一个**Gateway**的东西，这个就是**网关**。

## 你了解MAC头和IP头的细节吗？

一旦配置了IP地址和网关，往往就能够指定目标地址进行访问了。由于在跨网关访问的时候，牵扯到MAC地址和IP地址的变化，这里有必要详细描述一下MAC头和IP头的细节。

![](<https://static001.geekbang.org/resource/image/82/65/825e54560a6de08a32e4cab4e0f59f65.jpg?wh=2643*4029>)

在MAC头里面，先是目标MAC地址，然后是源MAC地址，然后有一个协议类型，用来说明里面是IP协议。IP头里面的版本号，目前主流的还是IPv4，服务类型TOS在第三节讲ip addr命令的时候讲过，TTL在第7节讲ICMP协议的时候讲过。另外，还有8位标识协议。这里到了下一层的协议，也就是，是TCP还是UDP。最重要的就是源IP和目标IP。先是源IP地址，然后是目标IP地址。

在任何一台机器上，当要访问另一个IP地址的时候，都会先判断，这个目标IP地址，和当前机器的IP地址，是否在同一个网段。怎么判断同一个网段呢？需要CIDR和子网掩码，这个在第三节的时候也讲过了。

**如果是同一个网段**，例如，你访问你旁边的兄弟的电脑，那就没网关什么事情，直接将源地址和目标地址放入IP头中，然后通过ARP获得MAC地址，将源MAC和目的MAC放入MAC头中，发出去就可以了。

**如果不是同一网段**，例如，你要访问你们校园网里面的BBS，该怎么办？这就需要发往默认网关Gateway。Gateway的地址一定是和源IP地址是一个网段的。往往不是第一个，就是第二个。例如192.168.1.0/24这个网段，Gateway往往会是192.168.1.1/24或者192.168.1.2/24。

如何发往默认网关呢？网关不是和源IP地址是一个网段的么？这个过程就和发往同一个网段的其他机器是一样的：将源地址和目标IP地址放入IP头中，通过ARP获得网关的MAC地址，将源MAC和网关的MAC放入MAC头中，发送出去。网关所在的端口，例如192.168.1.1/24将网络包收进来，然后接下来怎么做，就完全看网关的了。

**网关往往是一个路由器，是一个三层转发的设备。**啥叫三层设备？前面也说过了，就是把MAC头和IP头都取下来，然后根据里面的内容，看看接下来把包往哪里转发的设备。

在你的宿舍里面，网关就是你宿舍长的电脑。一个路由器往往有多个网口，如果是一台服务器做这个事情，则就有多个网卡，其中一个网卡是和源IP同网段的。

很多情况下，人们把网关就叫做路由器。其实不完全准确，而另一种比喻更加恰当：**<span class="orange">路由器是一台设备，它有五个网口或者网卡，相当于有五只手，分别连着五个局域网。每只手的IP地址都和局域网的IP地址相同的网段，每只手都是它握住的那个局域网的网关。</span>

**

任何一个想发往其他局域网的包，都会到达其中一只手，被拿进来，拿下MAC头和IP头，看看，根据自己的路由算法，选择另一只手，加上IP头和MAC头，然后扔出去。

## 静态路由是什么？

这个时候，问题来了，该选择哪一只手？IP头和MAC头加什么内容，哪些变、哪些不变呢？这个问题比较复杂，大致可以分为两类，一个是**静态路由**，一个是**动态路由**。动态路由下一节我们详细地讲。这一节我们先说静态路由。

**静态路由，其实就是在路由器上，配置一条一条规则。**这些规则包括：想访问BBS站（它肯定有个网段），从2号口出去，下一跳是IP2；想访问教学视频站（它也有个自己的网段），从3号口出去，下一跳是IP3，然后保存在路由器里。

每当要选择从哪只手抛出去的时候，就一条一条的匹配规则，找到符合的规则，就按规则中设置的那样，从某个口抛出去，找下一跳IPX。

## IP头和MAC头哪些变、哪些不变？

对于IP头和MAC头哪些变、哪些不变的问题，可以分两种类型。我把它们称为“**欧洲十国游”型**和“**玄奘西行”型**。

之前我说过，MAC地址是一个局域网内才有效的地址。因而，MAC地址只要过网关，就必定会改变，因为已经换了局域网。两者主要的区别在于IP地址是否改变。不改变IP地址的网关，我们称为**转发网关；**改变IP地址的网关，我们称为**NAT网关**。

### “欧洲十国游”型

结合这个图，我们先来看“欧洲十国游”型。

![](<https://static001.geekbang.org/resource/image/1d/8c/1d604f88456096a73e40437d8f9e458c.jpg?wh=2579*1223>)

服务器A要访问服务器B。首先，服务器A会思考，192.168.4.101和我不是一个网段的，因而需要先发给网关。那网关是谁呢？已经静态配置好了，网关是192.168.1.1。网关的MAC地址是多少呢？发送ARP获取网关的MAC地址，然后发送包。包的内容是这样的：

- 源MAC：服务器A的MAC

- 目标MAC：192.168.1.1这个网口的MAC

- 源IP：192.168.1.101

- 目标IP：192.168.4.101


<!-- -->

包到达192.168.1.1这个网口，发现MAC一致，将包收进来，开始思考往哪里转发。

在路由器A中配置了静态路由之后，要想访问192.168.4.0/24，要从192.168.56.1这个口出去，下一跳为192.168.56.2。

于是，路由器A思考的时候，匹配上了这条路由，要从192.168.56.1这个口发出去，发给192.168.56.2，那192.168.56.2的MAC地址是多少呢？路由器A发送ARP获取192.168.56.2的MAC地址，然后发送包。包的内容是这样的：

- 源MAC：192.168.56.1的MAC地址

- 目标MAC：192.168.56.2的MAC地址

- 源IP：192.168.1.101

- 目标IP：192.168.4.101


<!-- -->

包到达192.168.56.2这个网口，发现MAC一致，将包收进来，开始思考往哪里转发。

在路由器B中配置了静态路由，要想访问192.168.4.0/24，要从192.168.4.1这个口出去，没有下一跳了。因为我右手这个网卡，就是这个网段的，我是最后一跳了。

于是，路由器B思考的时候，匹配上了这条路由，要从192.168.4.1这个口发出去，发给192.168.4.101。那192.168.4.101的MAC地址是多少呢？路由器B发送ARP获取192.168.4.101的MAC地址，然后发送包。包的内容是这样的：

- 源MAC：192.168.4.1的MAC地址

- 目标MAC：192.168.4.101的MAC地址

- 源IP：192.168.1.101

- 目标IP：192.168.4.101


<!-- -->

包到达服务器B，MAC地址匹配，将包收进来。

通过这个过程可以看出，每到一个新的局域网，MAC都是要变的，但是IP地址都不变。在IP头里面，不会保存任何网关的IP地址。**所谓的下一跳是，某个IP要将这个IP地址转换为MAC放入MAC头。**

之所以将这种模式比喻称为欧洲十国游，是因为在整个过程中，IP头里面的地址都是不变的。IP地址在三个局域网都可见，在三个局域网之间的网段都不会冲突。在三个网段之间传输包，IP头不改变。这就像在欧洲各国之间旅游，一个签证就能搞定。

![](<https://static001.geekbang.org/resource/image/35/3b/35fb548bbaa7d77012ab46151bfbe63b.jpg?wh=2579*1223>)

### “玄奘西行”型

我们再来看“玄奘西行”型。

这里遇见的第一个问题是，局域网之间没有商量过，各定各的网段，因而IP段冲突了。最左面大唐的地址是192.168.1.101，最右面印度的地址也是192.168.1.101，如果单从IP地址上看，简直是自己访问自己，其实是大唐的192.168.1.101要访问印度的192.168.1.101。

怎么解决这个问题呢？既然局域网之间没有商量过，你们各管各的，那到国际上，也即中间的局域网里面，就需要使用另外的地址。就像出国，不能用咱们自己的身份证，而要改用护照一样，玄奘西游也要拿着专门取经的通关文牒，而不能用自己国家的身份证。

首先，目标服务器B在国际上要有一个国际的身份，我们给它一个192.168.56.2。在网关B上，我们记下来，国际身份192.168.56.2对应国内身份192.168.1.101。凡是要访问192.168.56.2，都转成192.168.1.101。

于是，源服务器A要访问目标服务器B，要指定的目标地址为192.168.56.2。这是它的国际身份。服务器A想，192.168.56.2和我不是一个网段的，因而需要发给网关，网关是谁？已经静态配置好了，网关是192.168.1.1，网关的MAC地址是多少？发送ARP获取网关的MAC地址，然后发送包。包的内容是这样的：

- 源MAC：服务器A的MAC

- 目标MAC：192.168.1.1这个网口的MAC

- 源IP：192.168.1.101

- 目标IP：192.168.56.2


<!-- -->

包到达192.168.1.1这个网口，发现MAC一致，将包收进来，开始思考往哪里转发。

在路由器A中配置了静态路由：要想访问192.168.56.2/24，要从192.168.56.1这个口出去，没有下一跳了，因为我右手这个网卡，就是这个网段的，我是最后一跳了。

于是，路由器A思考的时候，匹配上了这条路由，要从192.168.56.1这个口发出去，发给192.168.56.2。那192.168.56.2的MAC地址是多少呢？路由器A发送ARP获取192.168.56.2的MAC地址。

当网络包发送到中间的局域网的时候，服务器A也需要有个国际身份，因而在国际上，源IP地址也不能用192.168.1.101，需要改成192.168.56.1。发送包的内容是这样的：

- 源MAC：192.168.56.1的MAC地址

- 目标MAC：192.168.56.2的MAC地址

- 源IP：192.168.56.1

- 目标IP：192.168.56.2


<!-- -->

包到达192.168.56.2这个网口，发现MAC一致，将包收进来，开始思考往哪里转发。

路由器B是一个NAT网关，它上面配置了，要访问国际身份192.168.56.2对应国内身份192.168.1.101，于是改为访问192.168.1.101。

在路由器B中配置了静态路由：要想访问192.168.1.0/24，要从192.168.1.1这个口出去，没有下一跳了，因为我右手这个网卡，就是这个网段的，我是最后一跳了。

于是，路由器B思考的时候，匹配上了这条路由，要从192.168.1.1这个口发出去，发给192.168.1.101。

那192.168.1.101的MAC地址是多少呢？路由器B发送ARP获取192.168.1.101的MAC地址，然后发送包。内容是这样的：

- 源MAC：192.168.1.1的MAC地址

- 目标MAC：192.168.1.101的MAC地址

- 源IP：192.168.56.1

- 目标IP：192.168.1.101


<!-- -->

包到达服务器B，MAC地址匹配，将包收进来。

从服务器B接收的包可以看出，源IP为服务器A的国际身份，因而发送返回包的时候，也发给这个国际身份，由路由器A做NAT，转换为国内身份。

从这个过程可以看出，IP地址也会变。这个过程用英文说就是**Network Address Translation**，简称**NAT**。

其实这第二种方式我们经常见，现在大家每家都有家用路由器，家里的网段都是192.168.1.x，所以你肯定访问不了你邻居家的这个私网的IP地址的。所以，当我们家里的包发出去的时候，都被家用路由器NAT成为了运营商的地址了。

很多办公室访问外网的时候，也是被NAT过的，因为不可能办公室里面的IP也是公网可见的，公网地址实在是太贵了，所以一般就是整个办公室共用一个到两个出口IP地址。你可以通过 [https://www.whatismyip.com/](<https://www.whatismyip.com/>) 查看自己的出口IP地址。

## 小结

好了，这一节内容差不多了，我来总结一下：

- 如果离开本局域网，就需要经过网关，网关是路由器的一个网口；

- 路由器是一个三层设备，里面有如何寻找下一跳的规则；

- 经过路由器之后MAC头要变，如果IP不变，相当于不换护照的欧洲旅游，如果IP变，相当于换护照的玄奘西行。


<!-- -->

最后，给你留两个思考题吧。

1. 当在你家里要访问163网站的时候，你的包需要NAT成为公网IP，返回的包又要NAT成你的私有IP，返回包怎么知道这是你的请求呢？它怎么就这么智能的NAT成了你的IP而非别人的IP呢？
2. 对于路由规则，这一节讲述了静态路由，需要手动配置，如果要自动配置，你觉得应该怎么办呢？

<!-- -->

欢迎你留言和我讨论。趣谈网络协议，我们下期见！

## 精选留言(181)

- ![img](%E7%AC%AC8%E8%AE%B2%20_%20%E4%B8%96%E7%95%8C%E8%BF%99%E4%B9%88%E5%A4%A7%EF%BC%8C%E6%88%91%E6%83%B3%E5%87%BA%E7%BD%91%E5%85%B3%EF%BC%9A%E6%AC%A7%E6%B4%B2%E5%8D%81%E5%9B%BD%E6%B8%B8%E4%B8%8E%E7%8E%84%E5%A5%98%E8%A5%BF%E8%A1%8C.resource/resize,m_fill,h_34,w_34.jpeg)

  lh

  老师，你在第二种情况说，网关B上记下来，国际身份192.168.56.2对应国内身份192.168.1.101。那么如果该局域网内还有很多其他机器，比如192.168.1.102，103等等，它们对应的国际身份呢？如果也是192.168.56.2，那么从192.168.56.1发来请求时，网关B要将该消息转发到哪个国内身份呢？

  2018-06-04

  **13

  **152

- ![img](%E7%AC%AC8%E8%AE%B2%20_%20%E4%B8%96%E7%95%8C%E8%BF%99%E4%B9%88%E5%A4%A7%EF%BC%8C%E6%88%91%E6%83%B3%E5%87%BA%E7%BD%91%E5%85%B3%EF%BC%9A%E6%AC%A7%E6%B4%B2%E5%8D%81%E5%9B%BD%E6%B8%B8%E4%B8%8E%E7%8E%84%E5%A5%98%E8%A5%BF%E8%A1%8C.resource/resize,m_fill,h_34,w_34-1662307310585-4896.jpeg)

  Leon📷

  这里面留言的都是人才。知识面又广，声音又好听，我超喜欢在这个地方看评论的感觉，不看评论是不可能的，这辈子都不可能不看评论的。

  2018-10-27

  **1

  **126

- ![img](data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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)

  起风了001

  作为教程我觉得问题可以简单带过, 但是一定要点出来, 这样读者可以继续深入学习. 比如在讲西行型时, 要说明实际上网络请求是有端口号的, 服务器A请求服务器B, 虽然是用的服务器B的192.168.56.2/24这个ip左右目标ip, 但是他本身是有带上端口号, 比如端口号123, 这个端口号在路由器B上有一个NAT映射, 路由器知道123端口代表着内网主机192.188.1.101:321, 这样可以解决很多人的疑问: 内网有多台机器的时候怎么知道目标是哪一台?

  作者回复: 赞，是的

  2019-05-17

  **6

  **119

- ![img](https://static001.geekbang.org/account/avatar/00/12/a2/a0/0aaa34e4.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Malcolm

  这一节讲的特别不清楚，对于懂的人来说当然懂，对于初学者来说，这节有点故弄玄虚了。 1.访问的外网的某个地址，怎么可能会访问某个私有ip（主机B）？ 2.NAT的TCP用一主机+端口映射，你不讲初学者怎么知道如何响应给哪台主机？

  作者回复: 比如访问学校里面的选课网站？可以先理解一对一映射的场景

  2018-09-10

  **8

  **72

- ![img](https://static001.geekbang.org/account/avatar/00/10/d6/60/f21b2164.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  jacy

  回答一下第一题，nat支持一对一转换，即一个内网ip与一个外网ip，题一需要协议支持一个外网ip对应多个内网ip，则需要napt协议支持，。协议会维护一张映射表,结构如下:        内网ip:port-->外网ip:空闲port 只要路由器空闲ip足够即可。但有个问题想请教老师，像微信这种有海量用户保持长连接的场景，路由port不够，是怎么处理的，不可能是加路由设备来处理吧？

  2018-07-05

  **13

  **69

- ![img](https://static001.geekbang.org/account/avatar/00/0f/94/c9/374a69f2.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  张爽

  NAT Gateway会以源IP+源端口的方式记录连接的NAT记录，Ping是直接调用的ICMP，不经过第四层的协议，并没有端口号，请问老师，同一内网的两台机器同时Ping百度，再收到两个应答之后，在没有端口号做区分的情况下，如何进行转发，谢谢

  作者回复: 连接维护用哈希匹配，tcp有端口的一种算法，icmp也有相应的算法

  2018-06-04

  **5

  **52

- ![img](https://static001.geekbang.org/account/avatar/00/10/69/d2/8a53f0a3.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](%E7%AC%AC8%E8%AE%B2%20_%20%E4%B8%96%E7%95%8C%E8%BF%99%E4%B9%88%E5%A4%A7%EF%BC%8C%E6%88%91%E6%83%B3%E5%87%BA%E7%BD%91%E5%85%B3%EF%BC%9A%E6%AC%A7%E6%B4%B2%E5%8D%81%E5%9B%BD%E6%B8%B8%E4%B8%8E%E7%8E%84%E5%A5%98%E8%A5%BF%E8%A1%8C.resource/resize,w_14.png)

  E

  有个地方有错误，在例子中，路由器B右边的192.168.1.0/24并不是静态路由，而是“直连网段”

  作者回复: 赞，是直连，直连也有条路由的

  2018-06-04

  **

  **32

- ![img](%E7%AC%AC8%E8%AE%B2%20_%20%E4%B8%96%E7%95%8C%E8%BF%99%E4%B9%88%E5%A4%A7%EF%BC%8C%E6%88%91%E6%83%B3%E5%87%BA%E7%BD%91%E5%85%B3%EF%BC%9A%E6%AC%A7%E6%B4%B2%E5%8D%81%E5%9B%BD%E6%B8%B8%E4%B8%8E%E7%8E%84%E5%A5%98%E8%A5%BF%E8%A1%8C.resource/resize,m_fill,h_34,w_34-1662307310586-4901.jpeg)![img](%E7%AC%AC8%E8%AE%B2%20_%20%E4%B8%96%E7%95%8C%E8%BF%99%E4%B9%88%E5%A4%A7%EF%BC%8C%E6%88%91%E6%83%B3%E5%87%BA%E7%BD%91%E5%85%B3%EF%BC%9A%E6%AC%A7%E6%B4%B2%E5%8D%81%E5%9B%BD%E6%B8%B8%E4%B8%8E%E7%8E%84%E5%A5%98%E8%A5%BF%E8%A1%8C.resource/resize,w_14.png)

  顾骨

  局域网中两台机器同时访问百度，但是出现了一个极端情况：两台机器的源端口都是一样的，回来时，网关怎么区分该发给谁呢。

  2018-06-04

  **5

  **22

- ![img](https://static001.geekbang.org/account/avatar/00/11/18/de/45875491.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](%E7%AC%AC8%E8%AE%B2%20_%20%E4%B8%96%E7%95%8C%E8%BF%99%E4%B9%88%E5%A4%A7%EF%BC%8C%E6%88%91%E6%83%B3%E5%87%BA%E7%BD%91%E5%85%B3%EF%BC%9A%E6%AC%A7%E6%B4%B2%E5%8D%81%E5%9B%BD%E6%B8%B8%E4%B8%8E%E7%8E%84%E5%A5%98%E8%A5%BF%E8%A1%8C.resource/resize,w_14.png)

  蔺波

  Nat有session,这一块需要讲的

  作者回复: 是的，会讲

  2018-07-02

  **

  **21

- ![img](https://static001.geekbang.org/account/avatar/00/11/6f/06/0e80d837.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  yunfei_lei

  对于情况二，服务器A怎么知道服务器B的国际地址的？

  2018-06-05

  **3

  **20

- ![img](https://static001.geekbang.org/account/avatar/00/0f/62/b3/edf0f4d9.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  indeyo

  回答第一个问题。老师在讲“玄奘西行游”的过程，只讲了服务器A给服务器B发包的情况，没有讲服务器B给服务器A回复包的情况，其实是类似的。根据私有ip（国家身份证）不能在公网上面出现的原则，我列一下回去的包的内容是怎样的： 假设和服务器A直连的路由器为路由器a，和服务器B直连的路由器为路由器b。 服务器B->路由器b 源MAC：192.168.1.101的MAC 目标MAC：192.168.1.1的MAC 源IP：192.168.1.101 目标IP：192.168.56.1 路由器b->路由器a 源MAC：192.168.56.2的MAC 目标MAC：192.168.56.1的MAC 源IP：192.168.56.2 目标IP：192.168.56.1 路由器a->服务器A 源MAC：192.168.1.1的MAC 目标MAC：192.168.1.101的MAC 源IP：192.168.56.2 目标IP：192.168.1.101 最关键的地方在于，当第二个包到达路由器a时，它是怎么知道服务器A的私有ip（国家身份证）的呢？路由器a有个引射表，可以通过公有ip（护照）查找出私有ip（国家身份证）。

  2018-12-09

  **1

  **17

- ![img](https://static001.geekbang.org/account/avatar/00/0f/74/60/0403b575.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](%E7%AC%AC8%E8%AE%B2%20_%20%E4%B8%96%E7%95%8C%E8%BF%99%E4%B9%88%E5%A4%A7%EF%BC%8C%E6%88%91%E6%83%B3%E5%87%BA%E7%BD%91%E5%85%B3%EF%BC%9A%E6%AC%A7%E6%B4%B2%E5%8D%81%E5%9B%BD%E6%B8%B8%E4%B8%8E%E7%8E%84%E5%A5%98%E8%A5%BF%E8%A1%8C.resource/resize,w_14.png)

  林三杠

  一直有个疑问，IPv4的公网地址是有限的，现在那么多云厂商卖虚拟主机，每台主机都有一个公网IP，会有用完的时候吗？分给每个云厂商的公网IP有多少啊？

  2018-06-05

  **4

  **16

- ![img](https://static001.geekbang.org/account/avatar/00/11/40/30/40690d3b.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](%E7%AC%AC8%E8%AE%B2%20_%20%E4%B8%96%E7%95%8C%E8%BF%99%E4%B9%88%E5%A4%A7%EF%BC%8C%E6%88%91%E6%83%B3%E5%87%BA%E7%BD%91%E5%85%B3%EF%BC%9A%E6%AC%A7%E6%B4%B2%E5%8D%81%E5%9B%BD%E6%B8%B8%E4%B8%8E%E7%8E%84%E5%A5%98%E8%A5%BF%E8%A1%8C.resource/resize,w_14.png)

  星辰大海

  老师您好，我有一个关于NAPT的疑问。 将端口号和ip地址都translate成为公网ip和运算后的端口号，端口号最多65535个，如果内网机器特别多，都走tcp请求，导致接口超过65535个，怎么办？

  2018-06-05

  **4

  **13

- ![img](http://thirdwx.qlogo.cn/mmopen/vi_32/pc41FOKAiabVaaKiawibEm7zglvnsYBnYeRiaSAElf9ciczovXmXmI0hOeR6U9RULFtMoqX5kobNttvwXCLsUM9Hbcg/132)

  monkay

  有下一跳和没有下一条运作上有什么区别？为什么每次都强调有没有下一跳？

  2018-06-04

  **1

  **13

- ![img](https://static001.geekbang.org/account/avatar/00/11/41/80/bd6419bb.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  化雨

  查了下第一题，nat时不光会替换ip地址，也会替换端口号；每个网关应该都维护了一张端口主机映射表，这样便能准确寻址私网主机。仔细看了下您画的报文结构，猜测端口号占用的应该是ip报文中的选项字段

  2018-06-05

  **2

  **10

- ![img](https://static001.geekbang.org/account/avatar/00/10/56/09/4a9d4a35.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  zj坚果

  老师，为啥我们在宿舍里用交换机而不是用路由器啊，我们能够上外网呀

  作者回复: 有的交换机叫交换机，其实是有路由功能的

  2018-06-07

  **3

  **9

- ![img](https://static001.geekbang.org/account/avatar/00/11/a5/cd/3aff5d57.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Alery

  老师，你在第二种情况说，网关B上记下来，国际身份192.168.56.2对应国内身份192.168.1.101。那么如果该局域网内还有很多其他机器，比如192.168.1.102，103等等，它们对应的国际身份呢？如果也是192.168.56.2，那么从192.168.56.1发来请求时，网关B要将该消息转发到哪个国内身份呢？就好比公司局域网往往是几十个几百个绑定到一个公网ip上的，这个时候怎么对应到具体的某个局域网ip呢？

  2018-07-05

  **2

  **8

- ![img](https://static001.geekbang.org/account/avatar/00/16/61/ee/ac36af18.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  蓝色宫殿

  看到有些人对路由器5个网口连着5个局域网的说法有些疑惑，说一下个人的理解： 一般来说，家用路由器的4个LAN口只对应了一个局域网，可以认为路由器内置了一个“交换机”连着这4个口，还有一个口连着路由器上的一张网卡，这张网卡的地址也就是网关的地址。如果路由器有更多的网卡，通过一些额外的配置，是可以让不同的口连向不同的网卡的。只不过家庭网络中通常不需要这个功能。不知道我的理解是否正确，如有错误请老师帮忙指正。

  2020-02-22

  **4

  **7

- ![img](https://static001.geekbang.org/account/avatar/00/0f/ed/47/f4cdbd09.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  master

  1.wan口地址怎么来的？ 2.是否在到达公网前的这一段链路上每一跳都需要NAT？

  作者回复: wan口地址是运营商分配的，只有最后一跳使用nat

  2018-10-28

  **3

  **7

- ![img](https://static001.geekbang.org/account/avatar/00/11/68/1a/d9a35bc7.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Ziggy_aa

  老师，有个不理解的地方。 如果外网和内网的 IP是一一绑定的话，内网 IP的意义不就没有了么？ 还是说，一个内网中有十台机器,但只有一个公网IP的情况，这个网络中就只有一台可以连接外网，其他都连接不了。

  作者回复: 当然不能一一绑定，所以有多台机器共享一个外网ip的情况

  2018-06-04

  **

  **7

- ![img](https://static001.geekbang.org/account/avatar/00/10/11/cd/9122abaf.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  破障

  打了个大比喻，但是缺少了对主角NAT协议的描述，为啥需要NAT？它解决了什么问题？随着学习课程的推进，发现有些比喻过度简化会造成误解。还是不要依赖一个课程解决你所有的网络协议的困惑

  2021-02-06

  **1

  **7

- ![img](https://static001.geekbang.org/account/avatar/00/0f/ce/ce/761f285c.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  潇洒

  问题一：因为到达目的服务器接收的源IP就是公网IP，返回时到达最后一个和源IP网段相同的网关，在这里转换为私有IP并发送。 不知道这样理解正确吗

  作者回复: 是的

  2018-11-19

  **

  **6

- ![img](https://static001.geekbang.org/account/avatar/00/11/4b/d6/68561c13.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  重剑

  很赞，我是写java的，感觉有点懂网络协议了

  2018-08-16

  **1

  **6

- ![img](https://static001.geekbang.org/account/avatar/00/13/2b/ec/af6d0b10.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  caohuan

  本篇所得：1.玄奘西游，需要转换IP地址，把外网 与内网相互转换，欧洲十日游 不需要转换 IP地址； 2.静态配置路由 为规定 哪个口 访问对应的外网； 3.离开 局域网 需要经过网关，网关是路由器的一个网口； 4.路由为三层设备，里面包括 下一跳的信息； 老师的问题1.公网IP转 私有IP，以及私有IP转化为公网IP，可以用一套算法，正向、反向类推。 2.自动匹配 可以用 数据结构+算法，自动匹配路由的IP，既方便又效率。

  2018-12-31

  **

  **5

- ![img](https://static001.geekbang.org/account/avatar/00/11/e2/58/8c8897c8.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  杨春鹏

  可不可以这样理解:公司内部的不同的局域网使用的就是转发网关；如果公司内部访问外网的时候，这个时候就必须使用NAT网关

  2018-08-04

  **

  **5

- ![img](https://static001.geekbang.org/account/avatar/00/11/66/34/0508d9e4.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  u

  对于第一个问题，答案叫做napt！

  2018-06-09

  **

  **5

- ![img](https://static001.geekbang.org/account/avatar/00/12/bf/97/14626661.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  lewis

  不同的网段依靠路由器进行， 2个不同的路由之间是直连网段吗？ 在讲解中， 相邻的路由之间使用arp协议进行广播通信， 那就是直接工作在mac层了， 但是路由器是三层设备， 工作在网络层， 这一点不是很清楚？

  作者回复: 两个路由之间，之前有一个口是同一网段的

  2018-09-20

  **3

  **4

- ![img](https://static001.geekbang.org/account/avatar/00/0f/88/cd/2c3808ce.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](%E7%AC%AC8%E8%AE%B2%20_%20%E4%B8%96%E7%95%8C%E8%BF%99%E4%B9%88%E5%A4%A7%EF%BC%8C%E6%88%91%E6%83%B3%E5%87%BA%E7%BD%91%E5%85%B3%EF%BC%9A%E6%AC%A7%E6%B4%B2%E5%8D%81%E5%9B%BD%E6%B8%B8%E4%B8%8E%E7%8E%84%E5%A5%98%E8%A5%BF%E8%A1%8C.resource/resize,w_14.png)

  Yangjing

  什么场景下网络是“欧洲十国游”类型的，能提供个例子不？

  2018-08-05

  **1

  **4

- ![img](https://static001.geekbang.org/account/avatar/00/12/c8/f0/a37daf86.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  👹

  如果是我主动发起请求，我怎么知道目标服务器在目标网关上的端口号是多少

  作者回复: 网关不会改变监听端口，服务器的监听端口是知名端口，比如80

  2018-11-24

  **

  **3

- ![img](data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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)

  我是大神郑

  老师，您好。我有个小疑问。就是三层交换机和路由器可以不可以理解为同一功能的设备，还是有包络关系？期待老师答复

  2018-06-10

  **

  **3

- ![img](https://static001.geekbang.org/account/avatar/00/16/a5/98/a65ff31a.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  djfhchdh

  问题1：路由器会记录源ip，源端口，目的ip，目的端口的映射关系，也即链接跟踪表，nat的返回包，根据这个连接跟踪表，就可以查询到是哪个内网的私有ip了。 问题2：如果动态路由，则需要动态路由协议，即每个路由器按照动态路由协议的格式，周期性广播自己的路由表信息，这样就可以学习到其他路由器的网络拓扑信息，形成整个网络的拓扑信息。

  2020-08-05

  **

  **3

- ![img](https://static001.geekbang.org/account/avatar/00/16/0c/37/913de94f.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  keys头

  “路由器是一台设备，它有五个网口或者网卡，相当于有五只手，分别连着五个局域网。”这里说的路由器不是普通家用路由器吧？普通家用路由器是5个LAN口在一个局域网内的，这么理解对吗？

  作者回复: 是的，家用路由器的五个口是一个局域网

  2020-06-10

  **2

  **3

- ![img](https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoo5NPAjKzwYTLSnb0leNIhyJWz0d4vAspl8QpLbNia6Nib39iboK42fQwtFRM4gQicT95j7jTtbH9Yibg/132)

  Geek_ea86a0

  路由器怎么知道要不要nat转换，或者怎么知道是内网访问还是公网访问

  2020-05-17

  **1

  **2

- ![img](https://static001.geekbang.org/account/avatar/00/10/e4/e9/0dd3829f.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  aguan(^･ｪ･^)

  老师，反复看了您所描写的第二种场景，里面并未记录最开始发起请求机器的MAC地址，那么在服务器B返回响应包时，这个包是怎么找到A的呢？？ 引用问题如下----- 老师，你在第二种情况说，网关B上记下来，国际身份192.168.56.2对应国内身份192.168.1.101。那么如果该局域网内还有很多其他机器，比如192.168.1.102，103等等，它们对应的国际身份呢？如果也是192.168.56.2，那么从192.168.56.1发来请求时，网关B要将该消息转发到哪个国内身份呢？

  2018-09-29

  **

  **2

- ![img](https://static001.geekbang.org/account/avatar/00/10/5b/66/ad35bc68.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  党

  讲的太好了 问题一 一直困扰着我 我觉得是因为主动访问公网ip的时候路由器是有记录的 当公网ip响应的时候 路由器会查询记录

  2018-07-04

  **

  **2

- ![img](https://static001.geekbang.org/account/avatar/00/11/45/69/3c21acef.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Rimin

  对于第一个问题：通过NAT地址转换表进行转换。不过一个NAT全球ip地址只能对应一个专用网内的主机。所以现在常用的NAT转换表把运输层端口号也给用上，即NAPT。

  2018-06-04

  **

  **2

- ![img](https://static001.geekbang.org/account/avatar/00/11/4a/2a/0add6e7c.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Cheung

  IP 地址在三个局域网都可见，什么情况下IP地址在不同局域网可见，什么时候在局域网不可见？

  2018-06-04

  **

  **2

- ![img](data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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)

  ricepot100

  个人觉得不需要在这一章写NAT，因为从层次上看，交换机属于2层设备，不涉及mac变化，路由器属于3层设备，涉及mac变化，而单纯三层NAT不具备实际意义，只有涉及端口更上层的协议才有意义，这个时候把NAT设备认为是单纯的三层设备不是太合适。

  2020-04-02

  **1

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/10/0e/1f/d0472177.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  厉害了我的国

  太详细了！

  2019-12-16

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/13/11/b2/dd0606b2.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  水先生

  老师，“下跳”的解释是：某个 IP 要将这个 IP 地址转换为 MAC 放入 MAC头。 IP地址转化为MAC，有点抽象…请问是怎么转换？意思是在IP网段，通过ARP协议获得MAC的过程么？ 望老师解惑~

  作者回复: 是的

  2019-09-05

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/15/f7/36/7a6a6b6e.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  脸红因为风太烫

  老师，能否说一下什么叫下一跳？还有网口、网卡、网关之间的区别

  作者回复: MAC地址填的就是下一跳，就是下一次要发给哪个集群。网口和网卡不用分这么清楚，一般买个交换机，上面有口，叫做网口，买一台服务器，上面有卡，叫网卡。都有MAC地址。网关是一个有多个网口或者网卡的三层设备。

  2019-07-14

  **

  **1

- ![img](data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7/7gAOQWRvYmUAZMAAAAAB/9sAhAABAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAgICAgICAgICAgIDAwMDAwMDAwMDAQEBAQEBAQIBAQICAgECAgMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwP/wAARCADuAO4DAREAAhEBAxEB/8QAfAABAAICAwEBAAAAAAAAAAAAAAYHBAgBAwUCCgEBAAAAAAAAAAAAAAAAAAAAABAAAgIBAgIECwQJBQAAAAAAAAECAwQRBSEGMWESF0FRgVITk+MUVJTUIkJiB5EyhBVFhbXFNnFygqJTEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwD9vAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGHmbhg7fD0mbl4+LF69l32wrctPBCMmpTfUk2BG7ue+Wqm4rNsua6XTi5DWvVKyutPyaoDmnnrlq19l506W9NPTYuSk2/xQqnGPlaQElxM7Dzq/S4WVj5VfhlRbC1Rfil2G3GXU9GBlAAAAAAAAAAAAAAAAAAAAAAAAAAAA4bUU5SajGKblJtJJJattvgkkBVHMnP8AJSswtilHSLcLdxcVLV9DWHCWsdF/6ST1+6uiQFW35F+VbK/Jutvum9Z23WSssk/xTm3JgdIADvx8nIxLY34t9uPdD9W2myVc1412otPR6cV0MC1uWufvTTrwd8cITlpCrcYpQhKT4KOXBaQrbf346R8aXFgWmnrxXFPimvCAAAAAAAAAAAAAAAAAAAAAAAAAAFUfmBzHKLexYVjjrGMtxsg+LU12oYia6E4tSn400vOQFTAAAAAAAuDkDmSWRFbHm2OVtUHLb7ZvWU6oLWeK2+LdMV2ofgTX3UBaAAAAAAAAAAAAAAAAAAAAAAAABi52XDAwsvNs4wxce6+S10cvRQlNQX4ptaLrYGr+RfblX3ZN8nO7Itsutk/vWWSc5Pq4sDpAAAAAABlYWXbgZeNmUPS3Guruhx0TcJJ9mWnTGa4NeFMDaDGvrysejJqeteRTVfW/HC2EbI/9ZAdwAAAAAAAAAAAAAAAAAAAAAACJc8WurlncOzwdrxateqeVT2v0wTXlA18AAAAAAAAAbFcnXSu5a2mcnq402U/8cfJuoivJGtASYAAAAAAAAAAAAAAAAAAAAAABFOdqXdyzuSjxlWse7yVZVMp/or1YGvQAAAAAAAADY3lGiWPy3tNclo5Yzv8AF9nJusyYvyxtQEjAAAAAAAAAAAAAAAAAAAAAAAdGVj15eNkYty1qyaLaLF4exbCVctOvSXADWDNxLsDLycLIj2bsa6dM/E3B6KUfHCa0afhTAxQAAAAAAZ224Nu55+LgUp+kyboV6pa9iDetljXm1VpyfUgNnqaoUU1UVLs101wqrj4oVxUILyRQHYAAAAAAAAAAAAAAAAAAAAAAAAVrz5yzPNh++cGtzyaK1HNpgtZX0QX2bopcZW0R4NdLhp5ujCmQAAAAAAXbyLyzPbaXumdW4ZuVX2aKprSWNjS0bck+Mbr9FqumMeHS2gLDAAAAAAAAAAAAAAAAAAAAAAAAAACuOZOQ6c+dmbtDrxcubc7cWX2cbIm+LlW0n7vbLw8OxJ+bxbCpM7bM/bLXVn4l+NPVpekg1CenhrsWtdseuLaAwQAHo7ftO47raqsDEuyZapSlCOlVevhtul2aql/uaAt3lrkWjbJ15u5yry86Gk6qYrXFxpripfaSd90X0NpRi+hNpSAsIAAAAAAAAAAAAAAAAAAAAAAAAAAAAD4sqrug67a4W1y/WhZCM4P/AFjJNMDw7eVuXrm5T2jCTfT6Kr0C49VLrQHNPK/L1ElKvaMJtcU7alfo/Gle7FqB7cK4VQVdcIVwitIwhFQhFeJRikkgPsAAAAAAAAAAAAAAAAAAAAAAAAAY2XmYuBRPKzL68aiv9ay2XZjq+iKXTKcvBFJt+BARGf5g8uRk4q3LsSeinDFkoy60pyhPR9aQHz3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAMjG575cybY1PKtxnJpRnk0Trq1fglZHtxrXXLRLxgTCMozjGUZKUZJSjKLTjKLWqlFrVNNPgwOQAAAAAAAAAAAAAAAAAAAAUZ+YW43ZG9ywHOSx9vqpUa9fsu7IphkTta8MnCyMepLrYECAAAAAAAAAAAF0/lxuN2Tt+Zg2zlOO320uhyerhTlK1qpPzYWUSa8Xa06NALHAAAAAAAAAAAAAAAAAAAABr3zx/lO6fsX9OxAImAAAAAAAAAAALY/K/+Ofyz+4AWwAAAAAAAAAAAAAAAAAAAADXvnj/ACndP2L+nYgETAAAAAAAAAAAFsflf/HP5Z/cALYAAAAAAAAAAAAAAAAAAAABVvMfJG7bxvOZuONkbdCjI937Eb7cmNq9DiUUS7Ua8S2C1nU2tJPgB4fdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAJvyby1ncvfvH323Et989z9F7rZdPs+7+9dvt+loo019OtNNfD0ATcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//Z)

  Geek_94e115

  \1. conntrack 2. dhcp

  2019-04-29

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/14/9b/9f/2cbc2a4f.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](%E7%AC%AC8%E8%AE%B2%20_%20%E4%B8%96%E7%95%8C%E8%BF%99%E4%B9%88%E5%A4%A7%EF%BC%8C%E6%88%91%E6%83%B3%E5%87%BA%E7%BD%91%E5%85%B3%EF%BC%9A%E6%AC%A7%E6%B4%B2%E5%8D%81%E5%9B%BD%E6%B8%B8%E4%B8%8E%E7%8E%84%E5%A5%98%E8%A5%BF%E8%A1%8C.resource/resize,w_14.png)

  人间乐园

  看过路由这一块东西，所以这篇看得比较流畅，老师讲得简直棒的飞起！

  2019-01-01

  **1

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/10/be/d8/bc9030e7.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Tiny2017

  玄奘西行，路由器B最后的转换是： 源 MAC：192.168.1.1 的 MAC 地址 目标 MAC：192.168.1.101 的 MAC 地址 源 IP：192.168.56.1 目标 IP：192.168.1.101 上面的源mac地址是否就是192.168.56.2 的 MAC 地址？

  作者回复: 不是的，mac地址会是本地网关那个口的地址

  2018-12-18

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/10/19/ee/e395a35e.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  小先生

  静态路由分为 欧洲十国游和玄奘西行的。因为我们的个人主机使用内网 IP。需要 NAT 转化。 注意在往下传递过程中， MAC 地址都在变化。 每到一个局域网，需要判断目的 IP 和自己是否在同一个网段，如果不在，就需要发到网关，前往下个地点。

  2018-09-30

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/0f/49/b8/fb19aa6a.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Marnie

  网关是路由器的一个口，连接一个局域网。该局域网内的服务器要访问另一个局域网的服务器，得经过路由器的转换。 路由器是三层设备，含义是指需要根据Mac头和IP头，看看要把包往哪里转发的设备。 吓一跳是指，从某个网口出去，要到达的下一个路由器的某个网口的IP。 欧洲十国游，是指经过转发路由，发到目的IP。转发过程中IP不变，但Mac变。 玄奘西游，是指经过NAT路由，将本地IP转为公有IP，转发后使用公有IP在网络间传输。IP变化，MAC也变化。但IP只在NAT路由器转换的时候变一次，传输过程不在变化。MAC每经过一个路由网口，就变一次。

  2018-09-29

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/12/d5/ef/0af42eb2.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  小倪

  你好老师，虚拟机配置中的桥接，是不是就是您在文章说的转发（欧洲十国游）？

  作者回复: 不是，虚拟机的桥接，虚拟机ip和物理管理一样，这样是二层互通的，不存在旅游，所以不是欧洲十国游。

  2018-09-28

  **

  **1

- ![img](data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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)

  星星的光

  路由器a下面通过nat方式下面有个pc b，分别在路由器a出口处抓包和pc 出口处抓包，当pc浏览网页时抓获两者的流量，从报文特征层面上区分两份流量能区分出那个是路由器那个是pc么？

  2018-06-16

  **

  **1

- ![img](data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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)

  像风

  可能是我理解问题，看了文章之后，有几个问题：路由器是有多个网口吗？换句话说，有多个网卡（wan）吗？多个网口有什么用？为什么家用的只有一个wan？如果不是，那文章中静态路由规则中说明的2号口，3号口是什么？

  2018-06-05

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/11/27/0b/12dee5ed.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](%E7%AC%AC8%E8%AE%B2%20_%20%E4%B8%96%E7%95%8C%E8%BF%99%E4%B9%88%E5%A4%A7%EF%BC%8C%E6%88%91%E6%83%B3%E5%87%BA%E7%BD%91%E5%85%B3%EF%BC%9A%E6%AC%A7%E6%B4%B2%E5%8D%81%E5%9B%BD%E6%B8%B8%E4%B8%8E%E7%8E%84%E5%A5%98%E8%A5%BF%E8%A1%8C.resource/resize,w_14.png)

  进化论

  napt网络地址端口转换，类似应用程序端口

  2018-06-04

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/10/71/17/abb7bfe3.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  饮识止渴(Vilin)

  没明白，nat转换，怎么知道最后局域网中的ip地址的。

  作者回复: 是的，后面会讲

  2018-06-04

  **

  **1

- ![img](https://thirdwx.qlogo.cn/mmopen/vi_32/nXv3pLUO0OBIBlTATaCINic2VT7iaE6iagJJkbERCsdYlhEyy0dYEXY6wC02nxwsPj0wIpXWXb7jlicMuNw3xqFfnA/132)![img](%E7%AC%AC8%E8%AE%B2%20_%20%E4%B8%96%E7%95%8C%E8%BF%99%E4%B9%88%E5%A4%A7%EF%BC%8C%E6%88%91%E6%83%B3%E5%87%BA%E7%BD%91%E5%85%B3%EF%BC%9A%E6%AC%A7%E6%B4%B2%E5%8D%81%E5%9B%BD%E6%B8%B8%E4%B8%8E%E7%8E%84%E5%A5%98%E8%A5%BF%E8%A1%8C.resource/resize,w_14.png)

  jodo

  关于第一个问题的答案，这篇文章写的很好哦 https://www.zhihu.com/question/31332694

  2022-07-24

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/23/7e/c0/1c3fd7dd.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](%E7%AC%AC8%E8%AE%B2%20_%20%E4%B8%96%E7%95%8C%E8%BF%99%E4%B9%88%E5%A4%A7%EF%BC%8C%E6%88%91%E6%83%B3%E5%87%BA%E7%BD%91%E5%85%B3%EF%BC%9A%E6%AC%A7%E6%B4%B2%E5%8D%81%E5%9B%BD%E6%B8%B8%E4%B8%8E%E7%8E%84%E5%A5%98%E8%A5%BF%E8%A1%8C.resource/resize,w_14.png)

  朱新威

  第二张图里面路由器的两个接口，一个为主机的私有ip的网关地址，一个为公有ip地址。是不是代表公有ip地址一般都为路由器与相邻网络相连的接口地址呢？

  2022-07-15

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/7f/6e/863e4b2a.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  云计算小菜鸟

  有几个疑问：家用路由器有一个WAN口，和若干个LAN口，1.每一个LAN口应该就是一个独立的网段吧？我得理解路由器可以分割广播域，所以不同的LAN口不能有相同的网段对吧。2.如果第一点成立的话，是不是每一个LAN口都是一个独立的局域网（如果连接了很多主机）。3.那有几个LAN口，是不是路由器就有几张对应的网卡（还有WAN口的网卡）。    希望有大佬解答一下！感谢

  2022-07-06

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/25/02/d4/1e0bb504.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Peter

  网关往往是一个路由器，是一个三层转发的设备  -->老师， 是不是可以理解为三层的交换机可以理解为是这种路由器的

  2022-05-22

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/2d/53/c4/63419c36.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  抱着大貉妖睡觉的猫羽雫

  真是无语了，本来一门课程就不可能做到让每个人都满意，怎么总是有人在吐槽这个老师讲得不清不楚的，故弄玄虚的，比喻太用力的。奇奇怪怪，不适合自己就不要看啊，找别的课程啊，我觉得老师讲得挺好的，好耶~

  2022-04-12

  **

  **

- ![img](https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ7mAt63VrbLZPHpeZxSc4IlBYswQSnaAB5wGePaGFDehgiaNfIxI1SJ5yIHIlmVk8hsw0RaoaSCPA/132)

  Stephen

  NAPT表项指定了报文的私网IP地址和端口号与公网IP地址和端口号的映射关系。https://blog.csdn.net/qq_46254436/article/details/105373253

  2022-03-18

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/1f/4c/dd/c6035349.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](%E7%AC%AC8%E8%AE%B2%20_%20%E4%B8%96%E7%95%8C%E8%BF%99%E4%B9%88%E5%A4%A7%EF%BC%8C%E6%88%91%E6%83%B3%E5%87%BA%E7%BD%91%E5%85%B3%EF%BC%9A%E6%AC%A7%E6%B4%B2%E5%8D%81%E5%9B%BD%E6%B8%B8%E4%B8%8E%E7%8E%84%E5%A5%98%E8%A5%BF%E8%A1%8C.resource/resize,w_14.png)

  Bumblebee

  老师你好，我想问个问题： 比如服务器A和B都有固定的公网IP（A,B服务不在同一个网段内），服务器上有个Netty编写的程序，连接到了服务器B,我在服务器B能获取到服务A的真实IP么？还是只能获取到A到B经过的最后一跳路由器的IP?

  2022-03-04

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/2b/a1/7d/64ed0fdd.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](%E7%AC%AC8%E8%AE%B2%20_%20%E4%B8%96%E7%95%8C%E8%BF%99%E4%B9%88%E5%A4%A7%EF%BC%8C%E6%88%91%E6%83%B3%E5%87%BA%E7%BD%91%E5%85%B3%EF%BC%9A%E6%AC%A7%E6%B4%B2%E5%8D%81%E5%9B%BD%E6%B8%B8%E4%B8%8E%E7%8E%84%E5%A5%98%E8%A5%BF%E8%A1%8C.resource/resize,w_14.png)

  电单车

  net就涉及sNet和dNet了，也就是原地址转换和目的地址转换

  2022-03-02

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/25/67/0f/3cb10900.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  菜鸟

  个人电脑（内网）通过路由（IP+端口映射）可以访问公网地址（百度IP），但是 在家个人电脑（192.168.0.2）使用NAT转换可以访问公司内网电脑（172.16.231.110）吗？不能吧。

  2022-01-13

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/14/a3/aa/8b475aa5.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  冰点

  家里的路由器的公网ip不定期会变，是不是存在如果恰好发送了一个包，公网ip变了是不是就收不到回复了

  2021-12-24

  **

  **

- ![img](https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLuAicsPOEh7z38iaibW34jqAchcgAzNVmjqc3Y9VkWUzyBs4bFfGGfQU0oYiaJMrHibY0lffUD5erlYug/132)

  Geek_WHH

  老师您好，服务器A想访问服务器B那A是怎么知道目标IP地址的呢？“玄奘西行”模型里A是怎么判断不是自己发送自己接收呢？

  2021-11-21

  **

  **

- ![img](https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ7mAt63VrbLZPHpeZxSc4IlBYswQSnaAB5wGePaGFDehgiaNfIxI1SJ5yIHIlmVk8hsw0RaoaSCPA/132)

  Stephen

  如果不存在地址转换，包在传送过程中目的ip不发生改变，经过路由器Mac地址会发生改变，因为mac地址里存储的是下一跳的。如果发生地址转换正在传输中，则目的ip，mac都会发生变化。

  2021-11-17

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/2b/0b/b4/65582d6a.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  ABC

  老师，我想问一下，我在百度查IP地址查询，是这样的本机IP: 123.117.133.207北京市北京 联通；；然后在你给网址上，是这样的：222.199.230.222来自北京市朝阳 教育网；；那这两个的关系是什么？？？不都是出口地址？

  2021-10-29

  **

  **

- ![img](https://thirdwx.qlogo.cn/mmopen/vi_32/WP4Ge8ABcINFkccKaNYKibicFnI0JAoojBBAUGrichNeRAgzm5RGbHG7GqYrFX3ELEzenuEbicQHJy2HZ72RxSOuMA/132)

  Geek_842f07

  \1. 因为发送的时候你的私网IP和公网IP的映射已经被存储在路由器中，当接收返回包时会利用这个映射找到你的私网IP在转发给你 2. 第一遍广播，找到了就存储这个路由关系，这样不断更新

  2021-08-25

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/19/32/f1/fd24d52b.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  青禾qingh

  想问下，除了一个工作在二层，一个工作在三层之外，交换机和路由器的核心区别是什么？

  2021-07-28

  **

  **

- ![img](data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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)![img](%E7%AC%AC8%E8%AE%B2%20_%20%E4%B8%96%E7%95%8C%E8%BF%99%E4%B9%88%E5%A4%A7%EF%BC%8C%E6%88%91%E6%83%B3%E5%87%BA%E7%BD%91%E5%85%B3%EF%BC%9A%E6%AC%A7%E6%B4%B2%E5%8D%81%E5%9B%BD%E6%B8%B8%E4%B8%8E%E7%8E%84%E5%A5%98%E8%A5%BF%E8%A1%8C.resource/resize,w_14.png)

  Geek_b52974

  簡單總結 1. 只要在不同網關，目標mac要先換成網關的，接下來每經過一次網關就會轉換一次mac 2. 如果是nat 才會連 ip 一起換，如果目標是nat 網關裡的機器，就只能將 ip 設為 nat 網關的對外ip

  2021-06-05

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/1e/01/c5/b48d25da.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  cake

  校园网的 IP 地址，假设是 10.10.x.x。 老师请问下为啥校园网ip 也是内网ip呢

  2021-05-28

  **

  **

- ![img](http://thirdwx.qlogo.cn/mmopen/vi_32/ZHw73tgCqGKhvticUWGRz4icgicu4hFWfKtacoFJeItH7maNuNUmjnEgDTJvOibwUWgGV0p6guNPibMVWDV4BUmEmlA/132)

  Ethan

  “你可以通过 https://www.whatismyip.com/ 查看自己的出口 IP 地址。”我查询的结果是58.249.3.13。为啥我ping 58.249.3.13 显示请求超时？？

  2021-05-27

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/14/55/37/57aeb6af.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  没有軒的筝

  如果要访问的公网IP和源网段内中某个局域网IP一样的话，那么包是不是就传不到公网IP对应的服务器了？，直接就传给源网段内中局域网中了

  2021-04-21

  **1

  **

- ![img](https://thirdwx.qlogo.cn/mmopen/vi_32/Sjso4nq3gykvb8CQsgLVZIoUjibsIDCI84HTzTS9Aib86AF2zTK1OZDtH7Gg1uiateoKX9c4HP7fsxxDSjDyMaGrQ/132)

  Geek_0824e7

  玄奘西行 对服务器A来说是不是只知道服务器B的外网地址 

  2021-04-18

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/20/ec/81/4863e9ed.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  文刂文化十

  回答第一个问题：发送请求时,网关A通过修改源端口来区分

  2021-03-05

  **

  **

- ![img](data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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)

  Geek_908e99

  老师，请问路由器1的端口192.168.56.1/24和路由器2的端口192.168.56.2/24，这两个IP是同一网段的，这个是如何保证的？在外网这两个相连的路由器可能是由不同机构所有的，那这个网段是怎么分配给两个路由器的？

  2021-01-24

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/7b/ae/66ae403d.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  熊猫

   于是，路由器 A 思考的时候，匹配上了这条路由，要从 192.168.56.1 这个口发出去，发给 192.168.56.2。那 192.168.56.2 的 MAC 地址是多少呢？路由器 A 发送 ARP 获取 192.168.56.2 的 MAC 地址。———老师，公司里出口IP和入口IP是不是也是指路由器的光纤入口和一个网口？

  2021-01-05

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/22/07/ca/c0f1f37a.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Geek_d4c820

  老师讲的非常好，通俗易懂

  2020-10-25

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/e1/93/365ba71d.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  陈德伟

  1，nat做转换的时候肯定要分配给这个tcp连接一个端口，nat本身维护了这个端口和内网IP的映射，当这个端口的tcp响应到来，就通过这个映射找到对应的内网ip做转发 2，动态路由：缓存上次成功的记录？

  2020-10-20

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](%E7%AC%AC8%E8%AE%B2%20_%20%E4%B8%96%E7%95%8C%E8%BF%99%E4%B9%88%E5%A4%A7%EF%BC%8C%E6%88%91%E6%83%B3%E5%87%BA%E7%BD%91%E5%85%B3%EF%BC%9A%E6%AC%A7%E6%B4%B2%E5%8D%81%E5%9B%BD%E6%B8%B8%E4%B8%8E%E7%8E%84%E5%A5%98%E8%A5%BF%E8%A1%8C.resource/resize,w_14.png)

  piboye

  nat情况下，timewait会出现在nat设备上吗？ 如果不会从4层来看，不是会串包吗？是会做seq转换来防止seq回绕吗？

  2020-10-01

  **

  **

- ![img](http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIicUcshfoJoCUV82gGVGl0mswFSq9tFfH6HFIUNExbflZaxXX6icIBfaYKkMAA8rSoNiczFxSuGyVEA/132)

  Geek_7361b8

  对于NAT而言，每台内网机器有60000+端口，如果多台内网机器，NAT转换表能放得下这么多映射关系么，是否也有冲突的可能？

  2020-09-21

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/1f/6f/0e/8874d1bc.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  明

  “欧洲十国游”型中192.168.56.1为什么要跳到192.168.56.2  为什么不直接到192.168.4.1  

  2020-08-24

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/16/6c/a8/1922a0f5.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  郑祖煌

  NAT转换的，IP地址变化的时候，MAC地址有做对应的变化吗。 上面的例子好像只有在192.168.1.1发往网关的时候MAC地址有变，其他时候都是取源和目标的mac地址。

  2020-08-19

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/16/6c/a8/1922a0f5.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  郑祖煌

  这个NAT转换说的是公有IP和私有IP是一对一情况下的转换，如果是公有IP只有一个，而这个公有IP对应着整个vlan虚拟网络，那他是怎么知道这个包是要发送给那个IP的呢。如果要回包给发送他他又得怎么做的呢。

  2020-08-19

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/15/fc/04/d83a555e.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Kevin⚡️Zhou

  第一个问题, 路由器会cache nat表

  2020-08-04

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/15/fc/04/d83a555e.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Kevin⚡️Zhou

  路由器B给服务器发送包那里 难道源ip不应该是192.168.1.1么?

  2020-08-04

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/17/9d/f3/3f6dd32b.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  叶紫真

  最后一个图，为什么NAT路由器B在转发的时候，没有将原地址192.168.56.1转化为192.168.1.1？

  2020-07-29

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/0f/e8/ca/2a7cc193.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  阿鼎

  请问，交换机的默认网关是第一个地址。公司的网关都是貌似是最后一个。这些网关为什么会是这些ip？怎么知道交换机网关是哪个？出厂就陪好的吗？

  2020-07-29

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/4a/d2/46143e6d.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  arthinking

  问题一：传统的NAT(traditional NAT)包括基本NAT(basic NAT)和网络地址端口转换(Network Address Port Translation, NAPT)。基本NAT只执行IP地址的重写，本质上是将私有地址改写为一个公共地址，这往往取自于一个由ISP提供的地址池或共有地址范围，这种NAT不是最流行的，因为无助于减少需要使用的IP地址数量。比较流行的做法是使用NAPT，NAPT使用传输层标识符如TCP或者UDP端口，以及ICMP查询标识符来确定一个特定的数据报到底和NAT内部哪台私有主机相关联。

  2020-07-19

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/1e/49/31/6d5728ac.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  LUO JINGYUAN

  个人的困惑： 1. 路由器是三层设备，其实不太理解什么是三层设备？两层又是指什么？ 个人理解： 1.小型局域网可能有不同的两个路由器，路由器根据ARP表查询MAC地址，每一次包到一个新的站点就更新一遍MAC地址，但是源、目标IP不变。 2.如果需要互联网，则需要一个公网身份，所谓公网身份，就是本地运行商给家里提供宽带时候所提供过的一个IP地址。跟小型局域网有点像，只是在路由器和路由器之间插入了一个更大虚拟路由器，这个路由器由各个运营商管理。

  作者回复: 三层设备就是解析到第三层网络层就到头了，当然二层，一层也会处理的，四层的数据就不会处理了。

  2020-06-06

  **2

  **

- ![img](https://static001.geekbang.org/account/avatar/00/13/d9/fa/216e5c24.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  游贺龙

  老师，有两个问题 1. 如果目标地址ip和源地址是统一个网段，那么通过ARP来获得mac，这是建立在目标地址和源地址是二层互通的吗？说明这两个节点是连在同一个交换机吗 2. 不同网段网段的连接需要通过网关跳一下，那么这两个不同网段也是二层互通吗

  作者回复: 第一个，是的。第二个，不是，源和网关左手二层互通，网关两只手，左手倒右手，右手和目标二层互通

  2020-06-02

  **

  **

- ![img](http://thirdwx.qlogo.cn/mmopen/vi_32/8Dj4ugujXwY24G8pcpgDFGiciarXetG3ItQ4M9mSQMLyRdRRXEXXJVfib48mGUQAu87QcvImwyJIVJlEFeEguV44w/132)

  Geek_ac7784

  看到玄奘西游的比喻，感觉我多年来的疑惑终于要解决了，结果，老师把问题又踢回来了，无语。你说B服务器有一个国际通行证，那么B下的所有机器都应该有一个国际通行证啊，岂不是违背了公有IP重复利用的原则？这个问题是我知道公有IP重复利用后一直疑惑的，老师竟然放在了问题一。

  2020-05-22

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/1e/a0/70/b0886748.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  熊博士

  nat 终于记得了

  2020-05-18

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/12/d6/39/6b45878d.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  意无尽

  总结： 这次讲了三种情形上网的方法： 1) 在同一个网段内。比如访问旁边兄弟的电脑，与网关没关系，是直接将源地址和目标地址放入 IP 头，然后通过 ARP 协议，找到旁边兄弟的 MAC 地址，将源 MAC 地址和目标 MAC 地址放入 MAC 头中。 2) 不同网段。比如要访问学校内的 BBS，此时需要有网关 Gateway了。网关的地址一定是和源 IP 地址是同一个网段的。 既然是同一个网段的，那其实就跟在同一个网段内的访问是一样的，将 源 IP 和目标 IP 放入 IP 头中，然后通过 ARP 协议获得 MAC 地址，将源 MAC 和目标 MAC 放入 MAC 头中。 网关往往是一个路由器，是一个三层转发的设备。啥叫三层设备？前面也说过了，就是把 MAC 头和 IP 头都取下来，然后根据里面的内容，看看接下来把包往哪里转发的设备。 路由器是一台设备，它有五个网口或者网卡，相当于有五只手，分别连着五个局域网。每只手的 IP 地址都和局域网的 IP 地址相同的网段，每只手都是它握住的那个局域网的网关。 静态路由：静态路由，其实就是在路由器上，配置一条一条规则。 个人理解：访问国内的都是 IP 不变，MAC 变（毕竟 MAC 地址是一个局域网内才有效的地址）。不改变 IP 地址的网关，我们称为转发网关；改变 IP 地址的网关，我们称为NAT 网关。 3) 跨国访问。 比如 A 和 B 的 IP 地址都是一样的，此时两者就需要一个国际身份来分别代表相应国内的 IP 地址。

  2020-05-14

  **

  **

- ![img](data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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)

  Geek_f0bd6b

  一节课10分钟到20多分钟不等，相信老师为了精炼内容煞费苦心

  2020-03-22

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/ee/88/a890b41e.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](%E7%AC%AC8%E8%AE%B2%20_%20%E4%B8%96%E7%95%8C%E8%BF%99%E4%B9%88%E5%A4%A7%EF%BC%8C%E6%88%91%E6%83%B3%E5%87%BA%E7%BD%91%E5%85%B3%EF%BC%9A%E6%AC%A7%E6%B4%B2%E5%8D%81%E5%9B%BD%E6%B8%B8%E4%B8%8E%E7%8E%84%E5%A5%98%E8%A5%BF%E8%A1%8C.resource/resize,w_14.png)

  chris

  好久没看了，每次老师所讲的都是有收获的

  2020-03-22

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/1d/39/f9/b946719a.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  King-ZJ

  对于本章讲的上网行为实现过程，对应到网络协议中就有网关的概念，再探究到上网时数据包的封装。对于上互联网又有欧洲十国游和玄奘西游的比喻去讲解IP头中内容的变与不变，着实有趣。对于读者，这些都是作者这么多年实践和思考的结晶，最终才能这么游刃有余地输出，反观自身出了看，更多地实践和思考，也输出自己的一点点成果。

  2020-03-21

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/13/f0/81/8d539cba.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  王凯

  你们当时到底是有多穷啊 😂

  2020-02-10

  **

  **

- ![img](http://thirdwx.qlogo.cn/mmopen/vi_32/fBOybgVTWXYXxaicaVEysXCjkKT13dX7icAj96KibJ815mia1FvYro9KcbA3xtwnIxmPJ38Vt6rmg6vp0auGKel93A/132)

  Geek_d26e63

  看不懂，NAT后是"国际身份"，又是从哪知道它的国际身份啊？一上来就当已知条件？一脸懵逼

  2020-01-18

  **

  **

- ![img](http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTImeO3D5b56uwnS9OqzsuhNiciaA3ekC49lNt7NaGoTZ3U7tfLKRLR3V0F7k8hEJQZ4mQD7hfGwWiceQ/132)

  飞火流苏

  操作系统是如何得知目标IP的？如果是通过DNS解析拿到的IP，肯定是公网IP，何来需要NAT过程把目标私网IP转为公网IP呢？

  2020-01-13

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/13/62/1e/ad721e61.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](%E7%AC%AC8%E8%AE%B2%20_%20%E4%B8%96%E7%95%8C%E8%BF%99%E4%B9%88%E5%A4%A7%EF%BC%8C%E6%88%91%E6%83%B3%E5%87%BA%E7%BD%91%E5%85%B3%EF%BC%9A%E6%AC%A7%E6%B4%B2%E5%8D%81%E5%9B%BD%E6%B8%B8%E4%B8%8E%E7%8E%84%E5%A5%98%E8%A5%BF%E8%A1%8C.resource/resize,w_14.png)

  flow

  问一下, 为什么ip数据包里源mac一直会改变, 正常来讲不是修改目标mac就能找到下一跳地址吗? 修改源mac有什么意义吗?

  2019-12-18

  **

  **

- ![img](http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLqBI3vIIIEKrkw5luxq446fdOBJltljd4oRjdzLWgQ9rWWUydKCGVhjdPcpkkHhQHXbLJPUMwvVg/132)

  ZEROAZERO

  还是和理论书籍结合的看吧

  2019-12-16

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/12/bf/10/b7974690.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  BD

  静态路由：由路由器手动配置的路由 NAT:为了解决局域网直接的ip网段重叠无法区分具体目的地问题，采用获取外网IP代替目的地局域网ip，并且把自己的ip换成外网ip 跨网关流程：A服务器发送包到B服务器时发现跟B不是一个网段，首先发送ARP协议到A网关获取A网关的MAC地址，然后发送包到网关，包内容由源MAC 目标MAC 源IP 目标IP,到达A网关发现MAC地址匹配收下包，然后根据目标IP和静态路由判断出下一跳路由，在下一跳路由修改源mac为当前路由mac，目标mac为下一跳路由mac

  2019-11-22

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/d4/44/0ec958f4.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Eleven

  我觉得是同样的道理把，返回包的NAT路由器上面也映射了公网IP和局域网IP对应关系。

  2019-11-21

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/12/cb/ab/1aac53bf.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  董航

  越看越懂，写的很nice

  2019-11-19

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/13/5c/02/e7af1750.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  teddytyy

  当包到达192.168.56.1时，如何知道下一跳是192.168.56.2，而不是192.168.56.x？是路由器里记录的吗？若是如此，那路由器里需要记录多少公网上对应的下一跳？不会放不下吗？

  2019-11-15

  **

  **

- ![img](http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIwL80nq0CbiaphH0fVwibmA1SeJTBgmVvMlhzgF1dbssRgprRaiaxNgl0axOUk2wM9r8jICLXeYZpcQ/132)

  tang

  第一种是不是会出现问题，记录ip难道ip 是不重复的吗？

  2019-10-28

  **

  **

- ![img](http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIwL80nq0CbiaphH0fVwibmA1SeJTBgmVvMlhzgF1dbssRgprRaiaxNgl0axOUk2wM9r8jICLXeYZpcQ/132)

  tang

  第一种：ip 不变，mac来记录转发？ 1、ip 中,记录源ip和目标ip,不会变化 2、mac中，本机mac为源mac,目标mac就是下一个到达的mac网关，到达之后，源mac就是到达的目标mac。 第二种，了解到就是说，在跨国际旅行时候，都要通过net 转换为国际地址，只要是不同局域网内，到达指定局域网内的最后一跳，再通过net 转换为原来ip。 不知道理解对不对。

  2019-10-28

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/12/fd/91/65ff3154.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  _stuView

  服务器A给服务器B发包，目的IP是B的私有IP，网关A是怎么知道网关B的公网IP呢？

  2019-10-10

  **

  **

- ![img](data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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)

  随缘

  刘老师好： 针对NAT网关，服务器A怎么知道服务器B的公网地址呢？

  2019-10-06

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/0f/93/4a/de82f373.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  AICC

  老师，我是一个刚要上大学的学生，云计算专业，现在想买一个电脑，老师能帮忙推荐一下

  2019-10-04

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/7a/03/51399175.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Mr_Tree

  老师讲的很好了，说看不明白的还是自己底子差，这就好比在学校上课一样，讲新知识前老师都会提前告告知你要预习一样，你既没有基础又没预习自然看的云里雾里

  2019-09-19

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/0f/bb/85/191eea69.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  搬铁少年ai

  在R1上面配置静态路由，如果下一跳地址是R2设备的IP地址，那么本设备怎么怎么知道从哪个口出去呢？是查R1设备的上的路由表吗？（直连路由？）

  2019-09-11

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/64/86/f5a9403a.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  多襄丸

  老师  原文中  路由器是一台设备，它有五个网口或者网卡，相当于有五只手，分别连着五个局域网。每只手的 IP 地址都和局域网的 IP 地址相同的网段，每只手都是它握住的那个局域网的网关。 我想问一下 这五只手，组成的网络，算局域网吗？

  作者回复: 这五只手，相当于咱们家里买的路由器的五个口，所以不是局域网，也不组成一个网络

  2019-08-30

  **3

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/64/86/f5a9403a.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  多襄丸

  第一个例子 乍一看确实没太明白 机器A怎么就拿到机器B的私有ip了  我理解的是为了说明 两个本地局域网之间访问的问题吧 ，就是说，机器A所在网段的网关 与 机器B 所在网段的网关，两个网关 所在的网段 是同一个，是为了说明这个问题吧？

  作者回复: 对的，是两个本地局域网

  2019-08-30

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/12/f0/21/7168f973.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  JStFs

  贴一张地址转换表，4个字段，清清楚楚，可以减少评论区至少一半的疑问，有时候一图胜千文

  作者回复: 对于已经有基础的，的确转换表更直观

  2019-08-16

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/60/17/2c2c21b6.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  无敌小饭桶

  老师您好，我最近在配置网络摄像头，摄像头配置在内网环境，我请问下想萤石云这种软件如何从内网环境获取视频流的，然后再手机端可以获取的，我理解是有一个转发服务器，但是不清楚他们是怎么做到的，是因为网络摄像头能把视频流实时的推送他们的转发服务器，然后手机请求转发服务器拉去相应的视频流么？

  作者回复: 摄像头里面有agent，推送到云端，然后手机也是从云端下载的。可以看一下视频云的相关资料

  2019-07-25

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/14/83/af/1cb42cd3.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  马以

  老师，公网IP实在太贵了，比如我们平时租的服务器，是一台机器对应一个公网ip呢？还是说很多太服务器也是被NAT为一个出口？

  作者回复: 可以一台对一个，但是要付钱

  2019-07-12

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/14/83/af/1cb42cd3.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  马以

  老师这里面说的路由器的5个网段是指的网络的5种ip地址吗？

  作者回复: 不是，是五个网口，每个网口一个网段

  2019-07-12

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/0f/a5/5f/05d97868.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  DaDo Wang

  NAT不使用端口时，N个公网IP的专用网中最多只有N个主机，这样才能NAT。 后台 NAT路由开始借助端口，将一个公网IP+端口 映射成 多个内网主机+端口。这样就提高了IP利用率。

  作者回复: 是的

  2019-06-29

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/17/e8/5f/3da7df6e.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  小小杰吖！

  可是如果我只知道某一个内网的IP，要怎么ping吖

  作者回复: 没法ping了

  2019-06-21

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/17/e8/5f/3da7df6e.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  小小杰吖！

  对不起啊老师、我实在理解不了电脑装两个网卡如何在连一个交换机进而工作的，能否详细讲解一下吖

  作者回复: 这需要bond了

  2019-06-21

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/4c/be/25919d4b.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  FF

  那么第一种转发网关基本上用不到了咯

  作者回复: 数据中心内部会的

  2019-06-21

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/12/c0/ce/fc41ad5e.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  陳先森

  都是公网ip的情况下，也就是不用做nat映射

  作者回复: NAT另外讲

  2019-06-20

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/12/12/f9/7e6e3ac6.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Geek_04e22a

  路由器会把外网IP加端口映射成内网的IP，即NAPT

  作者回复: 赞

  2019-05-31

  **

  **

- ![img](https://thirdwx.qlogo.cn/mmopen/vi_32/jFWS9tNKKqGs8y0Ybbj6IibH8owGPHAQE4ev6VZ90JCU3VSN8aT4IcbQo6mpFrxkU3RWdXMJHaFiagBEVpMI5lhQ/132)

  Geek_137edd

  有个问题，路由怎么知道发给内网哪个主要呢？

  作者回复: 有路由表，同一个网段的话，就直接arp了

  2019-05-16

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/16/cb/a2/5e7c557e.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  傲娇的小宝

  第一个问题当年大学学的时候其实有点稀里糊涂，最近听老师讲，我觉得应该是这样的流程，如有错误还请老师指正。因为是通过公网通信，假设请求是从A到B的（A、B都是公网IP），B通过解析报文，获得源IP，通过MAC地址获得A的信息（能通信，必然路由表有记录），然后返回的报文将解析的源IP地址封装为目标IP，再通过mac地址信息发送给A，A根据它解析到的目标ip和路由表转发到下一跳，直到到达目标主机。

  2019-05-14

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/4f/bd/e08af2e9.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  冷萃浮乐朵

  为什么情况二，网关B在转发出去时，源IP是写网口的地址，而不是主机A的国际地址？

  作者回复: 主机A的国际地址就是在网口上

  2019-05-09

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/0f/e8/4b/57fa0e34.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  brianway

  会不会存在多级NAT的情况？比如电脑1连接卧室的路由器C，卧室路由器C连接客厅路由器A，卧室的路由器C的外网口是路由器A分配的私有地址，电脑1的ip是卧室路由器C分配的私有地址。

  作者回复: 会的，可以多次NAT

  2019-05-08

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/03/15/293a185d.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  JRich

  感觉应该会带上源主机的私有ip地址，只不过被隐藏起来不被看见，返回时解析就能找到源主机。

  2019-04-29

  **

  **

- ![img](https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI8iabFMZNZb2FzejezzahEL1KK0O6EBpmfLcbT5O2b8sCLlUADfEicn8Nniagf0PKQ7dHQqN1kkLw8Q/0)

  Jalins

  可不可以这么理解，第一种情况描述的是两个公网IP的相互访问，而第二种情况是两个不同内网IP之间的相互访问？

  作者回复: 第一种情况是局域网内两个ip，第二种情况是两个公网ip

  2019-04-11

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/0f/fd/0a/47b515da.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  赵帅

  第二种情况的原mac地址没有变过

  作者回复: 应该是变的

  2019-04-04

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/14/10/5d/9fc4ae25.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  K

  我记得NAT转换中内网IP和外网IP好像是动态绑定的，有一个绑定时间，时间过期后其他内网IP才能进行绑定与外网进行数据交互，不过不知道对不对

  作者回复: 不是动态绑定的。SNAT conntrack

  2019-04-02

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/13/ec/8f/8299495a.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  少盐

  原来就在想世界上那么多联网设备，ip 肯定不够，原来是局域网内共用少量的外网ip

  作者回复: 是的，ipv6就好很多了

  2019-03-31

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/12/4c/6d/c20f2d5a.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  LJK

  小白求教，国际地址就是Public IP，国内地址就是Private IP，是这样吗？鉴于这个App没有回复功能，如果是的话请帮忙点赞。

  作者回复: 不是国内和国际。运营商分配的也是公网ip，家里的是私网ip

  2019-03-29

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/12/e9/29/629d9bb0.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  天王

  MAC头里有源mac地址，目标mac地址和协议类型。ip头里有版本号，目前是IPv4，服务类型TOS，8位标识协议，到下一层的协议，还有源ip和目标ip地址。先看下源ip和目标ip是不是同一个9网段，如果是同一个网段，通过ARP获取到mac地址，发出去就能被目标服务器收到了。如果不是同一个网段，通过ARP获取到默认网关的mac地址，加上请求头发到默认网关上。路由器是一台设备，有5个网口相当于5只手，每个网口相当于控制那个网络的网关。路由器会通过一只手把包拿过来，拿掉IP头和mac头，通过路由算法，转到哪个手上。欧洲十国游不改变ip地址，转发网关。不在一个网段，先找网关的mac地址，第一次的目标mac地址，然后通过静态路由配置的规则，通过ip找到对应的网口，先判断网口的网段和目标ip网段是否一样，如果一样，则直接通过ARP获取目标mac的地址，发出去。如果不是在一个网段，则找到下一个的网关的ip，再通过ARP获得mac地址，跳到下一个网关，直到找到为止。NAT网关就是，一台服务器有一个局域网地址和一个公网地址，用内网地址会重复，所以源ip会使用运营商的ip，发到网关服务器之后，NAT网关会转成内网ip，再获取到MaAC地址。家庭路由器是一个NaT网关，转成外网地址。

  2019-03-23

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/e4/e9/0dd3829f.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  aguan(^･ｪ･^)

  有个疑问＼(◎o◎)／！有个最后服务器B收到的包里面还能知道源IP地址是：服务器A的外网IP地址呢？太神奇了

  作者回复: SNAT，在服务器A的外网网关，会做一次IP地址转换，用外网IP替换内网IP

  2019-03-01

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/46/18/636b9a31.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  非武

  可以回答一下楼上的这个问题嘛？ 老师，你在第二种情况说，网关B上记下来，国际身份192.168.56.2对应国内身份192.168.1.101。那么如果该局域网内还有很多其他机器，比如192.168.1.102，103等等，它们对应的国际身份呢？如果也是192.168.56.2，那么从192.168.56.1发来请求时，网关B要将该消息转发到哪个国内身份呢？

  作者回复: 赞，参考conntrack

  2019-01-30

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/12/08/94/2c22bd4e.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](%E7%AC%AC8%E8%AE%B2%20_%20%E4%B8%96%E7%95%8C%E8%BF%99%E4%B9%88%E5%A4%A7%EF%BC%8C%E6%88%91%E6%83%B3%E5%87%BA%E7%BD%91%E5%85%B3%EF%BC%9A%E6%AC%A7%E6%B4%B2%E5%8D%81%E5%9B%BD%E6%B8%B8%E4%B8%8E%E7%8E%84%E5%A5%98%E8%A5%BF%E8%A1%8C.resource/resize,w_14.png)

  克里斯

  老师的外网ip地址用的都是私有ip地址192.168.*.*，不对吧？

  作者回复: 意思到了，是不应该用私有ip地址

  2019-01-26

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/15/26/52/c74f3ff7.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  谢

  玄奘西行版的图在排版上有点小错误，不过有老师这么精彩的讲演并不影响哈~

  2019-01-25

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/13/db/26/54f2c164.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  靠人品去赢

  我按我的理解说一下， （1）路由网关 路由大家都看过用过，一个WAN口 4个LAN口就很常见，四个LAN口就像文章说的四个手，可以管理四个局域网。但是往外面发消息就是LAN到WAN口操作，操作要复杂一下哦（参考一下你出入境的过程），路由是一个设备，他有一个负责信息“出入境”的功能或者部门，“海关”即网关。 （2）欧洲旅游与玄奘西行 这个其实就是关于 转发网关和NAT网关 的理解。欧洲大家都知道，欧盟内部拿着自己的国家的身份证随便转，不用去A国就要办A国的护照。咱们去欧洲就要办护照，你那身份证人家也看不懂。-----》身份证对应的是IP，IP网关不改就是转发，IP网关给你改了你就是NAT。 （3）信息传出去与传回来 传出去是转发你就转发，是NAT你就NAT变换IP再传出去。回来这部分我理解的也不是很好，知道有一个映射表的东西可以让转发回来的知道是你的，传给你。 希望有人能指点一下，比如说公司好多人访问百度，大家访问的问题不一样，百度返回过来的东西都是A问题对应A解释，B问题B解释的，都是对应的上没差错，这个是怎么做到的，难道是靠路由映射表来维护？还有关于WEB服务器对于成千上万的请求，的返回，我知道端口是定死的80，怎么做到A的请求给A的回应，B的给B，C的给C？

  作者回复: 百度是http，是基于tcp，是建立了连接的，一对一的连接。

  2019-01-19

  **

  **

- ![img](http://thirdwx.qlogo.cn/mmopen/vi_32/OVq8d3D1m1SkoOUL6iaerJjDfVlibDDfutGBJ3ceu2vpskOXb6ib6vS7iaLAQSUK7U5kv2xrHcdqFXR6ROo5QeAhow/132)

  Oliveryoung

  在路由器 B 中配置了静态路由，要想访问 192.168.4.0/24，要从 192.168.4.1 这个口出去，没有下一跳了。因为我右手这个网卡，就是这个网段的，我是最后一跳了。 192.168.4.0/24 应该是 192.168.4.101/24

  作者回复: 先判断网段，然后才arp

  2019-01-05

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/13/2b/ec/af6d0b10.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  caohuan

  本篇所得：1.玄奘西游，需要转换IP地址，把外网 与内网相互转换，欧洲十日游 不需要转换 IP地址； 2.静态配置路由 为规定 哪个口 访问对应的外网； 3.离开 局域网 需要经过网关，网关是路由器的一个网口； 4.路由为三层设备，里面包括 下一跳的信息； 老师的问题1.公网IP转 私有IP，以及私有IP转化为公网IP，可以用一套算法，正向、反向类推。 2.自动匹配 可以用 数据结构+算法，自动匹配路由的IP，既方便又效率。

  2018-12-31

  **

  **

- ![img](https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKquyF7gtbe0du33bWFxEaial4LsnhIClicAUduiac5YZHV6gKz1TibkibVyCBPmeYcgzic3MDBBXyP73kw/0)

  听说改名可以变帅～

  所谓的变ip是只源ip变成了网关的ip吧，目标ip是对方的公网ip，对吗？

  2018-12-13

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/13/00/a4a2065f.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Michael

  终于知道了网关这个概念，以及和路由器之间的关系，还有 MAC 头，学校真的只是讲了个概念哇

  2018-12-06

  **

  **

- ![img](http://thirdwx.qlogo.cn/mmopen/vi_32/ABjAPveWxOuBs3ibbCaBicX7OSibic3prycYG9vOicGHMEv8Vws5o3epykBSFHkbysnaKeMqQaJufINNUncGhmAEomg/132)

  雪人

  不知道现在留言还会不会被回复，报名的有点晚。 老师好，这里我说一下自己的理解，还有一些不太理解，希望您能解答一下， 第一个问题，每个计算机跟一个网关或者路由器，或者交换机，反正就是一个转发中枢，那么他是提前知道这个转发中枢的Mac地址吗？ 1，第一个那个十国游型，转发网络包的过程，第一步，先带着目标IP地址将根据交换机的Mac将网络包发送到交换机处，然后交换机拿着目标IP去轮询（或者直接通过他的路由表找到目标交换机的Mac地址），找到包含这个目标IP所在的那个交换机的Mac地址，然后重新把这个Mac地址封装到网络包并发送，这个网络包就会被发送到下一个交换机，直到发送到目标IP地址所在的主机。是这样的嘛？还是说我哪里理解的有问题？

  作者回复: 如果是交换机，不用知道他的mac，但是路由器，可以通过arp得到mac

  2018-12-04

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/14/22/69/09f7a8a2.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Don Wang

  在路由器 A 中配置了静态路由之后，要想访问 192.168.4.0/24，要从 192.168.56.1 这个口出去，下一跳为 192.168.56.2。  访问的Ip 写错了？

  2018-11-28

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/12/b9/f0/cf8e01e5.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Ada

  老师，玄奘西游行的时候，文稿里面为什么路由器A和路由器B都是最后一跳了？路由器A不是还有一跳是跳到路由器B的啊？我理解错了吗？

  2018-11-25

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/12/c8/f0/a37daf86.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  👹

  假设目标内网有多台服务器，我要访问其中一台a，但如果我只有他网关的公网ip加80端口，那我走到网关后他怎么知道我要访问哪台呢，如果每台服务器在网关那的端口号不一样，我通过什么方式知道我要访问的a服务器在网关的端口是多少

  作者回复: 要不就是用多个公网ip映射为私网ip，如果只有一个公网ip，只能映射到一个私网ip，一般会映射到负载均衡器上，然后再分发

  2018-11-24

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/12/37/1b/82310e20.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  拿笔小星

  对文中的交换机和路由器，有点傻傻分不清了，还有之前说的集线器，他们三个可否说说区别以及发展作用？

  作者回复: 集线器是物理层，交换机是二层，路由器是三层

  2018-11-24

  **2

  **

- ![img](https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](%E7%AC%AC8%E8%AE%B2%20_%20%E4%B8%96%E7%95%8C%E8%BF%99%E4%B9%88%E5%A4%A7%EF%BC%8C%E6%88%91%E6%83%B3%E5%87%BA%E7%BD%91%E5%85%B3%EF%BC%9A%E6%AC%A7%E6%B4%B2%E5%8D%81%E5%9B%BD%E6%B8%B8%E4%B8%8E%E7%8E%84%E5%A5%98%E8%A5%BF%E8%A1%8C.resource/resize,w_14.png)

  HelloBug

  老师，家用NAT路由出去的网络包的IP地址都是运营商的IP，每个家庭出去的运营商的IP应该不能重复吧？可是公网IP很贵，运营商是不是用了什么策略使IP可以重复呢？

  2018-11-22

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/0f/d8/0a/9c734a9d.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  潇xiao

  请问一下老师，给路由器的内网端口配置ip地址，是不是任意配，只要网络地址相同，主机号不冲突即可？

  作者回复: 可以的

  2018-11-22

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/12/8a/9a/7270d764.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Enterprize

  请教下百度查办公室出口ip和谷歌查出口ip为啥有时不一样呢

  作者回复: 你们公司有多个snat出口

  2018-11-20

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/13/e2/63/039f3896.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  阿吉

  这章看得晕，写的有点啰嗦，不容易抓到重点笔记有点靠猜。 手机和笔记本连同一个wifi，查到的公有IP 不相同，子网内所有设备访问外网都会获得一个零时的独立公用地址吗？ 8网关 getway 三层设备  转发网关 改Mac不改IP nat网关 (network address translation) Mac和IP都改 有两个IP，一个对内一个对外 whatismyip.com查公网IP地址

  2018-11-14

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/12/6f/63/abb7bfe3.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  扬～

  如果目的地址是另一个网段的私有地址，网关是如何知道它的国际身份呢？

  作者回复: 两边都要nat

  2018-10-30

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/19/ee/e395a35e.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  小先生

  静态路由，规则需要手动配置。

  2018-09-30

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/12/d7/85/f2d5997a.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Zzzzz

  包到达 192.168.1.1 这个网口，发现 MAC 一致，将包收进来，开始思考往哪里转发。 老师，这里是不是反了？不是应该先匹配mac地址是否一致，再进行ip转发的处理？为什么是先判断ip是否一致，再进行mac匹配？

  作者回复: 真正发送数据包的时候，是整个局域网都能收到的

  2018-09-30

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/12/f2/9e/2385f57c.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  冰水

  当服务器B收到A的求情时，IP地址都改变了，怎么知道返回信息给服务器A呢

  作者回复: 在网关做映射，conntrack

  2018-09-30

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/2d/18/918eaecf.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  后端进阶

  不能继续回复是真的蛋疼，继续向老师提问，根据contract评论，那么就意味着不能并行处理相同端口的请求了吗？只能并发处理，如果这时同时出现n多个相同端口请求，那么路由器是不是只能一个一个处理？

  作者回复: 端口也会变

  2018-09-29

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/2d/18/918eaecf.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  后端进阶

  老师，看到评论区，我又有一个疑问了：当内网同时有两个端口号请求同一个目标ip，那么网关应该怎么标记才不会有冲突呢？

  作者回复: 见答疑里面的conntrack

  2018-09-29

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/2d/18/918eaecf.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  后端进阶

  不得不说，IPv4就是一个沉重的历史包袱，IPv6每人一个独立的ip不就简化了很多步骤吗？

  2018-09-29

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/53/e9/f244988e.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  NIRVANA

  IP地址为:192.168.88.103,但是默认网关IP地址为192.168.89.1,这个怎么理解啊老师?还有各位前辈,请教请教,对这一块有些懵逼.

  作者回复: 子网掩码怎么配置的呢？就是带255的那个

  2018-09-27

  **

  **

- ![img](http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoh6rMNGKHZe7OLnd0sNTZAIMlG5UD5l4hj0ibQUXU1N9zqHx2uPnhuJevN40pDyCs5vfDVkgsETZQ/132)

  0x7c00

  两个路由器之前的通讯还是三层的，应该还是路由协议，不需要mac地址吧？高层协议不依赖下一层协议。现在的交换机都是三层交换，路由mac一起处理

  作者回复: 需要mac地址的

  2018-09-08

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/0f/fc/34/c733b116.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  何磊

  回答下第一个思考题：当我们从内网请求互联网时，在经过地址转换设备时，该设备会替换IP头中的IP为公网IP，并且标记该包从哪个端口发出。此时设备会把内网实际发请求机器的内网IP与端口和该设备的IP与端口记录下来。那么当服务器响应时，自然就可以通过公网IP与端口找到对应的内网IP与端口。 然后请求完成后，删除该记录，端口可以复用。

  作者回复: conntrack

  2018-09-04

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/b0/12/cddd766c.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  大树

  您讲的宿舍长的电脑两个网卡，一个接校园网，一个接宿舍内局域网，是否需要在宿舍长的机器上配个转发才能实现大家上网，还是需要配置静态路由呢？

  2018-08-06

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/e2/58/8c8897c8.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  杨春鹏

  服务器A与服务器B通信的时候，什么时候使用转发网关，什么时候使用NAT网关？也就是什么时候IP可见，什么时候IP不可见，需要进行内网转公网

  2018-08-04

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/a2/da/a8a32113.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  太子长琴

  当时宿舍上网我记得是宿舍预留的口接出来到交换机，其他人也通过交换机连接，而且必须设置一个固定的ip

  2018-08-01

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/0f/67/0e/c77ad9b1.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  eason2017

  老师，西行类型的，是如何返回的呢？在国际间转发是，本地放的国际路由器会记录映射吗？返回时，好知道是谁的？采用啥协议呀？

  2018-08-01

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/1a/e5/6899701e.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  favorlm

  请问老师，宿舍长的网卡，怎么会让其他电脑可以上网。

  2018-07-27

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/0f/4b/e4/abb7bfe3.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](%E7%AC%AC8%E8%AE%B2%20_%20%E4%B8%96%E7%95%8C%E8%BF%99%E4%B9%88%E5%A4%A7%EF%BC%8C%E6%88%91%E6%83%B3%E5%87%BA%E7%BD%91%E5%85%B3%EF%BC%9A%E6%AC%A7%E6%B4%B2%E5%8D%81%E5%9B%BD%E6%B8%B8%E4%B8%8E%E7%8E%84%E5%A5%98%E8%A5%BF%E8%A1%8C.resource/resize,w_14.png)

  Alvan

  有个地方不太理解，服务器A只能通过子掩网码发现服务器B跟自己不是一个网段，而不能知道服务器B是哪一个网段吧?没有服务器B的子网掩码怎么能够知道服务器B所在的网段？

  作者回复: 服务器b的ip按服务器a的子网掩码算一下，就知道了

  2018-07-19

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/d6/60/f21b2164.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  jacy

  越读越明白，生动有趣，跟读head first系列一个感觉，爽

  2018-07-05

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](%E7%AC%AC8%E8%AE%B2%20_%20%E4%B8%96%E7%95%8C%E8%BF%99%E4%B9%88%E5%A4%A7%EF%BC%8C%E6%88%91%E6%83%B3%E5%87%BA%E7%BD%91%E5%85%B3%EF%BC%9A%E6%AC%A7%E6%B4%B2%E5%8D%81%E5%9B%BD%E6%B8%B8%E4%B8%8E%E7%8E%84%E5%A5%98%E8%A5%BF%E8%A1%8C.resource/resize,w_14.png)

  一步![img](https://static001.geekbang.org/resource/image/89/43/89yyff4c4c2e2b73ce4931bb01a6a943.png)

  老师我想咨询一个问题，是这样的我有一个wifi手机是可以连接上网的，但是我的mac笔记本连接wifi的时候提示：wifi有自分配ip169.254.218.86将无法连接互联网，我网上查了一下手动配置了一下dhcp获取ip让他和路由器在同一个网段，显示连接上了，但是不能上网的，这是什么原因，怎么解决呢？

  2018-06-30

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/ac/c8/4b1c0d40.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  勤劳的小胖子-libo

  Linux系统中会设置这个网关是转发还是Nat吧？这二者可以并存吗？

  作者回复: 见iptables

  2018-06-19

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/5a/76/3f8dcda6.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  陈亦凡

  ip头和mac头改变的两个例子很棒，看完有了最基本的认识，再结合网上的资料就很容易理解了

  2018-06-14

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/46/6a/6f40611d.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Jing

  能否讲解下dns 我怎么拿到bbs ip地址的

  作者回复: 以后会有一节讲的

  2018-06-14

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/66/34/0508d9e4.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  u

  本来是很想睡了，听着听着，就精神了。。。

  2018-06-09

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/4b/cd/185e5378.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  泊浮目

  老师，关于第一个问题。为什么NAT server不记录mac地址来确定是不是我的请求呢？

  2018-06-09

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/48/7f/eff2c474.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  沒結果的花

  请问老师，最后一跳如何在思考时匹配到下一跳路由的呢

  作者回复: 路由表里面也有一条

  2018-06-07

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/60/be/68ce2fd0.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  小田

  \#提纲 路由器 vs 网关 MAC头和IP头关键内容：地址、协议类型 路由器是三层设备：读取到IP层 静态路由：固定目标IP与出口IP的对应关系 网关分类：转发型、NAT型

  2018-06-07

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/0f/82/8a/fc2cfe30.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  欧文先生

  通勤路上边学边思考，温故知新，受益良多，感谢老师的精心准备！

  2018-06-05

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/61/44/66cd6f3f.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  A7

  1.设备上维护链接表。 2.路由设备间通过动态路由协议学习或计算出路由。

  2018-06-04

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/28/1e/76e19bd3.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  张立春

  对于今天的问题：返回包的目标ip是NAT路由器公网ip，路由器怎么知道把这个包翻译成私网的某一个主机呢？我理解NAT路由器需要维护一张session映射表或者包中某个位置要始终存放真正目的ip。

  2018-06-04

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/32/3f/fa4ac035.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  sunlight001

  访问局域网时，不改变网关地址，只换mac地址，访问公网时，出网会改变ip地址

  2018-06-04

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/0f/e7/38/310001f2.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  普罗米修斯

  等更新等的好辛苦，老师讲的真好。

  2018-06-04
