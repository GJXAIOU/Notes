# 29ç†è®ºä¸‰ï¼šä»€ä¹ˆæ˜¯ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Ÿå¦‚ä½•å†™å‡ºå¯æµ‹è¯•æ€§å¥½çš„ä»£ç ï¼Ÿ

å®é™…ä¸Šï¼Œå†™å•å…ƒæµ‹è¯•å¹¶ä¸éš¾ï¼Œä¹Ÿä¸éœ€è¦å¤ªå¤šæŠ€å·§ï¼Œç›¸åï¼Œå†™å‡ºå¯æµ‹è¯•çš„ä»£ç åå€’æ˜¯ä»¶éå¸¸æœ‰æŒ‘æˆ˜çš„äº‹æƒ…ã€‚æ‰€ä»¥ï¼Œä»Šå¤©ï¼Œæˆ‘ä»¬å°±å†æ¥èŠä¸€èŠä»£ç çš„å¯æµ‹è¯•æ€§ï¼Œä¸»è¦åŒ…æ‹¬è¿™æ ·å‡ ä¸ªé—®é¢˜ï¼š

- ä»€ä¹ˆæ˜¯ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Ÿ å¦‚ä½•å†™å‡ºå¯æµ‹è¯•çš„ä»£ç ï¼Ÿ

- æœ‰å“ªäº›å¸¸è§çš„ä¸å¥½æµ‹è¯•çš„ä»£ç ï¼Ÿ

## ç¼–å†™å¯æµ‹è¯•ä»£ç æ¡ˆä¾‹å®æˆ˜

åˆšåˆšæåˆ°çš„è¿™å‡ ä¸ªå…³äºä»£ç å¯æµ‹è¯•æ€§çš„é—®é¢˜ï¼Œæˆ‘å‡†å¤‡é€šè¿‡ä¸€ä¸ªå®æˆ˜æ¡ˆä¾‹æ¥è®²è§£ã€‚å…·ä½“çš„è¢«æµ‹è¯•ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚

å…¶ä¸­ï¼ŒTransaction æ˜¯ç»è¿‡æˆ‘æŠ½è±¡ç®€åŒ–ä¹‹åçš„ä¸€ä¸ªç”µå•†ç³»ç»Ÿçš„äº¤æ˜“ç±»ï¼Œç”¨æ¥è®°å½•æ¯ç¬”è®¢å•äº¤æ˜“çš„æƒ…å†µã€‚Transaction ç±»ä¸­çš„ execute() å‡½æ•°è´Ÿè´£æ‰§è¡Œè½¬è´¦æ“ä½œï¼Œå°†é’±ä»ä¹°å®¶çš„é’±åŒ…è½¬åˆ°å–å®¶çš„é’±åŒ…ä¸­ã€‚çœŸæ­£çš„è½¬è´¦æ“ä½œæ˜¯é€šè¿‡è°ƒç”¨ WalletRpcService RPC æœåŠ¡æ¥å®Œæˆçš„ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œä»£ç ä¸­è¿˜æ¶‰åŠä¸€ä¸ªåˆ†å¸ƒå¼é” DistributedLock å•ä¾‹ç±»ï¼Œç”¨æ¥é¿å… Transaction å¹¶å‘æ‰§è¡Œï¼Œå¯¼è‡´ç”¨æˆ·çš„é’±è¢«é‡å¤è½¬å‡ºã€‚

```java
public class Transaction {
    private String id;
    private Long buyerId;
    private Long sellerId;
    private Long productId;
    private String orderId;
    private Long createTimestamp;
    private Double amount;
    private STATUS status;
    private String walletTransactionId;
    // ...get() methods...
    public Transaction(String preAssignedId, Long buyerId, Long sellerId, Long p){
        if (preAssignedId != null && !preAssignedId.isEmpty()) {
            this.id = preAssignedId;
        } else {
            this.id = IdGenerator.generateTransactionId();
        }
        if (!this.id.startWith("t_")) {
            this.id = "t_" + preAssignedId;
        }
        this.buyerId = buyerId;
        this.sellerId = sellerId;
        this.productId = productId;
        this.orderId = orderId;
        this.status = STATUS.TO_BE_EXECUTD;
        this.createTimestamp = System.currentTimestamp();
    }
    public boolean execute() throws InvalidTransactionException {
        if ((buyerId == null || (sellerId == null || amount < 0.0))){
            throw new InvalidTransactionException(...);
        }
        if (status == STATUS.EXECUTED) return true;
        boolean isLocked = false;
        try {
            isLocked = RedisDistributedLock.getSingletonIntance().lockTransction(id);
            if (!isLocked) {
                return false; // é”å®šæœªæˆåŠŸï¼Œè¿”å› falseï¼Œjob å…œåº•æ‰§è¡Œ
            }
            if (status == STATUS.EXECUTED) return true; // double check
            long executionInvokedTimestamp = System.currentTimestamp();
            if (executionInvokedTimestamp - createdTimestap > 14days) {
                this.status = STATUS.EXPIRED;
                return false;
            }
            WalletRpcService walletRpcService = new WalletRpcService();
            String walletTransactionId = walletRpcService.moveMoney(id, buyerId, sell);
            if (walletTransactionId != null) {
                this.walletTransactionId = walletTransactionId;
                this.status = STATUS.EXECUTED;
                return true;
            } else {
                this.status = STATUS.FAILED;
                return false;
            }
        } finally {
            if (isLocked) {
                RedisDistributedLock.getSingletonIntance().unlockTransction(id);
            }
        }
    }
}
```

å¯¹æ¯”ä¸Šä¸€èŠ‚è¯¾ä¸­çš„ Text ç±»çš„ä»£ç ï¼Œè¿™æ®µä»£ç è¦å¤æ‚å¾ˆå¤šã€‚å¦‚æœè®©ä½ ç»™è¿™æ®µä»£ç ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œä½ ä¼šå¦‚ä½•æ¥å†™å‘¢ï¼Ÿä½ å¯ä»¥å…ˆè¯•ç€æ€è€ƒä¸€ä¸‹ï¼Œç„¶åå†æ¥çœ‹æˆ‘ä¸‹é¢çš„åˆ†æã€‚

åœ¨ Transaction ç±»ä¸­ï¼Œä¸»è¦é€»è¾‘é›†ä¸­åœ¨ execute() å‡½æ•°ä¸­ï¼Œæ‰€ä»¥å®ƒæ˜¯æˆ‘ä»¬æµ‹è¯•çš„é‡ç‚¹å¯¹è±¡ã€‚ä¸ºäº†å°½å¯èƒ½å…¨é¢è¦†ç›–å„ç§æ­£å¸¸å’Œå¼‚å¸¸æƒ…å†µï¼Œé’ˆå¯¹è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘è®¾è®¡äº†ä¸‹é¢ 6 ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚

1.  æ­£å¸¸æƒ…å†µä¸‹ï¼Œäº¤æ˜“æ‰§è¡ŒæˆåŠŸï¼Œå›å¡«ç”¨äºå¯¹è´¦ï¼ˆäº¤æ˜“ä¸é’±åŒ…çš„äº¤æ˜“æµæ°´ï¼‰ç”¨çš„ walletTransactionIdï¼Œäº¤æ˜“çŠ¶æ€è®¾ç½®ä¸º EXECUTEDï¼Œå‡½æ•°è¿”å› trueã€‚

2.  buyerIdã€sellerId ä¸º nullã€amount å°äº 0ï¼Œè¿”å› InvalidTransactionExceptionã€‚

3.  äº¤æ˜“å·²è¿‡æœŸï¼ˆcreateTimestamp è¶…è¿‡ 14 å¤©ï¼‰ï¼Œäº¤æ˜“çŠ¶æ€è®¾ç½®ä¸º EXPIREDï¼Œè¿”å› falseã€‚

4.  äº¤æ˜“å·²ç»æ‰§è¡Œäº†ï¼ˆstatus==EXECUTEDï¼‰ï¼Œä¸å†é‡å¤æ‰§è¡Œè½¬é’±é€»è¾‘ï¼Œè¿”å› trueã€‚

5.  é’±åŒ…ï¼ˆWalletRpcServiceï¼‰è½¬é’±å¤±è´¥ï¼Œäº¤æ˜“çŠ¶æ€è®¾ç½®ä¸º FAILEDï¼Œå‡½æ•°è¿”å› falseã€‚

6.  äº¤æ˜“æ­£åœ¨æ‰§è¡Œç€ï¼Œä¸ä¼šè¢«é‡å¤æ‰§è¡Œï¼Œå‡½æ•°ç›´æ¥è¿”å› falseã€‚

æµ‹è¯•ç”¨ä¾‹è®¾è®¡å®Œäº†ã€‚ç°åœ¨çœ‹èµ·æ¥ä¼¼ä¹ä¸€åˆ‡è¿›å±•é¡ºåˆ©ã€‚ä½†æ˜¯ï¼Œäº‹å®æ˜¯ï¼Œå½“æˆ‘ä»¬å°†æµ‹è¯•ç”¨ä¾‹è½å®åˆ°å…·ä½“çš„ä»£ç å®ç°æ—¶ï¼Œä½ å°±ä¼šå‘ç°æœ‰å¾ˆå¤šè¡Œä¸é€šçš„åœ°æ–¹ã€‚å¯¹äºä¸Šé¢çš„æµ‹è¯•ç”¨ä¾‹ï¼Œç¬¬ 2 ä¸ªå®ç°èµ·æ¥éå¸¸ç®€å•ï¼Œæˆ‘å°±ä¸åšä»‹ç»äº†ã€‚æˆ‘ä»¬é‡ç‚¹æ¥çœ‹å…¶ä¸­çš„ 1 å’Œ 3ã€‚æµ‹è¯•ç”¨ä¾‹ 4ã€5ã€6 è·Ÿ 3 ç±»ä¼¼ï¼Œç•™ç»™ä½ è‡ªå·±æ¥å®ç°ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬å°±æ¥çœ‹æµ‹è¯•ç”¨ä¾‹ 1 çš„ä»£ç å®ç°ã€‚å…·ä½“å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public void testExecute() {
    Long buyerId = 123L;
    Long sellerId = 234L;
    Long productId = 345L;
    Long orderId = 456L;
    Transction transaction = new Transaction(null, buyerId, sellerId, productId,orderId);
    boolean executedResult = transaction.execute();
    assertTrue(executedResult);
}
```

execute() å‡½æ•°çš„æ‰§è¡Œä¾èµ–ä¸¤ä¸ªå¤–éƒ¨çš„æœåŠ¡ï¼Œä¸€ä¸ªæ˜¯ RedisDistributedLockï¼Œä¸€ä¸ª WalletRpcServiceã€‚è¿™å°±å¯¼è‡´ä¸Šé¢çš„å•å…ƒæµ‹è¯•ä»£ç å­˜åœ¨ä¸‹é¢å‡ ä¸ªé—®é¢˜ã€‚

å¦‚æœè¦è®©è¿™ä¸ªå•å…ƒæµ‹è¯•èƒ½å¤Ÿè¿è¡Œï¼Œæˆ‘ä»¬éœ€è¦æ­å»º Redis æœåŠ¡å’Œ Wallet RPC æœåŠ¡ã€‚æ­å»ºå’Œç»´æŠ¤çš„æˆæœ¬æ¯”è¾ƒé«˜ã€‚

æˆ‘ä»¬è¿˜éœ€è¦ä¿è¯å°†ä¼ªé€ çš„ transaction æ•°æ®å‘é€ç»™ Wallet RPC æœåŠ¡ä¹‹åï¼Œèƒ½å¤Ÿæ­£ç¡®è¿”å›æˆ‘ä»¬æœŸæœ›çš„ç»“æœï¼Œç„¶è€Œ Wallet RPC æœåŠ¡æœ‰å¯èƒ½æ˜¯ç¬¬ä¸‰æ–¹ï¼ˆå¦ä¸€ä¸ªå›¢é˜Ÿå¼€å‘ç»´æŠ¤çš„ï¼‰çš„æœåŠ¡ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬å¯æ§çš„ã€‚æ¢å¥è¯è¯´ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬æƒ³è®©å®ƒè¿”å›ä»€ä¹ˆæ•°æ®å°±è¿”å›ä»€ä¹ˆã€‚

Transaction çš„æ‰§è¡Œè·Ÿ Redisã€RPC æœåŠ¡é€šä¿¡ï¼Œéœ€è¦èµ°ç½‘ç»œï¼Œè€—æ—¶å¯èƒ½ä¼šæ¯”è¾ƒé•¿ï¼Œå¯¹å•å…ƒæµ‹è¯•æœ¬èº«çš„æ‰§è¡Œæ€§èƒ½ä¹Ÿä¼šæœ‰å½±å“ã€‚

ç½‘ç»œçš„ä¸­æ–­ã€è¶…æ—¶ã€Redisã€RPC æœåŠ¡çš„ä¸å¯ç”¨ï¼Œéƒ½ä¼šå½±å“å•å…ƒæµ‹è¯•çš„æ‰§è¡Œã€‚

æˆ‘ä»¬å›åˆ°å•å…ƒæµ‹è¯•çš„å®šä¹‰ä¸Šæ¥çœ‹ä¸€ä¸‹ã€‚**å•å…ƒæµ‹è¯•ä¸»è¦æ˜¯æµ‹è¯•ç¨‹åºå‘˜è‡ªå·±ç¼–å†™çš„ä»£ç é€»è¾‘çš„æ­£ç¡®æ€§ï¼Œå¹¶éæ˜¯ç«¯åˆ°ç«¯çš„é›†æˆæµ‹è¯•ï¼Œå®ƒä¸éœ€è¦æµ‹è¯•æ‰€ä¾èµ–çš„å¤–éƒ¨ç³»ç»Ÿï¼ˆåˆ†å¸ƒå¼é”ã€Wallet RPC æœåŠ¡ï¼‰çš„é€»è¾‘æ­£ç¡®æ€§ã€‚**æ‰€ä»¥ï¼Œå¦‚æœä»£ç ä¸­ä¾èµ–äº†å¤–éƒ¨ç³»ç»Ÿæˆ–è€…ä¸å¯æ§ç»„ä»¶ï¼Œæ¯”å¦‚ï¼Œéœ€è¦ä¾èµ–æ•°æ®åº“ã€ç½‘ç»œé€šä¿¡ã€æ–‡ä»¶ç³»ç»Ÿç­‰ï¼Œé‚£æˆ‘ä»¬å°±éœ€è¦å°†è¢«æµ‹ä»£ç ä¸å¤–éƒ¨ç³»ç»Ÿè§£ä¾èµ–ï¼Œè€Œè¿™ç§è§£ä¾èµ–çš„æ–¹æ³•å°±å«ä½œâ€œmockâ€ã€‚æ‰€è°“çš„ mock å°±æ˜¯ç”¨ä¸€ä¸ªâ€œå‡â€çš„æœåŠ¡æ›¿æ¢çœŸæ­£çš„æœåŠ¡ã€‚mock çš„æœåŠ¡å®Œå…¨åœ¨æˆ‘ä»¬çš„æ§åˆ¶ä¹‹ä¸‹ï¼Œæ¨¡æ‹Ÿè¾“å‡ºæˆ‘ä»¬æƒ³è¦çš„æ•°æ®ã€‚

é‚£å¦‚ä½•æ¥ mock æœåŠ¡å‘¢ï¼Ÿmock çš„æ–¹å¼ä¸»è¦æœ‰ä¸¤ç§ï¼Œæ‰‹åŠ¨ mock å’Œåˆ©ç”¨æ¡†æ¶ mockã€‚åˆ©ç”¨æ¡†æ¶ mock ä»…ä»…æ˜¯ä¸ºäº†ç®€åŒ–ä»£ç ç¼–å†™ï¼Œæ¯ä¸ªæ¡†æ¶çš„ mock æ–¹å¼éƒ½ä¸å¤§ä¸€æ ·ã€‚æˆ‘ä»¬è¿™é‡Œåªå±•ç¤ºæ‰‹åŠ¨ mockã€‚

æˆ‘ä»¬é€šè¿‡ç»§æ‰¿ WalletRpcService ç±»ï¼Œå¹¶ä¸”é‡å†™å…¶ä¸­çš„ moveMoney() å‡½æ•°çš„æ–¹å¼æ¥å®ç° mockã€‚å…·ä½“çš„ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºã€‚é€šè¿‡ mock çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥è®© moveMoney() è¿”å›ä»»æ„æˆ‘ä»¬æƒ³è¦çš„æ•°æ®ï¼Œå®Œå…¨åœ¨æˆ‘ä»¬çš„æ§åˆ¶èŒƒå›´å†…ï¼Œå¹¶ä¸”ä¸éœ€è¦çœŸæ­£è¿›è¡Œç½‘ç»œé€šä¿¡ã€‚

```java
public class MockWalletRpcServiceOne extends WalletRpcService {
    public String moveMoney(Long id, Long fromUserId, Long toUserId, Double amount){
        return "123bac";
    }
}
public class MockWalletRpcServiceTwo extends WalletRpcService {
    public String moveMoney(Long id, Long fromUserId, Long toUserId, Double amount){
        return null;
    }
}
```

ç°åœ¨æˆ‘ä»¬å†æ¥çœ‹ï¼Œå¦‚ä½•ç”¨ MockWalletRpcServiceOneã€MockWalletRpcServiceTwo æ¥æ›¿æ¢ä»£ç ä¸­çš„çœŸæ­£çš„ WalletRpcService å‘¢ï¼Ÿ

å› ä¸º WalletRpcService æ˜¯åœ¨ execute() å‡½æ•°ä¸­é€šè¿‡ new çš„æ–¹å¼åˆ›å»ºçš„ï¼Œæˆ‘ä»¬æ— æ³•åŠ¨æ€åœ°å¯¹å…¶è¿›è¡Œæ›¿æ¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒTransaction ç±»ä¸­çš„ execute() æ–¹æ³•çš„å¯æµ‹è¯•æ€§å¾ˆå·®ï¼Œéœ€è¦é€šè¿‡é‡æ„æ¥è®©å…¶å˜å¾—æ›´å®¹æ˜“æµ‹è¯•ã€‚è¯¥å¦‚ä½•é‡æ„è¿™æ®µä»£ç å‘¢ï¼Ÿ

åœ¨ç¬¬ 19 èŠ‚ä¸­ï¼Œæˆ‘ä»¬è®²åˆ°ï¼Œä¾èµ–æ³¨å…¥æ˜¯å®ç°ä»£ç å¯æµ‹è¯•æ€§çš„æœ€æœ‰æ•ˆçš„æ‰‹æ®µã€‚æˆ‘ä»¬å¯ä»¥åº”ç”¨ä¾èµ–æ³¨å…¥ï¼Œå°† WalletRpcService å¯¹è±¡çš„åˆ›å»ºåè½¬ç»™ä¸Šå±‚é€»è¾‘ï¼Œåœ¨å¤–éƒ¨åˆ›å»ºå¥½ä¹‹åï¼Œå†æ³¨å…¥åˆ° Transaction ç±»ä¸­ã€‚é‡æ„ä¹‹åçš„ Transaction ç±»çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public class Transaction {
    //...
    // æ·»åŠ ä¸€ä¸ªæˆå‘˜å˜é‡åŠå…¶ set æ–¹æ³•
    private WalletRpcService walletRpcService;
    public void setWalletRpcService(WalletRpcService walletRpcService) {
        this.walletRpcService = walletRpcService;
    }
    // ...
    public boolean execute() {
        // ...
        // åˆ é™¤ä¸‹é¢è¿™ä¸€è¡Œä»£ç 
        // WalletRpcService walletRpcService = new WalletRpcService();
        // ...
    }
}
```

ç°åœ¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å•å…ƒæµ‹è¯•ä¸­ï¼Œéå¸¸å®¹æ˜“åœ°å°† WalletRpcService æ›¿æ¢æˆ MockWalletRpcServiceOne æˆ– WalletRpcServiceTwo äº†ã€‚é‡æ„ä¹‹åçš„ä»£ç å¯¹åº”çš„å•å…ƒæµ‹è¯•å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public void testExecute() {
    Long buyerId = 123L;
    Long sellerId = 234L;
    Long productId = 345L;
    Long orderId = 456L;
    Transction transaction = new Transaction(null, buyerId, sellerId, productId,orderId);
    // ä½¿ç”¨ mock å¯¹è±¡æ¥æ›¿ä»£çœŸæ­£çš„ RPC æœåŠ¡
    transaction.setWalletRpcService(new MockWalletRpcServiceOne()):
    boolean executedResult = transaction.execute();
    assertTrue(executedResult);
    assertEquals(STATUS.EXECUTED, transaction.getStatus());
}
```

WalletRpcService çš„ mock å’Œæ›¿æ¢é—®é¢˜è§£å†³äº†ï¼Œæˆ‘ä»¬å†æ¥çœ‹ RedisDistributedLockã€‚å®ƒçš„ mock å’Œæ›¿æ¢è¦å¤æ‚ä¸€äº›ï¼Œä¸»è¦æ˜¯å› ä¸º RedisDistributedLock æ˜¯ä¸€ä¸ªå•ä¾‹ç±»ã€‚**å•ä¾‹ç›¸å½“äºä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæˆ‘ä»¬æ— æ³• mockï¼ˆæ— æ³•ç»§æ‰¿å’Œé‡å†™æ–¹æ³•ï¼‰ï¼Œä¹Ÿæ— æ³•é€šè¿‡ä¾èµ–æ³¨å…¥çš„æ–¹å¼æ¥æ›¿æ¢ã€‚**

å¦‚æœ RedisDistributedLock æ˜¯æˆ‘ä»¬è‡ªå·±ç»´æŠ¤çš„ï¼Œå¯ä»¥è‡ªç”±ä¿®æ”¹ã€é‡æ„ï¼Œé‚£æˆ‘ä»¬å¯ä»¥å°†å…¶æ”¹ä¸ºéå•ä¾‹çš„æ¨¡å¼ï¼Œæˆ–è€…å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œæ¯”å¦‚ IDistributedLockï¼Œè®© RedisDistributedLock å®ç°è¿™ä¸ªæ¥å£ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åƒå‰é¢ WalletRpcService çš„æ›¿æ¢æ–¹å¼é‚£æ ·ï¼Œæ›¿æ¢ RedisDistributedLock ä¸º MockRedisDistributedLock äº†ã€‚ä½†å¦‚æœ RedisDistributedLock ä¸æ˜¯æˆ‘ä»¬ç»´æŠ¤çš„ï¼Œæˆ‘ä»¬æ— æƒå»ä¿®æ”¹è¿™éƒ¨åˆ†ä»£ç ï¼Œè¿™ä¸ªæ—¶å€™è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ

æˆ‘ä»¬å¯ä»¥å¯¹ transaction ä¸Šé”è¿™éƒ¨åˆ†é€»è¾‘é‡æ–°å°è£…ä¸€ä¸‹ã€‚å…·ä½“ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public class TransactionLock {
    public boolean lock(String id) {
        return RedisDistributedLock.getSingletonIntance().lockTransction(id);
    } 
    public void unlock() {
        RedisDistributedLock.getSingletonIntance().unlockTransction(id);
    }
} 

public class Transaction {
    //...
    private TransactionLock lock;
    public void setTransactionLock(TransactionLock lock) {
        this.lock = lock;
    } 
    public boolean execute() {
        //...
        try {
            isLocked = lock.lock();
            //...
        } finally {
            if (isLocked) {
                lock.unlock();
            }
        }
        //...
    }
}
```

é’ˆå¯¹é‡æ„è¿‡çš„ä»£ç ï¼Œæˆ‘ä»¬çš„å•å…ƒæµ‹è¯•ä»£ç ä¿®æ”¹ä¸ºä¸‹é¢è¿™ä¸ªæ ·å­ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±èƒ½åœ¨å•å…ƒæµ‹è¯•ä»£ç ä¸­éš”ç¦»çœŸæ­£çš„ RedisDistributedLock åˆ†å¸ƒå¼é”è¿™éƒ¨åˆ†é€»è¾‘äº†ã€‚

```java
public void testExecute() {
    Long buyerId = 123L;
    Long sellerId = 234L;
    Long productId = 345L;
    Long orderId = 456L;
    TransactionLock mockLock = new TransactionLock() {
        public boolean lock(String id) {
            return true;
        } 
        public void unlock() {}
    };

    Transction transaction = new Transaction(null, buyerId, sellerId, productId,orderId);
    transaction.setWalletRpcService(new MockWalletRpcServiceOne());
    transaction.setTransactionLock(mockLock);
    boolean executedResult = transaction.execute();
    assertTrue(executedResult);
    assertEquals(STATUS.EXECUTED, transaction.getStatus());
}
```

è‡³æ­¤ï¼Œæµ‹è¯•ç”¨ä¾‹ 1 å°±ç®—å†™å¥½äº†ã€‚æˆ‘ä»¬é€šè¿‡ä¾èµ–æ³¨å…¥å’Œ mockï¼Œè®©å•å…ƒæµ‹è¯•ä»£ç ä¸ä¾èµ–ä»»ä½•ä¸å¯æ§çš„å¤–éƒ¨æœåŠ¡ã€‚ä½ å¯ä»¥ç…§ç€è¿™ä¸ªæ€è·¯ï¼Œè‡ªå·±å†™ä¸€ä¸‹æµ‹è¯•ç”¨ä¾‹ 4ã€5ã€6ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬å†æ¥çœ‹æµ‹è¯•ç”¨ä¾‹ 3ï¼šäº¤æ˜“å·²è¿‡æœŸï¼ˆcreateTimestamp è¶…è¿‡ 14 å¤©ï¼‰ï¼Œäº¤æ˜“çŠ¶æ€è®¾ç½®ä¸º EXPIREDï¼Œè¿”å› falseã€‚é’ˆå¯¹è¿™ä¸ªå•å…ƒæµ‹è¯•ç”¨ä¾‹ï¼Œæˆ‘ä»¬è¿˜æ˜¯å…ˆæŠŠä»£ç å†™å‡ºæ¥ï¼Œç„¶åå†æ¥åˆ†æã€‚

```java
public void testExecute_with_TransactionIsExpired() {
    Long buyerId = 123L;
    Long sellerId = 234L;
    Long productId = 345L;
    Long orderId = 456L;
    Transction transaction = new Transaction(null, buyerId, sellerId, productId,orderId);
    transaction.setCreatedTimestamp(System.currentTimestamp() - 14days);
    boolean actualResult = transaction.execute();
    assertFalse(actualResult);
    assertEquals(STATUS.EXPIRED, transaction.getStatus());
}
```

ä¸Šé¢çš„ä»£ç çœ‹ä¼¼æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚æˆ‘ä»¬å°† transaction çš„åˆ›å»ºæ—¶é—´ createdTimestamp è®¾ç½®ä¸º 14 å¤©å‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å•å…ƒæµ‹è¯•ä»£ç è¿è¡Œçš„æ—¶å€™ï¼Œtransaction ä¸€å®šæ˜¯å¤„äºè¿‡æœŸçŠ¶æ€ã€‚ä½†æ˜¯ï¼Œå¦‚æœåœ¨ Transaction ç±»ä¸­ï¼Œå¹¶æ²¡æœ‰æš´éœ²ä¿®æ”¹ createdTimestamp æˆå‘˜å˜é‡çš„ set æ–¹æ³•ï¼ˆä¹Ÿå°±æ˜¯æ²¡æœ‰å®šä¹‰ setCreatedTimestamp() å‡½æ•°ï¼‰å‘¢ï¼Ÿ

ä½ å¯èƒ½ä¼šè¯´ï¼Œå¦‚æœæ²¡æœ‰ createTimestamp çš„ set æ–¹æ³•ï¼Œæˆ‘å°±é‡æ–°æ·»åŠ ä¸€ä¸ªå‘—ï¼å®é™…ä¸Šï¼Œè¿™è¿åäº†ç±»çš„å°è£…ç‰¹æ€§ã€‚åœ¨ Transaction ç±»çš„è®¾è®¡ä¸­ï¼ŒcreateTimestamp æ˜¯åœ¨äº¤æ˜“ç”Ÿæˆæ—¶ï¼ˆä¹Ÿå°±æ˜¯æ„é€ å‡½æ•°ä¸­ï¼‰è‡ªåŠ¨è·å–çš„ç³»ç»Ÿæ—¶é—´ï¼Œæœ¬æ¥å°±ä¸åº”è¯¥äººä¸ºåœ°è½»æ˜“ä¿®æ”¹ï¼Œæ‰€ä»¥ï¼Œæš´éœ² createTimestamp çš„ set æ–¹æ³•ï¼Œè™½ç„¶å¸¦æ¥äº†çµæ´»æ€§ï¼Œä½†ä¹Ÿå¸¦æ¥äº†ä¸å¯æ§æ€§ã€‚å› ä¸ºï¼Œæˆ‘ä»¬æ— æ³•æ§åˆ¶ä½¿ç”¨è€…æ˜¯å¦ä¼šè°ƒç”¨ set æ–¹æ³•é‡è®¾ createTimestampï¼Œè€Œé‡è®¾ createTimestamp å¹¶éæˆ‘ä»¬çš„é¢„æœŸè¡Œä¸ºã€‚

é‚£å¦‚æœæ²¡æœ‰é’ˆå¯¹ createTimestamp çš„ set æ–¹æ³•ï¼Œé‚£æµ‹è¯•ç”¨ä¾‹ 3 åˆè¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿå®é™…ä¸Šï¼Œè¿™æ˜¯ä¸€ç±»æ¯”è¾ƒå¸¸è§çš„é—®é¢˜ï¼Œå°±æ˜¯ä»£ç ä¸­åŒ…å«è·Ÿâ€œæ—¶é—´â€æœ‰å…³çš„â€œæœªå†³è¡Œä¸ºâ€é€»è¾‘ã€‚æˆ‘ä»¬ä¸€èˆ¬çš„å¤„ç†æ–¹å¼æ˜¯å°†è¿™ç§æœªå†³è¡Œä¸ºé€»è¾‘é‡æ–°å°è£…ã€‚é’ˆå¯¹ Transaction ç±»ï¼Œæˆ‘ä»¬åªéœ€è¦å°†äº¤æ˜“æ˜¯å¦è¿‡æœŸçš„é€»è¾‘ï¼Œå°è£…åˆ° isExpired() å‡½æ•°ä¸­å³å¯ï¼Œå…·ä½“çš„ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public class Transaction {
    protected boolean isExpired() {
        long executionInvokedTimestamp = System.currentTimestamp();
        return executionInvokedTimestamp - createdTimestamp > 14days;
    }
    
    public boolean execute() throws InvalidTransactionException {
        //...
        if (isExpired()) {
            this.status = STATUS.EXPIRED;
            return false;
        }
        //...
    }
}
```

é’ˆå¯¹é‡æ„ä¹‹åçš„ä»£ç ï¼Œæµ‹è¯•ç”¨ä¾‹ 3 çš„ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public void testExecute_with_TransactionIsExpired() {
    Long buyerId = 123L;
    Long sellerId = 234L;
    Long productId = 345L;
    Long orderId = 456L;
    Transction transaction = new Transaction(null, buyerId, sellerId, productId,orderId){
        protected boolean isExpired() {
            return true;
        }
    };
    boolean actualResult = transaction.execute();
    assertFalse(actualResult);
    assertEquals(STATUS.EXPIRED, transaction.getStatus());
}
```

é€šè¿‡é‡æ„ï¼ŒTransaction ä»£ç çš„å¯æµ‹è¯•æ€§æé«˜äº†ã€‚ä¹‹å‰ç½—åˆ—çš„æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ï¼Œç°åœ¨æˆ‘ä»¬éƒ½é¡ºåˆ©å®ç°äº†ã€‚ä¸è¿‡ï¼ŒTransaction ç±»çš„æ„é€ å‡½æ•°çš„è®¾è®¡è¿˜æœ‰ç‚¹ä¸å¦¥ã€‚ä¸ºäº†æ–¹ä¾¿ä½ æŸ¥çœ‹ï¼Œæˆ‘æŠŠæ„é€ å‡½æ•°çš„ä»£ç é‡æ–° copy äº†ä¸€ä»½è´´åˆ°è¿™é‡Œã€‚

```java
public Transaction(String preAssignedId, Long buyerId, Long sellerId, Long productId){
    if (preAssignedId != null && !preAssignedId.isEmpty()) {
        this.id = preAssignedId;
    } else {
        this.id = IdGenerator.generateTransactionId();
    }
    if (!this.id.startWith("t_")) {
        this.id = "t_" + preAssignedId;
    }
    this.buyerId = buyerId;
    this.sellerId = sellerId;
    this.productId = productId;
    this.orderId = orderId;
    this.status = STATUS.TO_BE_EXECUTD;
    this.createTimestamp = System.currentTimestamp();
}
```

æˆ‘ä»¬å‘ç°ï¼Œæ„é€ å‡½æ•°ä¸­å¹¶éåªåŒ…å«ç®€å•èµ‹å€¼æ“ä½œã€‚äº¤æ˜“ id çš„èµ‹å€¼é€»è¾‘ç¨å¾®å¤æ‚ã€‚æˆ‘ä»¬æœ€å¥½ä¹Ÿè¦æµ‹è¯•ä¸€ä¸‹ï¼Œä»¥ä¿è¯è¿™éƒ¨åˆ†é€»è¾‘çš„æ­£ç¡®æ€§ã€‚ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ id èµ‹å€¼è¿™éƒ¨åˆ†é€»è¾‘å•ç‹¬æŠ½è±¡åˆ°ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œå…·ä½“çš„ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public Transaction(String preAssignedId, Long buyerId, Long sellerId, Long productId){
    //...
    fillTransactionId(preAssignId);
    //...
} 

protected void fillTransactionId(String preAssignedId) {
    if (preAssignedId != null && !preAssignedId.isEmpty()) {
        this.id = preAssignedId;
    } else {
        this.id = IdGenerator.generateTransactionId();
    }
    if (!this.id.startWith("t_")) {
        this.id = "t_" + preAssignedId;
    }
}
```

åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥å°† Transaction ä»ä¸å¯æµ‹è¯•ä»£ç é‡æ„æˆäº†æµ‹è¯•æ€§è‰¯å¥½çš„ä»£ç ã€‚ä¸è¿‡ï¼Œä½ å¯èƒ½è¿˜ä¼šæœ‰ç–‘é—®ï¼ŒTransaction ç±»ä¸­ isExpired() å‡½æ•°å°±ä¸ç”¨æµ‹è¯•äº†å—ï¼Ÿå¯¹äº isExpired() å‡½æ•°ï¼Œé€»è¾‘éå¸¸ç®€å•ï¼Œè‚‰çœ¼å°±èƒ½åˆ¤å®šæ˜¯å¦æœ‰ bugï¼Œæ˜¯å¯ä»¥ä¸ç”¨å†™å•å…ƒæµ‹è¯•çš„ã€‚

å®é™…ä¸Šï¼Œå¯æµ‹è¯•æ€§å·®çš„ä»£ç ï¼Œæœ¬èº«ä»£ç è®¾è®¡å¾—ä¹Ÿä¸å¤Ÿå¥½ï¼Œå¾ˆå¤šåœ°æ–¹éƒ½æ²¡æœ‰éµå®ˆæˆ‘ä»¬ä¹‹å‰è®²åˆ°çš„è®¾è®¡åŸåˆ™å’Œæ€æƒ³ï¼Œæ¯”å¦‚â€œåŸºäºæ¥å£è€Œéå®ç°ç¼–ç¨‹â€æ€æƒ³ã€ä¾èµ–åè½¬åŸåˆ™ç­‰ã€‚é‡æ„ä¹‹åçš„ä»£ç ï¼Œä¸ä»…å¯æµ‹è¯•æ€§æ›´å¥½ï¼Œè€Œä¸”ä»ä»£ç è®¾è®¡çš„è§’åº¦æ¥è¯´ï¼Œä¹Ÿéµä»äº†ç»å…¸çš„è®¾è®¡åŸåˆ™å’Œæ€æƒ³ã€‚è¿™ä¹Ÿå°è¯äº†æˆ‘ä»¬ä¹‹å‰è¯´è¿‡çš„ï¼Œä»£ç çš„å¯æµ‹è¯•æ€§å¯ä»¥ä»ä¾§é¢ä¸Šååº”ä»£ç è®¾è®¡æ˜¯å¦åˆç†ã€‚é™¤æ­¤ä¹‹ å¤–ï¼Œåœ¨å¹³æ—¶çš„å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿè¦å¤šæ€è€ƒä¸€ä¸‹ï¼Œè¿™æ ·ç¼–å†™ä»£ç ï¼Œæ˜¯å¦å®¹æ˜“ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œè¿™ä¹Ÿæœ‰åˆ©äºæˆ‘ä»¬è®¾è®¡å‡ºå¥½çš„ä»£ç ã€‚

## å…¶ä»–å¸¸è§çš„ Anti-Patterns

åˆšåˆšæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®æˆ˜æ¡ˆä¾‹ï¼Œè®²è§£äº†å¦‚ä½•åˆ©ç”¨ä¾èµ–æ³¨å…¥æ¥æé«˜ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Œä»¥åŠç¼–å†™å•å…ƒæµ‹è¯•ä¸­æœ€å¤æ‚çš„ä¸€éƒ¨åˆ†å†…å®¹ï¼šå¦‚ä½•é€šè¿‡ mockã€äºŒæ¬¡å°è£…ç­‰æ–¹å¼è§£ä¾èµ–å¤–éƒ¨æœåŠ¡ã€‚ç°åœ¨ï¼Œ æˆ‘ä»¬å†æ¥æ€»ç»“ä¸€ä¸‹ï¼Œæœ‰å“ªäº›å…¸å‹çš„ã€å¸¸è§çš„æµ‹è¯•æ€§ä¸å¥½çš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ Anti- Patternsã€‚

### æœªå†³è¡Œä¸º

æ‰€è°“çš„æœªå†³è¡Œä¸ºé€»è¾‘å°±æ˜¯ï¼Œä»£ç çš„è¾“å‡ºæ˜¯éšæœºæˆ–è€…è¯´ä¸ç¡®å®šçš„ï¼Œæ¯”å¦‚ï¼Œè·Ÿæ—¶é—´ã€éšæœºæ•°æœ‰å…³çš„ä»£ç ã€‚å¯¹äºè¿™ä¸€ç‚¹ï¼Œåœ¨åˆšåˆšçš„å®æˆ˜æ¡ˆä¾‹ä¸­æˆ‘ä»¬å·²ç»è®²åˆ°ï¼Œä½ å¯ä»¥åˆ©ç”¨åˆšæ‰è®²åˆ°çš„æ–¹æ³•ï¼Œè¯•ç€é‡æ„ä¸€ä¸‹ä¸‹é¢çš„ä»£ç ï¼Œå¹¶ä¸”ä¸ºå®ƒç¼–å†™å•å…ƒæµ‹è¯•ã€‚

```java
public class Demo {
    public long caculateDelayDays(Date dueTime) {
        long currentTimestamp = System.currentTimeMillis();
        if (dueTime.getTime() >= currentTimestamp) {
            return 0;
        }
        long delayTime = currentTimestamp - dueTime.getTime();
        long delayDays = delayTime / 86400;
        return delayDays;
    }
}
```

## å…¨å±€å˜3é‡

å‰é¢æˆ‘ä»¬è®²è¿‡ï¼Œå…¨å±€å˜é‡æ˜¯ä¸€ç§é¢å‘è¿‡ç¨‹çš„ç¼–ç¨‹é£æ ¼ï¼Œæœ‰ç§ç§å¼Šç«¯ã€‚å®é™…ä¸Šï¼Œæ»¥ç”¨å…¨å±€å˜é‡ä¹Ÿè®©ç¼–å†™å•å…ƒæµ‹è¯•å˜å¾—å›°éš¾ã€‚æˆ‘ä¸¾ä¸ªä¾‹å­æ¥è§£é‡Šä¸€ä¸‹ã€‚

RangeLimiter è¡¨ç¤ºä¸€ä¸ª \[-5, 5\] çš„åŒºé—´ï¼Œposition åˆå§‹åœ¨ 0 ä½ç½®ï¼Œmove() å‡½æ•°è´Ÿè´£ç§»åŠ¨ positionã€‚å…¶ä¸­ï¼Œposition æ˜¯ä¸€ä¸ªé™æ€å…¨å±€å˜é‡ã€‚RangeLimiterTest ç±»æ˜¯ä¸ºå…¶è®¾è®¡çš„å•å…ƒæµ‹è¯•ï¼Œä¸è¿‡ï¼Œè¿™é‡Œé¢å­˜åœ¨å¾ˆå¤§çš„é—®é¢˜ï¼Œä½ å¯ä»¥å…ˆè‡ªå·±åˆ†æä¸€ä¸‹ã€‚

```java
public class RangeLimiter {
    private static AtomicInteger position = new AtomicInteger(0);
    public static final int MAX_LIMIT = 5;
    public static final int MIN_LIMIT = -5;
    public boolean move(int delta) {
        int currentPos = position.addAndGet(delta);
        boolean betweenRange = (currentPos <= MAX_LIMIT) && (currentPos >= MIN_LIMIT);
        return betweenRange;
    }
} 

public class RangeLimiterTest {
    public void testMove_betweenRange() {
        RangeLimiter rangeLimiter = new RangeLimiter();
        assertTrue(rangeLimiter.move(1));
        assertTrue(rangeLimiter.move(3));
        assertTrue(rangeLimiter.move(-5));
    }
    public void testMove_exceedRange() {
        RangeLimiter rangeLimiter = new RangeLimiter();
        assertFalse(rangeLimiter.move(6));
    }
}
```

ä¸Šé¢çš„å•å…ƒæµ‹è¯•æœ‰å¯èƒ½ä¼šè¿è¡Œå¤±è´¥ã€‚å‡è®¾å•å…ƒæµ‹è¯•æ¡†æ¶é¡ºåºä¾æ¬¡æ‰§è¡Œ testMove\_betweenRange() å’Œ testMove\_exceedRange() ä¸¤ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚åœ¨ç¬¬ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹æ‰§è¡Œå®Œæˆä¹‹åï¼Œposition çš„å€¼å˜æˆäº† -1ï¼›å†æ‰§è¡Œç¬¬äºŒä¸ªæµ‹è¯•ç”¨ä¾‹çš„æ—¶å€™ï¼Œposition å˜æˆäº† 5ï¼Œmove() å‡½æ•°è¿”å› trueï¼ŒassertFalse è¯­å¥åˆ¤å®šå¤±è´¥ã€‚æ‰€ä»¥ï¼Œç¬¬äºŒä¸ªæµ‹è¯•ç”¨ä¾‹è¿è¡Œå¤±è´¥ã€‚

å½“ç„¶ï¼Œå¦‚æœ RangeLimiter ç±»æœ‰æš´éœ²é‡è®¾ï¼ˆresetï¼‰position å€¼çš„å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ¯æ¬¡æ‰§è¡Œå•å…ƒæµ‹è¯•ç”¨ä¾‹ä¹‹å‰ï¼ŒæŠŠ position é‡è®¾ä¸º 0ï¼Œè¿™æ ·å°±èƒ½è§£å†³åˆšåˆšçš„é—®é¢˜ã€‚

ä¸è¿‡ï¼Œæ¯ä¸ªå•å…ƒæµ‹è¯•æ¡†æ¶æ‰§è¡Œå•å…ƒæµ‹è¯•ç”¨ä¾‹çš„æ–¹å¼å¯èƒ½æ˜¯ä¸åŒçš„ã€‚æœ‰çš„æ˜¯é¡ºåºæ‰§è¡Œï¼Œæœ‰çš„æ˜¯å¹¶å‘æ‰§è¡Œã€‚å¯¹äºå¹¶å‘æ‰§è¡Œçš„æƒ…å†µï¼Œå³ä¾¿æˆ‘ä»¬æ¯æ¬¡éƒ½æŠŠ position é‡è®¾ä¸º 0ï¼Œä¹Ÿå¹¶ä¸å¥æ•ˆã€‚å¦‚æœä¸¤ä¸ªæµ‹è¯•ç”¨ä¾‹å¹¶å‘æ‰§è¡Œï¼Œç¬¬ 16ã€17ã€18ã€23 è¿™å››è¡Œä»£ç å¯èƒ½ä¼šäº¤å‰æ‰§è¡Œï¼Œå½±å“åˆ° move() å‡½æ•°çš„æ‰§è¡Œç»“æœã€‚

### é™æ€æ–¹æ³•

å‰é¢æˆ‘ä»¬ä¹Ÿæåˆ°ï¼Œé™æ€æ–¹æ³•è·Ÿå…¨å±€å˜é‡ä¸€æ ·ï¼Œä¹Ÿæ˜¯ä¸€ç§é¢å‘è¿‡ç¨‹çš„ç¼–ç¨‹æ€ç»´ã€‚åœ¨ä»£ç ä¸­è°ƒç”¨é™æ€æ–¹æ³•ï¼Œæœ‰æ—¶å€™ä¼šå¯¼è‡´ä»£ç ä¸æ˜“æµ‹è¯•ã€‚ä¸»è¦åŸå› æ˜¯é™æ€æ–¹æ³•ä¹Ÿå¾ˆéš¾ mockã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªè¦åˆ†æƒ…å†µæ¥çœ‹ã€‚åªæœ‰åœ¨è¿™ä¸ªé™æ€æ–¹æ³•æ‰§è¡Œè€—æ—¶å¤ªé•¿ã€ä¾èµ–å¤–éƒ¨èµ„æºã€é€»è¾‘å¤æ‚ã€è¡Œä¸ºæœªå†³ç­‰æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ‰éœ€è¦åœ¨å•å…ƒæµ‹è¯•ä¸­ mock è¿™ä¸ªé™æ€æ–¹æ³•ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå¦‚æœåªæ˜¯ç±»ä¼¼ Math.abs() è¿™æ ·çš„ç®€å•é™æ€æ–¹æ³•ï¼Œå¹¶ä¸ä¼šå½±å“ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Œå› ä¸ºæœ¬èº«å¹¶ä¸éœ€è¦ mockã€‚

### å¤æ‚ç»§æ‰¿

æˆ‘ä»¬å‰é¢æåˆ°ï¼Œç›¸æ¯”ç»„åˆå…³ç³»ï¼Œç»§æ‰¿å…³ç³»çš„ä»£ç ç»“æ„æ›´åŠ è€¦åˆã€ä¸çµæ´»ï¼Œæ›´åŠ ä¸æ˜“æ‰©å±•ã€ä¸æ˜“ç»´æŠ¤ã€‚å®é™…ä¸Šï¼Œç»§æ‰¿å…³ç³»ä¹Ÿæ›´åŠ éš¾æµ‹è¯•ã€‚è¿™ä¹Ÿå°è¯äº†ä»£ç çš„å¯æµ‹è¯•æ€§è·Ÿä»£ç è´¨é‡çš„ç›¸å…³æ€§ã€‚

å¦‚æœçˆ¶ç±»éœ€è¦ mock æŸä¸ªä¾èµ–å¯¹è±¡æ‰èƒ½è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œé‚£æ‰€æœ‰çš„å­ç±»ã€å­ç±»çš„å­ç±»â€¦â€¦åœ¨ç¼–å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œéƒ½è¦ mock è¿™ä¸ªä¾èµ–å¯¹è±¡ã€‚å¯¹äºå±‚æ¬¡å¾ˆæ·±ï¼ˆåœ¨ç»§æ‰¿å…³ç³»ç±»å›¾ä¸­è¡¨ç°ä¸ºçºµå‘æ·±åº¦ï¼‰ã€ç»“æ„å¤æ‚ï¼ˆåœ¨ç»§æ‰¿å…³ç³»ç±»å›¾ä¸­è¡¨ç°ä¸ºæ¨ªå‘å¹¿åº¦ï¼‰çš„ç»§æ‰¿å…³ç³»ï¼Œè¶Šåº•å±‚çš„å­ç±»è¦ mock çš„å¯¹è±¡å¯èƒ½å°±ä¼šè¶Šå¤šï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´ï¼Œåº•å±‚å­ç±»åœ¨å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œè¦ä¸€ä¸ªä¸€ä¸ª mock å¾ˆå¤šä¾èµ–å¯¹è±¡ï¼Œè€Œä¸”è¿˜éœ€è¦æŸ¥çœ‹çˆ¶ç±»ä»£ç ï¼Œå»äº†è§£è¯¥å¦‚ä½• mock è¿™äº›ä¾èµ–å¯¹è±¡ã€‚

å¦‚æœæˆ‘ä»¬åˆ©ç”¨ç»„åˆè€Œéç»§æ‰¿æ¥ç»„ç»‡ç±»ä¹‹é—´çš„å…³ç³»ï¼Œç±»ä¹‹é—´çš„ç»“æ„å±‚æ¬¡æ¯”è¾ƒæ‰å¹³ï¼Œåœ¨ç¼–å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œåªéœ€è¦ mock ç±»æ‰€ç»„åˆä¾èµ–çš„å¯¹è±¡å³å¯ã€‚

### é«˜è€¦åˆä»£ç 

å¦‚æœä¸€ä¸ªç±»èŒè´£å¾ˆé‡ï¼Œéœ€è¦ä¾èµ–åå‡ ä¸ªå¤–éƒ¨å¯¹è±¡æ‰èƒ½å®Œæˆå·¥ä½œï¼Œä»£ç é«˜åº¦è€¦åˆï¼Œé‚£æˆ‘ä»¬åœ¨ç¼–å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œå¯èƒ½éœ€è¦ mock è¿™åå‡ ä¸ªä¾èµ–çš„å¯¹è±¡ã€‚ä¸ç®¡æ˜¯ä»ä»£ç è®¾è®¡çš„è§’åº¦æ¥è¯´ï¼Œè¿˜æ˜¯ä»ç¼–å†™å•å…ƒæµ‹è¯•çš„è§’åº¦æ¥è¯´ï¼Œè¿™éƒ½æ˜¯ä¸åˆç†çš„ã€‚

## é‡ç‚¹å›é¡¾

å¥½äº†ï¼Œä»Šå¤©çš„å†…å®¹åˆ°æ­¤å°±è®²å®Œäº†ã€‚æˆ‘ä»¬ä¸€å—æ¥æ€»ç»“å›é¡¾ä¸€ä¸‹ï¼Œä½ éœ€è¦é‡ç‚¹æŒæ¡çš„å†…å®¹ã€‚

### ä»€ä¹ˆæ˜¯ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Ÿ

ç²—ç•¥åœ°è®²ï¼Œæ‰€è°“ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Œå°±æ˜¯é’ˆå¯¹ä»£ç ç¼–å†™å•å…ƒæµ‹è¯•çš„éš¾æ˜“ç¨‹åº¦ã€‚å¯¹äºä¸€æ®µä»£ç ï¼Œ å¦‚æœå¾ˆéš¾ä¸ºå…¶ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œæˆ–è€…å•å…ƒæµ‹è¯•å†™èµ·æ¥å¾ˆè´¹åŠ²ï¼Œéœ€è¦ä¾é å•å…ƒæµ‹è¯•æ¡†æ¶ä¸­å¾ˆé«˜çº§çš„ç‰¹æ€§ï¼Œé‚£å¾€å¾€å°±æ„å‘³ç€ä»£ç è®¾è®¡å¾—ä¸å¤Ÿåˆç†ï¼Œä»£ç çš„å¯æµ‹è¯•æ€§ä¸å¥½ã€‚

### ç¼–å†™å¯æµ‹è¯•æ€§ä»£ç çš„æœ€æœ‰æ•ˆæ‰‹æ®µ

ä¾èµ–æ³¨å…¥æ˜¯ç¼–å†™å¯æµ‹è¯•æ€§ä»£ç çš„æœ€æœ‰æ•ˆæ‰‹æ®µã€‚é€šè¿‡ä¾èµ–æ³¨å…¥ï¼Œæˆ‘ä»¬åœ¨ç¼–å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œ å¯ä»¥é€šè¿‡ mock çš„æ–¹æ³•è§£ä¾èµ–å¤–éƒ¨æœåŠ¡ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨ç¼–å†™å•å…ƒæµ‹è¯•çš„è¿‡ç¨‹ä¸­æœ€æœ‰æŠ€æœ¯æŒ‘æˆ˜çš„åœ°æ–¹ã€‚

### å¸¸è§çš„ Anti-Patterns

- å¸¸è§çš„æµ‹è¯•ä¸å‹å¥½çš„ä»£ç æœ‰ä¸‹é¢è¿™ 5 ç§ï¼š

- ä»£ç ä¸­åŒ…å«æœªå†³è¡Œä¸ºé€»è¾‘æ»¥ç”¨å¯å˜å…¨å±€å˜é‡

- æ»¥ç”¨é™æ€æ–¹æ³•

- ä½¿ç”¨å¤æ‚çš„ç»§æ‰¿å…³ç³»é«˜åº¦è€¦åˆçš„ä»£ç 

## è¯¾å ‚è®¨è®º

1.  å®æˆ˜æ¡ˆä¾‹ä¸­çš„ void fillTransactionId(String preAssignedId) å‡½æ•°ä¸­åŒ…å«ä¸€å¤„é™æ€å‡½æ•°è°ƒç”¨ï¼šIdGenerator.generateTransactionId()ï¼Œè¿™æ˜¯å¦ä¼šå½±å“åˆ°ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Ÿåœ¨å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ˜¯å¦éœ€è¦ mock è¿™ä¸ªå‡½æ•°ï¼Ÿ

2.  æˆ‘ä»¬ä»Šå¤©è®²åˆ°ï¼Œä¾èµ–æ³¨å…¥æ˜¯æé«˜ä»£ç å¯æµ‹è¯•æ€§çš„æœ€æœ‰æ•ˆçš„æ‰‹æ®µã€‚æ‰€ä»¥ï¼Œä¾èµ–æ³¨å…¥ï¼Œå°±æ˜¯ ä¸è¦åœ¨ç±»å†…éƒ¨é€šè¿‡ new çš„æ–¹å¼åˆ›å»ºå¯¹è±¡ï¼Œè€Œæ˜¯è¦é€šè¿‡å¤–éƒ¨åˆ›å»ºå¥½ä¹‹åä¼ é€’ç»™ç±»ä½¿ç”¨ã€‚é‚£æ˜¯ä¸æ˜¯æ‰€æœ‰çš„å¯¹è±¡éƒ½ä¸èƒ½åœ¨ç±»å†…éƒ¨åˆ›å»ºå‘¢ï¼Ÿå“ªç§ç±»å‹çš„å¯¹è±¡å¯ä»¥åœ¨ç±»å†…éƒ¨åˆ›å»ºå¹¶ä¸”ä¸å½± å“ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Ÿä½ èƒ½ä¸¾å‡ ä¸ªä¾‹å­å—ï¼Ÿ



## ç²¾é€‰ç•™è¨€

> ![](media/image12.png)**å®‰é™çš„boy**
>
> 2020-01-08
>
> è¿™èŠ‚æ»¡æ»¡çš„å¹²è´§ğŸ‘ğŸ‘ğŸ‘
>
> å±•å¼€î˜ƒ
>
> ![](media/image13.png)![](media/image14.png)17
>
> ![](media/image15.png)**å¤±ç«çš„å¤å¤©**
>
> 2020-01-08
>
> æ€è€ƒé¢˜1ï¼Œè¯¥æ–¹æ³•é€»è¾‘å°±æ˜¯å¡«å……ä¸€ä¸ªIDï¼ŒåŸºæœ¬éƒ½æ˜¯å†…éƒ¨å®ç°çš„ä¸€ä¸ªidç”Ÿæˆå™¨ï¼Œå¯ä»¥ä¸ç”¨é‡å†™ã€‚ä¸€å®šè¦é‡å†™ä¹Ÿè¡Œï¼Œè‡ªå·±å¼„ä¸€ä¸ªè‡ªå¢idå®ç°å°±è¡Œäº†ã€‚
>
> æ€è€ƒé¢˜2ï¼Œæä¾›æ–¹æ³•çš„ç±»ä¸è¦newï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„serviceç±»ï¼Œè¿™ä¸ªæ˜¯è¦ä¾èµ–æ³¨å…¥çš„ã€‚æä¾›å±æ€§çš„ç±»ï¼Œæ¯”å¦‚voï¼Œboï¼Œentityè¿™äº›å°±å¯ä»¥newã€‚
>
> å±•å¼€î˜ƒ

![](media/image16.png)![](media/image17.png)12

> ![](media/image18.png)**è¾£ä¹ˆå¤§**
>
> 2020-01-08
>
> å‚è€ƒäº‰å“¥ä»Šå¤©çš„ä»£ç å†™äº†ä¾‹å­ä¸­çš„æµ‹è¯•ï¼ˆå¯è¿è¡Œï¼‰ï¼š https://github.com/gdhucoder/Algorithms4/tree/master/designpattern/u29
>
> ä»Šå¤©å­¦ä¹ åˆ°äº†é«˜çº§çš„å•å…ƒæµ‹è¯•æ–¹æ³•ï¼š 1ã€ä¾èµ–å¤–éƒ¨å•ä¾‹ï¼šå°†å•ä¾‹å°è£…â€¦
>
> å±•å¼€î˜ƒ
>
> ![](media/image19.png)![](media/image20.png)2 10
>
> ![](media/image21.png)**QQæ€ª**
>
> 2020-01-08
>
> çœ‹åˆ°ä¸€åŠï¼Œæˆ‘å°±æ¥è¯„è®ºï¼Œè€å¸ˆæ”¶ä¸‹æˆ‘çš„è†ç›–ï¼Œå¤ªå¼ºäº†
>
> å±•å¼€î˜ƒ
>
> ä½œè€…å›å¤: ğŸ˜ æ„Ÿè°¢è®¤å¯ï¼

![](media/image22.png)![](media/image23.png)4

> ![](media/image24.png)**æ¡‚åŸè€æ‰˜å°¼**
>
> 2020-01-08
>
> æ„Ÿè°¢äº‰å“¥åˆ†äº«
>
> è¯¾åè®¨è®º1.idçš„ç”Ÿæˆé€»è¾‘æœ‰ç‚¹æ²¡çœ‹æ‡‚ï¼Œå•çº¯ä»ä»£ç è¦†ç›–ä¸Šçœ‹ï¼ŒfillTransactionId æœªè¦†ç›–å®Œå…¨ï¼Œéœ€è¦mockä¸‹è¿™ä¸ªé™æ€æ–¹æ³•ï¼Œå½“ç„¶ä¹Ÿæœ‰å…¶ä»–åˆ†æ”¯é€»è¾‘å¯ä»¥è¦†ç›–ã€‚ idæ²¡æœ‰åœ¨executeæ–¹æ³•ä¸­ä¸æ˜¯æ ¸å¿ƒå±æ€§(mockæ–¹æ³•çš„å…¥å‚)ï¼Œä¸å½±å“executeçš„å¯æµ‹è¯•æ€§ã€‚ id çš„ç”Ÿæˆç”¨é™æ€æ–¹æ³•çœŸçš„å¥½ä¹ˆï¼Ÿâ€¦
>
> å±•å¼€î˜ƒ

![](media/image25.png)![](media/image26.png)3

> ![](media/image27.png)**è¾¾æ–‡è¥¿**
>
> 2020-01-09
>
> å†…å®¹éƒ½æ˜¯å¹²è´§,ä¸å¤Ÿçœ‹å•Š
>
> å±•å¼€î˜ƒ
>
> ![](media/image28.png)![](media/image29.png)2
>
> ![](media/image30.png)**ä¸‹é›¨å¤©**
>
> 2020-01-08
>
> é—®é¢˜å›ç­”ï¼š

1.  IdGenerator.generateTransactionId()æœ‰æœªå†³è¡Œä¸ºé€»è¾‘ï¼Œä½†ä¸æ˜¯è¯´æœ‰æœªå†³è¡Œä¸ºå°±ä¸€å®šå½±å“å¯æµ‹è¯•æ€§ï¼Œå‰ææ˜¯éœ€è¦çœ‹æœªå†³è¡Œä¸ºæ˜¯å¦æœ‰æµ‹è¯•å¿…è¦æ€§ï¼Œæ­¤å¤„ç”Ÿæˆä¸€ä¸ªéšæœºæ•°(ç±»ä¼¼ Syste m.currentTimeMillis())ï¼Œæµ‹è¯•æ„ä¹‰ä¸å¤§ï¼

> â€¦
>
> å±•å¼€î˜ƒ

![](media/image28.png)![](media/image29.png)2

> ![](media/image31.png)**é€é¥æ€**
>
> 2020-01-08

1.  ä¸ä¼šå½±å“å¯æµ‹è¯•æ€§ï¼Œå› ä¸º generateTransactionId å¹¶ä¸éœ€è¦ä¾èµ–ä»€ä¹ˆå¤–éƒ¨æœåŠ¡ï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦ mock

2.  ä¸æ˜¯ã€‚ä¸ä¾èµ–å¤–éƒ¨æœåŠ¡çš„ç±»å°±å¯ä»¥å†…éƒ¨åˆ›å»ºï¼Œæ¯”å¦‚ String

![](media/image25.png)![](media/image26.png)2

> ![](media/image32.png)**å¹³é£é€ é›¨**
>
> 2020-01-08
>
> // æŠ½å–äº†å½“å‰æ—¶é—´è·å–çš„é€»è¾‘ï¼Œæ–¹ä¾¿æµ‹è¯•private long currentTimeMillis;
>
> private Date dueTime;
>
> public Demo(Date dueTime){ this.dueTime = dueTime;â€¦
>
> å±•å¼€î˜ƒ
>
> ![](media/image33.png)![](media/image34.png)1
>
> ![](media/image35.png)**Jesse**
>
> 2020-01-08
>
> æ€è€ƒé¢˜1ï¼Œè¯¥æ–¹æ³•äº§ç”Ÿä¸€ä¸ªå”¯ä¸€çš„ID,æˆ‘è®¤ä¸ºä¸éœ€è¦mockã€‚
>
> æ€è€ƒé¢˜2ï¼Œæˆ‘è§‰å¾—å¦‚æœå¯¹è±¡æœ‰è¡Œä¸ºï¼Œå¹¶ä¸”è¡Œä¸ºä¸å¤–éƒ¨ç³»ç»Ÿäº¤äº’æˆ–è€…æ‰§è¡Œçš„ç»“æœå…·æœ‰ä¸ç¡®å®šæ€§ï¼Œå°±éœ€è¦ä¾èµ–æ³¨å…¥æ¥å®Œæˆæµ‹è¯•ã€‚å¦‚æœå¯¹è±¡çš„è¡Œä¸ºæ˜¯å¯é¢„æµ‹çš„å¹¶ä¸”å”¯ä¸€çš„ï¼Œå¯ä»¥ç›´æ¥ne wã€‚
>
> å±•å¼€î˜ƒ
>
> ![](media/image33.png)![](media/image34.png)1
>
> ![](media/image36.png)**è’‹å…ˆç”Ÿ**
>
> 2020-01-13
>
> æ”¶è·å¾ˆå¤šï¼Œè¦æ˜¯æ–‡ç« ç»“å°¾æœ‰ä¸ªå®Œæ•´ä»£ç å°±æ›´å¥½äº†ï¼Œä¸ç„¶ç°åœ¨è¿˜å¾—ä¸€ç‚¹ç‚¹å»å¤åˆ¶æ‰èƒ½çœ‹åˆ°å…¨è²Œã€‚

![](media/image37.png)![](media/image38.png)

> ![](media/image39.png)**jaryoung**
>
> 2020-01-13
>
> æ€è€ƒ1ï¼Œæ— éœ€å®ç°ï¼Œéšæœºç”Ÿæˆçš„IDä¸åº”è¯¥å½±å“ä¸šåŠ¡ä¸»æµç¨‹ï¼Œé™¤éIDæœ‰ä¸šåŠ¡å«ä¹‰å°±å¦å½“åˆ«è®ºã€‚æ€è€ƒäºŒï¼Œå¦‚æœç±»æœ¬èº«æ˜¯å½“å‰ç±»çš„å†…éƒ¨ç±»ï¼Ÿ
>
> å±•å¼€î˜ƒ

![](media/image37.png)![](media/image40.png)

> ![](media/image41.png)**é¥­ç²’**
>
> 2020-01-11
>
> è¯»å®Œè¿™ç¯‡æ„Ÿè§‰ä¸€ä¸‹å°±è®¤è¯†äº†ä»£ç çš„å¯æµ‹è¯•æ€§ã€‚ä¾èµ–æ³¨å…¥æé«˜ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Œé‚£ spring é‡Œæ¨èä½¿ç”¨ setter æ–¹æ³•å½¢å¼çš„ @autowired æ³¨å…¥ bean æ›´å¥½å“ã€‚
>
> ç„¶åæˆ‘è®¤ä¸º IdGenerator.generateTransactionId() ä¸éœ€è¦ mockï¼Œå®ƒçš„åŠŸèƒ½åº”è¯¥å°±æ˜¯ç”Ÿæˆä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ idï¼Œå¯¹ Transaction è€Œè¨€åŠŸèƒ½ç®€å•ï¼Œä¸å½±å“æµ‹è¯•æ€§ï¼Œæœ¬èº«çš„å®ç°é€»è¾‘ä¸åœ¨ Transaction æµ‹è¯•ã€‚
>
> å±•å¼€î˜ƒ

![](media/image33.png)![](media/image42.png)

> ![](media/image43.png)**å°ç¾**
>
> 2020-01-10
>
> äº‰å“¥ï¼Œæƒ³è¯·æ•™ä¸€ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬åœ¨mock RedisDistributedLockçš„æ—¶å€™ï¼Œå°†å…¶å°è£…æˆTransac tionLockï¼Œè¿™æ ·åŸTransactionç±»ä¸­è°ƒç”¨RedisDistributedLockçš„åœ°æ–¹éƒ½æ”¹æˆäº†è°ƒç”¨Trans actionLockã€‚
>
> è¿™æ ·ä¸å°±ç ´åäº†åŸæœ‰ç±»çš„å®ç°å—ï¼Ÿå¦‚æœè¿™æ ·çš„mockå¾ˆå¤šï¼Œæœ€åå¿˜è®°ä¿®æ”¹ï¼Œä¼šä¸ä¼šæœ‰é—®é¢˜ï¼Ÿ
>
> å±•å¼€î˜ƒ

![](media/image44.png)![](media/image45.png)

> ![](media/image46.png)**å°ç¾**
>
> 2020-01-10
>
> äº‰å“¥ï¼Œæƒ³è¯·æ•™ä¸€ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬åœ¨mock RedisDistributedLockçš„æ—¶å€™ï¼Œå°†å…¶å°è£…æˆTransac tionLockï¼Œè¿™æ ·åŸTransactionç±»ä¸­è°ƒç”¨RedisDistributedLockçš„åœ°æ–¹éƒ½æ”¹æˆäº†è°ƒç”¨Trans actionLockã€‚
>
> è¿™æ ·ä¸å°±ç ´åäº†åŸæœ‰ç±»çš„å®ç°å—ï¼Ÿå¦‚æœè¿™æ ·çš„mockå¾ˆå¤šï¼Œæœ€åå¿˜è®°ä¿®æ”¹ï¼Œä¼šä¸ä¼šæœ‰é—®é¢˜ï¼Ÿ
>
> å±•å¼€î˜ƒ

![](media/image47.png)![](media/image48.png)

> ![](media/image49.png)**L**ğŸš²ğŸ±
>
> 2020-01-10
>
> å…³äºæ€è€ƒé¢˜: æ€è€ƒé¢˜ ä¸€ IdGenerator.generateTransactionId() åªæ˜¯ç”Ÿæˆä¸€ä¸ª id ç”Ÿæˆå™¨, ä¸éœ€è¦mock è¿™ä¸ªå‡½æ•°, å°±ç”Ÿæˆä¸€ä¸ªéšæœºæ•°, æ²¡å¤šå¤§æµ‹è¯•æ„ä¹‰.
>
> æ€è€ƒé¢˜äºŒ æœ‰å®ç°æ–¹æ³•çš„ç±»åº”è¯¥ç”¨ä¾èµ–æ³¨å…¥å‡å°‘ä¾èµ–, entity bo vo ç­‰bean å¯ä»¥ new ä¸éœ€è¦ä¾èµ–æ³¨å…¥
>
> å±•å¼€î˜ƒ

![](media/image50.png)![](media/image51.png)

> ![](media/image52.png)**å µè½¦**
>
> 2020-01-10
>
> è¯·é—®å•å…ƒæµ‹è¯•åœ¨ä»€ä¹ˆæ—¶å€™åšæ¯”è¾ƒå¥½ï¼Ÿæ˜¯ä¸€ä¸ªæ¨¡å—å†™å®Œå†æµ‹è¯•è¿˜æ˜¯ä¸€ä¸ªæ–¹æ³•å†™å®Œå†æµ‹è¯•ï¼Ÿæ–‡ä¸­è·å–redisé”ç”¨é™æ€æ–¹æ³•ï¼Œä¸€è¡Œä»£ç å°±æå®šäº†ï¼Œè€Œä¸”å‡ ä¹æ‰€æœ‰çš„åˆ†å¸ƒå¼é”éƒ½æ˜¯è¿™æ ·çš„å†™æ³•ï¼Œç”¨èµ·æ¥å¾ˆæ–¹ä¾¿ï¼ŒåæœŸå‡ ä¹ä¸ä¼šå˜åŠ¨ã€‚ä¸ºäº†å¯æµ‹è¯•æ€§ï¼Œæ¯ä¸ªä¸šåŠ¡éƒ½å°è£…äº†ä¸€ä¸ªlock,æ˜¯ä¸æ˜¯è¿‡åº¦è§£è€¦äº†ã€‚
>
> å±•å¼€î˜ƒ

![](media/image44.png)![](media/image45.png)

> ![](media/image53.png)**èŠ±å„¿å°‘å¹´**
>
> 2020-01-10
>
> mockçš„é€šå¸¸æ˜¯å¤–éƒ¨æœåŠ¡ï¼Œidç”Ÿæˆå™¨å¦‚æœæ˜¯ä¸ªå¤–éƒ¨æœåŠ¡é‚£å°±éœ€è¦mockï¼Œä¸è¿‡é€šå¸¸æ¥è¯´idç”Ÿæˆä¸ä¼šå½±å“ä¸šåŠ¡é€»è¾‘ã€‚
>
> ä»€ä¹ˆæ—¶é—´å¯ä»¥newï¼Œéœ€è¦å–å†³äºnewçš„å¯¹è±¡æ˜¯å¦æœ‰å¤–éƒ¨ä¾èµ–ï¼Œæœ‰åˆ™éœ€è¦æ³¨å…¥ï¼Œå¦åˆ™å¯ä»¥ne w
>
> å±•å¼€î˜ƒ

![](media/image54.png)![](media/image55.png)

> ![](media/image56.png)**çŸ³ä»”**
>
> 2020-01-10
>
> ç»§ç»­ä¼˜åŒ–Demo:
>
> public class Demo {
>
> private long currentTimestamp; private long dueTimestamp; private long delayDays;â€¦
>
> å±•å¼€î˜ƒ

![](media/image54.png)![](media/image55.png)

> ![](media/image57.png)**çŸ³ä»”**
>
> 2020-01-10
>
> \[åŸåˆ™\]æ˜¯:ä¸ä¾èµ–ç½‘ç»œ,IOæˆ–è€…ç¬¬ä¸‰æ–¹æœåŠ¡çš„å°±å¯ä»¥ä¸éœ€è¦mock.

1.  æœ¬å®æˆ˜æ¡ˆä¾‹ å¹¶æ²¡æœ‰è¦å¯¹ TransactionId è¿›è¡ŒéªŒè¯,æ‰€ä»¥åªè¦å®ƒèƒ½æ­£å¸¸ç”Ÿæˆå°±å®Œæˆäº†å®ƒçš„ä»»åŠ¡ä¸éœ€è¦ mock.

2.  ç±»å†…éƒ¨é€šè¿‡ new çš„æ–¹å¼åˆ›å»ºå¯¹è±¡,åªè¦è¿™ä¸ªå¯¹è±¡çš„åˆ›å»ºä¸è¿å\[åŸåˆ™\]è€Œä¸”ä¸éœ€è¦åœ¨åç»­æµ‹è¯•ä¾èµ–åˆ°å°±å¯ä»¥æ”¾åœ¨å†…éƒ¨ new æ¥åˆ›å»º.â€¦

> å±•å¼€î˜ƒ

![](media/image58.png)![](media/image59.png)
