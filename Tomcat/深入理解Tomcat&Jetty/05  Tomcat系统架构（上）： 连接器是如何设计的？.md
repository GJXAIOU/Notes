# 05 | Tomcatç³»ç»Ÿæž¶æž„ï¼ˆä¸Šï¼‰ï¼š è¿žæŽ¥å™¨æ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Ÿ

åœ¨é¢è¯•æ—¶æˆ‘ä»¬å¯èƒ½ç»å¸¸è¢«é—®åˆ°ï¼šä½ åšçš„ XX é¡¹ç›®çš„æž¶æž„æ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Œè¯·è®²ä¸€ä¸‹å®žçŽ°çš„æ€è·¯ã€‚å¯¹äºŽé¢è¯•å®˜æ¥è¯´ï¼Œå¯ä»¥é€šè¿‡ä½ å¯¹å¤æ‚ç³»ç»Ÿè®¾è®¡çš„ç†è§£ï¼Œäº†è§£ä½ çš„æŠ€æœ¯æ°´å¹³ä»¥åŠå¤„ç†å¤æ‚é—®é¢˜çš„æ€è·¯ã€‚

é€šè¿‡åˆ†æž Tomcat çš„è®¾è®¡æ€è·¯ï¼Œçœ‹çœ‹ Tomcat çš„è®¾è®¡è€…ä»¬å½“æ—¶æ˜¯æ€Žä¹ˆå›žç­”è¿™ä¸ªé—®é¢˜çš„ã€‚ä¸€æ–¹é¢æˆ‘ä»¬å¯ä»¥å­¦åˆ° Tomcat çš„æ€»ä½“æž¶æž„ï¼Œå­¦ä¼šä»Žå®è§‚ä¸Šæ€Žä¹ˆåŽ»è®¾è®¡ä¸€ä¸ªå¤æ‚ç³»ç»Ÿï¼Œæ€Žä¹ˆè®¾è®¡é¡¶å±‚æ¨¡å—ï¼Œä»¥åŠæ¨¡å—ä¹‹é—´çš„å…³ç³»ï¼›å¦ä¸€æ–¹é¢ä¹Ÿä¸ºæˆ‘ä»¬æ·±å…¥å­¦ä¹  Tomcat çš„å·¥ä½œåŽŸç†æ‰“ä¸‹åŸºç¡€ã€‚

## ä¸€ã€Tomcat æ€»ä½“æž¶æž„

æˆ‘ä»¬çŸ¥é“å¦‚æžœè¦è®¾è®¡ä¸€ä¸ªç³»ç»Ÿï¼Œé¦–å…ˆæ˜¯è¦äº†è§£éœ€æ±‚ã€‚**Tomcat è¦å®žçŽ° 2 ä¸ªæ ¸å¿ƒåŠŸèƒ½**ï¼š

- å¤„ç† Socket è¿žæŽ¥ï¼Œè´Ÿè´£ç½‘ç»œå­—èŠ‚æµä¸Ž Request å’Œ Response å¯¹è±¡çš„è½¬åŒ–ã€‚
- åŠ è½½å’Œç®¡ç† Servletï¼Œä»¥åŠå…·ä½“å¤„ç† Request è¯·æ±‚ã€‚

**å› æ­¤ Tomcat è®¾è®¡äº†ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶è¿žæŽ¥å™¨ï¼ˆConnectorï¼‰å’Œå®¹å™¨ï¼ˆContainerï¼‰æ¥åˆ†åˆ«åšè¿™ä¸¤ä»¶äº‹æƒ…ã€‚è¿žæŽ¥å™¨è´Ÿè´£å¯¹å¤–äº¤æµï¼Œå®¹å™¨è´Ÿè´£å†…éƒ¨å¤„ç†ã€‚**

æ‰€ä»¥è¿žæŽ¥å™¨å’Œå®¹å™¨å¯ä»¥è¯´æ˜¯ Tomcat æž¶æž„é‡Œæœ€é‡è¦çš„ä¸¤éƒ¨åˆ†ï¼Œéœ€è¦ä½ èŠ±äº›ç²¾åŠ›ç†è§£æ¸…æ¥šã€‚è¿™ä¸¤éƒ¨åˆ†å†…å®¹æˆ‘ä¼šåˆ†æˆä¸¤æœŸï¼Œä»Šå¤©æˆ‘æ¥åˆ†æžè¿žæŽ¥å™¨æ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Œä¸‹ä¸€æœŸæˆ‘ä¼šä»‹ç»å®¹å™¨çš„è®¾è®¡ã€‚

åœ¨å¼€å§‹è®²è¿žæŽ¥å™¨å‰ï¼Œæˆ‘å…ˆé“ºåž«ä¸€ä¸‹ Tomcat æ”¯æŒçš„å¤šç§ I/O æ¨¡åž‹å’Œåº”ç”¨å±‚åè®®ã€‚

Tomcat æ”¯æŒçš„ I/O æ¨¡åž‹æœ‰ï¼š

- NIOï¼šéžé˜»å¡ž I/Oï¼Œé‡‡ç”¨ Java NIO ç±»åº“å®žçŽ°ã€‚
- NIO2ï¼šå¼‚æ­¥ I/Oï¼Œé‡‡ç”¨ JDK 7 æœ€æ–°çš„ NIO2 ç±»åº“å®žçŽ°ã€‚
- APRï¼šé‡‡ç”¨ Apache å¯ç§»æ¤è¿è¡Œåº“å®žçŽ°ï¼Œæ˜¯ C/C++ ç¼–å†™çš„æœ¬åœ°åº“ã€‚

Tomcat æ”¯æŒçš„åº”ç”¨å±‚åè®®æœ‰ï¼š

- HTTP/1.1ï¼šè¿™æ˜¯å¤§éƒ¨åˆ† Web åº”ç”¨é‡‡ç”¨çš„è®¿é—®åè®®ã€‚
- AJPï¼šç”¨äºŽå’Œ Web æœåŠ¡å™¨é›†æˆï¼ˆå¦‚ Apacheï¼‰ã€‚
- HTTP/2ï¼šHTTP 2.0 å¤§å¹…åº¦çš„æå‡äº† Web æ€§èƒ½ã€‚

Tomcat ä¸ºäº†å®žçŽ°æ”¯æŒå¤šç§ I/O æ¨¡åž‹å’Œåº”ç”¨å±‚åè®®ï¼Œä¸€ä¸ªå®¹å™¨å¯èƒ½å¯¹æŽ¥å¤šä¸ªè¿žæŽ¥å™¨ï¼Œå°±å¥½æ¯”ä¸€ä¸ªæˆ¿é—´æœ‰å¤šä¸ªé—¨ã€‚ä½†æ˜¯å•ç‹¬çš„è¿žæŽ¥å™¨æˆ–è€…å®¹å™¨éƒ½ä¸èƒ½å¯¹å¤–æä¾›æœåŠ¡ï¼Œéœ€è¦æŠŠå®ƒä»¬ç»„è£…èµ·æ¥æ‰èƒ½å·¥ä½œï¼Œç»„è£…åŽè¿™ä¸ªæ•´ä½“å«ä½œ Service ç»„ä»¶ã€‚è¿™é‡Œè¯·ä½ æ³¨æ„ï¼ŒService æœ¬èº«æ²¡æœ‰åšä»€ä¹ˆé‡è¦çš„äº‹æƒ…ï¼Œåªæ˜¯åœ¨è¿žæŽ¥å™¨å’Œå®¹å™¨å¤–é¢å¤šåŒ…äº†ä¸€å±‚ï¼ŒæŠŠå®ƒä»¬ç»„è£…åœ¨ä¸€èµ·ã€‚**Tomcat å†…å¯èƒ½æœ‰å¤šä¸ª Serviceï¼Œè¿™æ ·çš„è®¾è®¡ä¹Ÿæ˜¯å‡ºäºŽçµæ´»æ€§çš„è€ƒè™‘ã€‚é€šè¿‡åœ¨ Tomcat ä¸­é…ç½®å¤šä¸ª Serviceï¼Œå¯ä»¥å®žçŽ°é€šè¿‡ä¸åŒçš„ç«¯å£å·æ¥è®¿é—®åŒä¸€å°æœºå™¨ä¸Šéƒ¨ç½²çš„ä¸åŒåº”ç”¨ã€‚**

![image-20220814201841795](05%20%20Tomcat%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9A%20%E8%BF%9E%E6%8E%A5%E5%99%A8%E6%98%AF%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E7%9A%84%EF%BC%9F.resource/image-20220814201841795.png)

ä»Žå›¾ä¸Šä½ å¯ä»¥çœ‹åˆ°ï¼Œæœ€é¡¶å±‚æ˜¯ Serverï¼Œè¿™é‡Œçš„ Server æŒ‡çš„å°±æ˜¯ä¸€ä¸ª Tomcat å®žä¾‹ã€‚ä¸€ä¸ª Server ä¸­æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ª Serviceï¼Œä¸€ä¸ª Service ä¸­æœ‰å¤šä¸ªè¿žæŽ¥å™¨å’Œä¸€ä¸ªå®¹å™¨ã€‚è¿žæŽ¥å™¨ä¸Žå®¹å™¨ä¹‹é—´é€šè¿‡æ ‡å‡†çš„ ServletRequest å’Œ ServletResponse é€šä¿¡ã€‚

## äºŒã€è¿žæŽ¥å™¨

è¿žæŽ¥å™¨å¯¹ Servlet å®¹å™¨å±è”½äº†åè®®åŠ I/O æ¨¡åž‹ç­‰çš„åŒºåˆ«ï¼Œæ— è®ºæ˜¯ HTTP è¿˜æ˜¯ AJPï¼Œåœ¨å®¹å™¨ä¸­èŽ·å–åˆ°çš„éƒ½æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ ServletRequest å¯¹è±¡ã€‚

æˆ‘ä»¬å¯ä»¥æŠŠè¿žæŽ¥å™¨çš„åŠŸèƒ½éœ€æ±‚è¿›ä¸€æ­¥ç»†åŒ–ï¼Œæ¯”å¦‚ï¼š

- ç›‘å¬ç½‘ç»œç«¯å£ã€‚
- æŽ¥å—ç½‘ç»œè¿žæŽ¥è¯·æ±‚ã€‚
- è¯»å–è¯·æ±‚ç½‘ç»œå­—èŠ‚æµã€‚
- æ ¹æ®å…·ä½“åº”ç”¨å±‚åè®®ï¼ˆHTTP/AJPï¼‰è§£æžå­—èŠ‚æµï¼Œç”Ÿæˆç»Ÿä¸€çš„ Tomcat Request å¯¹è±¡ã€‚
- å°† Tomcat Request å¯¹è±¡è½¬æˆæ ‡å‡†çš„ ServletRequestã€‚
- è°ƒç”¨ Servlet å®¹å™¨ï¼Œå¾—åˆ° ServletResponseã€‚
- å°† ServletResponse è½¬æˆ Tomcat Response å¯¹è±¡ã€‚
- å°† Tomcat Response è½¬æˆç½‘ç»œå­—èŠ‚æµã€‚
- å°†å“åº”å­—èŠ‚æµå†™å›žç»™æµè§ˆå™¨ã€‚

éœ€æ±‚åˆ—æ¸…æ¥šåŽï¼Œæˆ‘ä»¬è¦è€ƒè™‘çš„ä¸‹ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œè¿žæŽ¥å™¨åº”è¯¥æœ‰å“ªäº›å­æ¨¡å—ï¼Ÿä¼˜ç§€çš„æ¨¡å—åŒ–è®¾è®¡åº”è¯¥è€ƒè™‘**é«˜å†…èšã€ä½Žè€¦åˆ**ã€‚

- **é«˜å†…èš**æ˜¯æŒ‡ç›¸å…³åº¦æ¯”è¾ƒé«˜çš„åŠŸèƒ½è¦å°½å¯èƒ½é›†ä¸­ï¼Œä¸è¦åˆ†æ•£ã€‚
- **ä½Žè€¦åˆ**æ˜¯æŒ‡ä¸¤ä¸ªç›¸å…³çš„æ¨¡å—è¦å°½å¯èƒ½å‡å°‘ä¾èµ–çš„éƒ¨åˆ†å’Œé™ä½Žä¾èµ–çš„ç¨‹åº¦ï¼Œä¸è¦è®©ä¸¤ä¸ªæ¨¡å—äº§ç”Ÿå¼ºä¾èµ–ã€‚

é€šè¿‡åˆ†æžè¿žæŽ¥å™¨çš„è¯¦ç»†åŠŸèƒ½åˆ—è¡¨ï¼Œæˆ‘ä»¬å‘çŽ°è¿žæŽ¥å™¨éœ€è¦å®Œæˆ 3 ä¸ª**é«˜å†…èš**çš„åŠŸèƒ½ï¼š

- ç½‘ç»œé€šä¿¡ã€‚
- åº”ç”¨å±‚åè®®è§£æžã€‚
- Tomcat Request/Response ä¸Ž ServletRequest/ServletResponse çš„è½¬åŒ–ã€‚

å› æ­¤ Tomcat çš„è®¾è®¡è€…è®¾è®¡äº† 3 ä¸ªç»„ä»¶æ¥å®žçŽ°è¿™ 3 ä¸ªåŠŸèƒ½ï¼Œåˆ†åˆ«æ˜¯ EndPointã€Processor å’Œ Adapterã€‚

ç»„ä»¶ä¹‹é—´é€šè¿‡æŠ½è±¡æŽ¥å£äº¤äº’ã€‚è¿™æ ·åšè¿˜æœ‰ä¸€ä¸ªå¥½å¤„æ˜¯**å°è£…å˜åŒ–ã€‚**è¿™æ˜¯é¢å‘å¯¹è±¡è®¾è®¡çš„ç²¾é«“ï¼Œå°†ç³»ç»Ÿä¸­ç»å¸¸å˜åŒ–çš„éƒ¨åˆ†å’Œç¨³å®šçš„éƒ¨åˆ†éš”ç¦»ï¼Œæœ‰åŠ©äºŽå¢žåŠ å¤ç”¨æ€§ï¼Œå¹¶é™ä½Žç³»ç»Ÿè€¦åˆåº¦ã€‚

ç½‘ç»œé€šä¿¡çš„ I/O æ¨¡åž‹æ˜¯å˜åŒ–çš„ï¼Œå¯èƒ½æ˜¯éžé˜»å¡ž I/Oã€å¼‚æ­¥ I/O æˆ–è€… APRã€‚åº”ç”¨å±‚åè®®ä¹Ÿæ˜¯å˜åŒ–çš„ï¼Œå¯èƒ½æ˜¯ HTTPã€HTTPSã€AJPã€‚æµè§ˆå™¨ç«¯å‘é€çš„è¯·æ±‚ä¿¡æ¯ä¹Ÿæ˜¯å˜åŒ–çš„ã€‚

ä½†æ˜¯æ•´ä½“çš„å¤„ç†é€»è¾‘æ˜¯ä¸å˜çš„ï¼Œ**EndPoint è´Ÿè´£æä¾›å­—èŠ‚æµç»™ Processorï¼ŒProcessor è´Ÿè´£æä¾› Tomcat Request å¯¹è±¡ç»™ Adapterï¼ŒAdapter è´Ÿè´£æä¾› ServletRequest å¯¹è±¡ç»™å®¹å™¨**ã€‚

å¦‚æžœè¦æ”¯æŒæ–°çš„ I/O æ–¹æ¡ˆã€æ–°çš„åº”ç”¨å±‚åè®®ï¼Œåªéœ€è¦å®žçŽ°ç›¸å…³çš„å…·ä½“å­ç±»ï¼Œä¸Šå±‚é€šç”¨çš„å¤„ç†é€»è¾‘æ˜¯ä¸å˜çš„ã€‚

ç”±äºŽ I/O æ¨¡åž‹å’Œåº”ç”¨å±‚åè®®å¯ä»¥è‡ªç”±ç»„åˆï¼Œæ¯”å¦‚ NIO + HTTP æˆ–è€… NIO2 + AJPã€‚Tomcat çš„è®¾è®¡è€…å°†ç½‘ç»œé€šä¿¡å’Œåº”ç”¨å±‚åè®®è§£æžæ”¾åœ¨ä¸€èµ·è€ƒè™‘ï¼Œè®¾è®¡äº†ä¸€ä¸ªå« ProtocolHandler çš„æŽ¥å£æ¥å°è£…è¿™ä¸¤ç§å˜åŒ–ç‚¹ã€‚å„ç§åè®®å’Œé€šä¿¡æ¨¡åž‹çš„ç»„åˆæœ‰ç›¸åº”çš„å…·ä½“å®žçŽ°ç±»ã€‚æ¯”å¦‚ï¼šHttp11NioProtocol å’Œ AjpNioProtocolã€‚

é™¤äº†è¿™äº›å˜åŒ–ç‚¹ï¼Œç³»ç»Ÿä¹Ÿå­˜åœ¨ä¸€äº›ç›¸å¯¹ç¨³å®šçš„éƒ¨åˆ†ï¼Œå› æ­¤ Tomcat è®¾è®¡äº†ä¸€ç³»åˆ—æŠ½è±¡åŸºç±»æ¥**å°è£…è¿™äº›ç¨³å®šçš„éƒ¨åˆ†**ï¼ŒæŠ½è±¡åŸºç±» AbstractProtocol å®žçŽ°äº† ProtocolHandler æŽ¥å£ã€‚æ¯ä¸€ç§åº”ç”¨å±‚åè®®æœ‰è‡ªå·±çš„æŠ½è±¡åŸºç±»ï¼Œæ¯”å¦‚ AbstractAjpProtocol å’Œ AbstractHttp11Protocolï¼Œå…·ä½“åè®®çš„å®žçŽ°ç±»æ‰©å±•äº†åè®®å±‚æŠ½è±¡åŸºç±»ã€‚ä¸‹é¢æˆ‘æ•´ç†ä¸€ä¸‹å®ƒä»¬çš„ç»§æ‰¿å…³ç³»ã€‚

![image-20220814201920296](05%20%20Tomcat%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9A%20%E8%BF%9E%E6%8E%A5%E5%99%A8%E6%98%AF%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E7%9A%84%EF%BC%9F.resource/image-20220814201920296.png)

é€šè¿‡ä¸Šé¢çš„å›¾ï¼Œä½ å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°å®ƒä»¬çš„ç»§æ‰¿å’Œå±‚æ¬¡å…³ç³»ï¼Œè¿™æ ·è®¾è®¡çš„ç›®çš„æ˜¯å°½é‡å°†ç¨³å®šçš„éƒ¨åˆ†æ”¾åˆ°æŠ½è±¡åŸºç±»ï¼ŒåŒæ—¶æ¯ä¸€ç§ I/O æ¨¡åž‹å’Œåè®®çš„ç»„åˆéƒ½æœ‰ç›¸åº”çš„å…·ä½“å®žçŽ°ç±»ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨æ—¶å¯ä»¥è‡ªç”±é€‰æ‹©ã€‚

å°ç»“ä¸€ä¸‹ï¼Œè¿žæŽ¥å™¨æ¨¡å—ç”¨ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼šEndpointã€Processor å’Œ Adapter æ¥åˆ†åˆ«åšä¸‰ä»¶äº‹æƒ…ï¼Œå…¶ä¸­ Endpoint å’Œ Processor æ”¾åœ¨ä¸€èµ·æŠ½è±¡æˆäº† ProtocolHandler ç»„ä»¶ï¼Œå®ƒä»¬çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![image-20220814201950704](05%20%20Tomcat%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9A%20%E8%BF%9E%E6%8E%A5%E5%99%A8%E6%98%AF%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E7%9A%84%EF%BC%9F.resource/image-20220814201950704.png)

ä¸‹é¢æˆ‘æ¥è¯¦ç»†ä»‹ç»è¿™ä¸¤ä¸ªé¡¶å±‚ç»„ä»¶ ProtocolHandler å’Œ Adapterã€‚

### ï¼ˆä¸€ï¼‰ProtocolHandler ç»„ä»¶

ç”±ä¸Šæ–‡æˆ‘ä»¬çŸ¥é“ï¼Œ**è¿žæŽ¥å™¨ç”¨ ProtocolHandler æ¥å¤„ç†ç½‘ç»œè¿žæŽ¥å’Œåº”ç”¨å±‚åè®®**ï¼ŒåŒ…å«äº† 2 ä¸ªé‡è¦éƒ¨ä»¶ï¼šEndPoint å’Œ Processorï¼Œä¸‹é¢æˆ‘æ¥è¯¦ç»†ä»‹ç»å®ƒä»¬çš„å·¥ä½œåŽŸç†ã€‚

- EndPoint

    EndPoint æ˜¯é€šä¿¡ç«¯ç‚¹ï¼Œå³é€šä¿¡ç›‘å¬çš„æŽ¥å£ï¼Œ**æ˜¯å…·ä½“çš„ Socket æŽ¥æ”¶å’Œå‘é€å¤„ç†å™¨**ï¼Œæ˜¯å¯¹ä¼ è¾“å±‚çš„æŠ½è±¡ï¼Œå› æ­¤ **EndPoint æ˜¯ç”¨æ¥å®žçŽ° TCP/IP åè®®çš„**ã€‚

    EndPoint æ˜¯ä¸€ä¸ªæŽ¥å£ï¼Œå¯¹åº”çš„æŠ½è±¡å®žçŽ°ç±»æ˜¯ AbstractEndpointï¼Œè€Œ AbstractEndpoint çš„å…·ä½“å­ç±»ï¼Œæ¯”å¦‚åœ¨ NioEndpoint å’Œ Nio2Endpoint ä¸­ï¼Œæœ‰ä¸¤ä¸ªé‡è¦çš„å­ç»„ä»¶ï¼šAcceptor å’Œ SocketProcessorã€‚

    å…¶ä¸­ Acceptor ç”¨äºŽç›‘å¬ Socket è¿žæŽ¥è¯·æ±‚ã€‚SocketProcessor ç”¨äºŽå¤„ç†æŽ¥æ”¶åˆ°çš„ Socket è¯·æ±‚ï¼Œå®ƒå®žçŽ° Runnable æŽ¥å£ï¼Œåœ¨ Run æ–¹æ³•é‡Œè°ƒç”¨åè®®å¤„ç†ç»„ä»¶ Processor è¿›è¡Œå¤„ç†ã€‚ä¸ºäº†æé«˜å¤„ç†èƒ½åŠ›ï¼ŒSocketProcessor è¢«æäº¤åˆ°çº¿ç¨‹æ± æ¥æ‰§è¡Œã€‚è€Œè¿™ä¸ªçº¿ç¨‹æ± å«ä½œæ‰§è¡Œå™¨ï¼ˆExecutor)ï¼Œæˆ‘åœ¨åŽé¢çš„ä¸“æ ä¼šè¯¦ç»†ä»‹ç» Tomcat å¦‚ä½•æ‰©å±•åŽŸç”Ÿçš„ Java çº¿ç¨‹æ± ã€‚

- Processor

    å¦‚æžœè¯´ EndPoint æ˜¯ç”¨æ¥å®žçŽ° TCP/IP åè®®çš„ï¼Œé‚£ä¹ˆ **Processor ç”¨æ¥å®žçŽ° HTTP åè®®ï¼ŒProcessor æŽ¥æ”¶æ¥è‡ª EndPoint çš„ Socketï¼Œè¯»å–å­—èŠ‚æµè§£æžæˆ Tomcat Request å’Œ Response å¯¹è±¡**ï¼Œå¹¶é€šè¿‡ Adapter å°†å…¶æäº¤åˆ°å®¹å™¨å¤„ç†ï¼ŒProcessor æ˜¯å¯¹åº”ç”¨å±‚åè®®çš„æŠ½è±¡ã€‚

    Processor æ˜¯ä¸€ä¸ªæŽ¥å£ï¼Œå®šä¹‰äº†è¯·æ±‚çš„å¤„ç†ç­‰æ–¹æ³•ã€‚å®ƒçš„æŠ½è±¡å®žçŽ°ç±» AbstractProcessor å¯¹ä¸€äº›åè®®å…±æœ‰çš„å±žæ€§è¿›è¡Œå°è£…ï¼Œæ²¡æœ‰å¯¹æ–¹æ³•è¿›è¡Œå®žçŽ°ã€‚å…·ä½“çš„å®žçŽ°æœ‰ AJPProcessorã€HTTP11Processor ç­‰ï¼Œè¿™äº›å…·ä½“å®žçŽ°ç±»å®žçŽ°äº†ç‰¹å®šåè®®çš„è§£æžæ–¹æ³•å’Œè¯·æ±‚å¤„ç†æ–¹å¼ã€‚

    æˆ‘ä»¬å†æ¥çœ‹çœ‹è¿žæŽ¥å™¨çš„ç»„ä»¶å›¾ï¼š

![image-20220814202014250](05%20%20Tomcat%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9A%20%E8%BF%9E%E6%8E%A5%E5%99%A8%E6%98%AF%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E7%9A%84%EF%BC%9F.resource/image-20220814202014250.png)

ä»Žå›¾ä¸­æˆ‘ä»¬çœ‹åˆ°ï¼ŒEndPoint æŽ¥æ”¶åˆ° Socket è¿žæŽ¥åŽï¼Œç”Ÿæˆä¸€ä¸ª SocketProcessor ä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± åŽ»å¤„ç†ï¼ŒSocketProcessor çš„ Run æ–¹æ³•ä¼šè°ƒç”¨ Processor ç»„ä»¶åŽ»è§£æžåº”ç”¨å±‚åè®®ï¼ŒProcessor é€šè¿‡è§£æžç”Ÿæˆ Request å¯¹è±¡åŽï¼Œä¼šè°ƒç”¨ Adapter çš„ Service æ–¹æ³•ã€‚

åˆ°è¿™é‡Œæˆ‘ä»¬å­¦ä¹ äº† ProtocolHandler çš„æ€»ä½“æž¶æž„å’Œå·¥ä½œåŽŸç†ï¼Œå…³äºŽ EndPoint çš„è¯¦ç»†è®¾è®¡ï¼ŒåŽé¢æˆ‘è¿˜ä¼šä¸“é—¨ä»‹ç» EndPoint æ˜¯å¦‚ä½•æœ€å¤§é™åº¦åœ°åˆ©ç”¨ Java NIO çš„éžé˜»å¡žä»¥åŠ NIO2 çš„å¼‚æ­¥ç‰¹æ€§ï¼Œæ¥å®žçŽ°é«˜å¹¶å‘ã€‚

### ï¼ˆäºŒï¼‰Adapter ç»„ä»¶

æˆ‘åœ¨å‰é¢è¯´è¿‡ï¼Œç”±äºŽåè®®ä¸åŒï¼Œå®¢æˆ·ç«¯å‘è¿‡æ¥çš„è¯·æ±‚ä¿¡æ¯ä¹Ÿä¸å°½ç›¸åŒï¼ŒTomcat å®šä¹‰äº†è‡ªå·±çš„ Request ç±»æ¥â€œå­˜æ”¾â€è¿™äº›è¯·æ±‚ä¿¡æ¯ã€‚ProtocolHandler æŽ¥å£è´Ÿè´£è§£æžè¯·æ±‚å¹¶ç”Ÿæˆ Tomcat Request ç±»ã€‚ä½†æ˜¯è¿™ä¸ª Request å¯¹è±¡ä¸æ˜¯æ ‡å‡†çš„ ServletRequestï¼Œä¹Ÿå°±æ„å‘³ç€ï¼Œä¸èƒ½ç”¨ Tomcat Request ä½œä¸ºå‚æ•°æ¥è°ƒç”¨å®¹å™¨ã€‚Tomcat è®¾è®¡è€…çš„è§£å†³æ–¹æ¡ˆæ˜¯å¼•å…¥ CoyoteAdapterï¼Œè¿™æ˜¯é€‚é…å™¨æ¨¡å¼çš„ç»å…¸è¿ç”¨ï¼Œ**è¿žæŽ¥å™¨è°ƒç”¨ CoyoteAdapter çš„ Sevice æ–¹æ³•ï¼Œä¼ å…¥çš„æ˜¯ Tomcat Request å¯¹è±¡ï¼ŒCoyoteAdapter è´Ÿè´£å°† Tomcat Request è½¬æˆ ServletRequestï¼Œå†è°ƒç”¨å®¹å™¨çš„ Service æ–¹æ³•ã€‚**

## ä¸‰ã€æœ¬æœŸç²¾åŽ

Tomcat çš„æ•´ä½“æž¶æž„åŒ…å«äº†ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶è¿žæŽ¥å™¨å’Œå®¹å™¨ã€‚è¿žæŽ¥å™¨è´Ÿè´£å¯¹å¤–äº¤æµï¼Œå®¹å™¨è´Ÿè´£å†…éƒ¨å¤„ç†ã€‚è¿žæŽ¥å™¨ç”¨ ProtocolHandler æŽ¥å£æ¥å°è£…é€šä¿¡åè®®å’Œ I/O æ¨¡åž‹çš„å·®å¼‚ï¼ŒProtocolHandler å†…éƒ¨åˆåˆ†ä¸º EndPoint å’Œ Processor æ¨¡å—ï¼ŒEndPoint è´Ÿè´£åº•å±‚ Socket é€šä¿¡ï¼ŒProccesor è´Ÿè´£åº”ç”¨å±‚åè®®è§£æžã€‚è¿žæŽ¥å™¨é€šè¿‡é€‚é…å™¨ Adapter è°ƒç”¨å®¹å™¨ã€‚

é€šè¿‡å¯¹ Tomcat æ•´ä½“æž¶æž„çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€äº›è®¾è®¡å¤æ‚ç³»ç»Ÿçš„åŸºæœ¬æ€è·¯ã€‚é¦–å…ˆè¦åˆ†æžéœ€æ±‚ï¼Œæ ¹æ®é«˜å†…èšä½Žè€¦åˆçš„åŽŸåˆ™ç¡®å®šå­æ¨¡å—ï¼Œç„¶åŽæ‰¾å‡ºå­æ¨¡å—ä¸­çš„å˜åŒ–ç‚¹å’Œä¸å˜ç‚¹ï¼Œç”¨æŽ¥å£å’ŒæŠ½è±¡åŸºç±»åŽ»å°è£…ä¸å˜ç‚¹ï¼Œåœ¨æŠ½è±¡åŸºç±»ä¸­å®šä¹‰æ¨¡æ¿æ–¹æ³•ï¼Œè®©å­ç±»è‡ªè¡Œå®žçŽ°æŠ½è±¡æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å…·ä½“å­ç±»åŽ»å®žçŽ°å˜åŒ–ç‚¹ã€‚

## è¯¾åŽæ€è€ƒ

å›žå¿†ä¸€ä¸‹ä½ åœ¨å·¥ä½œä¸­æ›¾ç»ç‹¬ç«‹è®¾è®¡è¿‡çš„ç³»ç»Ÿï¼Œæˆ–è€…ä½ ç¢°åˆ°è¿‡çš„è®¾è®¡ç±»é¢è¯•é¢˜ï¼Œç»“åˆä»Šå¤©ä¸“æ çš„å†…å®¹ï¼Œä½ æœ‰æ²¡æœ‰ä¸€äº›æ–°çš„æ€è·¯ï¼Ÿ

ä¸çŸ¥é“ä»Šå¤©çš„å†…å®¹ä½ æ¶ˆåŒ–å¾—å¦‚ä½•ï¼Ÿå¦‚æžœè¿˜æœ‰ç–‘é—®ï¼Œè¯·å¤§èƒ†çš„åœ¨ç•™è¨€åŒºæé—®ï¼Œä¹Ÿæ¬¢è¿Žä½ æŠŠä½ çš„è¯¾åŽæ€è€ƒå’Œå¿ƒå¾—è®°å½•ä¸‹æ¥ï¼Œä¸Žæˆ‘å’Œå…¶ä»–åŒå­¦ä¸€èµ·è®¨è®ºã€‚å¦‚æžœä½ è§‰å¾—ä»Šå¤©æœ‰æ‰€æ”¶èŽ·ï¼Œæ¬¢è¿Žä½ æŠŠå®ƒåˆ†äº«ç»™ä½ çš„æœ‹å‹ã€‚

## ç²¾é€‰ç•™è¨€(59)

- å¯¹Tomcatçš„ç»“æž„æœ‰ä¸ªæ¸…æ™°çš„äº†è§£ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š
  \1. PorotocolHandlerçš„ç»§æ‰¿å…³ç³»æ˜¯ä¸æ˜¯å¤ªé‡äº†ï¼Œçœ‹èµ·æ¥åƒå…¸åž‹çš„å¤šç»´åº¦æ‰©å±•ï¼Œnio2åœ¨apjå’Œ1HTTP11éƒ½è¦åšä¸€éï¼Œç”¨ç»„åˆä¼šä¸ä¼šæ›´å¥½
  \2. ä¸ºä»€ä¹ˆè¦å¤šä¸€å±‚adapterï¼Œåœ¨processorç›´æŽ¥è½¬æ¢ä¸ºå®¹å™¨çš„servletrequestå’Œservletresponseä¸æ˜¯æ›´å¥½ï¼Œä¸ºä»€ä¹ˆè¦å…ˆè½¬åŒ–Tomcatçš„requestå’Œresponseï¼Œå†ç”¨adapteråšä¸€å±‚è½¬æ¢æ¶ˆè€—æ€§èƒ½ï¼Ÿ
  è°¢è°¢äº†ï¼
  
  å±•å¼€*î˜ƒ*
  
  ä½œè€…å›žå¤: 1ï¼Œè¯´çš„å¯¹ï¼Œèƒ½ç”¨ç»„åˆå°±ä¸ç”¨ç»§æ‰¿ï¼Œè¿™é‡Œæˆ‘æ„Ÿè§‰Tomcatè®¾è®¡è€…è€ƒè™‘çš„æ˜¯é€šè¿‡å¤šå±‚ç»§æ‰¿æ¥å°½é‡é‡ç”¨ä¸€äº›é€šç”¨çš„é€»è¾‘ã€‚å¦å¤–I/Oæ¨¡åž‹å’Œåº”ç”¨å±‚åè®®çš„ä¸ªæ•°ä¹Ÿæ˜¯å¯æŽ§çš„ï¼Œç”¨æˆ·å¯ä»¥åœ¨server.xmlä¸­ç›´æŽ¥æŒ‡å®šæƒ³è¦çš„è¿žæŽ¥å™¨ç±»åž‹ï¼šæ¯”å¦‚Http11NioProtocolå’ŒHttp11Nio2Protocolã€‚
  
  2ï¼Œè¿™é‡Œçš„è€ƒè™‘æ˜¯ï¼Œå¦‚æžœè¿žæŽ¥å™¨ç›´æŽ¥åˆ›å»ºServletRequestå’ŒServletResponseå¯¹è±¡çš„è¯ï¼Œå°±å’ŒServletåè®®è€¦åˆäº†ï¼Œè®¾è®¡è€…è®¤ä¸ºè¿žæŽ¥å™¨å°½é‡ä¿æŒç‹¬ç«‹æ€§ï¼Œå®ƒä¸ä¸€å®šè¦è·ŸServletå®¹å™¨å·¥ä½œçš„ã€‚å¦å¤–å¯¹è±¡è½¬åŒ–çš„æ€§èƒ½æ¶ˆè€—è¿˜æ˜¯æ¯”è¾ƒå°‘çš„ï¼ŒTomcatå¯¹HTTPè¯·æ±‚ä½“é‡‡å–äº†å»¶è¿Ÿè§£æžçš„ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒTomcatRequestå¯¹è±¡è½¬åŒ–æˆServletRequestçš„æ—¶å€™ï¼Œè¯·æ±‚ä½“çš„å†…å®¹éƒ½è¿˜æ²¡è¯»å–å‘¢ï¼Œç›´åˆ°å®¹å™¨å¤„ç†è¿™ä¸ªè¯·æ±‚çš„æ—¶å€™æ‰è¯»å–çš„ã€‚
  
- â€œEndPoint æ˜¯é€šä¿¡ç«¯ç‚¹ï¼Œå³é€šä¿¡ç›‘å¬çš„æŽ¥å£ï¼Œæ˜¯å…·ä½“çš„ Socket æŽ¥æ”¶å’Œå‘é€å¤„ç†å™¨ï¼Œæ˜¯å¯¹ä¼ è¾“å±‚çš„æŠ½è±¡ï¼Œå› æ­¤ EndPoint æ˜¯ç”¨æ¥å®žçŽ° TCP/IP åè®®çš„ã€‚â€ï¼Œã€EndPointæ˜¯ç”¨æ¥å®žçŽ°TCP/IPåè®®çš„ã€‘è¿™ä¸ªæ²¡æœ‰å¤ªæ˜Žç™½ï¼Œæ®æˆ‘æœ‰é™çš„çŸ¥è¯†æ‰€çŸ¥ï¼ŒTCP/IPåè®®æ˜¯ã€ç”±æ“ä½œç³»ç»Ÿå®žçŽ°ã€‘çš„ï¼Œè€Œsocketåªæ˜¯åœ¨TCP/IPä¹‹ä¸Šå±•çŽ°ç»™ç”¨æˆ·å±‚çš„ä¸€ä¸ªæŽ¥å£ï¼Œè€ŒEndPointåˆç”¨åˆ°äº†socketæŽ¥å£ï¼ˆæˆ‘çžŽçŒœçš„ï¼‰ã€‚æ‰€ä»¥ï¼Œæˆ‘æ˜¯å¦å¯ä»¥æŠŠè¿™å¥è¯ç†è§£ä¸ºï¼ŒEndPointåˆ©ç”¨SocketæŽ¥å£æ¥å°†åº•å±‚ä¼ æ¥çš„æ•°æ®è½¬åŒ–æˆä¸ºHTTPæ ¼å¼çš„æ•°æ®ï¼Œè¿™ç§è¡Œä¸ºå°±å¯ä»¥çœ‹ä½œæ˜¯å¯¹TCP/IPåè®®çš„ä¸€ç§é—´æŽ¥å®žçŽ°ã€‚

  ä½œè€…å›žå¤: ç†è§£æ­£ç¡®ðŸ‘

- è€å¸ˆå¥½!Tomcaté…ç½®çš„å¹¶å‘æ•°æ˜¯æ–‡ä¸­endpointé‡Œé‚£ä¸ªçº¿ç¨‹æ± ä¹ˆ?IOæ–¹é¢çŸ¥è¯†æ¯”è¾ƒè–„å¼±ï¼Œå¸Œæœ›è€å¸ˆåŽæœŸè®²è§£æ—¶å¤šèŠ±ç‚¹å¿ƒæ€ã€‚

  ä½œè€…å›žå¤: æ˜¯çš„

- å¯¹tomcatçš„ç»“æž„çš„è¿žæŽ¥å™¨éƒ¨åˆ†æ”¶èŽ·ä¸å°‘ï¼Œæœ‰ä¸€é—®é¢˜ï¼Œtomcatçš„endpointçš„åŠŸèƒ½å’Œnettyçš„å®žçŽ°åŠŸèƒ½å¾ˆå¤šæ–¹é¢ä¸€æ ·ï¼Œtomcatä¸ºä»€ä¹ˆæ²¡æœ‰ç”¨nettyä½œä¸ºåº•å±‚é€šè®¯æ¡†æž¶ï¼Ÿ

  å±•å¼€*î˜ƒ*

  ä½œè€…å›žå¤: Tomcatåœ¨I/Oæ¨¡åž‹å’Œçº¿ç¨‹æ¨¡åž‹æ–¹é¢è·ŸNettyå¾ˆç›¸ä¼¼ï¼ŒåŽé¢ä¼šè¯¦ç»†åˆ†æžã€‚

- Adapterä¸€å±‚ä½¿ç”¨çš„æ˜¯é€‚é…å™¨è®¾è®¡æ¨¡å¼ï¼Œå¥½å¤„æ˜¯å½“å®¹å™¨ç‰ˆæœ¬å‡çº§åªä¿®æ”¹Adaperç»„ä»¶é€‚é…åˆ°æ–°ç‰ˆæœ¬å®¹å™¨å°±å¯ä»¥äº†ï¼Œprotocal handlerç»„ä»¶ä»£ç ä¸éœ€è¦æ”¹åŠ¨

- ä¸€ä¸ªserviceå¯¹åº”tomcatä¸­éƒ¨ç½²çš„ä¸€ä¸ªé¡¹ç›®ï¼Œä¸€ä¸ªè¿žæŽ¥å™¨å¯¹åº”ä¸€ä¸ªè¯·æ±‚ï¼Œè¿™æ ·ç†è§£å¯¹å—

  ä½œè€…å›žå¤: ä¸€ä¸ªServiceä¸­å¯ä»¥éƒ¨ç½²å¤šä¸ªé¡¹ç›®å‘¢ï¼Œä¸€ä¸ªè¿žæŽ¥å™¨å¯¹åº”ä¸€ä¸ªç›‘å¬ç«¯å£ï¼Œä¸æ˜¯ä¸€ä¸ªè¯·æ±‚ï¼Œä¸€ä¸ªç«¯å£ä¸Šå¯ä»¥æŽ¥æ”¶å¤šä¸ªè¯·æ±‚ã€‚

- è€å¸ˆï¼Œä½ çœ‹è¿™æ ·ç†è§£å¯¹ä¸ï¼Œ
  é‡‡ç”¨ä½•ç§I/Oæ¨¡å¼ï¼ˆNIOã€NIO2ã€ARPï¼‰ï¼Œä»¥åŠé‡‡ç”¨ä½•ç§åº”ç”¨åè®®ï¼ˆHTTP1.1ã€AJPã€HTTP/2)éƒ½æ˜¯åœ¨processorè¿™ä¸€å±‚å†³å®šçš„ã€‚EndPointåªè´Ÿè´£æŽ¥æ”¶è¿žæŽ¥ï¼Œå¹¶è¯»å–ç½‘ç»œå­—èŠ‚æµä½†æ˜¯ä¸å¯¹å­—èŠ‚æµæœ¬èº«å°±è¿›è¡Œä»»ä½•è§£æžã€‚
  
  ä½œè€…å›žå¤: å¯¹çš„
  
- è€å¸ˆæ‚¨å¥½,æˆ‘æœ‰ä¸¤ä¸ªé—®é¢˜,
  ä¸€ä¸ªæ˜¯ä¸Šé¢è¯´åˆ°ä¸€ä¸ªå®¹å™¨å¯¹æŽ¥å¤šä¸ªè¿žæŽ¥å™¨,ä¹Ÿå°±æ˜¯service,è¿™ä¸ªå…·ä½“æ˜¯ä¸æ˜¯å¯ä»¥åœ¨tomcatçš„confç›®å½•ä¸‹çš„server.xmlä¸­å‘çŽ°å‘¢? ä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹,ä¹Ÿå°±æ˜¯é»˜è®¤çš„,tomcatçš„ä¸€ä¸ªserverä¸‹åªä¼šæœ‰ä¸€ä¸ªserviceç»„ä»¶,è€Œconnectorå°±æ˜¯åœ¨serviceç»„ä»¶ä¸­é…ç½®çš„å‘¢?
  å¦ä¸€ä¸ªæ˜¯ä¸€ä¸ªserverä¸­æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªservice,ä¸€ä¸ªserviceä¸­æœ‰å¤šä¸ªè¿žæŽ¥å™¨å’Œä¸€ä¸ªå®¹å™¨,è¿™é‡Œçš„å®¹å™¨åˆ°åº•æ˜¯ä»€ä¹ˆ?æˆ‘å¹¶æ²¡æœ‰åœ¨server.xmlä¸­æ‰¾åˆ°ç›¸å…³çš„é…ç½®ç­‰å‘€.

  å±•å¼€*î˜ƒ*

  ä½œè€…å›žå¤: 1.å¯¹çš„ï¼Œé»˜è®¤æ˜¯ä¸€ä¸ªservice
  2.å®¹å™¨å°±æ˜¯è£…è½½Servletçš„ç®±å­ï¼ŒTomcatçš„å®¹å™¨åˆ†å±‚æ¬¡ï¼Œå¤§ç®±å­é‡Œæœ‰å°ç®±å­ï¼Œæœ€å¤§çš„ç®±å­æ˜¯Engineï¼Œä¸‹ä¸€ç¯‡ä¼šè®²åˆ°ã€‚
  
- è€å¸ˆè¯·æ•™ä¸¤ä¸ªé—®é¢˜
  1.åº”ç”¨å±‚çš„i/oæ¨¡åž‹å’Œhttp1ï¼Œajpç­‰åè®®æ˜¯æŒ‡åœ¨endpointæŽ¥å—ç½‘ç»œè¯·æ±‚åŽï¼Œå¯¹è¯·æ±‚å†…å®¹è§£æžæ‰ä¼šç”¨åˆ°å§ï¼Œå°±æ˜¯åœ¨processoré‡Œé¢ï¼Œè¿™é‡Œé¢å°±æ˜¯æ ¹æ®è¯·æ±‚çš„åè®®ç±»åž‹ï¼Œé‡‡ç”¨æŒ‡å®ši/oè¯»å–ç½‘ç»œæµï¼Œæ˜¯ä¸æ˜¯è¿™æ ·ï¼Ÿ
  2.ajpä¹Ÿæ˜¯æŒ‡ä¸€ç§ç½‘ç»œåè®®ä¹ˆï¼Œç±»ä¼¼äºŽhttpè¿™ç§ï¼Œprocessoré‡Œé¢æ˜¯æ ¹æ®ä»€ä¹ˆæ¥åˆ¤å®šè¯·æ±‚çš„åè®®ç±»åž‹ï¼Œæ¯”å¦‚æµè§ˆå™¨é‡Œé¢è¯·æ±‚çš„headeré‡Œé¢çš„å†…å®¹å—
  3.endpointé‡Œé¢çš„aceptoræœ¬èº«æ˜¯ç›‘å¬å’ŒèŽ·å–ç½‘ç»œè¯·æ±‚æ²¡æœ‰ç”¨å¤šçº¿ç¨‹ï¼Œè¿™é‡Œä¼šæˆä¸ºé«˜å¹¶å‘çš„ç“¶é¢ˆç‚¹ä¸
  
  å±•å¼€*î˜ƒ*
  
  ä½œè€…å›žå¤: 1. å¯¹çš„
  2.AJPå¯ä»¥ç†è§£ä¸ºåº”ç”¨å±‚åè®®ï¼Œå®ƒæ˜¯ç”¨äºŒè¿›åˆ¶çš„æ–¹å¼æ¥ä¼ è¾“æ–‡æœ¬ï¼Œæ¯”å¦‚HTTPçš„è¯·æ±‚å¤´â€œaccept-languageâ€æœ‰15ä¸ªå­—ç¬¦ï¼Œå¦‚æžœç”¨äºŒè¿›åˆ¶0xA004è¡¨ç¤ºåªæœ‰2ä¸ªå­—èŠ‚ï¼Œæ•ˆçŽ‡å¤§å¤§æå‡ã€‚
  \3. Endpointä¸­çš„Acceptoræœ‰å¤šä¸ªï¼Œæ¯ä¸ªAcceptorè·‘åœ¨å•ç‹¬çš„çº¿ç¨‹é‡Œï¼ŒåŽé¢ä¼šè¯¦ç»†åˆ†æžä¸ºä»€ä¹ˆè¦è¿™æ ·åšã€‚
  
- çŽ°åœ¨ä¸æŠ“æºç ï¼ŒåªåŽ»äº†è§£æ•´ä¸ªé¡¹ç›®çš„æž¶æž„ï¼Œè‡ªå·±ä¹Ÿå¿«è¦åšé¡¹ç›®ç»ç†äº†ï¼Œéœ€è¦å¸¦å›¢é˜Ÿè‡ªå·±æ­å»ºé¡¹ç›®ï¼Œè¦ä»Žtomcaté‡Œå­¦ä¹ ç»å…¸æ¡†æž¶ï¼

- å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªè¿žæŽ¥å™¨å¯¹åº”ä¸€ä¸ªåº”ç”¨å—

  å±•å¼€*î˜ƒ*

  ä½œè€…å›žå¤: ä¸æ˜¯çš„ï¼Œä¸€ä¸ªè¿žæŽ¥å™¨å¯¹åº”ä¸€ä¸ªç›‘å¬ç«¯å£ï¼Œæ¯”å¦‚ä¸€æ‰‡é—¨ï¼Œä¸€ä¸ªwebåº”ç”¨æ˜¯ä¸€ä¸ªä¸šåŠ¡éƒ¨é—¨ï¼Œè¿›äº†è¿™ä¸ªé—¨åŽä½ å¯ä»¥åˆ°å„ä¸ªä¸šåŠ¡éƒ¨é—¨åŽ»åŠžäº‹ã€‚

- ä¸€ä¸ªserviceæœ‰å¤šä¸ªè¿žæŽ¥å™¨å’Œä¸€ä¸ªå®¹å™¨ï¼Œå¤šä¸ªServiceå°±å¯èƒ½æœ‰nä¸ªè¿žæŽ¥å™¨å’Œnä¸ªå®¹å™¨å—ï¼Ÿè¿˜æ˜¯æœ‰ä¸”åªæœ‰ä¸€ä¸ªå®¹å™¨ï¼Œæ‰€æœ‰çš„è¿žæŽ¥å™¨éƒ½æŒ‡å‘è¿™ä¸ªå®¹å™¨ï¼Œè¯·è€å¸ˆè§£ç­”ï¼Œè°¢è°¢ï¼

  å±•å¼€*î˜ƒ*

  ä½œè€…å›žå¤: Serviceæ˜¯å¯¹å¤–æä¾›æœåŠ¡çš„å•ä½ï¼Œä¸€ä¸ªServiceå¯¹åº”ä¸€ä¸ªå®¹å™¨ï¼Œå¤šä¸ªServiceå°±æœ‰å¤šä¸ªå®¹å™¨ã€‚

- â€œå¦‚æžœè¯´ EndPoint æ˜¯ç”¨æ¥å®žçŽ° TCP/IP åè®®çš„ï¼Œé‚£ä¹ˆ Processor ç”¨æ¥å®žçŽ° HTTP åè®®â€ï¼Œè¿™å¥è¯ä¸å¤ªç†è§£ï¼ŒTCP/IPåè®®ä¸æ˜¯ç”±linuxç³»ç»Ÿå†…æ ¸å®žçŽ°çš„ä¹ˆï¼Ÿ

  ä½œè€…å›žå¤: è¿™é‡Œå¯ä»¥ç†è§£ä¸ºEndpointè´Ÿè´£Socketç½‘ç»œé€šä¿¡ï¼Œè·ŸTCP/IPåè®®ç´§å¯†ç›¸å…³ã€‚â€œå®žçŽ°â€è¿™ä¸ªè¯ç¡®å®žæœ‰ç‚¹è¯¯å¯¼ã€‚ï¼šï¼‰

- ä»Žä¸Šä¸€èŠ‚çªç„¶è·³è½¬åˆ°æœ¬èŠ‚ï¼Œæ„Ÿè§‰è·³è·ƒæ€§å¾ˆå¤§ã€‚çªç„¶è¿›å…¥æ•´ä½“æž¶æž„åŽï¼Œå³ä½¿æˆ‘èŠ±äº†å¤§é‡æ—¶é—´å¤šæ¬¡é˜…è¯»æœ¬èŠ‚ï¼Œä¹Ÿå¾ˆéš¾æ¶ˆåŒ–ã€‚çœŸçš„æ‰æ€¥ï¼
ä¸çŸ¥é“è€å¸ˆä¸Šé¢æåˆ°çš„ç±»åï¼Œæ˜¯åŸºäºŽTomcatçš„å“ªä¸ªç‰ˆæœ¬ã€‚
  ä»Šå¤©æˆ‘åˆ»æ„èŠ±æ—¶é—´æŠŠtomcat7.0.94çš„æºç ä¸‹è½½ä¸‹æ¥ï¼Œå¯¼å…¥IDEAã€‚å‘çŽ°org.apache.tomcat.util.net.AbstractEndpointæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæ—¢æ²¡æœ‰å®žçŽ°EndPointï¼Œä¹Ÿæ²¡æœ‰å£°æ˜Žå†…éƒ¨ç±»SocketProcessorã€‚å’Œè€å¸ˆè®²ä¸Šé¢æåˆ°çš„æœ‰å‡ºå…¥ï¼Œéš¾é“æˆ‘ä¸‹äº†ä¸€ä¸ªå‡çš„Tomatoæºç ã€‚>å¤§å“­<

  å±•å¼€*î˜ƒ*

  ä½œè€…å›žå¤: åˆšå¼€å§‹æ˜¯éœ€è¦é€‚åº”ä¸€ä¸‹^_^ï¼Œå…¶å®žä¸éš¾çš„ï¼Œæˆ‘ç”¨çš„æœ€æ–°ç‰ˆçš„ä»£ç ï¼šhttps://github.com/apache/tomcatï¼ŒAbstractEndpointæœ¬èº«ç¡®å®žæ²¡æœ‰å†…éƒ¨ç±»ï¼Œæ˜¯å®ƒçš„å­ç±»Nio2Endpointä¸­åŒ…å«äº†ä¸¤ä¸ªå†…éƒ¨ç±»ï¼šNio2Acceptor å’Œ SocketProcessorã€‚å·²ç»åœ¨ä¸‹é¢çš„å›žå¤ä¸­å·²ç»çº æ­£äº†ã€‚

- ä¸¤ä¸ªé—®é¢˜è¯·æ•™ä¸€ä¸‹è€å¸ˆ
  ç¬¬ä¸€ï¼Œå¦‚ä½•debugæºç å‘¢ï¼Ÿ
  ç¬¬äºŒï¼Œtomcatå’Œnettyæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿä¸ºä»€ä¹ˆnettyå¸¸å¸¸ç”¨åšåº•å±‚é€šè®¯æ¨¡å—ï¼Œè€Œtomcatä½œä¸ºwebå®¹å™¨å‘¢ï¼Ÿ

  ä½œè€…å›žå¤: 1ï¼‰è½¯ä»¶ç³»ç»Ÿæœ¬è´¨æ˜¯å¯¹ä¿¡æ¯çš„å¤„ç†ï¼Œè¦è·Ÿè¸ªä¿¡æ¯åœ¨æµåŠ¨è¿‡ç¨‹ä¸­çš„ç»è¿‡çš„å…³é”®çŽ¯èŠ‚ï¼Œå¹¶åœ¨è¿™äº›åœ°æ–¹ä¸‹æ–­ç‚¹ï¼Œçœ‹çœ‹å˜é‡çš„å€¼æ˜¯ä»€ä¹ˆã€‚æ¯”å¦‚ä½ å¯ä»¥åœ¨ä¸šåŠ¡ä»£ç ä¸­ä¸‹ä¸ªæ–­ç‚¹ï¼Œçœ‹çœ‹è°ƒç”¨æ ˆï¼Œçœ‹Tomcatå’ŒSpringæ˜¯æ€Žä¹ˆè°ƒåˆ°ä½ çš„ä»£ç çš„ï¼Œç„¶åŽåœ¨è¿™ä¸ªè°ƒç”¨æ ˆä¸­çš„å…³é”®å‡½æ•°é‡Œä¸Šä¸‹éƒ½çœ‹çœ‹ï¼Œå…ˆç†Ÿæ‚‰ä¸ªå¤§æ¦‚ï¼Œç„¶åŽå¸¦ç€é—®é¢˜åŽ»æ·±å…¥è°ƒè¯•ã€‚
  2ï¼‰ä½ å¯ä»¥æŠŠNettyç†è§£æˆTomcatä¸­çš„è¿žæŽ¥å™¨ï¼Œå®ƒä»¬éƒ½è´Ÿè´£ç½‘ç»œé€šä¿¡ï¼Œéƒ½åˆ©ç”¨äº†Java NIOéžé˜»å¡žç‰¹æ€§ã€‚ä½†Nettyç´ ä»¥é«˜æ€§èƒ½é«˜å¹¶å‘è‘—ç§°ï¼Œä¸ºä»€ä¹ˆTomcatä¸æŠŠè¿žæŽ¥å™¨æ›¿æ¢æˆNettyå‘¢ï¼Ÿç¬¬ä¸€ä¸ªåŽŸå› æ˜¯Tomcatçš„è¿žæŽ¥å™¨æ€§èƒ½å·²ç»è¶³å¤Ÿå¥½äº†ï¼ŒåŒæ ·æ˜¯Java NIOç¼–ç¨‹ï¼Œå¥—è·¯éƒ½å·®ä¸å¤šã€‚ç¬¬äºŒä¸ªåŽŸå› æ˜¯Tomcatåšä¸ºWebå®¹å™¨ï¼Œéœ€è¦è€ƒè™‘åˆ°Servletè§„èŒƒï¼ŒServletè§„èŒƒè§„å®šäº†å¯¹HTTP Bodyçš„è¯»å†™æ˜¯é˜»å¡žçš„ï¼Œå› æ­¤å³ä½¿ç”¨åˆ°äº†Nettyï¼Œä¹Ÿä¸èƒ½å……åˆ†å‘æŒ¥å®ƒçš„ä¼˜åŠ¿ã€‚æ‰€ä»¥Nettyä¸€èˆ¬ç”¨åœ¨éžHTTPåè®®å’ŒServletçš„åœºæ™¯ä¸‹ã€‚
  
- è€å¸ˆï¼Œæºç å¦‚ä½•é˜…è¯»æ•ˆæžœå¥½å•Šï¼ŸçŽ°åœ¨æºç ä¸€å¤§å †ï¼Œä¸çŸ¥ä»Žä½•ä¸‹æ‰‹ã€‚è°¢è°¢

  å±•å¼€*î˜ƒ*

  ä½œè€…å›žå¤: æŠ“ä¸»çº¿ï¼ŒæŠ“ä¸»å¹²ï¼Œæ¯ä¸ªç³»ç»Ÿä¸­éƒ½æœ‰ä¸€ä¸ªå…³é”®çš„æ ¸å¿ƒç±»ï¼Œç´§ç´§æŠ“ä½è¿™äº›ç±»ï¼Œå…ˆä¸è¦åˆ†æ•£ï¼Œåœ¨é€æ­¥çœ‹æ—æžï¼Œç­‰ä½ å­¦ä¹ å¼„æ˜Žç™½ä¸€ä¸ªç»å…¸çš„ç³»ç»Ÿï¼Œå¾ˆå¤šå¥—è·¯ä½ å°±æ˜Žç™½äº†ã€‚

- ä¸€ã€è¯¾åŽé¢˜ï¼šåˆšå¥½æœ€è¿‘ç‹¬ç«‹è®¾è®¡å¼€å‘è¿‡ä¸€ä¸ªä»¥ç¬¬ä¸‰æ–¹ä¸ºæ ‡å‡†çš„é¡¹ç›®ï¼Œå…¶å®žæ— è®ºè°ä¸ºæ ‡å‡†ï¼Œè¦åšçš„äº‹æƒ…éžè‡ªå·±ç³»ç»Ÿä¸Žåˆ«äººç³»ç»Ÿé«˜åº¦è€¦åˆçš„å®šåˆ¶é¡¹ç›®ï¼Œéƒ½å¯ä»¥è¿›è¡ŒæŠ½ç¦»ã€‚
  1ã€è‡ªå·±å…ˆæŠŠæµç¨‹åˆ†æžï¼Œç¡®å®šé‚£äº›æ˜¯å›ºå®šçš„ï¼Œå“ªäº›æ˜¯å˜çš„ï¼›
  2ã€å®šä¹‰è‡ªå·±æ ‡å‡†ç‰ˆçš„æ•°æ®ç»“æž„ï¼Œå¯¹äºŽä»»ä½•æ¥è‡ªç¬¬ä¸‰æ–¹çš„æ•°æ®éƒ½å¯ä»¥ç”¨é€‚é…å™¨æ¨¡å¼è½¬åŒ–ä¸ºè‡ªå·±æ ‡å‡†ç‰ˆçš„ã€‚
  äºŒã€å…³äºŽè€å¸ˆçš„è¯¾ä»¶ç‰ˆæœ¬ä»£ç æ˜¯å¦æ˜¯åœ¨githubä¸ŠèŽ·å–çš„å¯¹åº”æºç ï¼Œæˆ‘èŽ·å–çš„tomcatæºç ä¸­AbstractEndpointå¹¶æœªåŒ…å«ä»»ä½•å†…éƒ¨ç±»ã€‚
  
  å±•å¼€*î˜ƒ*
  
  ä½œè€…å›žå¤: æºç åœ¨è¿™é‡Œï¼šhttps://github.com/apache/tomcat
  
  ä½ è¯´çš„å¯¹ï¼ŒAbstractEndpointä¸­æ²¡æœ‰å†…éƒ¨ç±»ï¼Œæ˜¯å®ƒçš„å­ç±»Nio2EndpointåŒ…å«äº†ä¸¤ä¸ªå†…éƒ¨ç±»ï¼šNio2Acceptor å’Œ SocketProcessorã€‚
  
- è€å¸ˆï¼Œè¯·æ±‚æ¥çš„æ—¶å€™ï¼Œæºç å…¥å£åœ¨å“ªé‡Œï¼Ÿ

  å±•å¼€*î˜ƒ*

  ä½œè€…å›žå¤: åœ¨Acceptorçš„runæ–¹æ³•é‡Œï¼š

  socket = endpoint.serverSocketAccept();

  è¿™å¥è¯ç”¨æ¥æŽ¥æ”¶ä¸€ä¸ªæ–°çš„è¿žæŽ¥

  
