# 14 \| 高性能数据库集群：读写分离

“从0开始学架构”专栏已经更新了13期，从各个方面阐述了架构设计相关的理论和流程，包括架构设计起源、架构设计的目的、常见架构复杂度分析、架构设计原则、架构设计流程等，掌握这些知识是做好架构设计的基础。

在具体的实践过程中，为了更快、更好地设计出优秀的架构，除了掌握这些基础知识外，还需要掌握业界已经成熟的各种架构模式。大部分情况下，我们做架构设计主要都是基于已有的成熟模式，结合业务和团队的具体情况，进行一定的优化或者调整；即使少部分情况我们需要进行较大的创新，前提也是需要对已有的各种架构模式和技术非常熟悉。

接下来，我将逐一介绍最常见的“高性能架构模式”“高可用架构模式”“可扩展架构模式”，这些模式可能你之前大概了解过，但其实每个方案里面都有很多细节，只有深入的理解这些细节才能理解常见的架构模式，进而设计出优秀的架构。

虽然近十年来各种存储技术飞速发展，但关系数据库由于其ACID的特性和功能强大的SQL查询，目前还是各种业务系统中关键和核心的存储系统，很多场景下高性能的设计最核心的部分就是关系数据库的设计。

不管是为了满足业务发展的需要，还是为了提升自己的竞争力，关系数据库厂商（Oracle、DB2、MySQL等）在优化和提升单个数据库服务器的性能方面也做了非常多的技术优化和改进。但业务发展速度和数据增长速度，远远超出数据库厂商的优化速度，尤其是互联网业务兴起之后，海量用户加上海量数据的特点，单个数据库服务器已经难以满足业务需要，必须考虑数据库集群的方式来提升性能。

从今天开始，我会分几期来介绍高性能数据库集群。高性能数据库集群的第一种方式是“读写分离”，其本质是将访问压力分散到集群中的多个节点，但是没有分散存储压力；第二种方式是“分库分表”，既可以分散访问压力，又可以分散存储压力。先来看看“<span class="orange">读写分离</span>

”，下一期我再介绍“分库分表”。

## 读写分离原理

**读写分离的基本原理是将数据库读写操作分散到不同的节点上**，下面是其基本架构图。

<img src="14%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%EF%BC%9A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.resource/362d22168bf344687ec0c206aa115807.jpg" style="zoom:25%;" />

读写分离的基本实现是：

- 数据库服务器搭建主从集群，一主一从、一主多从都可以。

- 数据库主机负责读写操作，从机只负责读操作。

- 数据库主机通过复制将数据同步到从机，每台数据库服务器都存储了所有的业务数据。

- 业务服务器将写操作发给数据库主机，将读操作发给数据库从机。

需要注意的是，这里用的是“主从集群”，而不是“主备集群”。“从机”的“从”可以理解为“仆从”，仆从是要帮主人干活的，“从机”是需要提供读数据的功能的；而“备机”一般被认为仅仅提供备份功能，不提供访问功能。所以使用“主从”还是“主备”，是要看场景的，这两个词并不是完全等同的。

读写分离的实现逻辑并不复杂，但有两个细节点将引入设计复杂度：**主从复制延迟**和**分配机制**。

## 复制延迟

以MySQL为例，主从复制延迟可能达到1秒，如果有大量数据同步，延迟1分钟也是有可能的。主从复制延迟会带来一个问题：如果业务服务器将数据写入到数据库主服务器后立刻（1秒内）进行读取，此时读操作访问的是从机，主机还没有将数据复制过来，到从机读取数据是读不到最新数据的，业务上就可能出现问题。例如，用户刚注册完后立刻登录，业务服务器会提示他“你还没有注册”，而用户明明刚才已经注册成功了。

解决主从复制延迟有几种常见的方法：

1\.写操作后的读操作指定发给数据库主服务器

例如，注册账号完成后，登录时读取账号的读操作也发给数据库主服务器。这种方式和业务强绑定，对业务的侵入和影响较大，如果哪个新来的程序员不知道这样写代码，就会导致一个bug。

2\.读从机失败后再读一次主机

这就是通常所说的“二次读取”，二次读取和业务无绑定，只需要对底层数据库访问的API进行封装即可，实现代价较小，不足之处在于如果有很多二次读取，将大大增加主机的读操作压力。例如，黑客暴力破解账号，会导致大量的二次读取操作，主机可能顶不住读操作的压力从而崩溃。

3\.关键业务读写操作全部指向主机，非关键业务采用读写分离

例如，对于一个用户管理系统来说，注册+登录的业务读写操作全部访问主机，用户的介绍、爱好、等级等业务，可以采用读写分离，因为即使用户改了自己的自我介绍，在查询时却看到了自我介绍还是旧的，业务影响与不能登录相比就小很多，还可以忍受。

## 分配机制

将读写操作区分开来，然后访问不同的数据库服务器，一般有两种方式：**程序代码封装**和**中间件封装**。

1\.程序代码封装

程序代码封装指在代码中抽象一个数据访问层（所以有的文章也称这种方式为“中间层封装”），实现读写操作分离和数据库服务器连接的管理。例如，基于Hibernate进行简单封装，就可以实现读写分离，基本架构是：

<img src="14%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%EF%BC%9A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.resource/f8d538f9201e3ebee37dfdcd1922e9df.jpg" style="zoom:25%;" />

程序代码封装的方式具备几个特点：

- 实现简单，而且可以根据业务做较多定制化的功能。

- 每个编程语言都需要自己实现一次，无法通用，如果一个业务包含多个编程语言写的多个子系统，则重复开发的工作量比较大。

- 故障情况下，如果主从发生切换，则可能需要所有系统都修改配置并重启。

目前开源的实现方案中，淘宝的TDDL（Taobao Distributed Data Layer，外号:头都大了）是比较有名的。它是一个通用数据访问层，所有功能封装在jar包中提供给业务代码调用。其基本原理是一个基于集中式配置的 jdbc datasource实现，具有主备、读写分离、动态数据库配置等功能，基本架构是：

<img src="14%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%EF%BC%9A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.resource/3b87f6ce297c4af219fa316d29eb5507.jpg" style="zoom:25%;" />

2\.中间件封装

中间件封装指的是独立一套系统出来，实现读写操作分离和数据库服务器连接的管理。中间件对业务服务器提供SQL兼容的协议，业务服务器无须自己进行读写分离。对于业务服务器来说，访问中间件和访问数据库没有区别，事实上在业务服务器看来，中间件就是一个数据库服务器。其基本架构是：

<img src="14%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%EF%BC%9A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.resource/2a2dba7f07581fd055d9cd5a3aa8388e.jpg" style="zoom:25%;" />

数据库中间件的方式具备的特点是：

- 能够支持多种编程语言，因为数据库中间件对业务服务器提供的是标准SQL接口。

- 数据库中间件要支持完整的SQL语法和数据库服务器的协议（例如，MySQL客户端和服务器的连接协议），实现比较复杂，细节特别多，很容易出现bug，需要较长的时间才能稳定。

- 数据库中间件自己不执行真正的读写操作，但所有的数据库操作请求都要经过中间件，中间件的性能要求也很高。

- 数据库主从切换对业务服务器无感知，数据库中间件可以探测数据库服务器的主从状态。例如，向某个测试表写入一条数据，成功的就是主机，失败的就是从机。

由于数据库中间件的复杂度要比程序代码封装高出一个数量级，一般情况下建议采用程序语言封装的方式，或者使用成熟的开源数据库中间件。如果是大公司，可以投入人力去实现数据库中间件，因为这个系统一旦做好，接入的业务系统越多，节省的程序开发投入就越多，价值也越大。

目前的开源数据库中间件方案中，MySQL官方先是提供了MySQL Proxy，但MySQL Proxy一直没有正式GA，现在MySQL官方推荐MySQL Router。MySQL Router的主要功能有读写分离、故障自动切换、负载均衡、连接池等，其基本架构如下：

<img src="14%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%EF%BC%9A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.resource/c9c7a3f3602a05d428484c571c1d4faf.jpg" style="zoom:25%;" />

奇虎360公司也开源了自己的数据库中间件Atlas，Atlas是基于MySQL Proxy实现的，基本架构如下：

![](<14%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%EF%BC%9A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.resource/75058a4145bb78880faa4e9c74d9d031.png> "图片来源网络")

以下是官方介绍，更多内容你可以参考[这里](<https://github.com/Qihoo360/Atlas/wiki/Atlas%E7%9A%84%E6%9E%B6%E6%9E%84>)。

> Atlas是一个位于应用程序与MySQL之间中间件。在后端DB看来，Atlas相当于连接它的客户端，在前端应用看来，Atlas相当于一个DB。Atlas作为服务端与应用程序通信，它实现了MySQL的客户端和服务端协议，同时作为客户端与MySQL通信。它对应用程序屏蔽了DB的细节，同时为了降低MySQL负担，它还维护了连接池。

## 小结

今天我为你讲了读写分离方式的原理，以及两个设计复杂度：复制延迟和分配机制，希望对你有所帮助。

这就是今天的全部内容，留一道思考题给你吧，数据库读写分离一般应用于什么场景？能支撑多大的业务规模？

欢迎你把答案写到留言区，和我一起讨论。相信经过深度思考的回答，也会让你对知识的理解更加深刻。（编辑乱入：精彩的留言有机会获得丰厚福利哦！）

## 精选留言(123)

- 老师，您好 我个人的想法是可以加入缓存，例如注册后登录这种业务，可以在注册后加入数据库，并加入缓存，登录的时候先查缓存再查库表。 例如存入redis中并设置十分钟的过期时间。登录的时候先查redis，再查库表，如果redis中没有，说明就是过期的数据，这时候查从机就肯定存在了，希望能得到老师的点评，谢谢。

  作者回复: 赞同，并不是说一有性能问题就上读写分离，而是应该先优化，例如优化慢查询，调整不合理的业务逻辑，引入缓存等，只有确定系统没有优化空间后，才考虑读写分离或者集群

  

- 我认为读写分离适用单机并发无法支撑并且读的请求更多的情形。在单机数据库情况下，表上加索引一般对查询有优化作用却影响写入速度，读写分离后可以单独对读库进行优化，写库上减少索引，对读写的能力都有提升，且读的提升更多一些。 不适用的情况:1如果并发写入特别高，单机写入无法支撑，就不适合这种模式。 2 通过缓存技术或者程序优化能够满足要求

  作者回复: 赞同👍

  

- 目前还在用单机一直在扛着，目前数据量在百万万，在不停的优化，建立冗余等方式，还在保持着一个较快的查询速度，因为业务查询的关系，多表之间的关联，聚合，很难避免，一直想引用缓存，但是查询的条件太多，很动态，就不知道如何设计缓存，类似于京东筛选物品，多品类，多维度筛选，不知道大牛有何高见

  作者回复: 按照2-8原则，选出占访问量80%的前20%的请求条件缓存，因为大部分人的查询不会每次都非常多条件，以手机为例，查询苹果加华为的可能占很大一部分

- 我们做网银系统，用redis存了一些不太重要的数据，比如数据字典信息，作为缓存。但是不太敢把用户权限，交易数据等重要信息存在缓存里，因为redis并不保证事务，我们担心一旦缓存服务器宕机或者失败会影响银行业务。所以缓存的作用也不是很大，还是把大部分读数据的压力放到了数据库上，您说我们这种担心有必要吗？如果单库后续扛不住压力，是否读写分离比加缓存更好一些？

  作者回复: 交易型业务缓存应用不多，缓存一般总在查询类业务上，你们的担心有一定必要

  

- 是否还应该加上一个，当单机写顶不住压力后，就可以做数据库拆分了，例如业务纵向拆分，连同数据库一起，就变成分布式服务，微服务了:)

  作者回复: 说法没错，但具体实施的时候要注意，不要一有压力就上读者分离，因为很多时候其实是sql语句或者业务逻辑有问题，因此先优化，只有优化后也无法满足要求的时候才考虑读者分离或者集群

  2018-05-30

  **

  **18

- ![img](14%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%EF%BC%9A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.resource/resize,m_fill,h_34,w_34-16617954782491777.jpeg)

  小喵喵

  公司现在的系统时采用读写分离的，是中间层程序封装的api，第一套分两类:1读主库,2.读从库.然后客户端程序通过传递SQL或存储过程和参数的值调用。 第二套只提供一个api,通过传递一个布尔值来判断是走主库还是从库，这套是供自动调度工具来调用。这两套api都有一个共同点，就程序猿必须手动指定是走主库还是从库。现在出现的问题是大量的SQL应该走从库，结果很多菜鸟都走了主库，导致现在的主库压力很大。听了你的课程后觉得走主库还是从库不应该由程序猿自己指定，而是由中间层来判断。具体如何做呢，请老师指点一下。客户端有时传递一些复杂的SQL,比如，先做更新然后再查。

  作者回复: 默认读走从库，写走主库，特殊情况才由程序员制定，可以代码指定，可以配置指定，这样就不会出现大量sql都走主库了

  

- 前段时间，老大在大表上执行了delete操作，然后主从就不同步了。然后线上各种bug，最后我花了5分钟排查到了问题（运维团队比较小，我打杂的）。解决方式，线上业务部分限流，关键业务读写紧急切换到主库，修复主从不同步问题，切换回读写分离配置。最后发现是老大做了骚操作，一问才知道，是个日志表，清理一下。😂我。。。

  作者回复: 我们要求线上delete每次不能超过1000条，超过就定时循环操作

  2019-12-18

  **3

  **11

- ![img](14%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%EF%BC%9A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.resource/resize,m_fill,h_34,w_34-16617954782491781.jpeg)

  rubin

  读写分离的前提是并发量大，单机已经不能处理该数量的并发请求了，想要解决问题就得做作拆分，于是有了读写分离，主库负责写，从库负责读，降低了同台机器并发请求，当读越来越多时，可扩充从库，写越来越多时，只好拆分业务或分库分表，如：注册功能，单独出来做一个注册的微服务，但还是会到达一个瓶颈，没做过，不知道能支持多少的并发？

  作者回复: 要具体测试，不同业务复杂度不同

  2018-05-30

  **

  **10

- ![img](https://static001.geekbang.org/account/avatar/00/10/b6/79/22e582a5.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  刘岚乔月

  请问 对于主从出现的数据同步延时问题 在实际生产落地 真的只有把重要的查询指向主吗 还有其他真正的落地方案吗

  作者回复: 当然是真的呀，难道我还会骗你不成？😂 如果不想用这种方式，用缓存是可以规避这个问题的，但其实这时候的方案就不是读写分离了

  2018-05-29

  **2

  **10

- ![img](https://static001.geekbang.org/account/avatar/00/11/16/2d/2753369a.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  allen.huang

  老师您好， 像我们数据库服务器只有一台，并且现在业务量也越来越大，尤其是中午，晚上加起来大概是5，6个小时是业务高峰，订餐的量还挺大。前台读写操作都很频繁， 后来就是要看数据统计啊之类的，客户也是经常在使用。在业务高峰期，他们还要进去看实时交易情况。这样子经常会出现磁盘IO报警。 我也在尝试规划做读写分离，但是像业务前台做了以后，就会出现数据延时的情况，这样子业务处理就有问题。 我现在初步规划是前台都用主，后台读写分离，这样子是否合理，有经验的同学也给予我指导谢谢😜

  作者回复: 面向用户的业务读写都用主，面向客户和运营的业务可以读写分离，大部分场景没必要看实时交易情况的

  2018-08-14

  **

  **9

- ![img](https://static001.geekbang.org/account/avatar/00/11/bd/a4/cf4744ce.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  老邪

  你好，华仔，请问文章内的架构图用的什么软件，谢谢！

  作者回复: Libre office的Draw

  2018-07-19

  **2

  **9

- ![img](https://static001.geekbang.org/account/avatar/00/10/d5/31/b09432cc.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  @漆~心endless

  并非所有系统都需要进行读写分离，正如之前讲得架构三原则，其中根据“合适原则”的规定，先确认系统的业务量是否出现了数据库的性能问题。如果是，首先通过优化MySQL语句等，如果还是达不到要求的性能指标，则需进行读写分离。毕竟读写分离会引入一系列不可预知的问题，如数据不同步。

  2018-05-31

  **

  **8

- ![img](https://static001.geekbang.org/account/avatar/00/10/d1/1c/f6e95d1d.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  刘志刚

  读写分离比较适用于类似消息记录，对于写和读业务的强实时性要求不到苛刻的地步的情况，而且做的时候这种跟业务量还是有比较大关系的，比如，业务量的订单量每年都不超过1千万，整天去做分库分表倒不如好好优化下sql写法，如果订单量每天都超过好几百万，那这个必要性就很强了！

  作者回复: 赞，先优化

  2018-05-29

  **2

  **6

- ![img](http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132)

  null

  re: 写操作后的读操作指定发给数据库主服务器 后端无法知道本次请求是否为写操作之后的读，因此会依赖前端传递一个参数，如 target_db=master / slave，来决定目标数据库。 所以这种方式，需要在前后端代码实现相关逻辑，代码耦合较大。 这种解决方案是否只提供了一种思路，实际开发时很少使用这方案，不知道理解是否正确，谢谢！

  作者回复: 是的，对代码逻辑有要求，

  2018-05-29

  **

  **6

- ![img](https://static001.geekbang.org/account/avatar/00/0f/e5/65/cf1243f4.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  悠悠

  华仔，现在表数据500万-大小8g，大部分查询这表sql性能差，怎么测试是不是数量导致的性能下降，还是其他原因导致的。怎么测是分表还是分区性能提高，如数据量增加是不是分表，如改架构是不是把一部分数据放到mongo或是pg数据库里。

  作者回复: 如果是MySQL的话，索引和innodb buffer pool是关键，索引设计不对的话会慢，innodb buffer pool装不下所有数据会慢，但优化方案的话没有通用的，需要根据你们的业务来分析

  2019-08-10

  **

  **5

- ![img](https://static001.geekbang.org/account/avatar/00/12/6d/4d/ada0aa8a.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  亚东

  老师，如何优化慢查询？

  作者回复: 《高性能MySQL》

  2019-05-18

  **

  **5

- ![img](http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJUHvicvia3fpBbahB1r7QOnrnwZaZOVXYnibKGyYbzQJibbrts4niardQ7JUyxJLeSsJmsCZBf6N7aEtg/132)

  马广乐

  加个缓存能解决写完立即读的场景吗，老师。

  作者回复: 可以的，但那是另外一个方案了，很多场景就算用了缓存也要读写分离

  2018-05-29

  **

  **5

- ![img](14%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%EF%BC%9A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.resource/resize,m_fill,h_34,w_34-16617954782501791.jpeg)

  王磊

  华仔，这样理解对吗? 读写分离的原因是同一个表的读写操作往往是阻塞的(事务隔离级别中的可重复读和串行)，因此如果数据库有较多的更新和插入操作，并且影响了读操作，这时应该考虑读写分离。 但是数据库复制时，是否一样会对从机的读操作阻塞?

  作者回复: 现在的数据库，写阻塞读是比较少了，你了解一下MVCC之类的机制，主要还是单台服务器撑不住性能要求

  2018-05-29

  **

  **5

- ![img](https://static001.geekbang.org/account/avatar/00/16/25/64/d66ea739.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  黑洞

  适合单点数据库无法承载大并发量的读写请求，并且是读多写少的应用，使用读写分离是合适的。当然真正实施前，必须先优化读写性能加cache等，如果实在优化也无法满足业务增长的需要，再上读写分离。

  作者回复: 正解👍

  2020-12-18

  **

  **4

- ![img](https://static001.geekbang.org/account/avatar/00/13/07/0b/a33982a5.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Cest la vie

  来晚了，最近才定的，回复不知道能不能看到。 现在我们网站架构用的也是makara实现MySQL读写分离，引入的目的是为了解决异地访问数据库慢的问题，即主服务在上海，成都的用户来访问的时候，数据库读取非常慢，于是在成都搭了多个slave mysql用来处理成都的读操作，写操作还是到上海。 带来的问题： 1. 经常也会出现成都用户提交信息后，刷新网页会报404的问题，即主从写同步延迟的问题，目前未采取任何措施来解决这个问题 2. 还有个问题是随着slave的增多，主数据库的连接数老是超，报too many connections，主服务设置了最大连接数为2000，现在也在梳理每台机器的连接数，没有好的解决方案

  作者回复: 跨这么远的距离做主从复制，延迟是必然的，提交信息后刷新属于session关联操作，应该都访问上海主库。 too many connection出现在数据库上，很可能是短链接导致的，备机不可能占这么多连接数吧

  2018-11-20

  **

  **4

- ![img](http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eo3DrWeV7ZwRLXrRZg4V3ic1LQYdZ3u1oicDhqPic47vMguvf5QS69roTiaJrwDr5Re3Sy2UyHDWwmsTA/132)

  大光头

  大部分业务场景都适合，因为基本上都是读多写少，又要应付大规模的访问。

  作者回复: 事实上大部分业务场景可能并不需要读写分离😃

  2018-05-29

  **

  **4

- ![img](https://static001.geekbang.org/account/avatar/00/10/e5/0d/b4258141.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  姜泮昌

  读写分离适用于单服务器无法满足所有请求的场景，从请求类型的角度对服务器进行拆分，但这样在要求硬件资源能够支撑的同时，对代码实现也有更高的要求。

  作者回复: 天下没有免费的午餐😃

  2018-05-29

  **

  **4

- ![img](14%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%EF%BC%9A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.resource/resize,m_fill,h_34,w_34-16617954782501796.jpeg)

  万历十五年

  对于已有系统的升级路线是“SQL优化——缓存——读写分离——分库分表”；对于新系统，还是要一开始就要在设计阶段考虑性能问题

  作者回复: 正解

  2021-07-12

  **

  **4

- ![img](https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  钱

  我认为性能优化的原则如下： 1：只让干的快的干 2：让干的快的多干，干的慢的少干 3：还干不完，就加人手，分活参考1/2 读写分离，属于加人手，并且各司其职，一端负责写另一端负责读，这样压力必然会分散一些，不过天下没有免费的午餐，引入的新问题就是主从延迟，延迟必然存在要么忍，要么弄得复杂一些，写后读主/从读不到再读主/数据再分阶，重要的读主次要的读从/加缓存，当然，能优化就优化，能不分就不分，分后太麻烦啦！

  2019-08-26

  **

  **3

- ![img](https://static001.geekbang.org/account/avatar/00/10/dc/fc/5c3ad841.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  asura

  用Sharding-Sphere也是一个不错的选择，选择读写中间件老师更推荐哪个？

  作者回复: 优选apache项目😄

  2018-11-23

  **3

  **3

- ![img](https://static001.geekbang.org/account/avatar/00/12/c6/51/e39b5828.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  刘鹏

  用缓存来保证主从一致性的时候，主从同步的延迟时间设置为缓存的过期时间，但是主从同步的延迟时间是和数据量有关的，这样如果设置过期时间太长，主从就没有意义了，有点疑惑这种方案的应用场景

  作者回复: 所以要看业务上数据更新频率和不一致的容忍度

  2018-10-11

  **

  **3

- ![img](https://static001.geekbang.org/account/avatar/00/0f/ee/67/c146c144.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  W_T

  从数据库读写的角度分类，一共有四类：写多读多，写少读少，写多读少，写少读多。 写少读少的情况，不需要分离。 写多的情况，单个库写入会造成单点压力，分库写入，那其实就是分库分表了。 所以我认为，读写分离的设计适用于写少读多的情况。 至于业务量，读可以不断水平扩展，主要还是受写的限制。

  2018-06-04

  **

  **3

- ![img](https://static001.geekbang.org/account/avatar/00/10/e8/90/d63f8347.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  yushing

  请问为什么黑客破解账号，会导致大量的二次读取操作呢？大部分帐号在从机中也有吧，怎么还会二次读取呢？

  作者回复: 黑客暴力破解的时候是尝试性的，很多账号或者信息不存在

  2018-05-29

  **

  **3

- ![img](https://static001.geekbang.org/account/avatar/00/16/15/73/e5e4b245.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Andy

  先从读写分离的定义下手。 读写分离，就是将访问的压力分拆到集群上各个节点上，而存储的压力则集中于主机之上，并未降低，反而增大。 鄙人以为，根据读写定义，在现实世界中，应用相对较多，我们社会大部分场景都是读多写少，诸如微博、朋友圈、电商、视频等等。 对于业务规模，依然从读写分离的定义和组成下手，访问是分散的，而存储是集中的。 从写的角度思考，一主多从的情况，再厉害的单台主机，并发操作始终是有上限的，假设当前所有的操作都是写操作，那么，此时的单台主机的最大并发量就是集群的最大业务规模。 从读的角度思考，访问是分散的，假设当前所有的操作都是读操作，那么，此时集群的业务规模理论上应当是单台机器的最大并发量乘以所有机器数，考虑到实际情况会有“折损”，故再乘以0.7，则为实际最大业务规模

  2020-09-09

  **

  **2

- ![img](https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](14%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%EF%BC%9A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.resource/resize,w_14.png)

  escray![img](https://static001.geekbang.org/resource/image/d5/62/d57fddfa5b2c2ce3071e92304da8af62.png)

  读写分离首先还是得考虑业务上是否能够接受延迟，如果对于实时性不敏感，而且业务量不是特别大，那么是不是可以等到主从复制之后，再允许读取新写入的数据即可？ 如果实时性要求比较高，那么采用第 3 种方法（关键业务读写操作全部指向主机）的变体，在一定时间内对于消息的读写操作指向主机，完成主从复制之后，改为读从机。 这个办法的缺点在于需要一个时间戳或者标志位来判断主从复制是否完成，优点是在一定程度上可以降低主机的压力。 再分配机制上，我倾向于按照演化原则，先使用数据访问层实现读写分离，如果业务需要，再升级为中间件封装。但是中间件封装，又有可能带来单点故障或者瓶颈，如果业务蓬勃发展的话，可能还得演化成中间件集群。 看到留言里面有同学说读写分离比较适合读多写少的场景，用来解决高性能读的问题，的确是这样，如果反之，写多读少，那么又该如何优化？我能想到的是先写到缓存，然后再刷盘，但是可靠性上似乎没法保证。 另外一个有价值的点在于，先考虑优化（加缓存），实在不行了再考虑读写分离，读写分离一定会带来复杂度。

  作者回复: 写多读少用基于LSM数据结构的系统来做，你有兴趣可以看看LevelDB，HBase的实现原理

  2020-09-08

  **

  **2

- ![img](https://static001.geekbang.org/account/avatar/00/11/bd/17/dc1eab6c.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Spring

  数据库中间件功能强大的成熟方案还有MyCaT，shardingsphere

  作者回复: 是的，写文章的时候这两个还不是太出名所以没列

  2020-07-03

  **

  **2

- ![img](https://static001.geekbang.org/account/avatar/00/1e/ae/26/a69ee5f3.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  陈先生（Ken）

  老师，关于中间件处理读写分离，我突然想起有些人在教学demo数据访问层全单表CURD，到了业务层再合并处理，不用join表，此方式到底对还是不对？（有点离题，不好意思）

  作者回复: 看场景，不要一刀切，你说的这种方式可能导致内存占用很高（因为要读取大量数据到内存），cpu很高（要循环遍历很多数据）！通常情况下，优先使用数据库的能力，当发现性能瓶颈时再考虑各种优化手段

  2020-06-15

  **

  **2

- ![img](https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLfrbMvhKQYhxP6ziaHaj4KUNRzst8u7BZsWUsazK8oTLXcNH6sDGITl6icy3IiaGFe9Iiae12LuTrF1g/132)

  天下行走

  有个问题请教一下，主机同步到从机，这里也设计写，那应该用批量删除再插入，还是update by 。我的理解主从情况下应该数据量非常大，感觉批量插入还比较靠谱

  作者回复: MySQL自己做了，binlog有不同格式，row, mixed, statement三类

  2019-06-20

  **

  **3

- ![img](https://static001.geekbang.org/account/avatar/00/10/20/9e/3278e1d8.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  胡萝卜

  老师，能不能具体说说，读写分离和缓存这两种方案的区别呢？ 我认为缓存支持的并发量更高，但是也更复杂，读写分离要简单一些 另外读写分离能解决一些数据库锁导致的阻塞问题，但我觉得这不是主要问题，这种问题更应该通过sql优化 

  作者回复: 读写分离也不简单，很多坑，数据库锁导致阻塞问题要看具体情况，有的是SQL没写好，有的是数据库压力太大

  2019-03-28

  **

  **2

- ![img](https://static001.geekbang.org/account/avatar/00/11/fd/96/44641d9e.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  向阳

  看评论区有说主备支持读写分离，然后索引维护可以备库独立维护，这个可以嘛？oracle主备索引不都是一致的嘛？

  2018-10-23

  **

  **2

- ![img](https://static001.geekbang.org/account/avatar/00/10/d5/3f/80bf4841.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  文竹

  读写分离适用的场景：单机数据库不能支持业务的读写规模，所以写和读分离。但写的规模不能高于单机数据库支持的规模；读规模可以横向扩展，但也不是无限的，因为数据库复制工具也需要从数据复制数据到从库，复制工具复制频率根据业务决定。

  2018-08-19

  **

  **2

- ![img](https://static001.geekbang.org/account/avatar/00/11/15/f5/4fb5284b.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Geek_59a17f

  高性能数据库集群的第一种方式是“读写分离”，其本质是将访问压力分散到集群中的多个节点，但是没有分散存储压力；第二种方式是“分库分表”，既可以分散访问压力，又可以分散存储压力。先来看看“读写分离”，下一期我再介绍“分库分表”。

  2018-06-11

  **

  **2

- ![img](http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELtOO0HKrj5SI5JSlmwiaCvaF6GLiaTmf5NX88OZaO3HymTAGTeIoicBUjqzmMF6sF5raPFjuqLFibrrw/132)

  gesanri

  我们系统也用到了读写分离，不过我们读写的分配就是访问的数据源不同，读是一个数据源，写是另一个数据源，不知道和文章中说的分配原则是什么区别，就是文章中说的第一种hibernate实现的吗？

  作者回复: 是的，程序代码实现的

  2018-06-10

  **

  **2

- ![img](https://static001.geekbang.org/account/avatar/00/10/e0/a8/4e739cf6.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Sic Pavis

  请问下，数据库读写分离对比主库+缓存的优势在哪里？ 因为考虑到缓存最大的问题就是数据时效性，但其实这个问题从库也有，而且从库有多久的延迟完全无法把握。更不说缓存的响应时间比从库快很多。 似乎选主从最大的优势就是：简单，不需要怎么开发。业务有一定的读压力时使用。 希望解惑

  作者回复: 如果时效性不是关键，一般都先上缓存，缓存是缓存sql查询的结果，数据库备机只是备份了表数据，实际的sql查询执行时间少不了

  2018-06-07

  **

  **2

- ![img](data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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)

  _fenghao_

  我想问无论主从、主备都需要时间，秒级，如果主挂了，那么这段时间的数据就丢失了。有好的办法吗？要求备写完返回又耗费性能

  作者回复: 没有好的办法😃

  2018-06-05

  **

  **2

- ![img](https://static001.geekbang.org/account/avatar/00/0f/7c/bd/b634fdd1.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](14%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%EF%BC%9A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.resource/resize,w_14.png)

  侯佳林![img](https://static001.geekbang.org/resource/image/89/43/89yyff4c4c2e2b73ce4931bb01a6a943.png)

  主服务器充当业务的写服务器、从服务器的读服务器，如果从服务器较多，单台写服务器的压力会很大

  2018-05-29

  **

  **2

- ![img](https://static001.geekbang.org/account/avatar/00/10/ef/a2/6ea5bb9e.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](14%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%EF%BC%9A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.resource/resize,w_14.png)

  LEON

  您好，请问如果没有数据库中间件，通过客户端程序的方式直接与数据库交互。客户端程序是不是只能指定一个写一个读。不能制定多个读？另外业务到达多大基线的时候需要引入数据库中间件？谢谢老师回复。

  作者回复: 1. 客户端程序用代码写的，可以为所欲为😂 2. 中间件并不是性能上有优势，而是可以跨语言夸系统复用，大公司才有实力做

  2018-05-29

  **

  **2

- ![img](http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIkkg9icSGleYMAnwlb7A9MMJYOdovl8kOCA0asMkDe6grPNF74ib0prQMicicJTNa1WsdpMJ4p1CWkUQ/132)

  shawn

  我们有个项目用hbase做数据库，在遇到full gc时有明显的停顿，影响在线调用，解决方案是采用双主的架构，2个集群的配置还不一样，防止同时gc，一个请求来时同时请求两个hbase，取先返回的那个。

  作者回复: 这个有点重的设计了，再说你两个集群也不能防止一定不同时gc呀，这个方案我觉得优化hbase的配置，降低full gc影响更好，java 8的G1以及后来的ZGC，full gc延迟方面都很优秀的。

  2021-12-09

  **

  **2

- ![img](https://static001.geekbang.org/account/avatar/00/14/3b/aa/e8dfcd7e.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  AAA_叶子

  最近经常听人提到说是 “尽量避免链表查询，多采用单表查询的方式，方便扩展“。不知道老师对这个观点怎么看的？

  作者回复: 没有银弹，单表查询，代码中做join，可扩展性也并不好，实现复杂度还高

  2021-06-05

  **2

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/14/64/9b/0b578b08.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  J.Smile

  ● 高性能mysql数据库集群 ○ 第一招：读写分离        缺点：        ● 没有分担存储压力，因为主从存在同步。        ● 主从同步存在延迟。        主从延迟的解决办法：          ● 写后的读操作发送给主服务器。          ● 二次读取：读从失败之后，读取一次主机。          ● 关键业务全部指向主机，非关键业务读写分离。 ○ 第二招：分库分表 ● 分配方案    ● 数据库访问中间件。如：mycat    ● 程序代码封装。如sharding-jdbc

  2020-12-09

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](14%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%EF%BC%9A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.resource/resize,w_14.png)

  piboye

  都写分离主要是应对写少读多的全量信息。非全量的热点数据可以靠redis这类缓存来解决。业务多个地方要mysql的数据，都访问主库压力大如果可以容忍一定延时，并且需要全量数据的情况，从库更合适。老师，不知道这样理解对？

  2020-08-26

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/10/21/78/732a2e33.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](14%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%EF%BC%9A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.resource/resize,w_14.png)

  M1racle

  读写分离在读写比例差异很大的时候很有用，分别扩容很容易，支撑多少在不分库分表的情况下取决于单表极限吧。

  作者回复: 是的

  2020-07-08

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/12/9b/6e/edd2da0c.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  蓝魔丶

  老师，关键业务走主机，非关键业务走从机，这还是需要对业务代码有侵入吧？

  作者回复: 是的，要判断是关键还是非关键业务

  2020-07-02

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/14/64/9b/0b578b08.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  J.Smile

  mysql主从切换后，中间件应当感知到谁是新主，谁是从，从而提供正常功能，由此可见mysql主从结构下不能在代码中配置主从数据库地址。

  作者回复: 主备的配置是中间件管理的

  2020-02-16

  **2

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/0f/42/7c/8ef14715.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  🄽🄸🅇🅄🅂

  有见到过一些网站，注册后就默认已登录状态的，感觉这样处理也很合理，就是数据提交后，如果写入成功，则直接把提交的数据返回

  2019-11-26

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/16/15/01/927d96e5.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  随风而逝

  老师，虽然专栏结束了，我们现在单表数据到了千万级别，如果不用读写分离有什么其他好的方案吗？希望得到回复，谢谢！

  作者回复: 你为啥不用读写分离呢？ 当然，前提看你遇到了什么问题，千万级的表在不同的业务场景下问题不一样

  2019-07-17

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/10/4b/a0/3fa531e5.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](14%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%EF%BC%9A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.resource/resize,w_14.png)

  Vicente

  程序代码封装方案没有提到 Sharding-JDBC，中间件封装没有提到 MyCat，可惜了，这两种是比较主流的方案。

  作者回复: 师傅领进门，我也不是什么都懂的，关键是教你方法😂

  2019-07-07

  **2

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/10/c3/c2/5ff554d9.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  @

  主从发生切换，则可能需要所有系统都修改配置并重启；这里是否可以使用域名的方式进行配置，万一发生主从切换，可以改下内网dns即可

  作者回复: 可以的，但是要考虑DNS缓存带来的问题

  2019-07-03

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/10/d7/1c/f539a8aa.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  秦岭

  shardingsphere怎么样?貌似要进apache了

  作者回复: 很不错

  2019-04-09

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/10/e4/a0/dae52542.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  RealMax

  “2. 读从机失败后再读一次主机. “  疑问：怎么去界定“读从机失败”这个点尼？

  作者回复: 读到空数据就算失败

  2019-01-09

  **

  **1

- ![img](http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLLUic3XzxET3L3QXxcTbeg96GMx1HkiaiaZdudchmOmtPnuEPHK5vYEeMkvJR098XljMbXDialYib3z6w/132)

  gkb111

  先优化程序，不能抗住，再优化结构的思想。读写分离，复制延迟，分配机制。

  2019-01-04

  **

  **1

- ![img](14%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%EF%BC%9A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.resource/resize,m_fill,h_34,w_34-16617954782491777.jpeg)

  小喵喵

  读写分离，读库建立索引，主库不建立索引吗？

  作者回复: 索引都要建

  2018-09-02

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/10/d5/3f/80bf4841.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  文竹

  读写分离适用于写少读多的场景

  2018-08-08

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/0f/62/64/40e9805d.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  梦醒时分![img](https://static001.geekbang.org/resource/image/89/43/89yyff4c4c2e2b73ce4931bb01a6a943.png)

  Mycat中间件 怎么样，功能挺全的

  作者回复: 没用过呢，开源中它算比较有名和成熟的，可以试试

  2018-08-02

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/10/ce/72/638a2804.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  林敏健

  关键业务读写主库，或者从库读取不到就再读一次主库，但是这样需要hardcode。 如果使用mysql proxy或者mysql router或者mycat屏蔽了后面的主从库，那程序都不知道谁是主库了，上面的方案貌似都没用了。

  作者回复: proxy可以实现从库读取不到读主库的逻辑，程序可以不关注

  2018-08-01

  **

  **2

- ![img](https://static001.geekbang.org/account/avatar/00/11/22/b6/4722ca3d.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  reed

  请教一下，数据库搭建主从的时候，是应该从库配置好，还是主库配置好？我们现在从库都是8核16G，而主库是4核8G，说是为了数据同步更快

  作者回复: 同步速度主要受网络延迟影响，和硬件关系不大，而且线上配置最好一样，否则出问题不好排查

  2018-06-30

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/11/00/88/fac83a28.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  放宕的压抑

  现在的数据库，写阻塞读是比较少了，你了解一下MVCC之类的机制，主要还是单台服务器撑不住性能要求 老师您好，我有两个问题。 1.照您的说法，那么划分是否应当是“读写-读写”比“读-写”更加合适呢？ 2.个人感觉读写分离并不能减轻写对读的阻塞(虽然老师您说，现在读写阻塞很少了，但是在读写阻塞还比较多的年代而言呢？)，因为从库还是要不停地写，但因为是复制，所以认为一定是可以最终一致的，可以“为所欲为”，避开读的高峰期实现写？但是是否也有这样的场景存在7×24小时读请求都非常高，这种情况怎么办？继续增加机器？ 不知道我理解得对不对，望老师指正。 (吐槽一下，第一次提交留言，因为我朋友圈里没几个人是做技术的，所以没想着分享，然后我就取消了。然后我就发了第二遍了😂)

  作者回复: 通常情况下从库的复制写比主库的业务写要简单一些，性能要高

  2018-06-16

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/10/cf/bb/22af0e52.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  孙振超

  虽然作者已经收到了众多的赞许，但好话不嫌多，在这里还是要向作者表示感谢，在每一篇的文章中都有收获。 对于本篇内容中何时使用读写分离，主要还是看系统所需要承担的容量，对于安装在配置好的物理机上mysql数据库单机qps可以到达数十万，因而对于qps峰值万级以下的是不用考虑读写分离的，对于十万级别的要求高可用的业务可以考虑用读写分离，只是在实际工作中通常会选择加一层缓存，毕竟缓存服务器的成本要比db服务器成本会底不少。

  作者回复: 单机mysql 10万QPS可能有误导，我们只是在测试mysql存储和查询k-v数据的时候达到这个量级，正常的业务表结构和查询语句远比这个复杂，远远达不到10万，一般就几千。

  2018-06-15

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/10/9e/56/af7a9435.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  米斯特.杜

  之前在一家小快递公司，日单量50万左右。最早是Oracle Rac，用了几年后扛不住了，上了读写分离。上线后效果还蛮好的，支撑一百万单量问题不大。用的是直接在代码中指向不同数据源的方式，偶尔会出现数据源指错的情况。也出现过一个事务指向了两个库。当然最坑的还是同步延迟，最长有过延迟十几个小时的情况。复杂的加购解决了原有问题，又带来了新问题。

  作者回复: 十几个小时还是太夸张了，应该做好监控及时处理

  2018-06-05

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/11/6e/c1/e2cc1261.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  不吃番茄的西红柿

  对于读写分离其实还少了一些吧，如果用户量特别大了，可能单存的读写分离已经不足以支持了……也可能比如用hash取余设定它能访问的数据库，把数据表拆开吧

  作者回复: 下一篇就讲了

  2018-06-03

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/11/22/eb/b580b80f.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  YMF_WX1981

  读写分离如果是为了性能，大可通过硬件扩容解决呀。我是想，既然读写分离了，是否意味数据和对数据操作也分离了，更容易记录和统计，也更安全？适合敏感的金融类业务。

  作者回复: 读写分离没有分离数据，只是分离了读写操作，和金融业务关系不大

  2018-05-30

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/10/e9/63/48fc3f4c.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  hello2018

  做了集群，是否可以不需要主备主从读写分离?

  作者回复: 集群更强大更复杂

  2018-05-30

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/11/17/be/73be948a.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  沧海一粟

  读写分离一般适用于读多写少的业务场景，支持规模应该在千万级别。问一下老师，可否使用缓存来替代数据库读写分离，做读写分离延迟是比较大的问题

  作者回复: 可以的，如果缓存能顶住，其实一般不用做读写分离，例如论坛的帖子浏览场景

  2018-05-29

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/10/94/80/70e483f6.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  任锋

  读写分离 主要解决了 读的压力，所以能满足多大的规模 瓶颈在于主库的瓶颈吧，比如连接数超了，系统也达不到高可用？不知道这样理解对不对……

  作者回复: 不一定是读的压力，我们假设机器的能力是100分，写占了70分，读占了30分，虽然写是性能主要消耗方，但读写分离一样可以减轻数据库压力

  2018-05-29

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/10/c6/e5/7e86498f.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  cqc

  适用场景的话大家都提到了：应该是读多写少的情况。另外对于数据复制/同步的三种方案，我归纳了一下，第1和3是从业务角度去解决，第2是从技术角度去解决，这让我想起一句话：有些技术不好解决的问题也许从业务方面处理会更有效一些，不知道理解得对不对？不过从这三个方案来看，方案三确实是目前最优的。

  作者回复: 非常正确，有时候业务上调整1分，技术复杂度能减少10分，但方案3不能说是最优的，对业务有侵入

  2018-05-29

  **

  **1

- ![img](data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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)

  Tom

  读写分离一方面分离了读和写，另一方面读可通过多个从机再进一步分担读。 1.一主 一开始，读和写都在主机这条船上，随着读写越来越多，读和写相互影响，主机压力越来越大船快沉了。 2.一主一从 于是，读和写商量说分家吧，否则要抱团死了，写是数据源头留在主机，你读就自己找个从机新船吧； 便分成了一主一从，由主向从单向同步数据，有主推和从拉两种同步方式；读和写各自轻松了。 3.一主多从 随着业务开展，读写再次增长，特别是一般系统都是读的增长一般比写快很多，读一个从机也快沉船了，就多加了几个从主，变成了一主多从，数据由主机同步到所有从机，可以很方便地水平扩展。 4.多组 这块已经不算是读写分离了，要分离写了。 当写增长到一定程度，单个主机已经hold不住写了，要分库了。 按业务垂直拆分或水平拆分，拆分后的多库每库作为新的一组，每组是一个主从集群。 还有一种可能的过程是一主机直接到分库成多主机，某个主机读太多时进行读写分离。 能支撑多大规模就不了解了。 查了下mysql官网benchmarks( https://www.mysql.com/why-mysql/benchmarks/ )，单机32users并发只读近40w+ qps，读写10w+ qps。 如果按这个数据，以32users算: 一主一从能支撑写10w+qps，读40w+; 一主三从能支撑写10w+qps，读120w+; 没压测过db，是不是太高了？ 请指正，谢谢！

  作者回复: 这个数据有误导性，要看具体的SQL语句和表结构，实际应用中一般不可能这么高

  2018-05-29

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/10/d4/28/3b6546e8.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Snway

  我们都是读写分离，单表数据量大就分库分表，有专门的数据库中间件，实现比较方便。当然，对于写后立即读的操作都是指定读主库的！在cqrs架构中还专门区分了读写模型。

  作者回复: 有中间件真的可以为所欲为😂

  2018-05-29

  **

  **1

- ![img](https://static001.geekbang.org/account/avatar/00/23/c4/91/a017bf72.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](14%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%EF%BC%9A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.resource/resize,w_14.png)

  coconut

  "读从机失败后读一次主机"，这种解决方式应该不适合"更新操作带来的不一致性"。

  作者回复: 是的，一般用在insert数据的场景

  2022-06-16

  **

  **

- ![img](http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKSX1p9ygO5qQSrXZXibBkfcxJJl0202Q8m8GgB1oLVg47S1GvXtFgp8YvV17Jxm8OCib6wYUqQgntg/132)

  就想做调包侠

  您好，我觉得这里不应该用集群这个词来描述，集群是指多个实例组成的整体，但是实例之间不需要协作。无论是读写分离还是分库分表，都是分布式而不是集群。

  作者回复: 集群也可以协作呀，比如说ZooKeeper。

  2022-02-20

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/2d/ca/02b0e397.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  fomy

  我所在的公司以前没有做数据库隔离，很多业务都是联表查询的。随着业务发展，原来的库（以下命名为a库）已经有几千张表了。 a库有16个从库，基本每个业务线都分了一个从库，供下面的很多业务做联表查询，主库主要用于写业务。其中一个是供大数据进行数据统计。 现在逐渐做了数据隔离，我花了大半年时间把用户相关的表拆分出来了，但是由于历史原因，还必须把用户表同步回a库。对实时要求比较高的一律要求走用户中心的接口。 一开始我在想为啥一开始不做数据库隔离呢？现在读了老师的课程，一开始为了业务快速上线，不做联表查询是最快的，遵循演化原则，才逐渐有了数据隔离的需求。

  作者回复: 对的，业务开发速度很快，毕竟很多新业务，快速迭代和试错，存活下来才是最重要的

  2021-10-13

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/29/ba/8e/4645afae.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Drake敏

  电商行业更适合读写分离

  作者回复: 是的

  2021-09-12

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/29/1c/02/5aa8b087.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Wayne👿

  读写分离的本质，就是单台机器性能已经满足当前的读写请求，所以需要再增加机器。又由于读写的差异性（写请求更加耗时，以及通常情况下读请求多于写请求）。所以干脆把读写请求进行分离，让所有的写请求都访问同一台机器，读请求访问其他的机器。如果写请求也太多了，一台机器无法满足要求，那么就需要增加更多服务的写请求的机器。

  作者回复: 正解

  2021-08-20

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/1d/44/a0/16d0d300.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  ZHANGPING![img](https://static001.geekbang.org/resource/image/8a/95/8ac15yy848f71919ef784a1c9065e495.png)

  个人感悟：读写分离是一种解决方案，但在实时之前：先评审是否索引是否合理，是不是慢查询引起等，最后才读写分离。不要盲目增加系统复杂度。

  作者回复: 点赞

  2021-06-27

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/1d/44/a0/16d0d300.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  ZHANGPING![img](https://static001.geekbang.org/resource/image/8a/95/8ac15yy848f71919ef784a1c9065e495.png)

  读写分离主要是针对读多写少的场景，并且能够水平扩展。如果业务是批量提交，则读写延迟可能会更大，如果是2地3中心，延迟就更高了。

  2021-06-27

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/28/60/b7/4a665c73.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  小鬼爱风雪

  读写分离一般用在使用数据实效性不高的场景，读这些配置信息或者权限信息，或者海量清洗数据的结果都可以，

  2021-06-16

  **

  **

- ![img](https://thirdwx.qlogo.cn/mmopen/vi_32/2c2QrKaYwDMqk3MaqQv8bpGfgicrRdyhcP3ZJib3YXBoEj57dmQI9dRbeIySX6bsPl29HiaosHor5tJulQ4axnE7Q/132)

  马里奥

  最近遇到mongodb一个慢查询的问题，请问下这这个场景下读写分离是否会解决这个问题？ 1.数据表在1亿左右 2.表的数据会高频插入数据，到几乎不修改数据 3.查询已经走索性了，但是有一个查询条件(是或否)会导致读取大量数据进行过滤(10w)，这是一个很低频查询 目前是主备

  作者回复: 从你的描述来看，走读写分离是比较好的

  2021-05-30

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/25/ed/a0/cc89c128.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  大聖

  我觉得读写分离的一个难点是，分配机制管理主机和从机连接信息，特别是主从切换了以后

  作者回复: 读写分离这部分处理还好，不怎么难

  2021-05-28

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/19/2e/ca/469f7266.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](14%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%EF%BC%9A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.resource/resize,w_14.png)

  菠萝吹雪—Code

  数据库读写分离一般应用于什么场景：读多写少的场景，比如电商系统就是一个典型的读多写少的案例。对于写多读少的系统就不适合了。 能支撑多大的业务规模：这个需要压测，每个系统可能不一样 感悟：并不是一定要上集群、读写分离。慢查询、系统代码优化没啥空间再考虑

  2021-03-19

  **

  **

- ![img](http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEL9JoquW6ia5A9AUkt8Ah51WQsqlpWnzwLcZwXKycAricKGOeqHf2JrVHxkHIjx5LuHnm8fJ1bJVLlA/132)

  荣码人生

  写完全依赖于主机，当主机故障，业务服务器端可以通过程序来主动判断主从数据库，但是数据库自身如何自动实现数据库主从切换？

  作者回复: 要么存储系统自己实现了切换，例如Redis、MongoDB，要么依赖第三方来实现切换，例如MySQL没有提供切换的能力，需要MySQL Router来切换，我以前在UC的时候，我们也是自己开发了类似MySQL Router的中间件。

  2021-03-11

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/12/d1/29/1b1234ed.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](14%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%EF%BC%9A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.resource/resize,w_14.png)

  DFighting

  读写分离的应用前提除了读频率>>写之外，还有一个就是对数据短期不一致的容忍度吧。还有读写分离只是解决了存储访问的局限，算是一种优化，但是数据依然全部存储到了每台机器上。以前真没从这方面思考分表分库和读写分离的区别

  作者回复: 专栏里面有很多分析的角度，学完后你看技术方案的角度，对技术方案的理解会更全面更深入。

  2021-03-04

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/13/20/08/bc06bc69.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Dovelol

  老师好，想问下TDDL开源版是没有维护吗？网上资料很少，查到的也是很多年前的介绍了。现在淘宝还在用这个的话肯定已经升级过很多版本了，为啥没有更新出来呢？

  作者回复: 因为我不是那个团队的，所以没法详细回答，内部有在用的，为啥没更新开源这个我就不清楚了。

  2020-12-06

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/0f/f7/9d/be04b331.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  落叶飞逝的恋

  读写分离一般用在读得操作很大，写得操作很少得应用场景下。

  2020-09-24

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/ad/24/c6b763b4.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](14%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%EF%BC%9A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.resource/resize,w_14.png)

  桃子-夏勇杰

  需要区分真的是读的性能要分离了，还是原来的sql读取性能有问题，过早的读写分离可能引入不必要的复杂度。

  2020-09-19

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/1d/43/dc/95d4f2c5.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  林毅鑫

  笔记笔记： 读写分离怎么搞？ 1、复制延迟，将主机定时同步到从机； 2、分配机制，使用中间件或代码封装，将读写分离。

  2020-07-31

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/1d/fe/83/df562574.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  慎独明强

  我们系统在写多读也多有读写分离，核心业务读写操作全部走主库，把查询只读服务拆分出来，配置从库数据源，对外查询接口大部分走只读服务。但是主从延迟是个比较大问题，主库高并发，大事务，大表的ddl，延迟会达到1－3个小时。对于订单拉单漏单，后面我们结合实际业务场景，执行大sql时，一般是晚上，切换只读数据源为主库，等执行完后再切到从库。不知道大厂是怎么干的？

  作者回复: 你这个延迟太夸张了😂正常来说延迟1分钟内可以接受。这种情况要用分库分表拆主库

  2020-07-27

  **

  **

- ![img](http://thirdwx.qlogo.cn/mmopen/vi_32/73JN7HxoDAxjPmSWlaGydX6Cpico0aWNIP6mHYibB5BsYcLRt3f7Lm3ZgvtLYWTnBKm9D8bicZI7Q02UTicTiaXycLA/132)

  霸蛮人

  个人觉得当读写不平衡，读、写需求差异明显时，需要进行读写分离，有利于整体资源的高效利用。

  2020-03-24

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/1a/1b/70/547042ee.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  谭方敏

  读写分离一般适合于读的并发压力远远超过写的并发压力的情况，单库读取已经无法满足需求，针对这样的情况，只能增加一些库来专门提供读取，这就是读写分离的应用场景。现在大部分数据库都支持读者分离了，mysql是最典型的了，mongodb也有支持（甚至还提出了副本集这种一主多从的技术）。 至于规模的话，能有十万级别吧，这个主要取决于业务复杂度吧。毕竟读写分离只是为了提高读取的能力，对整个数据库效率和压力提升来说有限。算是初级形态吧。

  2020-03-01

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/0f/75/9b/611e74ab.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](14%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%EF%BC%9A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.resource/resize,w_14.png)

  技术修行者![img](https://static001.geekbang.org/resource/image/89/43/89yyff4c4c2e2b73ce4931bb01a6a943.png)

  对于一个线上运行的解决方案，当用户量达到一定规模后，可能会对数据库读写操作造成压力，单机版本的数据库服务器可能没有办法支撑过多的并发用户来进行读写操作。 为了解决这一问题，我们一般会有两种方法： 1. 加入缓存，对于经常访问的只读的数据，可以放在缓存中，从而减少对数据库的访问压力，这里需要考虑的是a) 哪些数据可以缓存，b) 缓存更新的策略。 2. 采用数据库读写分离，这里需要构造一个数据库主从集群，采用读写分离的前提是业务包含了大量的读操作和少量的写操作。 采用数据库读写分离方案，需要考虑 a) 读写同步问题，写操作后的数据，需要一定时间才能从写主库同步到读从库，在同步操作完成前，访问从库得到的数据不是最新的。可能的解决办法是核心业务总是从主库获取数据，非核心业务可以忍受一定延迟，或者业务做写操作后，紧接着的业务操作从主库读取数据。 b) 如何分配写库和读库，在集群中，独库和写库不是固定的，我们需要有一种方式来判断应该向哪个数据库执行操作，通常有两种方式，一种是通过程序和配置实现，一种是通过数据库中间件实现。

  2020-01-01

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/16/a0/a3/8da99bb0.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  业余爱好者

  数据库高性能架构方案一:读写分离 缺点:主从复制延迟，数据一致性问题。 解决:两阶段读取，即，先读从库，没有数据读主库。主要业务读写读走主库，次要业务读走从库。 加一个数据访问中间层。方案有程序语言封装，数据中间件。后者技术复杂度高，一般使用前者。

  2019-12-25

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/0f/89/d9/abb7bfe3.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  嚆同学

  读写分离的主要适用场景是读多写少，但是这也是要依据并发量大小。并发小，没必要做读写分离；并发大了，单机写就会是瓶颈。现在遇到的业务属于读多写少，但是并发量一般，每天定时执行批量入库操作，但是因为每天新增数据量太大，所以直接采用的分表。

  2019-10-31

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/14/6d/cf/ec335526.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  jc9090kkk

  感谢老师分享，一般来讲，读写分离应该是属于系统优化+垂直拓展后的一步，只有在系统的优化和单机性能到了天花板后，如果还是没办法达到理想效果，才会采取读写分离，不过读写分离的方式相对之前的维护性的难度也提升了，读写分离里面，如果主从延迟的问题会导致数据不一致，从而引发可用性的问题，甚至在一些极端的情况下，从库可能会一直追不上主库，这样就需要人工介入，去排查出现问题的原因是什么？如果是一主一从的架构，可以采用semi-sync的方式来尽量保证主从复制无延迟，如果是更复杂的读写分离架构，就需要新的策略了。

  2019-09-29

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/c8/34/fb871b2c.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  海罗沃德

  AWS的aurora数据库就是基于mysql的读写分离苦，可以配置多台mysql instance到aurora里，并按指定哪一台读哪一台写，中间的数据同步使用AWS的replica服务

  2019-06-30

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/0f/ae/00/025f37e7.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](14%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%EF%BC%9A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.resource/resize,w_14.png)

  xuery![img](https://static001.geekbang.org/resource/image/89/43/89yyff4c4c2e2b73ce4931bb01a6a943.png)

  一般使用于读多写少的场景，mysql从库设置为readonly, 只提供读操作，提升查询的qps; 具体能支撑多大量的业务，要根据压测之后单机的读QPS来看

  2019-04-04

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/12/f5/81/92d01e3a.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Sean

  我们之前用galera集群，多主的，并发大经常出现死锁。后来改成MGR,一主两从一备，采用探测服务切换主从，读写分离看业务而定，不过还是不敢上多主，怕并发写出现死锁。 今天看老师说了从库读不到数据再切到主库，这个具体怎么实现？

  作者回复: 代码实现的

  2018-11-05

  **

  **

- ![img](data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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)

  木头旮瘩

  看到一些评论里说如果单机写顶不住了就考虑拆库，我觉得也可以考虑更改主从的架构，比如由3M或者MHA这些传统的主从架构改为Galera Cluster这种多主架构模式，当然这种改动影响也不小，也挺费劲的(实际工作中没用过Galera，一直在用MHA)

  作者回复: MHA同一时刻只有一台主机，还是撑不住写操作哦

  2018-10-31

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/12/be/e6/7808520d.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Edward Lee

  读写分离问题 如果用户的前后操作存在依赖性我认为可以加入用户级别会话进行保存，会话保存方式可以是之前提到的 nginx ip_hash 或者引入 redis/memcache，引入会话后即使多个用户的信息存在共享关系，读写数据库的延迟用户也无法察觉 读写分离场景 每个系统都会涉及读写操作，主要是读写比例的合理分配，如电商类就是读多于写，办公类，像 OA 系统就是写多于读，分配读写数据库比例看来算是架构设计的其中一部分 : )

  2018-10-12

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/db/b3/040eb673.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  鸡蛋🎱 达芬奇

  使用mycat这种不是也很好吗？

  作者回复: 可以的

  2018-07-17

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/70/6d/11ea66f0.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  peison

  老师您好，想请教要怎么样做数据库压测？还有您说不同的数据库表设计性能测试结果不同，想问问怎样的设计性能高？怎么样的设计性能低？这方面有哪些资料可以参考吗？请老师指教

  作者回复: 高性能mysql，可以看看

  2018-07-09

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/70/6d/11ea66f0.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  peison

  想请教老师，怎么做数据库的压测呢？还有您说不同的数据库表设计性能不同，那怎么样的设计性能高，怎么样的设计性能低？这方面有那些技术资料可以参考吗？请老师指教

  作者回复: 可以看看《高性能mysql》

  2018-07-09

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/01/1b/24db90c7.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  Cola

  读写分离一般用于读操作频繁，读压力比写压力大一个量级的情况下。另外，读写压力较大也可以用各种缓存手段解决问题。

  2018-07-05

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/3a/85/8e32883f.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  张国胜

  其实有时候也大概知道一些概念，遇到性能问题可以做什么，可具体情况下，应该做什么，是新手不太能确定的。比如不知道怎样才是合理的数据库优化顺序。

  2018-06-29

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/21/0f/b61dc67e.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  ^_^

  请问老师，写库同步数据到从库具体是怎么实现的

  2018-06-28

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/0e/a1/152a5de1.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  甲韭

  读写分离，无它，一言以蔽之，一台服务器撑不住了

  2018-06-23

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/0e/a1/152a5de1.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  甲韭

  读写分离，无它，一言以蔽之，一台服务器撑不住了

  2018-06-23

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/11/0b/a6/b234aa79.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  孙晓明

  想问的其他同学都问了😁

  2018-06-20

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/a8/64/965e0d9b.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)![img](14%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%EF%BC%9A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.resource/resize,w_14.png)

  王维

  想请问下华仔，我们系统用的数据库是ms sqlserver，如果要使用数据库中间件，那么有什么好的可以推荐的呢？貌似ms sqlserver的数据库中间件没有my sql的多。

  作者回复: 目测没有几个成熟的面向sqlserver的开源中间件，估计要买或者自己写中间层

  2018-06-06

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/05/06/9b9b3143.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  如风

  写是对于主库，读是从库; 读写分离是随着业务的发展，而演变，现有的数据库支撑不了了，特别大量的数据及查询会拖死数据库，这个时候就得考虑读写分离和多个分组主从库，服务也做拆分，从而演变成微服务，保证核心业务不受影响，其他非核心业务挂了也不受影响，这就是服务降级，防止血崩

  2018-05-31

  **

  **

- ![img](http://thirdwx.qlogo.cn/mmopen/vi_32/7SOblVZ7dNJ88wkeYR0HklxdR9VuiaQ0GMscAnrlic6EjvRZS52m4n1VPypwZFsmabbJ4STZRbHFfVZE24Jjqr1w/132)

  今夕是何年

  读写分离应用于读多写少的场景

  2018-05-30

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/a8/1b/ced1d171.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  空档滑行

  读操作远大于写操作并且并发量很大的情况需要读写分离。因为分离后可以针对读库做单独的优化。 关于读写分离后的复制延迟问题，我感觉无论是二次读取还是区分关键业务，都会出现写库压力大的问题。还是要结合第一点的业务代码修改。 还有一个问题最近一直在考虑，读写分离后的dal层设计是在查询接口实现时读写库各实现一套还是通过传参来区分更好呢？请教一下老师

  2018-05-30

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/ce/2b/a47a0936.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  何国平

  还有事务必须走从库，而现在很多开发框架都用到事务，搞得主从读写分离很鸡肋

  2018-05-30

  **3

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/77/53/bc27222f.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  coder_java

  华仔好，看了大家的回答基本上回答的都不错。 关于集群的问题能否做个总结，redis里有集群，es有集群，kafka等等都有集群，他们有什么共同之处么？或者说区别都在于哪？都是主读写，从读么？

  作者回复: 这个留作课后作业给你，自己的总结印象最深刻

  2018-05-29

  **

  **

- ![img](https://static001.geekbang.org/account/avatar/00/10/88/47/e1b9c1cc.jpg?x-oss-process=image/resize,m_fill,h_34,w_34)

  nola den

  我想在独立一台主机无法承受访问压力时，才需要使用读写分离。目的是分配读操作的压力到从机上。但主机还是承受所有写操作压力，当主机无法应对大量写操作的时候，整个存储系统也就崩掉了。因为从机可以扩展，主机只能一台。
